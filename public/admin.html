<script>
  let firebaseConfig = null;
  const saved = localStorage.getItem('ccx_firebase_config');
  const savedPass = localStorage.getItem('ccx_admin_password');

  if (saved && savedPass) {
    try {
      firebaseConfig = JSON.parse(saved);
      initFirebase();
      document.getElementById('setupScreen').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
    } catch(e) {
      alert('Invalid saved config. Resetting...');
      localStorage.clear();
      location.reload();
    }
  }

  function saveConfig() {
    const configText = document.getElementById('configInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    if (!configText || !password) return alert('Fill both!');
    try {
      JSON.parse(configText);
      localStorage.setItem('ccx_firebase_config', configText);
      localStorage.setItem('ccx_admin_password', password);
      alert('Saved! Reloading...');
      location.reload();
    } catch(e) {
      alert('Invalid JSON!');
    }
  }

  let db;
  function initFirebase() {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    console.log('Firebase connected');
    loadTokens();
  }

  let isLoggedIn = false;
  function login() {
    const input = document.getElementById('loginPassword').value;
    const correct = localStorage.getItem('ccx_admin_password');
    if (input === correct) {
      isLoggedIn = true;
      document.getElementById('loggedIn').classList.remove('hidden');
      document.getElementById('loginPassword').parentNode.style.display = 'none';
      loadCoinList();
    } else {
      alert('Wrong password!');
    }
  }

  // === COINGECKO COIN LIST ===
  let coinList = [];
  async function loadCoinList() {
    if (coinList.length > 0) return;
    try {
      const res = await fetch('https://api.coingecko.com/api/v3/coins/list');
      coinList = await res.json();
      populateCoinSelect();
    } catch(e) {
      alert('Failed to load coin list. Check internet.');
    }
  }

  function populateCoinSelect() {
    const select = document.getElementById('tokenSelect');
    const options = coinList.slice(0, 500).map(coin => 
      `<option value="${coin.id}">${coin.name} (${coin.symbol.toUpperCase()})</option>`
    ).join('');
    select.innerHTML = '<option value="">Select a coin...</option>' + options;
  }

  function addToken() {
    if (!isLoggedIn) return alert('Login first!');
    const coinId = document.getElementById('tokenSelect').value;
    if (!coinId) return alert('Select a coin!');

    const coin = coinList.find(c => c.id === coinId);
    if (!coin) return;

    db.ref('tokens/' + coinId).set({
      id: coinId,
      name: coin.name,
      symbol: coin.symbol.toUpperCase()
    }).then(() => {
      alert(`${coin.name} added!`);
      document.getElementById('tokenSelect').value = '';
    }).catch(err => alert('Error: ' + err.message));
  }

  function loadTokens() {
    db.ref('tokens').on('value', snap => {
      const list = document.getElementById('tokenList');
      list.innerHTML = '';
      const data = snap.val() || {};
      Object.keys(data).forEach(key => {
        const t = data[key];
        const div = document.createElement('div');
        div.className = 'token-item';
        div.innerHTML = `
          <span><strong>${t.symbol}</strong> - ${t.name}</span>
          <button class="delete" onclick="deleteToken('${key}')">Delete</button>
        `;
        list.appendChild(div);
      });
    });
  }

  window.deleteToken = function(key) {
    if (confirm('Delete ' + key + '?')) {
      db.ref('tokens/' + key).remove();
    }
  };
</script>
