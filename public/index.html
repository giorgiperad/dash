<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
<meta name="description" content="Professional crypto dashboard with real-time market data, portfolio tracking, and price alerts">
<meta name="theme-color" content="#8b5cf6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CCX">
<meta name="mobile-web-app-capable" content="yes">
<meta name="msapplication-TileColor" content="#8b5cf6">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="application-name" content="CCX">
<meta name="format-detection" content="telephone=no">
<title>CRYPTO COLLECTIVE X - Desktop Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚ú® ELEGANT MODERN CRYPTO DASHBOARD - THEME SYSTEM
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
* { margin:0; padding:0; box-sizing:border-box; }

/* ‚îÄ‚îÄ‚îÄ‚îÄ ELEGANT MODERN THEME ‚îÄ‚îÄ‚îÄ‚îÄ */
:root {
  /* Dark Theme - Elegant & Sophisticated */
  --bg-primary: #0a0a0f;
  --bg-secondary: #111118;
  --bg-tertiary: #1a1a24;
  --bg-card: #14141c;
  --bg-card-hover: #1c1c28;
  --bg-overlay: rgba(10, 10, 15, 0.98);
  --bg-input: #0f0f15;
  --bg-input-focus: #1a1a24;
  
  --text-primary: #ffffff;
  --text-secondary: #b4b4c4;
  --text-tertiary: #7a7a8c;
  --text-muted: #5a5a6a;
  
  --border-primary: rgba(255, 255, 255, 0.08);
  --border-secondary: rgba(255, 255, 255, 0.04);
  --border-accent: rgba(139, 92, 246, 0.4);
  
  --accent-primary: #8b5cf6;
  --accent-secondary: #a78bfa;
  --accent-hover: #7c3aed;
  
  --success: #10b981;
  --success-bg: rgba(16, 185, 129, 0.12);
  --error: #ef4444;
  --error-bg: rgba(239, 68, 68, 0.12);
  --warning: #f59e0b;
  --warning-bg: rgba(245, 158, 11, 0.12);
  
  --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
  --shadow-glow: 0 0 24px rgba(139, 92, 246, 0.4);
  
  --gradient-primary: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 50%, #ec4899 100%);
  --gradient-card: linear-gradient(145deg, #14141c 0%, #111118 100%);
  --gradient-text: linear-gradient(135deg, #ffffff 0%, #e0e7ff 100%);
  --gradient-accent: linear-gradient(135deg, #8b5cf6, #ec4899, #f59e0b);
  
  --blur: blur(16px);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
}

[data-theme="light"] {
  /* Light Theme - Clean & Elegant */
  --bg-primary: #fafafa;
  --bg-secondary: #ffffff;
  --bg-tertiary: #f5f5f5;
  --bg-card: #ffffff;
  --bg-card-hover: #fafafa;
  --bg-overlay: rgba(255, 255, 255, 0.98);
  --bg-input: #ffffff;
  --bg-input-focus: #f5f5f5;
  
  --text-primary: #0a0a0f;
  --text-secondary: #3a3a4a;
  --text-tertiary: #6a6a7a;
  --text-muted: #9a9aaa;
  
  --border-primary: rgba(0, 0, 0, 0.08);
  --border-secondary: rgba(0, 0, 0, 0.04);
  --border-accent: rgba(139, 92, 246, 0.3);
  
  --accent-primary: #8b5cf6;
  --accent-secondary: #a78bfa;
  --accent-hover: #7c3aed;
  
  --success: #059669;
  --success-bg: rgba(5, 150, 105, 0.1);
  --error: #dc2626;
  --error-bg: rgba(220, 38, 38, 0.1);
  --warning: #d97706;
  --warning-bg: rgba(217, 119, 6, 0.1);
  
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
  --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
  --shadow-glow: 0 0 20px rgba(139, 92, 246, 0.25);
  
  --gradient-primary: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 50%, #ec4899 100%);
  --gradient-card: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
  --gradient-text: linear-gradient(135deg, #0a0a0f 0%, #3a3a4a 100%);
  --gradient-accent: linear-gradient(135deg, #8b5cf6, #ec4899, #f59e0b);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ‚îÄ‚îÄ */
@keyframes fadeIn {from{opacity:0}to{opacity:1}}
@keyframes fadeInUp {from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn {from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
@keyframes shimmer {0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
@keyframes rotate {from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ‚îÄ‚îÄ BODY & BACKGROUND ‚îÄ‚îÄ‚îÄ‚îÄ */
body{
  font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  min-height:100vh;
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  position:relative;
  transition:background-color 0.3s ease, color 0.3s ease;
}
.grain-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");opacity:0.03;pointer-events:none;z-index:1}
[data-theme="light"] .grain-overlay{opacity:0.01}
.navbar{background:var(--bg-secondary);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border-secondary);padding:0 24px;display:flex;justify-content:space-between;align-items:center;position:fixed;top:0;left:0;right:0;z-index:100;box-shadow:var(--shadow-sm);transition:background-color 0.3s ease, border-color 0.3s ease;height:60px}
.logo-section{display:flex;align-items:center;gap:16px}
.logo-icon{width:40px;height:40px;min-width:40px;min-height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;overflow:hidden;position:relative;flex-shrink:0}
.logo-icon img{width:100%;height:100%;object-fit:contain;max-width:40px;max-height:40px;filter:none}
.logo-text{display:flex;flex-direction:column}
.logo-title{font-size:18px;font-weight:600;letter-spacing:-0.3px;color:var(--text-primary);transition:color 0.3s ease}
.logo-subtitle{font-size:9px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1px;font-weight:500;transition:color 0.3s ease}
.nav-right{display:flex;align-items:center;gap:20px}
.theme-toggle{width:40px;height:40px;border-radius:10px;background:var(--bg-card);border:1px solid var(--border-primary);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;font-size:18px;color:var(--text-secondary);position:relative;overflow:hidden}
.theme-toggle:hover{background:var(--bg-card-hover);border-color:var(--accent-primary);transform:scale(1.05);color:var(--accent-primary)}
.theme-toggle::before{content:'';position:absolute;inset:0;background:var(--gradient-primary);opacity:0;transition:opacity .3s}
.theme-toggle:hover::before{opacity:0.1}
.auth-buttons{display:flex;gap:12px}
.auth-btn{padding:10px 20px;background:transparent;border:1px solid var(--border-primary);color:var(--text-secondary);font-size:13px;font-weight:500;border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;letter-spacing:0.2px}
.auth-btn:hover{background:var(--bg-card);border-color:var(--border-accent);color:var(--text-primary)}
.auth-btn.primary{background:var(--accent-primary);border-color:var(--accent-primary);color:#fff}
.auth-btn.primary:hover{background:var(--accent-hover);border-color:var(--accent-hover)}
.user-menu{display:flex;align-items:center;gap:12px}
.user-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--border-primary);box-shadow:var(--shadow-sm);transition:border-color 0.3s ease}
.user-name{font-size:14px;font-weight:500;color:var(--text-secondary);letter-spacing:0.2px;transition:color 0.3s ease}
.admin-controls{display:none;gap:12px;align-items:center}
.admin-controls.show{display:flex}
.admin-btn{padding:10px 20px;font-size:13px;font-weight:600;border-radius:10px;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);letter-spacing:0.3px}
.admin-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
.live-indicator{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--success-bg);border:1px solid var(--success);opacity:0.8;border-radius:12px;backdrop-filter:blur(10px);transition:all 0.3s ease}
.live-dot{width:8px;height:8px;background:var(--success);border-radius:50%;box-shadow:0 0 8px var(--success);animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.1)}}
.live-text{font-size:12px;color:var(--success);font-weight:600;text-transform:uppercase;letter-spacing:0.8px;transition:color 0.3s ease}
.time-display{font-size:14px;color:var(--text-tertiary);font-weight:500;font-variant-numeric:tabular-nums;letter-spacing:0.5px;transition:color 0.3s ease}
/* SIDEBAR MENU */
.sidebar{position:fixed;left:0;top:60px;width:260px;height:calc(100vh - 60px);background:var(--bg-secondary);border-right:1px solid var(--border-secondary);padding:20px 0;overflow-y:auto;overflow-x:hidden;z-index:90;transition:all 0.3s ease}
.sidebar::-webkit-scrollbar{width:6px}
.sidebar::-webkit-scrollbar-track{background:transparent}
.sidebar::-webkit-scrollbar-thumb{background:var(--border-primary);border-radius:3px}
.sidebar::-webkit-scrollbar-thumb:hover{background:var(--border-accent)}
.sidebar-menu{display:flex;flex-direction:column;gap:4px;padding:0 12px}
.sidebar-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--radius-md);color:var(--text-secondary);font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s ease;text-decoration:none;position:relative;border:1px solid transparent}
.sidebar-item:hover{background:var(--bg-tertiary);color:var(--text-primary);border-color:var(--border-primary)}
.sidebar-item.active{background:var(--accent-primary);color:#fff;box-shadow:var(--shadow-sm);border-color:var(--accent-primary)}
.sidebar-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:70%;background:#fff;border-radius:0 3px 3px 0}
.sidebar-icon{font-size:20px;width:24px;text-align:center;flex-shrink:0;line-height:1}
.sidebar-text{flex:1;white-space:nowrap;font-weight:500}
.sidebar-divider{height:1px;background:var(--border-secondary);margin:12px 16px}
.sidebar-section-title{font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);padding:8px 16px;font-weight:600;margin-top:8px}

/* MAIN CONTENT WITH SIDEBAR */
.main-layout{display:flex;min-height:calc(100vh - 60px);margin-top:60px}
.main-content{flex:1;margin-left:260px;padding:24px;transition:margin-left 0.3s ease;min-height:calc(100vh - 60px)}
.container{max-width:100%;margin:0;padding:0;position:relative;z-index:2;width:100%;box-sizing:border-box}
.hero-section{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:32px;grid-auto-rows:minmax(90px,auto)}
.hero-stat{background:var(--bg-card);backdrop-filter:var(--blur);border-radius:var(--radius-md);padding:12px 16px;border:1px solid var(--border-secondary);transition:all .2s;display:flex;flex-direction:column;justify-content:space-between;min-height:70px}
.hero-stat:hover{background:var(--bg-card-hover);border-color:var(--border-primary)}
.hero-stat-label{font-size:10px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-tertiary);margin-bottom:6px;font-weight:500}
.hero-stat-value{font-size:16px;font-weight:600;color:var(--text-primary);letter-spacing:-0.3px;line-height:1.2}
.hero-stat-change{font-size:11px;margin-top:6px;font-weight:500;padding:3px 8px;border-radius:var(--radius-sm);display:inline-block;width:fit-content}
.hero-stat-change.positive{color:var(--success);background:var(--success-bg)}
.hero-stat-change.negative{color:var(--error);background:var(--error-bg)}
.content-grid{display:block;width:100%;margin-bottom:48px}
.sidebar-section{display:flex;flex-direction:column;gap:20px}
.featured-card{background:var(--bg-card);backdrop-filter:var(--blur);border:1px solid var(--border-secondary);border-radius:var(--radius-lg);padding:24px;transition:all .2s}
.featured-card:hover{background:var(--bg-card-hover);border-color:var(--border-primary)}
.card-badge{display:inline-block;font-size:10px;text-transform:uppercase;letter-spacing:2px;font-weight:900;padding:6px 12px;border-radius:var(--radius-md);margin-bottom:20px}
.badge-gainer{background:var(--success-bg);color:var(--success);border:1px solid var(--success);opacity:0.8}
.badge-gold{background:var(--warning-bg);color:var(--warning);border:1px solid var(--warning);opacity:0.8}
.badge-loss{background:var(--error-bg);color:var(--error);border:1px solid var(--error);opacity:0.8}
.featured-header{display:flex;align-items:center;gap:20px;margin-bottom:24px}
.featured-icon{width:72px;height:72px;border-radius:50%;border:3px solid var(--border-secondary);box-shadow:var(--shadow-md);transition:all .4s}
.featured-card:hover .featured-icon{transform:rotate(10deg) scale(1.1);border-color:var(--accent-primary);box-shadow:var(--shadow-glow)}
.featured-info h3{font-size:22px;font-weight:800;margin-bottom:6px;color:var(--text-primary);transition:color 0.3s ease}
.featured-price{font-size:18px;color:var(--text-secondary);font-weight:700;transition:color 0.3s ease}
.progress-section{margin-top:24px}
.progress-label{display:flex;justify-content:space-between;margin-bottom:12px;font-size:13px;font-weight:700;color:var(--text-primary);transition:color 0.3s ease}
.progress-bar{height:12px;background:var(--bg-tertiary);border-radius:6px;overflow:hidden;position:relative;transition:background-color 0.3s ease}
.progress-fill{height:100%;border-radius:6px;position:relative;overflow:hidden;transition:width 1.2s cubic-bezier(.4,0,.2,1)}
.progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmerEffect 2s infinite}
.progress-fill.green{background:linear-gradient(90deg,var(--success),#059669);box-shadow:0 0 16px var(--success);opacity:0.8}
.progress-fill.gold{background:linear-gradient(90deg,var(--warning),#d97706);box-shadow:0 0 16px var(--warning);opacity:0.8}
.progress-fill.red{background:linear-gradient(90deg,var(--error),#dc2626);box-shadow:0 0 16px var(--error);opacity:0.8}
.progress-value{color:var(--success);font-size:18px;transition:color 0.3s ease}
.progress-value.negative{color:var(--error)}
.progress-value.gold{color:var(--warning)}
.main-section{background:var(--bg-card);backdrop-filter:var(--blur);border:1px solid var(--border-secondary);border-radius:var(--radius-lg);padding:20px;min-height:400px;transition:background-color 0.3s ease, border-color 0.3s ease;box-shadow:var(--shadow-sm)}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border-secondary);transition:border-color 0.3s ease;flex-wrap:wrap;gap:12px}
.section-title{font-size:18px;font-weight:600;color:var(--text-primary);letter-spacing:-0.4px;transition:color 0.3s ease}
.filter-tabs{display:flex;gap:6px;background:var(--bg-tertiary);padding:4px;border-radius:10px;border:1px solid var(--border-secondary);transition:background-color 0.3s ease}
.filter-tab{padding:8px 16px;border:none;background:transparent;color:var(--text-tertiary);font-size:12px;font-weight:500;cursor:pointer;border-radius:var(--radius-sm);transition:all .2s}
.filter-tab:hover{color:var(--text-primary);background:var(--bg-card)}
.filter-tab.active{background:var(--accent-primary);color:#fff}
.table-header{display:grid;grid-template-columns:60px 2fr 1fr 1fr 1fr;gap:16px;padding:10px 16px;margin-bottom:8px;border-radius:8px;background:var(--bg-tertiary);border:1px solid var(--border-secondary);transition:background-color 0.3s ease}
.table-header-cell{font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:500;transition:color 0.3s ease}
.tokens-list{display:flex;flex-direction:column;gap:10px}
.token-row{display:grid;grid-template-columns:60px 2fr 1fr 1fr 1fr;gap:16px;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--border-secondary);border-radius:var(--radius-md);align-items:center;transition:all .2s;animation:fadeInUp .3s ease-out backwards;animation-delay:calc(var(--index)*.02s)}
.token-row:hover{background:var(--bg-card-hover);border-color:var(--border-primary);transform:translateX(2px)}
.token-icon-col{display:flex;align-items:center;justify-content:center}
.token-icon{width:40px;height:40px;border-radius:50%;border:2px solid var(--border-primary);transition:all .3s;box-shadow:var(--shadow-sm)}
.token-row:hover .token-icon{border-color:var(--accent-secondary);transform:scale(1.05);box-shadow:var(--shadow-glow)}
.token-name-col h3{font-size:14px;font-weight:600;margin-bottom:2px;color:var(--text-primary);letter-spacing:-0.3px;transition:color 0.3s ease}
.token-symbol{font-size:11px;color:var(--text-tertiary);font-weight:500;text-transform:uppercase;letter-spacing:0.8px;transition:color 0.3s ease}
.token-price-col{font-size:15px;font-weight:600;color:var(--text-primary);letter-spacing:-0.3px;transition:color 0.3s ease}
.token-change-col{text-align:right}
.change-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:var(--radius-sm);font-size:12px;font-weight:500;transition:all .2s}
.change-badge.positive{background:var(--success-bg);color:var(--success)}
.change-badge.negative{background:var(--error-bg);color:var(--error)}
.token-mcap-col{font-size:13px;font-weight:500;color:var(--text-tertiary);letter-spacing:0.2px;transition:color 0.3s ease}
.loading{text-align:center;padding:120px}
.spinner{width:48px;height:48px;border:3px solid var(--border-secondary);border-top:3px solid var(--accent-primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 24px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:15px;color:var(--text-tertiary);font-weight:500;letter-spacing:0.3px;transition:color 0.3s ease}
.error{background:var(--error-bg);border:1px solid var(--error);color:var(--error);border-radius:var(--radius-lg);padding:20px;margin:24px 0;font-weight:500;text-align:center;backdrop-filter:var(--blur);transition:background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease}

/* Hero Carousel Styles - CoinAnk.com Exact Style */
.hero-carousel-wrapper{position:relative;margin-bottom:32px;width:100%;padding:0 4px;display:flex;justify-content:center;align-items:center}
.carousel{display:flex;gap:12px;overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth;scrollbar-width:none;-ms-overflow-style:none;padding:4px 0 12px;-webkit-overflow-scrolling:touch;justify-content:center;max-width:100%}
.carousel::-webkit-scrollbar{display:none}
.carousel-card{min-width:280px;width:280px;background:var(--bg-card);backdrop-filter:var(--blur);border-radius:10px;padding:18px 20px;border:1px solid var(--border-secondary);transition:all .25s cubic-bezier(.4,0,.2,1);flex-shrink:0;display:flex;flex-direction:column;position:relative;overflow:hidden}
.carousel-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--border-primary),transparent);opacity:0;transition:opacity .3s}
.carousel-card:hover{background:var(--bg-card-hover);border-color:var(--border-primary);transform:translateY(-1px);box-shadow:var(--shadow-md)}
.carousel-card:hover::before{opacity:1}
.carousel-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;position:relative;z-index:1}
.carousel-card-title{font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1.2px;font-weight:700;font-family:'Inter',sans-serif;transition:color 0.3s ease}
.carousel-card-arrow{color:var(--accent-primary);font-size:13px;opacity:0.5;transition:all .2s;cursor:pointer;line-height:1}
.carousel-card:hover .carousel-card-arrow{opacity:0.8;transform:translateX(1px);color:var(--accent-secondary)}
.carousel-card-value{font-size:20px;font-weight:700;color:var(--text-primary);letter-spacing:-0.2px;margin-bottom:6px;line-height:1.2;font-family:'Inter',sans-serif;transition:color 0.3s ease}
.carousel-card-change{font-size:11px;font-weight:600;display:flex;align-items:center;gap:3px;margin-top:2px}
.carousel-card-change.positive{color:var(--success)}
.carousel-card-change.negative{color:var(--error)}
.carousel-card-subtitle{font-size:10px;color:var(--text-muted);margin-top:4px;line-height:1.4;font-weight:500;transition:color 0.3s ease}
.carousel-nav{position:absolute;top:50%;transform:translateY(-50%);width:32px;height:32px;border-radius:50%;background:var(--bg-secondary);backdrop-filter:var(--blur);border:1px solid var(--border-primary);color:var(--text-primary);font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;z-index:10;box-shadow:var(--shadow-sm);opacity:0.8}
.carousel-nav:hover{background:var(--bg-tertiary);border-color:var(--accent-primary);opacity:1;transform:translateY(-50%) scale(1.05)}
.carousel-nav:active{transform:translateY(-50%) scale(0.95)}
.carousel-nav-right{right:8px}
.carousel-nav-left{left:8px}

/* ANIMATED SVG ARROWS */
.change-arrow{width:18px;height:18px;transition:transform .3s ease,filter .3s ease;animation:arrowPulse 1.5s ease-in-out infinite}
@keyframes arrowPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.change-badge:hover .change-arrow{transform:translateY(-2px) scale(1.2);filter:drop-shadow(0 0 8px currentColor)}
.change-value{font-variant-numeric:tabular-nums}

/* USER TABS */
.user-tabs{display:none}
.user-content{display:none;min-height:400px}
.user-content.active{display:block!important}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-tertiary)}
.empty-state-icon{font-size:64px;margin-bottom:20px;opacity:0.5}
.empty-state-title{font-size:20px;font-weight:600;color:var(--text-secondary);margin-bottom:12px}
.empty-state-text{font-size:14px;color:var(--text-tertiary);line-height:1.6;max-width:400px;margin:0 auto 24px}
.empty-state-action{display:inline-block;padding:12px 24px;background:var(--accent-primary);color:#fff;border-radius:var(--radius-md);font-weight:500;text-decoration:none;transition:all 0.3s;box-shadow:var(--shadow-sm)}
.empty-state-action:hover{background:var(--accent-hover);transform:translateY(-2px);box-shadow:var(--shadow-md)}

/* PORTFOLIO - Bold Vibrant Design with Dynamic Effects */
.portfolio-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.summary-card{background:var(--bg-card);border:1px solid var(--border-primary);border-radius:var(--radius-lg);padding:16px 18px;position:relative;overflow:hidden;transition:all .4s cubic-bezier(.34,1.56,.64,1);box-shadow:var(--shadow-md)}
.summary-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,var(--accent-primary) 0%,transparent 70%);opacity:0.05;transition:opacity .6s;pointer-events:none}
.summary-card::after{content:'';position:absolute;inset:0;border-radius:var(--radius-lg);padding:1px;background:var(--gradient-primary);-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);mask-composite:exclude;opacity:0;transition:opacity .4s}
.summary-card:hover{transform:translateY(-2px) scale(1.01);box-shadow:var(--shadow-lg);border-color:var(--accent-primary)}
.summary-card:hover::before{opacity:0.1;animation:rotate 8s linear infinite}
.summary-card:hover::after{opacity:0.3}
@keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.summary-value{font-size:20px;font-weight:800;margin:6px 0;color:var(--text-primary);letter-spacing:-0.6px;line-height:1.1;font-variant-numeric:tabular-nums;transition:color 0.3s ease}
[data-theme="dark"] .summary-value{background:var(--gradient-text);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.summary-label{font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1.2px;font-weight:700;margin-bottom:4px;transition:color 0.3s ease}
.holdings-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;margin-bottom:20px}
.holding-row{display:flex;flex-direction:column;gap:10px;padding:14px 16px;background:var(--bg-card);border:1px solid var(--border-primary);border-radius:var(--radius-lg);transition:all .4s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden;box-shadow:var(--shadow-md)}
.holding-row::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,var(--border-primary),transparent);transition:left .6s;opacity:0.3}
.holding-row:hover{background:var(--bg-card-hover);border-color:var(--accent-primary);transform:translateY(-4px) scale(1.01);box-shadow:var(--shadow-lg)}
.holding-row:hover::before{left:100%}
.holding-header{display:flex;align-items:center;gap:14px;padding-bottom:14px;border-bottom:1px solid var(--border-secondary);position:relative}
.holding-header::after{content:'';position:absolute;bottom:-1px;left:0;width:0;height:1px;background:var(--gradient-primary);transition:width .4s}
.holding-row:hover .holding-header::after{width:100%}
.holding-icon-wrapper{width:52px;height:52px;border-radius:var(--radius-lg);background:var(--bg-tertiary);border:1px solid var(--border-primary);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;box-shadow:var(--shadow-sm);transition:all .3s}
.holding-row:hover .holding-icon-wrapper{transform:rotate(5deg) scale(1.1);border-color:var(--accent-primary);box-shadow:var(--shadow-md)}
.holding-icon-wrapper img{width:100%;height:100%;object-fit:cover;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.holding-info{flex:1;min-width:0}
.holding-name{font-size:16px;font-weight:700;color:var(--text-primary);letter-spacing:-0.3px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:color 0.3s ease}
.holding-symbol{font-size:12px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1px;font-weight:600;transition:color 0.3s ease}
.holding-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.holding-stat{display:flex;flex-direction:column;gap:6px;padding:10px;background:var(--bg-tertiary);border:1px solid var(--border-secondary);border-radius:var(--radius-md);transition:all .3s;position:relative;overflow:hidden}
.holding-stat::before{content:'';position:absolute;inset:0;background:var(--accent-primary);opacity:0.03;transition:opacity .3s}
.holding-stat:hover{background:var(--bg-card);border-color:var(--border-primary);transform:translateY(-2px)}
.holding-stat:hover::before{opacity:0.05}
.holding-stat-label{font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1.2px;font-weight:700;transition:color 0.3s ease}
.holding-stat-value{font-size:14px;font-weight:700;color:var(--text-primary);letter-spacing:-0.2px;font-variant-numeric:tabular-nums;transition:color 0.3s ease}
.holding-stat-value.positive{color:var(--success)}
.holding-stat-value.negative{color:var(--error)}
.holding-actions{display:flex;gap:8px;padding-top:14px;border-top:1px solid var(--border-secondary);justify-content:flex-end;position:relative}
.holding-actions::before{content:'';position:absolute;top:-1px;left:0;width:0;height:1px;background:var(--gradient-primary);transition:width .4s}
.holding-row:hover .holding-actions::before{width:100%}
.edit-btn{background:var(--bg-tertiary);border:1px solid var(--accent-primary);color:var(--accent-primary);padding:8px 16px;border-radius:var(--radius-md);cursor:pointer;font-size:12px;font-weight:700;transition:all .3s;flex:1;text-align:center;text-transform:uppercase;letter-spacing:0.5px;box-shadow:var(--shadow-sm);position:relative;overflow:hidden}
.edit-btn::before{content:'';position:absolute;inset:0;background:var(--accent-primary);opacity:0;transition:opacity .3s}
.edit-btn:hover{background:var(--accent-primary);border-color:var(--accent-hover);color:#fff;transform:translateY(-2px) scale(1.05);box-shadow:var(--shadow-md)}
.edit-btn:hover::before{opacity:1}
.delete-btn{background:var(--bg-tertiary);border:1px solid var(--error);color:var(--error);padding:8px 16px;border-radius:var(--radius-md);cursor:pointer;font-size:12px;font-weight:700;transition:all .3s;flex:1;text-align:center;text-transform:uppercase;letter-spacing:0.5px;box-shadow:var(--shadow-sm);position:relative;overflow:hidden}
.delete-btn::before{content:'';position:absolute;inset:0;background:var(--error);opacity:0;transition:opacity .3s}
.delete-btn:hover{background:var(--error);border-color:var(--error);color:#fff;transform:translateY(-2px) scale(1.05);box-shadow:var(--shadow-md)}
.delete-btn:hover::before{opacity:1}
.editable{cursor:pointer;padding:4px 8px;border-radius:var(--radius-sm);transition:all .3s;display:inline-block;position:relative}
.editable:hover{background:var(--bg-tertiary);border:1px dashed var(--accent-primary);transform:scale(1.05);box-shadow:var(--shadow-sm)}
.add-holding-form{display:grid;grid-template-columns:1fr 1fr 1fr 80px;gap:12px;margin-top:24px}
.add-holding-form input,.add-holding-form select{padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;transition:all .2s}
.add-holding-form input:focus,.add-holding-form select:focus{outline:none;border-color:var(--accent-primary);background:var(--bg-input-focus)}
.add-holding-form button{background:var(--accent-primary);border:none;color:#fff;padding:10px 18px;border-radius:var(--radius-sm);font-weight:500;cursor:pointer;transition:all .2s;font-size:13px}
.add-holding-form button:hover{background:var(--accent-hover)}

/* ALERTS */
.alerts-list{display:flex;flex-direction:column;gap:10px}
.alert-row{display:grid;grid-template-columns:80px 2fr 1fr 1fr 80px;gap:16px;padding:16px 20px;background:var(--bg-tertiary);border:1px solid var(--border-secondary);border-radius:var(--radius-md);align-items:center;transition:all .2s}
.alert-row:hover{background:var(--bg-card-hover);border-color:var(--border-primary);transform:translateX(4px)}
.alert-row.triggered{background:var(--success-bg);border-color:var(--success)}
.add-alert-form{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 80px;gap:12px;margin-top:24px}
.add-alert-form select,.add-alert-form input{padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;transition:all .2s}
.add-alert-form select:focus,.add-alert-form input:focus{outline:none;border-color:var(--accent-primary);background:var(--bg-input-focus)}
.add-alert-form button{background:var(--accent-primary);border:none;color:#fff;padding:10px 18px;border-radius:var(--radius-sm);font-weight:500;cursor:pointer;transition:all .2s;font-size:13px}
.add-alert-form button:hover{background:var(--accent-hover)}

/* MODALS */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(12px);align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--bg-overlay);backdrop-filter:blur(20px);border:1px solid var(--border-primary);border-radius:var(--radius-lg);padding:32px;width:420px;max-width:90vw;box-shadow:var(--shadow-lg);animation:fadeIn .2s;transition:background-color 0.3s ease}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-size:20px;font-weight:600;color:var(--text-primary);letter-spacing:-0.3px;transition:color 0.3s ease}
.close-modal{cursor:pointer;color:var(--text-tertiary);font-size:24px;font-weight:300;transition:all .25s}
.close-modal:hover{color:var(--text-primary)}
.modal-input{margin-bottom:16px}
.modal-input label{display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500;transition:color 0.3s ease}
.modal-input input{width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;transition:all .2s}
.modal-input input:focus{outline:none;border-color:var(--accent-primary);background:var(--bg-input-focus)}
.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
.modal-btn{padding:12px 24px;border-radius:10px;font-weight:600;font-size:13px;cursor:pointer;transition:all .25s;letter-spacing:0.3px}
.modal-btn.cancel{background:transparent;border:1.5px solid var(--border-primary);color:var(--text-tertiary)}
.modal-btn.cancel:hover{background:var(--bg-card);color:var(--text-primary);border-color:var(--border-accent)}
.modal-btn.add{background:var(--accent-primary);border:none;color:#fff}
.modal-btn.add:hover{background:var(--accent-hover)}
.modal-btn.save{background:var(--success);border:none;color:#fff}
.modal-btn.save:hover{background:#16a34a}
.modal-close{background:transparent;border:none;color:var(--text-tertiary);font-size:28px;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);transition:all .25s}
.modal-close:hover{background:var(--bg-card);color:var(--text-primary)}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500;transition:color 0.3s ease}
.form-group input,.form-group select{width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;transition:all .2s}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--accent-primary);background:var(--bg-input-focus)}
.form-group input:disabled,.form-group select:disabled{opacity:.5;cursor:not-allowed}
.form-group small{display:block;margin-top:6px;font-size:11px;color:var(--text-muted);transition:color 0.3s ease}
.modal-header h3{font-size:20px;font-weight:600;color:var(--text-primary);letter-spacing:-0.3px;margin:0;transition:color 0.3s ease}

/* Sidebar Overlay for Mobile */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:85;backdrop-filter:blur(4px);transition:opacity 0.3s ease}
.sidebar-overlay.active{display:block}

.sidebar-toggle{display:none;width:40px;height:40px;background:var(--bg-card);border:1px solid var(--border-primary);border-radius:var(--radius-md);align-items:center;justify-content:center;cursor:pointer;color:var(--text-primary);font-size:20px;box-shadow:var(--shadow-sm);transition:all 0.3s ease}
.sidebar-toggle:hover{background:var(--bg-card-hover);border-color:var(--accent-primary);color:var(--accent-primary);transform:scale(1.05)}

/* Responsive Sidebar */
@media(max-width:1024px){
  .sidebar{transform:translateX(-100%);width:240px;transition:transform 0.3s ease}
  .sidebar.open{transform:translateX(0);box-shadow:var(--shadow-lg)}
  .main-content{margin-left:0!important;padding:20px 16px}
  #sidebarToggle{display:flex!important}
  .navbar{padding:0 16px}
  .sidebar-overlay.active{display:block}
}
@media(max-width:768px){
  .sidebar{width:220px}
  .main-content{padding:16px 12px}
  .hero-stat{padding:10px 12px;min-height:60px}
  .hero-stat-value{font-size:14px}
  .hero-stat-label{font-size:9px}
  .logo-title{font-size:16px}
  .logo-icon{width:36px;height:36px;min-width:36px;min-height:36px}
  .nav-right{gap:12px}
  .auth-btn{padding:8px 16px;font-size:12px}
}
@media(max-width:480px){
  .sidebar{width:200px}
  .main-content{padding:12px 8px}
  .main-section{padding:16px}
  .portfolio-summary{grid-template-columns:1fr;gap:8px}
  .holdings-list{grid-template-columns:1fr}
}

/* Responsive Styles for All Screen Sizes */

/* Ultra-wide and Large Desktop (2560px+) */
@media(min-width:2560px){
  .container{max-width:2400px;padding:64px 80px}
  .carousel-card{min-width:320px;max-width:320px;padding:24px}
  .carousel-card-value{font-size:28px}
  .carousel-card-title{font-size:12px}
  .section-title{font-size:32px}
  .token-row{padding:20px 24px;gap:32px}
  .main-section{padding:48px}
}

/* Large Desktop (1920px - 2559px) */
@media(min-width:1920px) and (max-width:2559px){
  .container{max-width:1920px;padding:48px 60px}
  .carousel-card{min-width:300px;max-width:300px;padding:22px}
  .carousel-card-value{font-size:24px}
}

/* Standard Desktop (1440px - 1919px) */
@media(min-width:1440px) and (max-width:1919px){
  .container{max-width:1440px;padding:40px 48px}
  .carousel-card{min-width:280px;max-width:280px}
  .main-section{padding:32px}
}

/* Medium Desktop / Large Laptop (1280px - 1439px) */
@media(min-width:1280px) and (max-width:1439px){
  .container{max-width:1280px;padding:36px 40px}
  .carousel-card{min-width:260px;max-width:260px;padding:18px}
  .carousel-card-value{font-size:22px}
  .main-section{padding:28px}
}

/* Small Desktop / Laptop (1024px - 1279px) */
@media(min-width:1024px) and (max-width:1279px){
  .container{max-width:1024px;padding:32px 36px}
  .carousel-card{min-width:240px;max-width:240px;padding:16px}
  .carousel-card-value{font-size:20px}
  .main-section{padding:24px}
  .token-row{grid-template-columns:60px 2fr 1fr 1fr 1fr;gap:20px;padding:14px 18px}
}

/* Tablet Landscape (768px - 1023px) */
@media(min-width:768px) and (max-width:1023px){
  .container{max-width:100%;padding:24px 20px}
  .content-grid{grid-template-columns:1fr;gap:20px}
  .hero-carousel-wrapper{padding:0 40px;margin-bottom:24px}
  .carousel-card{min-width:240px;max-width:240px;padding:16px}
  .carousel-card-value{font-size:20px}
  .carousel-card-title{font-size:11px}
  .carousel-nav{width:36px;height:36px;font-size:18px}
  .main-section{padding:24px}
  .token-row{grid-template-columns:50px 1.5fr 1fr 1fr;gap:12px;padding:16px}
  .token-mcap-col{display:none}
  .table-header{grid-template-columns:50px 1.5fr 1fr 1fr;gap:12px;padding:12px 16px}
  .table-header-cell:last-child{display:none}
  .token-icon{width:40px;height:40px}
  .token-name-col h3{font-size:14px}
  .token-price-col{font-size:15px}
  .change-badge{padding:4px 10px;font-size:12px}
  .section-header{flex-direction:column;align-items:flex-start;gap:16px;margin-bottom:24px}
  .filter-tabs{flex-wrap:wrap;width:100%}
  .filter-tab{padding:8px 16px;font-size:12px}
  .user-tabs{flex-wrap:wrap;gap:8px}
  .user-tab{padding:10px 16px;font-size:12px}
  .portfolio-summary{grid-template-columns:1fr;gap:12px}
  .holdings-list{grid-template-columns:1fr;gap:10px}
  .holding-row{padding:14px;gap:10px}
  .holding-stats{grid-template-columns:repeat(2,1fr);gap:8px}
  .holding-stat-value{font-size:12px}
  .add-holding-form{grid-template-columns:1fr;gap:10px}
  .add-alert-form{grid-template-columns:1fr;gap:10px}
  .modal-content{width:95vw;max-width:500px;padding:24px}
  .admin-controls{flex-wrap:wrap;padding:12px 16px}
  .admin-btn{padding:8px 16px;font-size:12px}
}
@media(max-width:768px){
  .navbar{padding:12px 16px}
  .logo-icon{width:36px;height:36px;min-width:36px;min-height:36px}
  .logo-icon img{max-width:36px;max-height:36px}
  .logo-title{font-size:16px}
  .logo-subtitle{font-size:10px}
  .nav-right{gap:8px}
  .live-indicator{padding:6px 12px}
  .live-text{font-size:11px}
  .time-display{font-size:12px;display:none}
  .container{padding:16px 12px}
  .hero-carousel-wrapper{padding:0 32px;margin-bottom:20px}
  .carousel-card{min-width:220px;max-width:220px;padding:14px}
  .carousel-card-value{font-size:18px}
  .carousel-card-title{font-size:10px}
  .carousel-card-subtitle{font-size:10px}
  .carousel-nav{width:32px;height:32px;font-size:16px;right:4px}
  .content-grid{gap:16px}
  .main-section{padding:20px 16px;border-radius:16px}
  .section-title{font-size:22px}
  .token-row{grid-template-columns:40px 1.5fr 1fr;gap:8px;padding:12px;border-radius:12px}
  .token-icon{width:36px;height:36px}
  .token-name-col h3{font-size:13px;margin-bottom:2px}
  .token-symbol{font-size:11px}
  .token-price-col{font-size:14px}
  .token-change-col{display:none}
  .table-header{grid-template-columns:40px 1.5fr 1fr;gap:8px;padding:10px 12px}
  .table-header-cell:nth-child(4),.table-header-cell:nth-child(5){display:none}
  .filter-tabs{padding:4px;gap:4px}
  .filter-tab{padding:8px 12px;font-size:11px;letter-spacing:0.5px}
  .user-tabs{gap:6px;margin-bottom:20px}
  .user-tab{padding:10px 14px;font-size:11px}
  .portfolio-summary{grid-template-columns:1fr;gap:10px;margin-bottom:24px}
  .summary-card{padding:16px}
  .summary-value{font-size:20px}
  .holdings-list{grid-template-columns:1fr;gap:10px}
  .holding-row{padding:14px;gap:10px}
  .holding-header{gap:10px;padding-bottom:10px}
  .holding-icon-wrapper{width:40px;height:40px}
  .holding-name{font-size:14px}
  .holding-stats{grid-template-columns:repeat(2,1fr);gap:8px}
  .holding-stat-value{font-size:12px}
  .holding-actions{flex-direction:row;gap:6px;padding-top:10px}
  .edit-btn,.delete-btn{padding:8px 12px;font-size:11px}
  .add-holding-form{grid-template-columns:1fr;gap:8px;margin-top:20px}
  .add-alert-form{grid-template-columns:1fr;gap:8px;margin-top:20px}
  .modal-content{width:95vw;padding:20px;border-radius:16px}
  .modal-header{padding:20px;border-radius:16px 16px 0 0}
  .modal-title{font-size:18px}
  .modal-input input{padding:12px 14px;font-size:14px}
  .modal-btn{padding:10px 20px;font-size:12px}
  .admin-controls{flex-direction:column;align-items:stretch;gap:8px;padding:12px}
  .admin-btn{width:100%;justify-content:center}
  .sidebar-card{padding:20px;border-radius:14px}
  .quotes-list,.top-gainers-list{gap:8px}
  .quote-item,.gainer-item{padding:12px;border-radius:10px}
  .settings-panel{gap:12px}
  .setting-item{flex-direction:column;align-items:flex-start;gap:8px}
  .alert-row{grid-template-columns:40px 1fr 1fr 60px;gap:10px;padding:14px;font-size:12px}
  .alert-row>div:nth-child(3){display:none}
  #portfolioAnalytics{padding:20px}
  #analyticsGrid{grid-template-columns:1fr!important;gap:20px}
  #portfolioAnalytics>div:first-child{flex-direction:column;align-items:flex-start;gap:12px}
  #allocationChart{max-width:100%!important;height:auto!important}
  #tokenOfTheDay{padding:20px}
  #todStatsGrid{grid-template-columns:1fr!important;gap:12px}
}
/* Mobile Portrait (320px - 479px) */
@media(max-width:479px){
  .navbar{padding:10px 12px}
  .logo-icon{width:32px;height:32px;min-width:32px;min-height:32px}
  .logo-icon img{max-width:32px;max-height:32px}
  .logo-title{font-size:14px}
  .auth-btn{padding:6px 12px;font-size:11px}
  .container{padding:12px 8px}
  .hero-carousel-wrapper{padding:0 24px;margin-bottom:16px}
  .carousel-card{min-width:200px;max-width:200px;padding:12px}
  .carousel-card-value{font-size:16px}
  .carousel-card-title{font-size:9px}
  .carousel-card-subtitle{font-size:9px}
  .carousel-nav{width:28px;height:28px;font-size:14px;right:2px}
  .main-section{padding:16px 12px}
  .section-title{font-size:18px}
  .token-row{grid-template-columns:36px 1fr 1fr;padding:10px;gap:6px}
  .token-icon{width:32px;height:32px}
  .token-name-col h3{font-size:12px}
  .token-price-col{font-size:13px}
  .filter-tab{padding:6px 10px;font-size:10px}
  .user-tab{padding:8px 12px;font-size:10px}
  .holdings-list{grid-template-columns:1fr;gap:8px}
  .holding-row{padding:12px;gap:8px}
  .holding-header{gap:8px;padding-bottom:8px}
  .holding-icon-wrapper{width:36px;height:36px}
  .holding-name{font-size:13px}
  .holding-stats{grid-template-columns:repeat(2,1fr);gap:6px}
  .holding-stat-value{font-size:11px}
  .holding-actions{flex-direction:row;gap:4px;padding-top:8px}
  .edit-btn,.delete-btn{padding:6px 10px;font-size:10px}
  .modal-content{width:98vw;padding:16px}
  .modal-header{padding:16px}
  .modal-title{font-size:16px}
  .sidebar-card{padding:16px}
  .quote-item,.gainer-item{padding:10px}
  #portfolioAnalytics{padding:16px}
  #portfolioAnalytics>div:first-child{margin-bottom:16px}
  #allocationChart{width:100%!important;height:auto!important}
  #tokenOfTheDay{padding:16px}
  #tokenOfTheDay>div:first-child{flex-direction:column;gap:12px;margin-bottom:12px}
  #todTokenIcon{width:48px!important;height:48px!important}
  #etfDataMain{margin-bottom:24px}
  #etfCarousel,#activityCarousel{overflow-x:auto;scroll-snap-type:x mandatory}
  #etfCarousel .carousel-card,#activityCarousel .carousel-card{scroll-snap-align:start}
}

/* Very Small Mobile (max-width: 360px) */
@media(max-width:360px){
  .container{padding:10px 6px}
  .navbar{padding:8px 10px}
  .logo-title{font-size:12px}
  .logo-subtitle{font-size:9px}
  .auth-btn{padding:5px 10px;font-size:10px}
  .hero-carousel-wrapper{padding:0 20px}
  .carousel-card{min-width:180px;max-width:180px;padding:10px}
  .carousel-card-value{font-size:14px}
  .carousel-card-title{font-size:8px}
  .main-section{padding:12px 8px}
  .section-title{font-size:16px}
  .token-row{grid-template-columns:32px 1fr 1fr;padding:8px;gap:4px}
  .token-icon{width:28px;height:28px}
  .token-name-col h3{font-size:11px}
  .token-price-col{font-size:12px}
  .filter-tab{padding:5px 8px;font-size:9px}
  .user-tab{padding:6px 10px;font-size:9px}
  .modal-content{width:100vw;padding:12px;border-radius:12px}
  .modal-title{font-size:14px}
}
/* Landscape Orientation Optimizations */
@media(orientation:landscape) and (max-height:600px){
  .navbar{padding:8px 16px}
  .hero-carousel-wrapper{padding:0 24px;margin-bottom:16px}
  .carousel-card{min-width:180px;max-width:180px;padding:10px}
  .carousel-card-value{font-size:14px}
  .container{padding:16px 20px}
  .main-section{padding:20px 16px}
  .section-title{font-size:20px}
  .token-row{padding:12px 16px}
  .portfolio-summary{grid-template-columns:repeat(3,1fr);gap:12px}
}

/* High DPI / Retina Displays */
@media(-webkit-min-device-pixel-ratio:2),(min-resolution:192dpi){
  .token-icon,.logo-icon img{border-width:1.5px}
  .carousel-card{border-width:0.5px}
}

/* Print Styles */
@media print{
  .navbar,.admin-controls,.carousel-nav,.filter-tabs,.user-tabs{display:none}
  .container{max-width:100%;padding:20px}
  .main-section{box-shadow:none;border:none}
  .token-row,.holding-row{page-break-inside:avoid}
}
/* Touch-friendly improvements for mobile devices */
@media(hover:none) and (pointer:coarse){
  .auth-btn,.admin-btn,.modal-btn,.filter-tab,.user-tab{min-height:44px;min-width:44px}
  .edit-btn,.delete-btn{min-height:40px;min-width:40px;padding:10px 14px}
  .carousel-card:hover{transform:none}
  .token-row:hover{transform:none}
  .quote-item:hover,.gainer-item:hover{transform:none}
  .holding-row:hover{transform:none}
  button,select,input[type="text"],input[type="number"],input[type="email"],input[type="password"]{font-size:16px}
}

/* Prevent text size adjustment on iOS */
@media screen and (max-width:768px){
  input,select,textarea{font-size:16px!important}
  button{font-size:16px!important}
}

/* Smooth scrolling for all devices */
html{scroll-behavior:smooth}
body{overflow-x:hidden}

/* Ensure proper box-sizing */
*,*::before,*::after{box-sizing:border-box}

/* Improve carousel responsiveness and centering */
.hero-carousel-wrapper{width:100%;overflow:hidden;position:relative;display:flex;justify-content:center;align-items:center}
.carousel{width:100%;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;display:flex;justify-content:flex-start;align-items:center}
.carousel-card{flex-shrink:0}
/* Center carousel when content fits in viewport (handled by JavaScript) */
.carousel.centered{justify-content:center}

/* Responsive ETF and Activity carousels */
#etfCarousel,#activityCarousel{width:100%;overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
#etfCarousel .carousel-card,#activityCarousel .carousel-card{flex-shrink:0}

/* Responsive quotes section */
#quotesSection{width:100%;max-width:100%;overflow:hidden}

/* ETF Two-Column Layout Responsive */
#etfDataMainContent > div:first-of-type{display:grid;grid-template-columns:1fr 1fr;gap:20px}
@media(max-width:768px){
  #etfDataMainContent > div:first-of-type{grid-template-columns:1fr!important}
}
</style>
</head>
<body>

<div class="grain-overlay"></div>

<nav class="navbar">
  <div class="logo-section">
    <div class="logo-icon"><img src="https://ta3bviqjtxy1kv7x.public.blob.vercel-storage.com/sticker.webp" alt="Logo"></div>
    <div class="logo-text">
      <div class="logo-title">CRYPTO COLLECTIVE X</div>
      <div class="logo-subtitle"></div>
    </div>
  </div>

  <div class="nav-right">
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar" title="Toggle menu">
      <span>‚ò∞</span>
    </button>
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme" title="Theme toggle">
      <span id="themeIcon">üåô</span>
    </button>
    <div class="live-indicator"><div class="live-dot"></div><div class="live-text">live</div></div>
    <div class="time-display" id="navTime">--:--:--</div>

    <div id="authContainer">
      <div class="auth-buttons">
        <button class="auth-btn" id="loginBtn">·É®·Éî·É°·Éï·Éö·Éê</button>
        <button class="auth-btn primary" id="registerBtn">·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éê</button>
      </div>
    </div>

    <div id="userContainer" class="user-menu" style="display:none;">
      <img id="userAvatar" class="user-avatar" src="" alt="·Éê·Éï·Éê·É¢·Éê·É†·Éò">
      <span id="userName" class="user-name"></span>
      <button class="auth-btn" id="logoutBtn">·Éí·Éê·É°·Éï·Éö·Éê</button>
    </div>

    <div id="adminControls" class="admin-controls" style="display:none;gap:12px;align-items:center;padding:14px 24px;background:rgba(15,20,30,.6);border:1px solid rgba(255,255,255,.12);border-radius:14px;backdrop-filter:blur(16px) saturate(180%);box-shadow:0 4px 16px rgba(0,0,0,.2);">
      <div style="display:flex;align-items:center;gap:10px;padding-right:16px;border-right:1px solid rgba(255,255,255,.1);">
        <span style="font-size:16px;opacity:0.9;">üëë</span>
        <span style="font-size:11px;font-weight:600;color:#9aa0a6;text-transform:uppercase;letter-spacing:0.8px;">·Éê·Éì·Éõ·Éò·Éú·Éò</span>
    </div>
      <button class="admin-btn" id="addTokenBtn" style="padding:10px 20px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;color:#fff;font-size:13px;font-weight:600;border-radius:10px;cursor:pointer;transition:all .25s;box-shadow:0 2px 8px rgba(139,92,246,.25);letter-spacing:0.3px;">‚ûï ·É¢·Éù·Éô·Éî·Éú·Éò·É° ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê</button>
      <button class="admin-btn" id="refreshBtn" style="padding:10px 20px;background:rgba(52,168,83,.12);border:1.5px solid rgba(52,168,83,.25);color:#34a853;font-size:13px;font-weight:600;border-radius:10px;cursor:pointer;transition:all .25s;letter-spacing:0.3px;">üîÑ ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê</button>
    </div>
    
  </div>
</nav>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Sidebar Menu -->
<aside class="sidebar" id="sidebar">
  <nav class="sidebar-menu">
    <a href="/" class="sidebar-item active">
      <span class="sidebar-icon">üìä</span>
      <span class="sidebar-text">·Éë·Éê·Éñ·Éê·É†·Éò</span>
    </a>
    <a href="/portfolio.html" class="sidebar-item">
      <span class="sidebar-icon">üíº</span>
      <span class="sidebar-text">·Éû·Éù·É†·É¢·É§·Éù·Éö·Éò·Éù</span>
    </a>
    <a href="/targets.html" class="sidebar-item">
      <span class="sidebar-icon">üéØ</span>
      <span class="sidebar-text">·Éí·Éê·É°·Éê·Éß·Éò·Éì·Éò ·Éõ·Éò·Éñ·Éú·Éî·Éë·Éò</span>
    </a>
    <a href="/alerts.html" class="sidebar-item">
      <span class="sidebar-icon">üîî</span>
      <span class="sidebar-text">·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éî·Éë·Éò</span>
    </a>
    <a href="/profile.html" class="sidebar-item">
      <span class="sidebar-icon">üë§</span>
      <span class="sidebar-text">·Éû·É†·Éù·É§·Éò·Éö·Éò</span>
    </a>
  </nav>
</aside>

<div class="main-content">
  <div class="container">
    <div id="loading" class="loading"><div class="spinner"></div><div class="loading-text">·Éë·Éê·Éñ·É†·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê...</div></div>
    <div id="error"></div>

    <div class="hero-carousel-wrapper" id="heroStats" style="display:none;margin-bottom:24px;">
      <div class="carousel" id="heroCarousel">
        <!-- Cards will be rendered here -->
      </div>
      <button class="carousel-nav carousel-nav-right" id="carouselNext" aria-label="Next cards">‚Üí</button>
    </div>

    <!-- Quotes Section -->
    <div id="quotesSection" style="display:none;margin-bottom:24px;background:var(--bg-card);backdrop-filter:var(--blur);border:1px solid var(--border-secondary);border-radius:var(--radius-lg);padding:16px;position:relative;overflow:hidden;transition:background-color 0.3s ease, border-color 0.3s ease;" role="region" aria-label="Quotes">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div class="carousel-card-title" style="margin:0;">üí¨ ·É™·Éò·É¢·Éê·É¢·Éê</div>
        <button id="refreshQuote" style="background:transparent;border:1px solid var(--border-primary);color:var(--text-tertiary);padding:6px 12px;border-radius:var(--radius-sm);font-size:11px;cursor:pointer;transition:all .2s;" onmouseover="this.style.borderColor='var(--accent-primary)';this.style.color='var(--accent-primary)';" onmouseout="this.style.borderColor='var(--border-primary)';this.style.color='var(--text-tertiary)';">üîÑ</button>
      </div>
      <div id="quoteContent" style="font-size:14px;color:var(--text-primary);font-weight:500;line-height:1.6;font-style:italic;transition:color 0.3s ease;">
        <div style="color:var(--text-muted);font-size:13px;">·É™·Éò·É¢·Éê·É¢·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê...</div>
      </div>
      <div id="quoteAuthor" style="margin-top:12px;font-size:12px;color:var(--text-tertiary);text-align:right;font-weight:500;transition:color 0.3s ease;">
      </div>
    </div>

    <!-- Recent Activity Carousel -->
    <div class="hero-carousel-wrapper" id="activityCarouselWrapper" style="display:none;margin-bottom:24px;">
      <div class="carousel" id="activityCarousel">
        <!-- Activity cards will be rendered here -->
      </div>
      <button class="carousel-nav carousel-nav-right" id="activityCarouselNext" aria-label="Next cards">‚Üí</button>
    </div>

    <div class="content-grid" id="contentGrid" style="display:none;">
      <div class="main-section" style="width:100%;">
        <div class="section-header">
          <div class="section-title">·Éë·Éê·Éñ·É†·Éò·É° ·Éõ·Éò·Éõ·Éù·ÉÆ·Éò·Éö·Éï·Éê</div>
          <div class="filter-tabs">
            <button class="filter-tab" onclick="sortBy('name')" id="sortName">·É°·Éê·ÉÆ·Éî·Éö·Éò</button>
            <button class="filter-tab" onclick="sortBy('price')" id="sortPrice">·É§·Éê·É°·Éò</button>
            <button class="filter-tab active" onclick="sortBy('change')" id="sortChange">24·É°·Éó</button>
            <button class="filter-tab" onclick="sortBy('mcap')" id="sortMcap">·Éô·Éê·Éû·Éò·É¢·Éê·Éö·Éò·Éñ·Éê·É™·Éò·Éê</button>
          </div>
        </div>

        <div class="table-header">
          <div class="table-header-cell">#</div>
          <div class="table-header-cell">·Éê·É•·É¢·Éò·Éï·Éò</div>
          <div class="table-header-cell">·É§·Éê·É°·Éò</div>
          <div class="table-header-cell">24·É°·Éó ·É™·Éï·Éö·Éò·Éö·Éî·Éë·Éê</div>
          <div class="table-header-cell">·É°·Éê·Éë·Éê·Éñ·É†·Éù ·Éô·Éê·Éû·Éò·É¢·Éê·Éö·Éò·Éñ·Éê·É™·Éò·Éê</div>
        </div>

        <div class="tokens-list" id="tokensList"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modals and other shared components -->
<div id="addTokenModal" class="modal">
  <div class="modal-content" style="max-width:600px;width:90vw;">
    <div class="modal-header" style="background:rgba(15,20,30,.95);backdrop-filter:blur(24px) saturate(180%);padding:24px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,.08);">
      <div class="modal-title" style="font-size:20px;font-weight:600;color:#e8eaed;letter-spacing:-0.3px;">üîç ·Éô·É†·Éò·Éû·É¢·Éù ·É¢·Éù·Éô·Éî·Éú·Éò·É° ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê</div>
      <span class="close-modal" id="closeModal" style="color:#9aa0a6;font-size:28px;cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:transparent;transition:all .25s;">√ó</span>
    </div>
    <div style="padding:28px;background:rgba(15,20,30,.95);backdrop-filter:blur(24px) saturate(180%);">
      <div class="modal-input" style="margin-bottom:20px;">
        <label style="display:block;font-size:12px;font-weight:500;color:#9aa0a6;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.8px;">·É¢·Éù·Éô·Éî·Éú·Éò·É° ·É´·Éò·Éî·Éë·Éê</label>
        <div style="position:relative;">
          <input type="text" id="tokenSearch" placeholder="·É©·Éê·É¨·Éî·É†·Éî·Éó ·É´·Éò·Éî·Éë·Éò·É°·Éó·Éï·Éò·É° (·Éõ·Éê·Éí. bitcoin, ethereum, solana)..." 
            style="width:100%;padding:14px 18px;background:rgba(10,14,26,.6);border:1.5px solid rgba(255,255,255,.1);border-radius:12px;color:#e8eaed;font-size:14px;transition:all .25s;backdrop-filter:blur(10px);"
            autocomplete="off">
          <div id="tokenSearchResults" style="position:absolute;top:100%;left:0;right:0;margin-top:8px;background:rgba(15,20,30,.98);backdrop-filter:blur(24px) saturate(180%);border:1px solid rgba(255,255,255,.12);border-radius:12px;max-height:300px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 12px 40px rgba(0,0,0,.5);"></div>
    </div>
        <div id="selectedToken" style="margin-top:16px;padding:16px;background:rgba(139,92,246,.1);border:1.5px solid rgba(139,92,246,.25);border-radius:12px;display:none;backdrop-filter:blur(10px);">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-weight:600;color:#e8eaed;font-size:15px;letter-spacing:-0.2px;" id="selectedTokenName"></div>
              <div style="font-size:12px;color:#9aa0a6;margin-top:4px;font-weight:400;" id="selectedTokenId"></div>
            </div>
            <button id="clearSelection" style="padding:8px 14px;background:rgba(234,67,53,.12);border:1.5px solid rgba(234,67,53,.25);color:#ea4335;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;transition:all .25s;letter-spacing:0.2px;">·Éí·Éê·É°·É£·É§·Éó·Éê·Éï·Éî·Éë·Éê</button>
          </div>
        </div>
      </div>
      <div class="modal-actions" style="display:flex;gap:12px;justify-content:flex-end;">
        <button class="modal-btn cancel" id="cancelAdd" style="padding:12px 24px;background:transparent;border:1.5px solid rgba(255,255,255,.15);color:#9aa0a6;border-radius:10px;cursor:pointer;font-weight:600;transition:all .25s;letter-spacing:0.3px;">·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê</button>
        <button class="modal-btn add" id="confirmAdd" style="padding:12px 24px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;color:#fff;border-radius:10px;cursor:pointer;font-weight:600;transition:all .25s;box-shadow:0 2px 8px rgba(139,92,246,.25);letter-spacing:0.3px;" disabled>·É¢·Éù·Éô·Éî·Éú·Éò·É° ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê</button>
      </div>
      <div id="addTokenStatus" style="margin-top:16px;padding:14px;border-radius:10px;display:none;font-size:13px;font-weight:500;backdrop-filter:blur(10px);"></div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebase config - Complete web app configuration
const firebaseConfig = { 
  apiKey: "AIzaSyARWG4t3i_pCpu-pOZPqauRufMQhZaI14U",
  authDomain: "ccx-dashboard.firebaseapp.com",
  databaseURL: "https://ccx-dashboard-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ccx-dashboard",
  storageBucket: "ccx-dashboard.firebasestorage.app",
  messagingSenderId: "413950601775",
  appId: "1:413950601775:web:53ca78e202ef7ec884b4da"
};
// Initialize Firebase app
let app;
try {
  app = firebase.initializeApp(firebaseConfig);
} catch (e) {
  // App already initialized
  app = firebase.app();
}
const auth = firebase.auth();

/* ---------- GLOBALS ---------- */
let cryptoData = [], prices = {}, globalData = null, fearGreedData = null, etfFlowsData = null;
let sortColumn = 'change', sortDirection = 'desc';
let currentUser = null;
let sellTargets = {}; // Initialize early to prevent "before initialization" errors
let portfolioHoldings = {}; // Store portfolio holdings for buy price calculation

/* ---------- HELPERS ---------- */
function $(id){return document.getElementById(id);}
function formatPrice(p){return p>=1000?p.toLocaleString('en-US',{maximumFractionDigits:0}):p>=1?p.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):p>=.01?p.toFixed(4):p.toFixed(6);}
function formatMarketCap(m){return m>=1e12?`${(m/1e12).toFixed(2)}T`:m>=1e9?`${(m/1e9).toFixed(2)}B`:m>=1e6?`${(m/1e6).toFixed(2)}M`:m.toLocaleString();}
function updateTime(){$('navTime').textContent=new Date().toLocaleTimeString('en-US',{hour12:false});}
updateTime();setInterval(updateTime,1000);

/* ---------- AUTH (same as before) ---------- */
$('loginBtn').onclick = () => authModal('login');
$('registerBtn').onclick = () => authModal('register');
$('logoutBtn').onclick = () => auth.signOut();

function authModal(mode){
  const email = prompt(`·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî·Éó ·Éî·Éö·É§·Éù·É°·É¢·Éê:`);
  if(!email) return;
  const password = prompt('·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî·Éó ·Éû·Éê·É†·Éù·Éö·Éò:');
  if(!password) return;
  
  // Ensure Firebase Auth is initialized
  if (!auth) {
    try {
      auth = firebase.auth();
    } catch (e) {
      console.error('Firebase Auth initialization error:', e);
      alert('·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éò·É° ·É°·Éî·É†·Éï·Éò·É°·Éò ·Éõ·Éò·É£·É¨·Éï·Éì·Éù·Éõ·Éî·Éö·Éò·Éê. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éù·Éó ·Éí·Éï·Éî·É†·Éì·Éò.');
      return;
    }
  }
  
  const authMethod = mode === 'login' ? auth.signInWithEmailAndPassword : auth.createUserWithEmailAndPassword;
  
  authMethod.call(auth, email, password)
    .then(() => {
      if(mode === 'register') {
        alert('·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éê ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·É£·Éö·Éò·Éê! ·Éê·ÉÆ·Éö·Éê ·É®·Éî·ÉÆ·Éï·Éî·Éì·Éò·Éó ·É°·Éò·É°·É¢·Éî·Éõ·Éê·É®·Éò.');
      }
    })
    .catch(e => {
      console.error('Auth error:', e);
      let errorMsg = e.message;
      // Provide more helpful error messages
      if(e.code === 'auth/email-already-in-use') {
        errorMsg = '·Éî·É° ·Éî·Éö·É§·Éù·É°·É¢·Éê ·É£·Éô·Éï·Éî ·É†·Éî·Éí·Éò·É°·É¢·É†·Éò·É†·Éî·Éë·É£·Éö·Éò·Éê. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·ÉÆ·Éï·Éò·Éì·Éî·Éó.';
      } else if(e.code === 'auth/weak-password') {
        errorMsg = '·Éû·Éê·É†·Éù·Éö·Éò ·É´·Éê·Éö·Éò·Éê·Éú ·É°·É£·É°·É¢·Éò·Éê. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éù·Éó ·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù.';
      } else if(e.code === 'auth/invalid-email') {
        errorMsg = '·Éê·É†·Éê·É°·É¨·Éù·É†·Éò ·Éî·Éö·É§·Éù·É°·É¢·Éò·É° ·Éõ·Éò·É°·Éê·Éõ·Éê·É†·Éó·Éò. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éù·Éó ·Éì·Éê ·É°·É™·Éê·Éì·Éù·Éó ·Éó·Éê·Éï·Éò·Éì·Éê·Éú.';
      } else if(e.code === 'auth/user-not-found') {
        errorMsg = '·Éê·Éõ ·Éî·Éö·É§·Éù·É°·É¢·Éò·Éó ·Éê·Éú·Éí·Éê·É†·Éò·É®·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·ÉØ·Éî·É† ·Éì·Éê·É†·Éî·Éí·Éò·É°·É¢·É†·Éò·É†·Éì·Éî·Éó.';
      } else if(e.code === 'auth/wrong-password') {
        errorMsg = '·Éê·É†·Éê·É°·É¨·Éù·É†·Éò ·Éû·Éê·É†·Éù·Éö·Éò. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É°·É™·Éê·Éì·Éù·Éó ·Éó·Éê·Éï·Éò·Éì·Éê·Éú.';
      } else if(e.message && e.message.includes('_delegate')) {
        errorMsg = '·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éò·É° ·É°·Éî·É†·Éï·Éò·É°·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éù·Éó ·Éí·Éï·Éî·É†·Éì·Éò ·Éì·Éê ·É°·É™·Éê·Éì·Éù·Éó ·Éó·Éê·Éï·Éò·Éì·Éê·Éú.';
      }
      alert(errorMsg);
    });
}

// Firebase real-time listener for tokens (auto-update when tokens are added/removed)
let tokensListener = null;
let initialTokensLoaded = false;

function setupTokensListener() {
  // Remove existing listener if any
  if (tokensListener) {
    const db = firebase.database();
    db.ref('tokens').off('value', tokensListener);
  }
  
  const db = firebase.database();
  const tokensRef = db.ref('tokens');
  
  tokensListener = tokensRef.on('value', (snapshot) => {
    const tokens = snapshot.val() || {};
    const tokenCount = Object.keys(tokens).length;
    console.log(`üîÑ Tokens updated in Firebase: ${tokenCount} tokens detected`);
    
    // On first load, just mark as loaded (don't refresh yet)
    if (!initialTokensLoaded) {
      initialTokensLoaded = true;
      console.log('Initial tokens loaded, waiting for changes...');
      return;
    }
    
    // Auto-refresh when tokens change (added or removed)
    if (tokenCount > 0) {
      console.log('‚ú® Auto-refreshing market data due to token changes...');
      // Debounce: wait 1.5 seconds before refreshing to avoid multiple rapid updates
      clearTimeout(window.tokenRefreshTimeout);
      window.tokenRefreshTimeout = setTimeout(() => {
        fetchAll();
      }, 1500);
    } else if (tokenCount === 0 && cryptoData.length > 0) {
      // If all tokens were removed, clear the display
      console.log('All tokens removed, clearing display...');
      cryptoData = [];
      renderAll();
    }
  }, (error) => {
    console.error('Error listening to tokens:', error);
  });
  
  console.log('‚úÖ Tokens listener set up - will auto-update when tokens are added/removed');
}

// Set up tokens listener immediately (works for both logged in and logged out users)
// This ensures tokens auto-update when admin adds them from admin.html
setTimeout(() => {
  setupTokensListener();
}, 1000); // Wait 1 second for Firebase to fully initialize

auth.onAuthStateChanged(user=>{
  currentUser = user;
  if(user){
    $('authContainer').style.display='none';
    $('userContainer').style.display='flex';
    $('userName').textContent = user.email.split('@')[0];
    $('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=8b5cf6&color=fff&size=64`;
    $('userTabs').style.display='flex';
    if(user.email === 'testireba5@gmail.com') $('adminControls').classList.add('show');
    
    // Load user data when authenticated
    // Wait a bit to ensure Firebase is fully initialized
    setTimeout(() => {
      loadPortfolio();
      loadAlerts();
    }, 500);
  }else{
    $('authContainer').style.display='flex';
    $('userContainer').style.display='none';
    $('userTabs').style.display='none';
    $('adminControls').style.display='none';
  }
});

/* ---------- USER TABS (same as before) ---------- */
document.querySelectorAll('.user-tab').forEach(tab=>{
  tab.onclick = () => {
    document.querySelectorAll('.user-tab,.user-content').forEach(el=>el.classList.remove('active'));
    tab.classList.add('active');
    $(tab.dataset.tab + 'Content').classList.add('active');
  };
});

/* ---------- RENDER FUNCTIONS ---------- */
function renderAll() {
  renderHeroStats();
  renderTokens();
  if (cryptoData && cryptoData.length > 0) {
    loadETFData();
    renderRecentActivity();
  }
  populateTokenSelect('holdingToken');
  populateTokenSelect('alertToken');
}

// Crypto ETF Data from SoSoValue
let etfDataCache = null;
async function loadETFData() {
  const etfList = $('etfDataList');
  if (!etfList) {
    console.warn('etfDataList element not found');
    return;
  }
  
  try {
    const res = await fetch('/api/etf-data');
    const data = await res.json();
    
    if (!res.ok || !data.success) {
      etfList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">ETF ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éõ·Éò·É£·É¨·Éï·Éì·Éù·Éõ·Éî·Éö·Éò·Éê</div>';
      return;
    }
    
    etfDataCache = data;
    renderETFData(data);
  } catch (error) {
    console.error('Error loading ETF data:', error);
    etfList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">ETF ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê</div>';
  }
}

function renderETFData(data) {
  const etfList = $('etfDataList');
  if (!etfList) return;
  
  const formatFlow = (value) => {
    if (!value && value !== 0) return 'N/A';
    const abs = Math.abs(value);
    if (abs >= 1000000000) return `${value >= 0 ? '+' : ''}$${(value / 1000000000).toFixed(2)}B`;
    if (abs >= 1000000) return `${value >= 0 ? '+' : ''}$${(value / 1000000).toFixed(2)}M`;
    return `${value >= 0 ? '+' : ''}$${value.toFixed(0)}`;
  };
  
  const formatAUM = (value) => {
    if (!value && value !== 0) return 'N/A';
    const abs = Math.abs(value);
    if (abs >= 1000000000) return `$${(value / 1000000000).toFixed(2)}B`;
    if (abs >= 1000000) return `$${(value / 1000000).toFixed(2)}M`;
    return `$${value.toFixed(0)}`;
  };
  
  // Extract BTC and ETH ETF data - handle various response formats
  let btcData = data.btc || data.data?.btc || null;
  let ethData = data.eth || data.data?.eth || null;
  
  // If data is nested differently, try to extract it
  if (!btcData && data.data && typeof data.data === 'object') {
    // Check if data.data is an array or object with BTC/ETH keys
    if (Array.isArray(data.data)) {
      btcData = data.data.find(item => item.symbol === 'BTC' || item.name?.toLowerCase().includes('bitcoin'));
      ethData = data.data.find(item => item.symbol === 'ETH' || item.name?.toLowerCase().includes('ethereum'));
    } else if (data.data.bitcoin) {
      btcData = data.data.bitcoin;
    } else if (data.data.ethereum) {
      ethData = data.data.ethereum;
    }
  }
  
  let html = '';
  
  // Bitcoin ETF - using SoSoValue API format
  if (btcData) {
    // Extract data from SoSoValue API response structure
    const dailyNetInflow = btcData.dailyNetInflow?.value || 0;
    const dailyNetInflowDate = btcData.dailyNetInflow?.lastUpdateDate || null;
    const totalNetAssets = btcData.totalNetAssets?.value || 0;
    const totalNetAssetsDate = btcData.totalNetAssets?.lastUpdateDate || null;
    const totalNetAssetsPercentage = btcData.totalNetAssetsPercentage?.value || 0;
    const cumNetInflow = btcData.cumNetInflow?.value || 0;
    const cumNetInflowDate = btcData.cumNetInflow?.lastUpdateDate || null;
    const totalTokenHoldings = btcData.totalTokenHoldings?.value || 0;
    const totalTokenHoldingsDate = btcData.totalTokenHoldings?.lastUpdateDate || null;
    const dailyTotalValueTraded = btcData.dailyTotalValueTraded?.value || 0;
    const dailyTotalValueTradedDate = btcData.dailyTotalValueTraded?.lastUpdateDate || null;
    const flowColor = dailyNetInflow >= 0 ? '#22c55e' : '#ef4444';
    
    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ka-GE', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch {
        return dateStr;
      }
    };
    
    html += `
      <div class="etf-item" style="padding:14px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:10px;margin-bottom:10px;transition:all .25s;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.05);">
          <span style="font-size:18px;">‚Çø</span>
          <span style="font-weight:600;font-size:14px;color:#e8eaed;">Bitcoin ETF</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·É¨·Éõ·Éò·Éú·Éì·Éê ·É®·Éî·Éõ·Éù·Éì·Éò·Éú·Éî·Éë·Éê (·Éì·É¶·Éî·É°)</div>
            <div style="font-size:15px;font-weight:600;color:${flowColor};margin-bottom:2px;">${formatFlow(dailyNetInflow)}</div>
            ${dailyNetInflowDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(dailyNetInflowDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·Éô·É£·Éõ·É£·Éö·Éê·É™·Éò·É£·É†·Éò ·É®·Éî·Éõ·Éù·Éì·Éò·Éú·Éî·Éë·Éê</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatFlow(cumNetInflow)}</div>
            ${cumNetInflowDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(cumNetInflowDate)}</div>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·É°·Éê·Éî·É†·Éó·Éù ·Éê·É•·É¢·Éò·Éï·Éî·Éë·Éò</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatAUM(totalNetAssets)}</div>
            ${totalNetAssetsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalNetAssetsDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·Éê·É•·É¢·Éò·Éï·Éî·Éë·Éò·É° %</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${(totalNetAssetsPercentage * 100).toFixed(2)}%</div>
            ${totalNetAssetsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalNetAssetsDate)}</div>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${totalTokenHoldings >= 1000 ? `${(totalTokenHoldings / 1000).toFixed(2)}K` : totalTokenHoldings.toFixed(0)}</div>
            ${totalTokenHoldingsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalTokenHoldingsDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·Éì·É¶·Éò·É£·É†·Éò ·Éï·Éê·É≠·É†·Éù·Éë·Éê</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatAUM(dailyTotalValueTraded)}</div>
            ${dailyTotalValueTradedDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(dailyTotalValueTradedDate)}</div>` : ''}
          </div>
        </div>
      </div>
    `;
  }
  
  // Ethereum ETF - using SoSoValue API format
  if (ethData) {
    // Extract data from SoSoValue API response structure
    const dailyNetInflow = ethData.dailyNetInflow?.value || 0;
    const dailyNetInflowDate = ethData.dailyNetInflow?.lastUpdateDate || null;
    const totalNetAssets = ethData.totalNetAssets?.value || 0;
    const totalNetAssetsDate = ethData.totalNetAssets?.lastUpdateDate || null;
    const totalNetAssetsPercentage = ethData.totalNetAssetsPercentage?.value || 0;
    const cumNetInflow = ethData.cumNetInflow?.value || 0;
    const cumNetInflowDate = ethData.cumNetInflow?.lastUpdateDate || null;
    const totalTokenHoldings = ethData.totalTokenHoldings?.value || 0;
    const totalTokenHoldingsDate = ethData.totalTokenHoldings?.lastUpdateDate || null;
    const dailyTotalValueTraded = ethData.dailyTotalValueTraded?.value || 0;
    const dailyTotalValueTradedDate = ethData.dailyTotalValueTraded?.lastUpdateDate || null;
    const flowColor = dailyNetInflow >= 0 ? '#22c55e' : '#ef4444';
    
    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ka-GE', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch {
        return dateStr;
      }
    };
    
    html += `
      <div class="etf-item" style="padding:14px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:10px;transition:all .25s;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.05);">
          <span style="font-size:18px;">Œû</span>
          <span style="font-weight:600;font-size:14px;color:#e8eaed;">Ethereum ETF</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·É¨·Éõ·Éò·Éú·Éì·Éê ·É®·Éî·Éõ·Éù·Éì·Éò·Éú·Éî·Éë·Éê (·Éì·É¶·Éî·É°)</div>
            <div style="font-size:15px;font-weight:600;color:${flowColor};margin-bottom:2px;">${formatFlow(dailyNetInflow)}</div>
            ${dailyNetInflowDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(dailyNetInflowDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·Éô·É£·Éõ·É£·Éö·Éê·É™·Éò·É£·É†·Éò ·É®·Éî·Éõ·Éù·Éì·Éò·Éú·Éî·Éë·Éê</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatFlow(cumNetInflow)}</div>
            ${cumNetInflowDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(cumNetInflowDate)}</div>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·É°·Éê·Éî·É†·Éó·Éù ·Éê·É•·É¢·Éò·Éï·Éî·Éë·Éò</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatAUM(totalNetAssets)}</div>
            ${totalNetAssetsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalNetAssetsDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·Éê·É•·É¢·Éò·Éï·Éî·Éë·Éò·É° %</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${(totalNetAssetsPercentage * 100).toFixed(2)}%</div>
            ${totalNetAssetsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalNetAssetsDate)}</div>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${totalTokenHoldings >= 1000 ? `${(totalTokenHoldings / 1000).toFixed(2)}K` : totalTokenHoldings.toFixed(0)}</div>
            ${totalTokenHoldingsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalTokenHoldingsDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">·Éì·É¶·Éò·É£·É†·Éò ·Éï·Éê·É≠·É†·Éù·Éë·Éê</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatAUM(dailyTotalValueTraded)}</div>
            ${dailyTotalValueTradedDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(dailyTotalValueTradedDate)}</div>` : ''}
          </div>
        </div>
      </div>
    `;
  }
  
  if (!html) {
    etfList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">ETF ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éê·É† ·Éê·É†·Éò·É° ·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò</div>';
    return;
  }
  
  etfList.innerHTML = html;
  
  // Add hover effects
  etfList.querySelectorAll('.etf-item').forEach(item => {
    item.onmouseenter = () => {
      item.style.background = 'rgba(255,255,255,.05)';
      item.style.borderColor = 'rgba(255,255,255,.1)';
      item.style.transform = 'translateX(2px)';
    };
    item.onmouseleave = () => {
      item.style.background = 'rgba(255,255,255,.03)';
      item.style.borderColor = 'rgba(255,255,255,.05)';
      item.style.transform = 'translateX(0)';
    };
  });
}

// Option 5: Token Categories Breakdown
function renderTokenCategories() {
  const categoriesList = $('tokenCategoriesList');
  if (!categoriesList) {
    console.warn('tokenCategoriesList element not found');
    return;
  }
  
  if (!cryptoData || cryptoData.length === 0) {
    categoriesList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">·Éë·Éê·Éñ·É†·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éõ·Éò·É£·É¨·Éï·Éì·Éù·Éõ·Éî·Éö·Éò·Éê</div>';
    return;
  }
  
  // Categorize tokens (simple categorization based on common patterns)
  const categories = {
    'Layer 1': ['bitcoin', 'ethereum', 'solana', 'cardano', 'polkadot', 'avalanche', 'cosmos', 'near', 'aptos', 'sui'],
    'Layer 2': ['polygon', 'arbitrum', 'optimism', 'base'],
    'DeFi': ['uniswap', 'aave', 'compound', 'maker', 'curve', 'pancakeswap', 'sushiswap'],
    'Stablecoins': ['tether', 'usd-coin', 'dai', 'binance-usd', 'tether-gold'],
    'Meme': ['dogecoin', 'shiba-inu', 'pepe', 'floki', 'bonk'],
    'Exchange': ['binancecoin', 'ethereum-classic', 'chainlink']
  };
  
  const categoryCounts = {};
  Object.keys(categories).forEach(cat => {
    categoryCounts[cat] = cryptoData.filter(t => 
      categories[cat].some(id => t.id.includes(id) || t.name.toLowerCase().includes(id))
    ).length;
  });
  
  // Add "Other" category
  const categorized = Object.values(categories).flat();
  categoryCounts['·É°·ÉÆ·Éï·Éê'] = cryptoData.filter(t => 
    !categorized.some(id => t.id.includes(id) || t.name.toLowerCase().includes(id))
  ).length;
  
  const total = cryptoData.length;
  
  categoriesList.innerHTML = Object.entries(categoryCounts)
    .filter(([_, count]) => count > 0)
    .sort((a, b) => b[1] - a[1])
    .map(([category, count]) => {
      const percentage = ((count / total) * 100).toFixed(0);
      const barWidth = (count / total) * 100;
      return `
        <div style="padding:10px;background:rgba(255,255,255,.03);border-radius:8px;border:1px solid rgba(255,255,255,.05);margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <span style="font-size:12px;font-weight:500;color:#e8eaed;">${category}</span>
            <span style="font-size:12px;font-weight:600;color:#fafafa;">${count} (${percentage}%)</span>
          </div>
          <div style="height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;">
            <div style="height:100%;width:${barWidth}%;background:linear-gradient(90deg,#6366f1 0%,#8b5cf6 100%);border-radius:3px;transition:width .3s;"></div>
          </div>
        </div>
      `;
    }).join('');
}

// Option 6: Recent Activity Feed (Carousel Style)
let activityFeed = [];
function renderRecentActivity() {
  const carousel = $('activityCarousel');
  if (!carousel) {
    console.warn('activityCarousel element not found');
    return;
  }
  
  if (!cryptoData || cryptoData.length === 0) {
    carousel.innerHTML = '<div style="padding:40px;text-align:center;color:#9aa0a6;font-size:13px;">·Éë·Éê·Éñ·É†·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éõ·Éò·É£·É¨·Éï·Éì·Éù·Éõ·Éî·Éö·Éò·Éê</div>';
    return;
  }
  
  // Generate recent activity from price changes
  const newActivities = [];
  cryptoData.forEach(token => {
    const change = token.price_change_percentage_24h || 0;
    if (Math.abs(change) > 5) { // Significant moves (>5%)
      newActivities.push({
        type: change > 0 ? 'surge' : 'drop',
        token: token.symbol?.toUpperCase() || token.id,
        tokenName: token.name || token.id,
        change: change,
        price: token.current_price || 0,
        timestamp: Date.now() - Math.random() * 3600000 // Random time in last hour
      });
    }
  });
  
  // Merge with existing activities and sort by timestamp
  activityFeed = [...activityFeed, ...newActivities]
    .sort((a, b) => b.timestamp - a.timestamp)
    .slice(0, 10); // Keep last 10 activities
  
  // Show the activity carousel wrapper
  const activityWrapper = $('activityCarouselWrapper');
  if (activityWrapper) activityWrapper.style.display = 'block';
  
  if (activityFeed.length === 0) {
    carousel.innerHTML = '<div style="padding:40px;text-align:center;color:#9aa0a6;font-size:13px;">·Éë·Éù·Éö·Éù ·Éê·É•·É¢·Éò·Éï·Éù·Éë·Éê ·Éê·É† ·Éê·É†·Éò·É°</div>';
    return;
  }
  
  // Render as carousel cards
  carousel.innerHTML = activityFeed.map(activity => {
    const timeAgo = Math.floor((Date.now() - activity.timestamp) / 60000);
    const timeText = timeAgo < 1 ? '·Éê·ÉÆ·Éö·Éê·ÉÆ·Éê·Éú' : timeAgo < 60 ? `${timeAgo}·É¨·Éó` : `${Math.floor(timeAgo / 60)}·É°·Éó`;
    const changeColor = activity.type === 'surge' ? '#22c55e' : '#ef4444';
    const icon = activity.type === 'surge' ? 'üìà' : 'üìâ';
    
    return `
      <div class="carousel-card">
        <div class="carousel-card-header">
          <div class="carousel-card-title">${icon} ${activity.token}</div>
          <span class="carousel-card-arrow">‚Üí</span>
        </div>
        <div class="carousel-card-value" style="color:${changeColor};">
          ${activity.change >= 0 ? '+' : ''}${activity.change.toFixed(2)}%
        </div>
        <div class="carousel-card-subtitle">${activity.type === 'surge' ? '·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éï·Éê·Éú·Éò ·Éñ·É†·Éì·Éê' : '·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éï·Éê·Éú·Éò ·Éì·Éê·É™·Éî·Éõ·Éê'}</div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.1);display:flex;justify-content:space-between;font-size:11px;">
          <div>
            <div style="color:#9aa0a6;margin-bottom:4px;">·É§·Éê·É°·Éò</div>
            <div style="color:#fafafa;font-weight:600;">$${formatPrice(activity.price)}</div>
          </div>
          <div style="text-align:right;">
            <div style="color:#9aa0a6;margin-bottom:4px;">·Éì·É†·Éù</div>
            <div style="color:#fafafa;font-weight:600;">${timeText}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  setupCarouselNavigation('activityCarousel', 'activityCarouselNext');
}



function renderQuotes() {
  const quotesList = $('quotesList');
  if (!quotesList) {
    console.warn('quotesList element not found');
    return;
  }
  
  if (!cryptoData || cryptoData.length === 0) {
    quotesList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">·Éë·Éê·Éñ·É†·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éõ·Éò·É£·É¨·Éï·Éì·Éù·Éõ·Éî·Éö·Éò·Éê</div>';
    return;
  }
  
  // Show top 5 losers (biggest 24h drops) from tracked tokens
  const topLosers = [...cryptoData]
    .filter(t => {
      const change = t.price_change_percentage_24h || 0;
      return !isNaN(change) && isFinite(change);
    })
    .sort((a, b) => {
      // Sort by lowest 24h change (most negative first)
      const changeA = a.price_change_percentage_24h || 0;
      const changeB = b.price_change_percentage_24h || 0;
      return changeA - changeB;
    })
    .slice(0, 5);
  
  if (topLosers.length === 0) {
    quotesList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éõ·Éò·É£·É¨·Éï·Éì·Éù·Éõ·Éî·Éö·Éò·Éê</div>';
    return;
  }
  
  quotesList.innerHTML = topLosers.map(token => {
    const change = token.price_change_percentage_24h || 0;
    return `
      <div class="quote-item" style="padding:14px;background:rgba(234,67,53,.06);border:1px solid rgba(234,67,53,.15);border-radius:12px;display:flex;justify-content:space-between;align-items:center;transition:all .25s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(10px);">
        <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">
          <img src="${token.image || 'https://via.placeholder.com/24'}" style="width:24px;height:24px;border-radius:50%;border:1px solid rgba(255,255,255,.1);flex-shrink:0;" onerror="this.src='https://via.placeholder.com/24?text=?'">
          <div style="min-width:0;flex:1;">
            <div style="font-weight:600;font-size:13px;color:#e8eaed;letter-spacing:-0.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${token.symbol?.toUpperCase() || token.id}</div>
            <div style="font-size:11px;color:#9aa0a6;margin-top:2px;font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${(token.name || token.id).substring(0, 15)}${(token.name || token.id).length > 15 ? '...' : ''}</div>
          </div>
        </div>
        <div style="text-align:right;flex-shrink:0;margin-left:12px;">
          <div style="font-weight:600;font-size:13px;color:#e8eaed;letter-spacing:-0.2px;">$${formatPrice(token.current_price || 0)}</div>
          <div class="change-badge negative" style="font-size:11px;padding:3px 8px;border-radius:6px;display:inline-block;margin-top:4px;background:rgba(234,67,53,.15);color:#ea4335;border:1px solid rgba(234,67,53,.25);font-weight:600;">
            ‚Üì ${Math.abs(change).toFixed(2)}%
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Add hover effect
  quotesList.querySelectorAll('.quote-item').forEach(item => {
    item.onmouseenter = () => {
      item.style.background = 'rgba(234,67,53,.1)';
      item.style.borderColor = 'rgba(234,67,53,.25)';
      item.style.transform = 'translateX(3px)';
      item.style.boxShadow = '0 4px 12px rgba(234,67,53,.2)';
    };
    item.onmouseleave = () => {
      item.style.background = 'rgba(234,67,53,.06)';
      item.style.borderColor = 'rgba(234,67,53,.15)';
      item.style.transform = 'translateX(0)';
      item.style.boxShadow = 'none';
    };
  });
}

function renderHeroStats() {
  const hero = $('heroStats');
  const carousel = $('heroCarousel');
  if (!globalData || !carousel) return;
  
  const marketCap = globalData.total_market_cap?.usd || 0;
  const volume = globalData.total_volume?.usd || 0;
  const btcDominance = globalData.market_cap_percentage?.btc || 0;
  const ethDominance = globalData.market_cap_percentage?.eth || 0;
  const marketCapChange = globalData.market_cap_change_percentage_24h_usd || 0;
  
  const fearGreedValue = fearGreedData?.value || 'N/A';
  const fearGreedClassification = fearGreedData?.value_classification || 'N/A';
  
  const getFearGreedColor = (value) => {
    if (value <= 25) return '#ef4444';
    if (value <= 45) return '#f59e0b';
    if (value <= 55) return '#eab308';
    if (value <= 75) return '#84cc16';
    return '#22c55e';
  };
  
  // Translate Fear & Greed classification to Georgian
  const translateFearGreed = (classification) => {
    const translations = {
      'Extreme Fear': '·Éî·É•·É°·É¢·É†·Éî·Éõ·Éê·Éö·É£·É†·Éò ·É®·Éò·É®·Éò',
      'Fear': '·É®·Éò·É®·Éò',
      'Neutral': '·Éú·Éî·Éò·É¢·É†·Éê·Éö·É£·É†·Éò',
      'Greed': '·É°·Éò·ÉÆ·Éê·É†·Éë·Éî',
      'Extreme Greed': '·Éî·É•·É°·É¢·É†·Éî·Éõ·Éê·Éö·É£·É†·Éò ·É°·Éò·ÉÆ·Éê·É†·Éë·Éî'
    };
    return translations[classification] || classification;
  };
  
  // Altcoin Season Index calculation
  const calculateAltcoinSeason = (btcDominance) => {
    // Altcoin season index: 0-100
    // Lower BTC dominance = higher altcoin season (more altcoins performing)
    // Formula: 100 - (BTC dominance * 1.5), capped between 0-100
    const index = Math.max(0, Math.min(100, Math.round(100 - (btcDominance * 1.5))));
    return index;
  };
  
  const getAltcoinSeasonColor = (btcDominance) => {
    const index = calculateAltcoinSeason(btcDominance);
    if (index >= 75) return '#22c55e'; // Strong altcoin season
    if (index >= 50) return '#84cc16'; // Moderate altcoin season
    if (index >= 25) return '#f59e0b'; // Weak altcoin season
    return '#ef4444'; // BTC season
  };
  
  const getAltcoinSeasonLabel = (btcDominance) => {
    const index = calculateAltcoinSeason(btcDominance);
    if (index >= 75) return '·É´·Éö·Éò·Éî·É†·Éò ·Éê·Éö·É¢-·É°·Éî·Éñ·Éù·Éú·Éò';
    if (index >= 50) return '·É°·Éê·É®·É£·Éê·Éö·Éù ·Éê·Éö·É¢-·É°·Éî·Éñ·Éù·Éú·Éò';
    if (index >= 25) return '·É°·É£·É°·É¢·Éò ·Éê·Éö·É¢-·É°·Éî·Éñ·Éù·Éú·Éò';
    return 'BTC ·É°·Éî·Éñ·Éù·Éú·Éò';
  };
  
  // Top Gainer Card (Green, before XAUT)
  const getTopGainerCard = () => {
    if (!cryptoData || cryptoData.length === 0) {
      return `
        <div class="carousel-card" style="border-color:rgba(34,197,94,.2);background:linear-gradient(135deg,rgba(18,18,23,.85) 0%,rgba(20,30,20,.9) 100%);">
          <div class="carousel-card-header">
            <div class="carousel-card-title" style="color:#22c55e;">üöÄ  Top Gainer</div>
            <span class="carousel-card-arrow" style="color:#22c55e;">‚Üí</span>
          </div>
          <div class="carousel-card-value" style="color:#22c55e;text-shadow:0 0 10px rgba(34,197,94,.3);">N/A</div>
          <div class="carousel-card-subtitle" style="color:#16a34a;">
            ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éõ·Éò·É£·É¨·Éï·Éì·Éù·Éõ·Éî·Éö·Éò·Éê
          </div>
        </div>
      `;
    }
    
    // Select token with highest 24h gain % from tracked tokens
    const token = [...cryptoData]
      .filter(t => {
        const change = t.price_change_percentage_24h || 0;
        return !isNaN(change) && isFinite(change);
      })
      .sort((a, b) => {
        const changeA = a.price_change_percentage_24h || 0;
        const changeB = b.price_change_percentage_24h || 0;
        return changeB - changeA;
      })[0];
    
    if (!token) {
      return `
        <div class="carousel-card" style="border-color:rgba(34,197,94,.2);background:linear-gradient(135deg,rgba(18,18,23,.85) 0%,rgba(20,30,20,.9) 100%);">
          <div class="carousel-card-header">
            <div class="carousel-card-title" style="color:#22c55e;">üöÄ ·Éì·É¶·Éò·É° ·É¢·Éù·Éû ·Éí·Éî·Éò·Éú·Éî·É†·Éò</div>
            <span class="carousel-card-arrow" style="color:#22c55e;">‚Üí</span>
          </div>
          <div class="carousel-card-value" style="color:#22c55e;text-shadow:0 0 10px rgba(34,197,94,.3);">N/A</div>
          <div class="carousel-card-subtitle" style="color:#16a34a;">
            ·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê
          </div>
        </div>
      `;
    }
    
    const change = token.price_change_percentage_24h || 0;
    
    return `
      <div class="carousel-card" style="border-color:rgba(34,197,94,.2);background:linear-gradient(135deg,rgba(18,18,23,.85) 0%,rgba(20,30,20,.9) 100%);">
        <div class="carousel-card-header">
          <div class="carousel-card-title" style="color:#22c55e;">üöÄ ·Éì·É¶·Éò·É° ·É¢·Éù·Éû ·Éí·Éî·Éò·Éú·Éî·É†·Éò</div>
          <span class="carousel-card-arrow" style="color:#22c55e;">‚Üí</span>
        </div>
        <div class="carousel-card-value" style="color:#22c55e;text-shadow:0 0 10px rgba(34,197,94,.3);">+${change.toFixed(2)}%</div>
        <div class="carousel-card-subtitle" style="color:#16a34a;">
          ${token.symbol?.toUpperCase() || token.id.toUpperCase()}
        </div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(34,197,94,.2);font-size:11px;color:#9aa0a6;">
          $${formatPrice(token.current_price || 0)}
        </div>
      </div>
    `;
  };
  
  // XAUT (Tether Gold) card
  const getXAUTCard = () => {
    const xaut = cryptoData.find(t => t.id === 'tether-gold' || t.symbol?.toLowerCase() === 'xaut');
    
    if (!xaut) {
      return `
        <div class="carousel-card" style="border-color:rgba(212,175,55,.2);">
          <div class="carousel-card-header">
            <div class="carousel-card-title">XAUT (·Éù·É•·É†·Éù)</div>
            <span class="carousel-card-arrow" style="color:#d4af37;">‚Üí</span>
          </div>
          <div class="carousel-card-value" style="color:#d4af37;">N/A</div>
          <div class="carousel-card-subtitle" style="color:#8b6f1e;">
            ·É¢·Éù·Éô·Éî·Éú·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê
          </div>
        </div>
      `;
    }
    
    const price = xaut.current_price || 0;
    const change = xaut.price_change_percentage_24h || 0;
    const changeColor = change >= 0 ? '#d4af37' : '#b8860b';
    
    return `
      <div class="carousel-card" style="border-color:rgba(212,175,55,.2);background:linear-gradient(135deg,rgba(18,18,23,.85) 0%,rgba(30,25,15,.9) 100%);">
        <div class="carousel-card-header">
          <div class="carousel-card-title" style="color:#d4af37;">XAUT (·Éù·É•·É†·Éù)</div>
          <span class="carousel-card-arrow" style="color:#d4af37;">‚Üí</span>
        </div>
        <div class="carousel-card-value" style="color:#d4af37;text-shadow:0 0 10px rgba(212,175,55,.3);">$${formatPrice(price)}</div>
        <div class="carousel-card-change" style="color:${changeColor};">
          ${change >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(change).toFixed(2)}%
        </div>
      </div>
    `;
  };
  
  carousel.innerHTML = `
    <div class="carousel-card">
      <div class="carousel-card-header">
        <div class="carousel-card-title">·É°·Éê·Éë·Éê·Éñ·É†·Éù ·Éô·Éê·Éû·Éò·É¢·Éê·Éö·Éò·Éñ·Éê·É™·Éò·Éê</div>
        <span class="carousel-card-arrow">‚Üí</span>
      </div>
      <div class="carousel-card-value">$${formatMarketCap(marketCap)}</div>
      <div class="carousel-card-change ${marketCapChange >= 0 ? 'positive' : 'negative'}">
        ${marketCapChange >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(marketCapChange).toFixed(2)}%
      </div>
    </div>
    
    <div class="carousel-card">
      <div class="carousel-card-header">
        <div class="carousel-card-title">·É®·Éò·É®·Éò ·Éì·Éê ·É°·Éò·ÉÆ·Éê·É†·Éë·Éî</div>
        <span class="carousel-card-arrow">‚Üí</span>
      </div>
      <div class="carousel-card-value" style="color:${getFearGreedColor(parseInt(fearGreedValue) || 50)};">${fearGreedValue}</div>
      <div class="carousel-card-subtitle" style="color:${getFearGreedColor(parseInt(fearGreedValue) || 50)};">
        ${translateFearGreed(fearGreedClassification)}
      </div>
    </div>
    
    <div class="carousel-card">
      <div class="carousel-card-header">
        <div class="carousel-card-title">·Éê·Éö·É¢-·É°·Éî·Éñ·Éù·Éú·Éò·É° ·Éò·Éú·Éì·Éî·É•·É°·Éò</div>
        <span class="carousel-card-arrow">‚Üí</span>
      </div>
      <div class="carousel-card-value" style="color:${getAltcoinSeasonColor(btcDominance)};">${calculateAltcoinSeason(btcDominance)}</div>
      <div class="carousel-card-subtitle" style="color:${getAltcoinSeasonColor(btcDominance)};">
        ${getAltcoinSeasonLabel(btcDominance)}
      </div>
    </div>
    
    ${getTopGainerCard()}
    
    ${getXAUTCard()}
  `;
  
  // Setup carousel navigation
  setupCarouselNavigation('heroCarousel', 'carouselNext');
  
  // Center carousel after rendering
  setTimeout(() => {
    const carousel = $('heroCarousel');
    if (carousel) {
      if (carousel.scrollWidth <= carousel.clientWidth) {
        carousel.style.justifyContent = 'center';
        carousel.classList.add('centered');
      } else {
        carousel.style.justifyContent = 'flex-start';
        carousel.classList.remove('centered');
      }
    }
  }, 200);
}

function setupCarouselNavigation(carouselId = 'heroCarousel', nextBtnId = 'carouselNext') {
  const carousel = $(carouselId);
  const nextBtn = $(nextBtnId);
  
  if (!carousel || !nextBtn) return;
  
  // Scroll right on button click
  nextBtn.onclick = () => {
    carousel.scrollBy({ left: 300, behavior: 'smooth' });
  };
  
  // Center carousel if content is smaller than viewport
  const centerCarousel = () => {
    if (carousel.scrollWidth <= carousel.clientWidth) {
      carousel.style.justifyContent = 'center';
      carousel.classList.add('centered');
      nextBtn.style.display = 'none';
    } else {
      carousel.style.justifyContent = 'flex-start';
      carousel.classList.remove('centered');
      nextBtn.style.display = 'flex';
    }
  };
  
  // Show/hide navigation based on scroll position
  const updateNavVisibility = () => {
    const maxScroll = carousel.scrollWidth - carousel.clientWidth;
    if (maxScroll <= 0) {
      nextBtn.style.display = 'none';
      centerCarousel();
    } else {
      nextBtn.style.display = 'flex';
      carousel.style.justifyContent = 'flex-start';
    }
  };
  
  // Center on load and resize
  setTimeout(centerCarousel, 100);
  window.addEventListener('resize', centerCarousel);
  carousel.addEventListener('scroll', updateNavVisibility);
  updateNavVisibility();
  
  // Touch/swipe support for mobile
  let isDown = false;
  let startX;
  let scrollLeft;
  
  carousel.addEventListener('mousedown', (e) => {
    isDown = true;
    startX = e.pageX - carousel.offsetLeft;
    scrollLeft = carousel.scrollLeft;
    carousel.style.cursor = 'grabbing';
  });
  
  carousel.addEventListener('mouseleave', () => {
    isDown = false;
    carousel.style.cursor = 'grab';
  });
  
  carousel.addEventListener('mouseup', () => {
    isDown = false;
    carousel.style.cursor = 'grab';
  });
  
  carousel.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - carousel.offsetLeft;
    const walk = (x - startX) * 2;
    carousel.scrollLeft = scrollLeft - walk;
  });
  
  carousel.style.cursor = 'grab';
}

function renderTokens() {
  const list = $('tokensList');
  list.innerHTML = '';
  if (!cryptoData || cryptoData.length === 0) {
    list.innerHTML = '<div class="error">·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê. ·Éì·Éê·Éê·Éõ·Éê·É¢·Éî·Éó ·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò ·Éê·Éì·Éõ·Éò·Éú ·Éû·Éê·Éú·Éî·Éö·É®·Éò.</div>';
    return;
  }
  cryptoData.sort((a, b) => {
    if (sortColumn === 'name') return sortDirection * a.name.localeCompare(b.name);
    if (sortColumn === 'price') return sortDirection * (a.current_price - b.current_price);
    if (sortColumn === 'change') return sortDirection * (a.price_change_percentage_24h - b.price_change_percentage_24h);
    if (sortColumn === 'mcap') return sortDirection * (a.market_cap - b.market_cap);
    return 0;
  }).forEach((coin, idx) => {
    const change = coin.price_change_percentage_24h || 0;
    const changeClass = change >= 0 ? 'positive' : 'negative';
    list.innerHTML += `
      <div class="token-row" style="--index: ${idx}">
        <div class="token-icon-col"><img src="${coin.image}" class="token-icon" alt="${coin.name}"></div>
        <div class="token-name-col">
          <h3>${coin.name}</h3>
          <span class="token-symbol">${coin.symbol.toUpperCase()}</span>
        </div>
        <div class="token-price-col">$${formatPrice(coin.current_price)}</div>
        <div class="token-change-col">
          <span class="change-badge ${changeClass}">
            ${change >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(change).toFixed(2)}%
          </span>
        </div>
        <div class="token-mcap-col">$${formatMarketCap(coin.market_cap)}</div>
      </div>
    `;
  });
}

window.sortBy = function(col) {
  if (sortColumn === col) {
    sortDirection *= -1;
  } else {
    sortColumn = col;
    sortDirection = col === 'name' ? 1 : -1;
  }
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  $(`sort${col.charAt(0).toUpperCase() + col.slice(1)}`).classList.add('active');
  renderTokens();
};


/* ---------- PORTFOLIO VISIBILITY TOGGLE (Enhanced Privacy Mode) ---------- */
let portfolioVisible = true;
let privacyMode = false;

// Animate number counter
function animateValue(element, start, end, duration = 1000) {
  if (!element) return;
  const startVal = parseFloat(start.toString().replace(/[^0-9.-]/g, '')) || 0;
  const endVal = parseFloat(end.toString().replace(/[^0-9.-]/g, '')) || 0;
  const isCurrency = start.toString().includes('$');
  const isPercent = start.toString().includes('%');
  const isNegative = start.toString().startsWith('-');
  
  const startTime = performance.now();
  const animate = (currentTime) => {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
    const current = startVal + (endVal - startVal) * easeOutQuart;
    
    let formatted;
    if (isCurrency) {
      formatted = `${isNegative && current < 0 ? '-' : ''}$${Math.abs(current).toFixed(2)}`;
    } else if (isPercent) {
      formatted = `${current >= 0 ? '+' : ''}${current.toFixed(2)}%`;
    } else {
      formatted = current.toFixed(2);
    }
    
    element.textContent = formatted;
    
    if (progress < 1) {
      requestAnimationFrame(animate);
    }
  };
  requestAnimationFrame(animate);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ THEME TOGGLE FUNCTIONALITY ‚îÄ‚îÄ‚îÄ‚îÄ */
function initTheme() {
  const themeToggle = $('themeToggle');
  const themeIcon = $('themeIcon');
  if (!themeToggle || !themeIcon) return;
  
  // Get saved theme or default to dark
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  updateThemeIcon(savedTheme);
  
  themeToggle.onclick = () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
  };
}

function updateThemeIcon(theme) {
  const themeIcon = $('themeIcon');
  if (!themeIcon) return;
  themeIcon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}

// Initialize theme on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initTheme);
} else {
  initTheme();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ SIDEBAR NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ */
function initSidebar() {
  const sidebarItems = document.querySelectorAll('.sidebar-item');
  const contentSections = document.querySelectorAll('.user-content');
  const sidebar = $('sidebar');
  const sidebarOverlay = $('sidebarOverlay');
  
  sidebarItems.forEach(item => {
    item.addEventListener('click', () => {
      const targetTab = item.dataset.tab;
      
      // Update active state
      sidebarItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      
      // Show/hide content sections
      contentSections.forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none';
      });
      
      const targetSection = document.getElementById(`${targetTab}Content`);
      if (targetSection) {
        targetSection.classList.add('active');
        targetSection.style.display = 'block';
        
        // Load data if needed
        if (targetTab === 'portfolio' && currentUser) {
          loadPortfolio();
        } else if (targetTab === 'targets' && currentUser) {
          loadTargets();
        } else if (targetTab === 'alerts' && currentUser) {
          loadAlerts();
        }
      }
      
      // Close sidebar on mobile after selection
      if (window.innerWidth <= 1024 && sidebar) {
        sidebar.classList.remove('open');
        if (sidebarOverlay) sidebarOverlay.classList.remove('active');
      }
    });
  });
}

// Initialize sidebar on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSidebar);
} else {
  initSidebar();
}

// Sidebar toggle for mobile
const sidebarToggle = $('sidebarToggle');
const sidebarOverlay = $('sidebarOverlay');
if (sidebarToggle) {
  sidebarToggle.onclick = () => {
    const sidebar = $('sidebar');
    if (sidebar) {
      sidebar.classList.toggle('open');
      if (sidebarOverlay) {
        sidebarOverlay.classList.toggle('active');
      }
    }
  };
}

// Close sidebar when clicking overlay
if (sidebarOverlay) {
  sidebarOverlay.onclick = () => {
    const sidebar = $('sidebar');
    if (sidebar) {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('active');
    }
  };
}

// Close sidebar when clicking outside on mobile
document.addEventListener('click', (e) => {
  const sidebar = $('sidebar');
  const sidebarToggle = $('sidebarToggle');
  if (window.innerWidth <= 1024 && sidebar && sidebarToggle) {
    if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target) && sidebar.classList.contains('open')) {
      sidebar.classList.remove('open');
      if (sidebarOverlay) sidebarOverlay.classList.remove('active');
    }
  }
});

if ($('toggleVisibility')) {
  $('toggleVisibility').onclick = () => {
    privacyMode = !privacyMode;
    portfolioVisible = !privacyMode;
    const totalValueCard = $('totalValueCard');
    const totalPLCard = $('totalPLCard');
    const totalValue = $('totalValue');
    const totalPL = $('totalPL');
    const toggleBtn = $('toggleVisibility');
    
    // Hide/show all dollar values across dashboard
    const allDollarValues = document.querySelectorAll('[id*="Value"], [id*="PL"], .holding-row [style*="color"]');
    
    if (privacyMode) {
      // Hide all dollar values
      if (totalValue) totalValue.style.display = 'none';
      if (totalPL) totalPL.style.display = 'none';
      if (totalValueCard) totalValueCard.style.opacity = '0.4';
      if (totalPLCard) totalPLCard.style.opacity = '0.4';
      
      // Hide dollar values in holdings
      document.querySelectorAll('.holding-row').forEach(row => {
        const valueCells = row.querySelectorAll('div');
        valueCells.forEach(cell => {
          if (cell.textContent.includes('$') && !cell.textContent.includes('%')) {
            cell.style.opacity = '0';
          }
        });
      });
      
      toggleBtn.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
      toggleBtn.style.opacity = '1';
      toggleBtn.title = '·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éë·Éî·Éë·Éò·É° ·É©·Éï·Éî·Éú·Éî·Éë·Éê';
      toggleBtn.setAttribute('aria-label', '·Éû·Éù·É†·É¢·É§·Éù·Éö·Éò·Éù·É° ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éë·Éî·Éë·Éò·É° ·É©·Éï·Éî·Éú·Éî·Éë·Éê');
    } else {
      // Show all dollar values
      if (totalValue) totalValue.style.display = 'block';
      if (totalPL) totalPL.style.display = 'block';
      if (totalValueCard) totalValueCard.style.opacity = '1';
      if (totalPLCard) totalPLCard.style.opacity = '1';
      
      // Show dollar values in holdings
      document.querySelectorAll('.holding-row').forEach(row => {
        const valueCells = row.querySelectorAll('div');
        valueCells.forEach(cell => {
          if (cell.textContent.includes('$')) {
            cell.style.opacity = '1';
          }
        });
      });
      
      toggleBtn.textContent = 'üëÅÔ∏è';
      toggleBtn.style.opacity = '0.7';
      toggleBtn.title = '·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éë·Éî·Éë·Éò·É° ·Éì·Éê·Éõ·Éê·Éö·Éï·Éê';
      toggleBtn.setAttribute('aria-label', '·Éû·Éù·É†·É¢·É§·Éù·Éö·Éò·Éù·É° ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éë·Éî·Éë·Éò·É° ·Éì·Éê·Éõ·Éê·Éö·Éï·Éê');
    }
  };
}


/* ---------- TOP GAINER OF DAY (Sidebar) ---------- */
function renderTopGainerSidebar() {
  const container = $('topGainerSidebar');
  if (!container) return;
  
  if (!cryptoData || cryptoData.length === 0) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éõ·Éò·É£·É¨·Éï·Éì·Éù·Éõ·Éî·Éö·Éò·Éê</div>';
    return;
  }
  
  // Select token with highest 24h gain % from tracked tokens
  const token = [...cryptoData]
    .filter(t => {
      // Only include tokens with valid price change data
      const change = t.price_change_percentage_24h || 0;
      return !isNaN(change) && isFinite(change);
    })
    .sort((a, b) => {
      // Sort by highest 24h gain percentage (descending)
      const changeA = a.price_change_percentage_24h || 0;
      const changeB = b.price_change_percentage_24h || 0;
      return changeB - changeA;
    })[0];
  
  if (!token) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê</div>';
    return;
  }
  
  const change = token.price_change_percentage_24h || 0;
  const changeColor = change >= 0 ? '#22c55e' : '#ef4444';
  
  container.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;padding:16px;background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.2);border-radius:12px;">
      <div style="width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0;border:2px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;background:rgba(20,20,30,.5);">
        ${token.image ? `<img src="${token.image}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML='üí∞'">` : 'üí∞'}
      </div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;font-size:14px;color:#fafafa;letter-spacing:-0.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${token.name || token.id}</div>
        <div style="font-size:11px;color:#71717a;margin-top:2px;">${(token.symbol || token.id).toUpperCase()}</div>
        <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
          <div style="font-size:13px;font-weight:600;color:#fafafa;">$${formatPrice(token.current_price || 0)}</div>
          <div style="font-size:12px;font-weight:600;padding:3px 8px;border-radius:6px;background:${changeColor}20;color:${changeColor};border:1px solid ${changeColor}40;">
            ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ---------- HAPTIC FEEDBACK (Mobile) ---------- */
function vibrate(pattern = [50]) {
  if ('vibrate' in navigator) {
    navigator.vibrate(pattern);
  }
}

// Add haptic feedback to alerts
const originalAddAlert = window.addAlert;
if (originalAddAlert) {
  window.addAlert = async function(alertData) {
    const result = await originalAddAlert.call(this, alertData);
    vibrate([50, 50, 50]); // Short vibration pattern when adding alert
    return result;
  };
}

/* ---------- SCREEN READER OPTIMIZATION ---------- */
// Add ARIA labels to interactive elements
document.addEventListener('DOMContentLoaded', () => {
  // Add labels to buttons
  document.querySelectorAll('button').forEach(btn => {
    if (!btn.getAttribute('aria-label') && !btn.textContent.trim()) {
      btn.setAttribute('aria-label', btn.title || 'Button');
    }
  });
  
  // Add labels to inputs
  document.querySelectorAll('input, select').forEach(input => {
    if (!input.getAttribute('aria-label') && !input.id.includes('holding') && !input.id.includes('alert')) {
      const label = input.previousElementSibling?.textContent || input.placeholder || 'Input field';
      input.setAttribute('aria-label', label);
    }
  });
  
  // Add role attributes
  const mainContent = document.querySelector('.main-section');
  if (mainContent && !mainContent.getAttribute('role')) {
    mainContent.setAttribute('role', 'main');
  }
  
  // Add live regions for dynamic content
  if (!document.getElementById('liveRegion')) {
    const liveRegion = document.createElement('div');
    liveRegion.id = 'liveRegion';
    liveRegion.setAttribute('aria-live', 'polite');
    liveRegion.setAttribute('aria-atomic', 'true');
    liveRegion.style.position = 'absolute';
    liveRegion.style.left = '-9999px';
    liveRegion.style.width = '1px';
    liveRegion.style.height = '1px';
    liveRegion.style.overflow = 'hidden';
    document.body.appendChild(liveRegion);
  }
});

/* ---------- SIDEBAR ACTIVE STATE ---------- */
// Set active sidebar item based on current page
function setActiveSidebarItem() {
  const currentPath = window.location.pathname;
  const sidebarItems = document.querySelectorAll('.sidebar-item');
  
  sidebarItems.forEach(item => {
    item.classList.remove('active');
    const href = item.getAttribute('href');
    if (href) {
      if (currentPath === '/' && href === '/') {
        item.classList.add('active');
      } else if (currentPath.includes(href.replace('.html', ''))) {
        item.classList.add('active');
      }
    }
  });
}

// Set active state on page load
setActiveSidebarItem();

/* ---------- INITIAL LOAD ---------- */
// Load data on page load
fetchAll();

/* ---------- FETCH MARKET DATA (via Vercel API) ---------- */
async function fetchAll(){
  const err = $('error'), load = $('loading');
  err.innerHTML = ''; load.style.display = 'block';
  try {
    console.log('Fetching market data from /api/portfolio...');
    
    const res = await fetch('/api/portfolio');
    console.log('Response status:', res.status, res.statusText);
    
    let data;
    try {
      data = await res.json();
      console.log('Response data:', data);
    } catch (jsonError) {
      console.error('Failed to parse JSON response:', jsonError);
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      // API returned an error response
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      const hint = data.hint || '';
      const requiredVars = data.requiredVars || [];
      
      let errorHtml = `<div class="error"><strong>·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${errorMsg}</strong>`;
      if (hint) errorHtml += `<br><br>${hint}`;
      if (requiredVars.length) {
        errorHtml += `<br><br><strong>·É°·Éê·É≠·Éò·É†·Éù ·Éí·Éê·É†·Éî·Éõ·Éù·É° ·É™·Éï·Éö·Éê·Éì·Éî·Éë·Éò:</strong><br>${requiredVars.join(', ')}`;
        errorHtml += `<br><br>·Éí·Éê·Éì·Éê·Éì·Éò·Éó Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables ·Éì·Éê ·Éì·Éê·Éê·Éß·Éî·Éú·Éî·Éó ·Éî·É° ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éë·Éî·Éë·Éò.`;
      }
      errorHtml += `<br><br><small>·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éò ·Éì·Éî·É¢·Éê·Éö·Éî·Éë·Éò·É°·Éó·Éï·Éò·É° ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éî·Éó ·Éë·É†·Éê·É£·Éñ·Éî·É†·Éò·É° ·Éô·Éù·Éú·É°·Éù·Éö·Éò (F12) ·Éì·Éê Vercel ·Éö·Éù·Éí·Éî·Éë·Éò</small></div>`;
      
      err.innerHTML = errorHtml;
      $('contentGrid').style.display = 'grid';
      $('heroStats').style.display = 'grid';
      load.style.display = 'none';
      return;
    }
    
    // Success - process data (even if some data is missing due to rate limiting)
    cryptoData = data.cryptoData || [];
    cryptoData.forEach(t => prices[t.id] = t.current_price);
    globalData = data.globalData;
    fearGreedData = data.fearGreed;
    etfFlowsData = data.etfFlows;
    
    if (data.cached && !data.stale) {
      // Silently use cached data - no warning needed for fresh cache
      console.log('Using cached data');
    }
    
    if (data.warning || data.stale) {
      const warningMsg = data.warning || 'API ·É®·Éî·É™·Éì·Éù·Éõ·Éò·É° ·Éí·Éê·Éõ·Éù ·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éî·Éë·Éê ·Éì·Éê·Éô·Éî·É®·Éò·Éö·Éò ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò';
      console.warn('API Warning:', warningMsg);
      // Show a subtle warning to user
      const warningEl = document.createElement('div');
      warningEl.className = 'error';
      warningEl.style.background = 'rgba(245,158,11,.1)';
      warningEl.style.borderColor = 'rgba(245,158,11,.3)';
      warningEl.style.color = '#f59e0b';
      warningEl.innerHTML = `<strong>‚ö†Ô∏è ${data.stale ? '·Éì·Éê·Éô·Éî·É®·Éò·Éö·Éò ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò' : '·É°·Éò·É©·É•·Éê·É†·Éò·É° ·Éö·Éò·Éõ·Éò·É¢·Éò·É° ·Éí·Éê·É§·É†·Éó·ÉÆ·Éò·Éö·Éî·Éë·Éê'}:</strong> ${warningMsg}. ·Éñ·Éù·Éí·Éò·Éî·É†·Éó·Éò ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éò ·É®·Éî·Éò·É´·Éö·Éî·Éë·Éê ·Éê·É†·Éê·É°·É†·É£·Éö·Éò ·Éò·Éß·Éù·É°.`;
      const errorDiv = $('error');
      if (errorDiv && !errorDiv.querySelector('.error')) {
        errorDiv.appendChild(warningEl);
        setTimeout(() => warningEl.remove(), 10000); // Remove after 10 seconds
      }
    }
    
    if (data.retryAfter) {
      console.warn('API Rate Limited - Retry after:', data.retryAfter, 'seconds');
      const errorEl = document.createElement('div');
      errorEl.className = 'error';
      errorEl.innerHTML = `<strong>‚ö†Ô∏è ·É°·Éò·É©·É•·Éê·É†·Éò·É° ·Éö·Éò·Éõ·Éò·É¢·Éò ·Éí·Éê·Éì·Éê·É≠·Éê·É†·Éë·Éî·Éë·É£·Éö·Éò·Éê:</strong> ${data.message || 'CoinGecko API ·É°·Éò·É©·É•·Éê·É†·Éò·É° ·Éö·Éò·Éõ·Éò·É¢·Éò ·Éí·Éê·Éì·Éê·É≠·Éê·É†·Éë·Éî·Éë·É£·Éö·Éò·Éê'}. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éì·Éê·Éî·Éö·Éù·Éì·Éù·Éó ${data.retryAfter} ·É¨·Éê·Éõ·É° ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê·Éõ·Éì·Éî.`;
      $('error').innerHTML = '';
      $('error').appendChild(errorEl);
    }
    
           console.log(`Loaded ${cryptoData.length} tokens`);
           
    renderAll();
           // Ensure Activity section is rendered
           if (cryptoData && cryptoData.length > 0) {
             renderRecentActivity();
           }
    $('contentGrid').style.display = 'block';
    // Ensure market content is visible
    if ($('marketContent')) {
      $('marketContent').style.display = 'block';
    }
    $('heroStats').style.display = 'grid';
           // Load portfolio, alerts, and targets after market data is loaded
           if(currentUser) { 
             loadPortfolio(); 
             loadAlerts();
             loadTargets();
           }
           // Populate target token select
           populateTargetTokenSelect();
           // Refresh targets display when prices update
           if (Object.keys(sellTargets).length > 0) {
             renderTargets();
           }
  } catch (e) {
    console.error('Fetch error:', e);
    console.error('Error details:', e.message, e.stack);
    // Check if it's a rate limit error (503)
    if (e.message && e.message.includes('503')) {
      err.innerHTML = `<div class="error"><strong>‚ö†Ô∏è Rate Limit Exceeded</strong><br><br>CoinGecko API rate limit has been exceeded. Please wait a minute and refresh the page.<br><br><small>The system will automatically retry, but you may need to wait a bit longer.</small></div>`;
    } else {
      err.innerHTML = `<div class="error"><strong>Network Error: ${e.message}</strong><br><br>This could mean:<br>‚Ä¢ The API endpoint is not responding<br>‚Ä¢ There's a network connectivity issue<br>‚Ä¢ The serverless function crashed<br>‚Ä¢ API rate limiting (429 errors)<br><br><small>Check browser console (F12) and Vercel deployment logs for details</small></div>`;
    }
    $('contentGrid').style.display = 'grid';
    $('heroStats').style.display = 'grid';
  } finally {
    load.style.display = 'none';
  }
}

/* ---------- PORTFOLIO (via Vercel API) ---------- */
async function loadPortfolio(){
  if(!currentUser) {
    console.log('No user logged in, skipping portfolio load');
    return;
  }
  
  try {
    console.log('Loading portfolio for user:', currentUser.uid);
    
    // Fetch user holdings directly from Firebase Realtime Database
    const userId = currentUser.uid;
    const db = firebase.database();
    const holdingsRef = db.ref(`users/${userId}/holdings`);
    
    holdingsRef.once('value', (snapshot) => {
      const holdings = snapshot.val() || {};
      portfolioHoldings = holdings; // Store globally for targets calculation
      console.log('Portfolio holdings loaded:', Object.keys(holdings).length, 'items');
      renderPortfolio(holdings);
      // Refresh targets display with updated buy prices
      if (Object.keys(sellTargets).length > 0) {
        renderTargets();
      }
    }, (error) => {
      console.error('Database read error:', error);
      // Only show alert if it's a real error, not just empty data
      if (error.code !== 'PERMISSION_DENIED') {
        console.error('Failed to load portfolio: ' + error.message);
        // Don't show alert, just log it
      } else {
        console.log('Permission denied - user may not have holdings yet');
      }
      // Always render portfolio (even if empty) to show empty state
      renderPortfolio({});
    });
  } catch (e) {
    console.error('Load portfolio error:', e);
    // Always render portfolio (even if empty) to show empty state
    renderPortfolio({});
  }
}

async function updateHolding(id, field, value) {
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/portfolio', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id, field, value })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // Reload portfolio after update
    await loadPortfolio();
  } catch (e) {
    alert('Update error: ' + e.message);
    console.error('Update holding error:', e);
  }
}

window.editHolding = function(id, tokenId, amount, buyPrice) {
  // Populate the edit modal with current values
  $('editHoldingId').value = id;
  $('editHoldingToken').value = tokenId;
  $('editHoldingAmount').value = amount;
  $('editHoldingBuyPrice').value = buyPrice;
  
  // Populate token select (in case it's not already populated)
  const tokenSelect = $('editHoldingToken');
  if (tokenSelect.options.length === 0) {
    cryptoData.forEach(token => {
      const option = document.createElement('option');
      option.value = token.id;
      option.textContent = `${token.name} (${token.symbol.toUpperCase()})`;
      if (token.id === tokenId) option.selected = true;
      tokenSelect.appendChild(option);
    });
  }
  
  // Show the modal
  $('editHoldingModal').classList.add('show');
};

window.deleteHolding = async (id) => {
  if(!confirm('Delete?')) return;
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/portfolio', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // Reload portfolio after delete
    await loadPortfolio();
  } catch (e) {
    alert('·É¨·Éê·É®·Éö·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + e.message);
    console.error('Delete holding error:', e);
  }
};

$('addHoldingForm').onsubmit = async e => {
  e.preventDefault();
  const tokenId = $('holdingToken').value;
  const amount = parseFloat($('holdingAmount').value);
  const buyPrice = parseFloat($('buyPrice').value);
  if(!tokenId || isNaN(amount) || isNaN(buyPrice)) return alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éê·Éï·É°·Éù·Éó ·Éß·Éï·Éî·Éö·Éê ·Éï·Éî·Éö·Éò');
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/portfolio', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ holding: { tokenId, amount, buyPrice } })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    e.target.reset();
    // Reload portfolio immediately after adding
    console.log('Holding added, reloading portfolio...');
    await loadPortfolio();
  } catch (e) {
    alert('·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + e.message);
    console.error('Add holding error:', e);
  }
};

// Edit holding form handler
$('editHoldingForm').onsubmit = async e => {
  e.preventDefault();
  const id = $('editHoldingId').value;
  const amount = parseFloat($('editHoldingAmount').value);
  const buyPrice = parseFloat($('editHoldingBuyPrice').value);
  
  if (!id || isNaN(amount) || isNaN(buyPrice) || amount <= 0 || buyPrice <= 0) {
    return alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·É°·É¨·Éù·É†·Éò ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éë·Éî·Éë·Éò ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éò·É°·Éê ·Éì·Éê ·É®·Éî·É°·Éß·Éò·Éì·Éï·Éò·É° ·É§·Éê·É°·Éò·É°·Éó·Éï·Éò·É°');
  }
  
  try {
    // Update both fields
    const token = await currentUser.getIdToken();
    
    // Update amount
    let res = await fetch('/api/portfolio', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id, field: 'amount', value: amount })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // Update buy price
    res = await fetch('/api/portfolio', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id, field: 'buyPrice', value: buyPrice })
    });
    
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // Close modal and reload portfolio
    $('editHoldingModal').classList.remove('show');
    await loadPortfolio();
  } catch (e) {
    alert('·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + e.message);
    console.error('Edit holding error:', e);
  }
};

/* ---------- ALERTS (via Vercel API) ---------- */
async function loadAlerts(){
  if(!currentUser) return;
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/alerts', {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    let data;
    try {
      const text = await res.text();
      if (!text) {
        data = {};
      } else {
        data = JSON.parse(text);
      }
    } catch (jsonError) {
      console.error('Failed to parse alerts response:', jsonError);
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText}). Response: ${(await res.text()).substring(0, 100)}`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    renderAlerts(data || {});
  } catch (e) {
    console.error('Load alerts error:', e);
    // Don't show alert if it's just empty alerts
    if (!e.message.includes('404') && !e.message.includes('invalid response')) {
      console.warn('·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + e.message);
    }
    // Always render alerts (even if empty) to show empty state
    renderAlerts({});
  }
}

async function addAlert(alert) {
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/alerts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ alert })
    });
    if (res.status !== 200) throw new Error('·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê');
    loadAlerts();
  } catch (e) {
    alert('·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + e.message);
  }
}

window.deleteAlert = async (id) => {
  if(!confirm('·É¨·Éê·É®·Éö·Éê?')) return;
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch(`/api/alerts?id=${encodeURIComponent(id)}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      const text = await res.text();
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText}): ${text.substring(0, 100)}`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    loadAlerts();
  } catch (e) {
    alert('·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éò·É° ·É¨·Éê·É®·Éö·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + e.message);
    console.error('Delete alert error:', e);
  }
};

$('addAlertForm').onsubmit = async e => {
  e.preventDefault();
  const tokenId = $('alertToken').value;
  const condition = $('alertCondition').value;
  const target = parseFloat($('targetPrice').value);
  const message = $('alertMessage').value;
  if(!tokenId || isNaN(target)) return alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éê·Éï·É°·Éù·Éó ·Éß·Éï·Éî·Éö·Éê ·Éï·Éî·Éö·Éò');
  await addAlert({ tokenId, condition, target, message });
  e.target.reset();
};

$('addTargetForm').onsubmit = async e => {
  e.preventDefault();
  await addTarget();
};

/* ---------- PROFILE MANAGEMENT ---------- */
// Tab switching
document.querySelectorAll('.user-tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.user-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.user-content').forEach(c => {
      c.classList.remove('active');
      c.style.display = 'none';
    });
    tab.classList.add('active');
    const tabName = tab.getAttribute('data-tab');
    const contentEl = $(tabName + 'Content');
    if (contentEl) {
      contentEl.classList.add('active');
      contentEl.style.display = 'block';
    }
  };
});

// Change Name Form
$('changeNameForm').onsubmit = async (e) => {
  e.preventDefault();
  if (!currentUser) {
    alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·ÉÆ·Éï·Éò·Éì·Éî·Éó ·É°·Éò·É°·É¢·Éî·Éõ·Éê·É®·Éò');
    return;
  }

  const name = $('newName').value.trim();
  if (!name) {
    showStatus('nameStatus', '·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·É°·Éê·ÉÆ·Éî·Éö·Éò', 'error');
    return;
  }

  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/profile', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ action: 'updateName', name })
    });

    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || data.message || '·É°·Éê·ÉÆ·Éî·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê');
    }

    showStatus('nameStatus', data.message || '·É°·Éê·ÉÆ·Éî·Éö·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É®·Éî·Éò·É™·Éï·Éê·Éö·Éê', 'success');
    $('newName').value = '';
    
    // Reload user data
    await currentUser.reload();
  } catch (error) {
    showStatus('nameStatus', error.message || '·É®·Éî·É™·Éì·Éù·Éõ·Éê ·É°·Éê·ÉÆ·Éî·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éò·É°·Éê·É°', 'error');
  }
};

// Change Email Form
$('changeEmailForm').onsubmit = async (e) => {
  e.preventDefault();
  if (!currentUser) {
    alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·ÉÆ·Éï·Éò·Éì·Éî·Éó ·É°·Éò·É°·É¢·Éî·Éõ·Éê·É®·Éò');
    return;
  }

  const email = $('newEmail').value.trim();
  const password = $('emailPassword').value;

  if (!email || !email.includes('@')) {
    showStatus('emailStatus', '·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·É°·É¨·Éù·É†·Éò ·Éî·Éö·É§·Éù·É°·É¢·Éê', 'error');
    return;
  }

  if (!password) {
    showStatus('emailStatus', '·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·Éû·Éê·É†·Éù·Éö·Éò', 'error');
    return;
  }

  try {
    // Verify password by re-authenticating
    const credential = firebase.auth.EmailAuthProvider.credential(
      currentUser.email,
      password
    );
    await currentUser.reauthenticateWithCredential(credential);

    const token = await currentUser.getIdToken();
    const res = await fetch('/api/profile', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ action: 'updateEmail', email, currentPassword: password })
    });

    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || data.message || '·Éî·Éö·É§·Éù·É°·É¢·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê');
    }

    showStatus('emailStatus', data.message || '·Éî·Éö·É§·Éù·É°·É¢·Éê ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É®·Éî·Éò·É™·Éï·Éê·Éö·Éê', 'success');
    $('newEmail').value = '';
    $('emailPassword').value = '';
    
    // Reload user data
    await currentUser.reload();
  } catch (error) {
    if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
      showStatus('emailStatus', '·Éê·É†·Éê·É°·É¨·Éù·É†·Éò ·Éû·Éê·É†·Éù·Éö·Éò', 'error');
    } else {
      showStatus('emailStatus', error.message || '·É®·Éî·É™·Éì·Éù·Éõ·Éê ·Éî·Éö·É§·Éù·É°·É¢·Éò·É° ·É®·Éî·É™·Éï·Éö·Éò·É°·Éê·É°', 'error');
    }
  }
};

// Change Password Form
$('changePasswordForm').onsubmit = async (e) => {
  e.preventDefault();
  if (!currentUser) {
    alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·ÉÆ·Éï·Éò·Éì·Éî·Éó ·É°·Éò·É°·É¢·Éî·Éõ·Éê·É®·Éò');
    return;
  }

  const currentPassword = $('currentPassword').value;
  const newPassword = $('newPassword').value;
  const confirmPassword = $('confirmPassword').value;

  if (!currentPassword || !newPassword || !confirmPassword) {
    showStatus('passwordStatus', '·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éê·Éï·É°·Éù·Éó ·Éß·Éï·Éî·Éö·Éê ·Éï·Éî·Éö·Éò', 'error');
    return;
  }

  if (newPassword.length < 6) {
    showStatus('passwordStatus', '·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò ·É£·Éú·Éì·Éê ·Éò·Éß·Éù·É° ·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù', 'error');
    return;
  }

  if (newPassword !== confirmPassword) {
    showStatus('passwordStatus', '·Éû·Éê·É†·Éù·Éö·Éî·Éë·Éò ·Éê·É† ·Éî·Éõ·Éó·ÉÆ·Éï·Éî·Éï·Éê', 'error');
    return;
  }

  try {
    // Verify current password by re-authenticating
    const credential = firebase.auth.EmailAuthProvider.credential(
      currentUser.email,
      currentPassword
    );
    await currentUser.reauthenticateWithCredential(credential);

    const token = await currentUser.getIdToken();
    const res = await fetch('/api/profile', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ 
        action: 'updatePassword', 
        currentPassword, 
        newPassword, 
        confirmPassword 
      })
    });

    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || data.message || '·Éû·Éê·É†·Éù·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê');
    }

    showStatus('passwordStatus', data.message || '·Éû·Éê·É†·Éù·Éö·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É®·Éî·Éò·É™·Éï·Éê·Éö·Éê', 'success');
    $('currentPassword').value = '';
    $('newPassword').value = '';
    $('confirmPassword').value = '';
  } catch (error) {
    if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
      showStatus('passwordStatus', '·Éê·É†·Éê·É°·É¨·Éù·É†·Éò ·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éû·Éê·É†·Éù·Éö·Éò', 'error');
    } else {
      showStatus('passwordStatus', error.message || '·É®·Éî·É™·Éì·Éù·Éõ·Éê ·Éû·Éê·É†·Éù·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éò·É°·Éê·É°', 'error');
    }
  }
};

/* ---------- SELL TARGETS MANAGEMENT ---------- */
// sellTargets and portfolioHoldings are declared in GLOBALS section above

async function loadTargets() {
  if (!currentUser) return;
  
  try {
    const userId = currentUser.uid;
    const db = firebase.database();
    const targetsRef = db.ref(`users/${userId}/sellTargets`);
    
    targetsRef.once('value', (snapshot) => {
      sellTargets = snapshot.val() || {};
      renderTargets(); // Always render to show empty state if needed
    }, (error) => {
      console.error('Failed to load targets:', error);
      sellTargets = {};
      renderTargets(); // Always render to show empty state
    });
  } catch (e) {
    console.error('Load targets error:', e);
    sellTargets = {};
    renderTargets(); // Always render to show empty state
  }
}

function renderTargets() {
  const container = $('targetsList');
  if (!container) return;
  
  // Ensure sellTargets is initialized
  if (!sellTargets) {
    sellTargets = {};
  }
  
  const targetsArray = Object.entries(sellTargets).map(([id, target]) => ({ id, ...target }));
  
  if (targetsArray.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üéØ</div>
        <div class="empty-state-title">·Éí·Éê·É°·Éê·Éß·Éò·Éì·Éò ·Éõ·Éò·Éñ·Éú·Éî·Éë·Éò ·Éê·É† ·Éê·É†·Éò·É°</div>
        <div class="empty-state-text">·Éì·Éê·Éê·Éõ·Éê·É¢·Éî·Éó ·Éí·Éê·É°·Éê·Éß·Éò·Éì·Éò ·Éõ·Éò·Éñ·Éú·Éî·Éë·Éò ·Éó·É•·Éï·Éî·Éú·Éò ·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò·É°·Éó·Éï·Éò·É°, ·É†·Éê·Éó·Éê ·Éó·Éï·Éê·Éö·Éò ·Éê·Éì·Éî·Éï·Éú·Éù·Éó ·É°·Éê·Éõ·Éò·Éñ·Éú·Éî ·É§·Éê·É°·Éî·Éë·É°</div>
      </div>
    `;
    return;
  }
  
  // Group by token
  const grouped = {};
  targetsArray.forEach(target => {
    if (!grouped[target.tokenId]) {
      grouped[target.tokenId] = [];
    }
    grouped[target.tokenId].push(target);
  });
  
  let html = '';
  Object.entries(grouped).forEach(([tokenId, targets]) => {
    const token = cryptoData.find(t => t.id === tokenId);
    const currentPrice = token?.current_price || prices[tokenId] || 0;
    const tokenName = token?.name || tokenId;
    const tokenSymbol = token?.symbol?.toUpperCase() || tokenId.toUpperCase();
    const tokenImage = token?.image || '';
    
    // Find buy price from portfolio holdings
    let buyPrice = 0;
    const holding = Object.values(portfolioHoldings).find(h => h.tokenId === tokenId);
    if (holding && holding.buyPrice) {
      buyPrice = parseFloat(holding.buyPrice);
    }
    
    targets.sort((a, b) => a.targetPrice - b.targetPrice);
    
    html += `
      <div style="background:rgba(20,20,30,.4);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:16px;margin-bottom:12px;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.05);">
          ${tokenImage ? `<img src="${tokenImage}" style="width:32px;height:32px;border-radius:50%;border:1px solid rgba(255,255,255,.1);">` : '<div style="width:32px;height:32px;border-radius:50%;background:rgba(99,102,241,.2);display:flex;align-items:center;justify-content:center;font-size:14px;color:#6366f1;">üí∞</div>'}
          <div>
            <div style="font-weight:600;font-size:14px;color:#fafafa;">${tokenName}</div>
            <div style="font-size:11px;color:#71717a;margin-top:2px;">${tokenSymbol}</div>
          </div>
          <div style="margin-left:auto;display:flex;gap:20px;text-align:right;">
            ${buyPrice > 0 ? `
              <div>
                <div style="font-size:11px;color:#9aa0a6;margin-bottom:4px;">·É®·Éî·É°·Éß·Éò·Éì·Éï·Éò·É° ·É§·Éê·É°·Éò</div>
                <div style="font-weight:600;font-size:14px;color:#fafafa;">$${formatPrice(buyPrice)}</div>
              </div>
            ` : ''}
            <div>
              <div style="font-size:11px;color:#9aa0a6;margin-bottom:4px;">·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·É§·Éê·É°·Éò</div>
              <div style="font-weight:600;font-size:16px;color:#fafafa;">$${formatPrice(currentPrice)}</div>
            </div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;">
    `;
    
    targets.forEach(target => {
      // Calculate distance from buy price (if available) or current price
      const basePrice = buyPrice > 0 ? buyPrice : currentPrice;
      const distance = basePrice > 0 ? ((target.targetPrice - basePrice) / basePrice * 100) : 0;
      const distanceColor = distance >= 0 ? '#22c55e' : '#ef4444';
      const distanceText = distance >= 0 ? `+${distance.toFixed(2)}%` : `${distance.toFixed(2)}%`;
      const isReached = currentPrice >= target.targetPrice;
      
      html += `
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:12px;align-items:center;padding:12px;background:rgba(10,14,26,.3);border-radius:8px;border:1px solid ${isReached ? 'rgba(34,197,94,.3)' : 'rgba(255,255,255,.05)'};">
          <div>
            <div style="font-size:11px;color:#9aa0a6;margin-bottom:4px;">·É°·Éê·Éõ·Éò·Éñ·Éú·Éî ·É§·Éê·É°·Éò</div>
            <div style="font-weight:600;font-size:14px;color:#fafafa;">$${formatPrice(target.targetPrice)}</div>
          </div>
          <div>
            <div style="font-size:11px;color:#9aa0a6;margin-bottom:4px;">·Éó·Éê·É†·Éí·Éî·Éó·Éò</div>
            <div style="font-weight:600;font-size:14px;color:${distanceColor};">${distanceText}</div>
          </div>
          <div>
            <div style="font-size:11px;color:#9aa0a6;margin-bottom:4px;">·Éí·Éê·É°·Éê·Éß·Éò·Éì·Éò %</div>
            <div style="font-weight:600;font-size:14px;color:#fafafa;">${target.percentage}%</div>
          </div>
          <div>
            <div style="font-size:11px;color:#9aa0a6;margin-bottom:4px;">·É°·É¢·Éê·É¢·É£·É°·Éò</div>
            <div style="font-weight:600;font-size:12px;color:${isReached ? '#22c55e' : '#9aa0a6'};">
              ${isReached ? '‚úì ·Éõ·Éò·É¶·É¨·Éî·É£·Éö·Éò' : '·Éõ·Éù·Éö·Éù·Éì·Éò·Éú·É®·Éò'}
            </div>
          </div>
          <div style="display:flex;gap:6px;">
            <button onclick="editTarget('${target.id}')" style="padding:6px 12px;background:rgba(99,102,241,.1);border:1px solid rgba(99,102,241,.3);color:#6366f1;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;transition:all .2s;">·É†·Éî·Éì·Éê·É•·É¢·Éò·É†·Éî·Éë·Éê</button>
            <button onclick="deleteTarget('${target.id}')" style="padding:6px 12px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#ef4444;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;transition:all .2s;">·É¨·Éê·É®·Éö·Éê</button>
          </div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

async function addTarget() {
  if (!currentUser) {
    alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·ÉÆ·Éï·Éò·Éì·Éî·Éó ·É°·Éò·É°·É¢·Éî·Éõ·Éê·É®·Éò');
    return;
  }
  
  const tokenId = $('targetToken')?.value;
  const targetPrice = parseFloat($('targetSellPrice')?.value);
  const percentage = parseFloat($('targetSellPercentage')?.value);
  
  if (!tokenId || !tokenId.trim()) {
    alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·É¢·Éù·Éô·Éî·Éú·Éò');
    return;
  }
  
  if (isNaN(targetPrice) || targetPrice <= 0) {
    alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·É°·É¨·Éù·É†·Éò ·É°·Éê·Éõ·Éò·Éñ·Éú·Éî ·É§·Éê·É°·Éò');
    return;
  }
  
  if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
    alert('·Éí·Éê·É°·Éê·Éß·Éò·Éì·Éò ·Éû·É†·Éù·É™·Éî·Éú·É¢·Éò ·É£·Éú·Éì·Éê ·Éò·Éß·Éù·É° 0-100 ·Éì·Éò·Éê·Éû·Éê·Éñ·Éù·Éú·É®·Éò');
    return;
  }
  
  try {
    const userId = currentUser.uid;
    const db = firebase.database();
    const targetsRef = db.ref(`users/${userId}/sellTargets`);
    const newTargetRef = targetsRef.push();
    
    await newTargetRef.set({
      tokenId,
      targetPrice,
      percentage
    });
    
    $('addTargetForm').reset();
    await loadTargets();
  } catch (e) {
    alert('·Éõ·Éò·Éñ·Éú·Éò·É° ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + e.message);
    console.error('Add target error:', e);
  }
}

async function deleteTarget(targetId) {
  if (!confirm('·Éì·Éê·É†·É¨·Éõ·É£·Éú·Éî·Éë·É£·Éö·Éò ·ÉÆ·Éê·É†·Éó, ·É†·Éù·Éõ ·Éí·É°·É£·É†·Éó ·Éê·Éõ ·Éõ·Éò·Éñ·Éú·Éò·É° ·É¨·Éê·É®·Éö·Éê?')) return;
  
  if (!currentUser) return;
  
  try {
    const userId = currentUser.uid;
    const db = firebase.database();
    await db.ref(`users/${userId}/sellTargets/${targetId}`).remove();
    await loadTargets();
  } catch (e) {
    alert('·Éõ·Éò·Éñ·Éú·Éò·É° ·É¨·Éê·É®·Éö·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + e.message);
    console.error('Delete target error:', e);
  }
}

window.editTarget = function(targetId) {
  // Ensure sellTargets is initialized
  if (!sellTargets) {
    sellTargets = {};
  }
  const target = sellTargets[targetId];
  if (!target) {
    alert('·Éõ·Éò·Éñ·Éê·Éú·Éò ·Éï·Éî·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê');
    return;
  }
  
  const newPrice = prompt('·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî·Éó ·Éê·ÉÆ·Éê·Éö·Éò ·É°·Éê·Éõ·Éò·Éñ·Éú·Éî ·É§·Éê·É°·Éò:', target.targetPrice);
  if (newPrice === null || isNaN(parseFloat(newPrice))) return;
  
  const newPercentage = prompt('·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éî·Éó ·Éí·Éê·É°·Éê·Éß·Éò·Éì·Éò ·Éû·É†·Éù·É™·Éî·Éú·É¢·Éò:', target.percentage);
  if (newPercentage === null || isNaN(parseFloat(newPercentage))) return;
  
  updateTarget(targetId, parseFloat(newPrice), parseFloat(newPercentage));
};

async function updateTarget(targetId, targetPrice, percentage) {
  if (!currentUser) return;
  
  if (percentage <= 0 || percentage > 100) {
    alert('·Éû·É†·Éù·É™·Éî·Éú·É¢·Éò ·É£·Éú·Éì·Éê ·Éò·Éß·Éù·É° 0-100 ·Éì·Éò·Éê·Éû·Éê·Éñ·Éù·Éú·É®·Éò');
    return;
  }
  
  try {
    const userId = currentUser.uid;
    const db = firebase.database();
    await db.ref(`users/${userId}/sellTargets/${targetId}`).update({
      targetPrice,
      percentage
    });
    await loadTargets();
  } catch (e) {
    alert('·Éõ·Éò·Éñ·Éú·Éò·É° ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + e.message);
    console.error('Update target error:', e);
  }
}

function populateTargetTokenSelect() {
  const select = $('targetToken');
  if (!select || !cryptoData || cryptoData.length === 0) return;
  
  select.innerHTML = '<option value="">·Éê·Éò·É†·É©·Éò·Éî·Éó ·É¢·Éù·Éô·Éî·Éú·Éò</option>';
  cryptoData.forEach(token => {
    const option = document.createElement('option');
    option.value = token.id;
    option.textContent = `${token.name} (${token.symbol?.toUpperCase() || token.id})`;
    select.appendChild(option);
  });
}

// Helper function to show status messages
function showStatus(elementId, message, type) {
  const element = $(elementId);
  if (!element) return;
  
  element.textContent = message;
  element.style.display = 'block';
  
  if (type === 'success') {
    element.style.background = 'rgba(34,197,94,.1)';
    element.style.border = '1px solid rgba(34,197,94,.25)';
    element.style.color = '#22c55e';
  } else {
    element.style.background = 'rgba(239,68,68,.1)';
    element.style.border = '1px solid rgba(239,68,68,.25)';
    element.style.color = '#ef4444';
  }
  
  // Auto-hide after 5 seconds
  setTimeout(() => {
    element.style.display = 'none';
  }, 5000);
}

/* ---------- ADMIN ADD TOKEN (with CoinGecko Search) ---------- */
let selectedTokenId = null;
let searchTimeout = null;

// Token search functionality
$('tokenSearch').oninput = async (e) => {
  const query = e.target.value.trim();
  const resultsDiv = $('tokenSearchResults');
  
  if (query.length < 2) {
    resultsDiv.style.display = 'none';
    selectedTokenId = null;
    $('selectedToken').style.display = 'none';
    $('confirmAdd').disabled = true;
    return;
  }
  
  // Debounce search
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    try {
      resultsDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">·É´·Éò·Éî·Éë·Éê...</div>';
      resultsDiv.style.display = 'block';
      
      const res = await fetch(`/api/search-tokens?query=${encodeURIComponent(query)}`);
      const data = await res.json();
      
      if (!res.ok || !data.success) {
        throw new Error(data.error || '·É´·Éò·Éî·Éë·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê');
      }
      
      if (data.tokens.length === 0) {
        resultsDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê</div>';
        return;
      }
      
      resultsDiv.innerHTML = data.tokens.map(token => `
        <div class="token-result-item" onclick="selectToken('${token.id}', '${token.name}', '${token.symbol}')" 
          style="padding:14px 18px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.06);transition:all .25s;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:600;color:#e8eaed;font-size:14px;letter-spacing:-0.2px;">${token.name}</div>
            <div style="font-size:12px;color:#9aa0a6;margin-top:3px;font-weight:400;">${token.symbol} ‚Ä¢ ${token.id}</div>
          </div>
          <span style="color:#8b5cf6;font-size:18px;opacity:0.7;">‚Üí</span>
        </div>
      `).join('');
      
      // Add hover effect
      resultsDiv.querySelectorAll('.token-result-item').forEach(item => {
        item.onmouseenter = () => {
          item.style.background = 'rgba(139,92,246,.08)';
          item.style.borderBottomColor = 'rgba(255,255,255,.1)';
        };
        item.onmouseleave = () => {
          item.style.background = 'transparent';
          item.style.borderBottomColor = 'rgba(255,255,255,.06)';
        };
      });
      
    } catch (error) {
      console.error('Search error:', error);
      resultsDiv.innerHTML = `<div style="padding:20px;text-align:center;color:#ef4444;">·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${error.message}</div>`;
    }
  }, 300);
};

// Select token from search results
window.selectToken = (id, name, symbol) => {
  selectedTokenId = id;
  $('tokenSearch').value = name;
  $('tokenSearchResults').style.display = 'none';
  $('selectedTokenName').textContent = `${name} (${symbol})`;
  $('selectedTokenId').textContent = `ID: ${id}`;
  $('selectedToken').style.display = 'block';
  $('confirmAdd').disabled = false;
};

// Clear selection
$('clearSelection').onclick = () => {
  selectedTokenId = null;
  $('tokenSearch').value = '';
  $('selectedToken').style.display = 'none';
  $('confirmAdd').disabled = true;
  $('tokenSearchResults').style.display = 'none';
};

// Close search results when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('#tokenSearch') && !e.target.closest('#tokenSearchResults')) {
    $('tokenSearchResults').style.display = 'none';
  }
});

// Add token
$('confirmAdd').onclick = async () => {
  if (!selectedTokenId) return alert('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·É¢·Éù·Éô·Éî·Éú·Éò');
  
  const statusDiv = $('addTokenStatus');
  statusDiv.style.display = 'block';
  statusDiv.style.background = 'rgba(59,130,246,.1)';
  statusDiv.style.border = '1px solid rgba(59,130,246,.3)';
  statusDiv.style.color = '#3b82f6';
  statusDiv.textContent = '·É¢·Éù·Éô·Éî·Éú·Éò·É° ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê...';
  $('confirmAdd').disabled = true;
  
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id: selectedTokenId })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    statusDiv.style.background = 'rgba(16,185,129,.1)';
    statusDiv.style.border = '1px solid rgba(16,185,129,.3)';
    statusDiv.style.color = '#10b981';
    statusDiv.textContent = `‚úÖ ${data.message || `·É¢·Éù·Éô·Éî·Éú·Éò "${selectedTokenId}" ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·Éì·Éê·Éî·Éõ·Éê·É¢·Éê!`}`;
    
    setTimeout(() => {
    $('addTokenModal').classList.remove('show');
      $('tokenSearch').value = '';
      $('selectedToken').style.display = 'none';
      selectedTokenId = null;
      $('confirmAdd').disabled = true;
      statusDiv.style.display = 'none';
    fetchAll();
    }, 1500);
    
  } catch (e) {
    statusDiv.style.background = 'rgba(239,68,68,.1)';
    statusDiv.style.border = '1px solid rgba(239,68,68,.3)';
    statusDiv.style.color = '#ef4444';
    statusDiv.textContent = `‚ùå ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${e.message}`;
    $('confirmAdd').disabled = false;
    console.error('Token add error:', e);
  }
};

/* ---------- RENDER FUNCTIONS (same as before) ---------- */
function renderPortfolio(holdings) {
  const list = $('holdingsList');
  if (!list) {
    console.warn('holdingsList element not found');
    return;
  }
  
  list.innerHTML = '';
  let totalValue = 0, totalCost = 0;
  
  if (!holdings || Object.keys(holdings).length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üíº</div>
        <div class="empty-state-title">·Éû·Éù·É†·É¢·É§·Éù·Éö·Éò·Éù ·É™·Éê·É†·Éò·Éî·Éö·Éò·Éê</div>
        <div class="empty-state-text">·Éì·Éê·Éê·Éõ·Éê·É¢·Éî·Éó ·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò ·Éó·É•·Éï·Éî·Éú·É° ·Éû·Éù·É†·É¢·É§·Éù·Éö·Éò·Éù·É®·Éò, ·É†·Éê·Éó·Éê ·Éì·Éê·Éò·É¨·Éß·Éù·Éó ·Éó·É•·Éï·Éî·Éú·Éò ·Éò·Éú·Éï·Éî·É°·É¢·Éò·É™·Éò·Éî·Éë·Éò·É° ·Éó·Éï·Éê·Éö·Éß·É£·É†·Éì·Éî·Éï·Éú·Éî·Éë·Éê</div>
      </div>
    `;
    if ($('totalValue')) $('totalValue').textContent = '$0.00';
    if ($('totalPL')) {
      $('totalPL').textContent = '$0.00';
      $('totalPL').style.color = '#9aa0a6';
      // Reset card colors to default
      const plCard = $('totalPL').closest('.summary-card');
      if (plCard) {
        plCard.style.borderColor = 'rgba(139,92,246,.15)';
        plCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(26,10,46,.6) 100%)';
        const valueEl = plCard.querySelector('.summary-value');
        if (valueEl) {
          valueEl.style.background = 'linear-gradient(135deg,#ffffff 0%,#e9d5ff 100%)';
          valueEl.style.webkitBackgroundClip = 'text';
          valueEl.style.backgroundClip = 'text';
          valueEl.style.webkitTextFillColor = 'transparent';
        }
      }
    }
    if ($('roi')) {
      $('roi').textContent = '0%';
      $('roi').style.color = '#9aa0a6';
      // Reset card colors to default
      const roiCard = $('roi').closest('.summary-card');
      if (roiCard) {
        roiCard.style.borderColor = 'rgba(139,92,246,.15)';
        roiCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(26,10,46,.6) 100%)';
        const valueEl = roiCard.querySelector('.summary-value');
        if (valueEl) {
          valueEl.style.background = 'linear-gradient(135deg,#ffffff 0%,#e9d5ff 100%)';
          valueEl.style.webkitBackgroundClip = 'text';
          valueEl.style.backgroundClip = 'text';
          valueEl.style.webkitTextFillColor = 'transparent';
        }
      }
    }
    return;
  }
  
  Object.entries(holdings || {}).forEach(([id, h]) => {
    if (!h || !h.tokenId) return; // Skip invalid holdings
    const token = cryptoData.find(t => t.id === h.tokenId) || { 
      name: h.tokenId || 'Unknown Token', 
      symbol: h.tokenId ? h.tokenId.toUpperCase().substring(0, 4) : 'UNK', 
      image: 'https://via.placeholder.com/32?text=?' 
    };
    const price = prices[h.tokenId] || 0;
    const value = h.amount * price;
    const cost = h.amount * h.buyPrice;
    totalValue += value;
    totalCost += cost;
    const pl = value - cost;
    const plPct = cost > 0 ? (pl / cost * 100) : 0;
    const plClass = pl >= 0 ? 'positive' : 'negative';
    const plSign = pl >= 0 ? '+' : '';
    
    list.innerHTML += `
      <div class="holding-row" data-id="${id}">
        <div class="holding-header">
          <div class="holding-icon-wrapper">
            <img src="${token.image || 'https://via.placeholder.com/44'}" onerror="this.parentElement.innerHTML='<span style=\\'font-size:20px;color:#6366f1\\'>üí∞</span>'">
        </div>
          <div class="holding-info">
            <div class="holding-name">${token.name || h.tokenId || 'Unknown'}</div>
            <div class="holding-symbol">${token.symbol ? token.symbol.toUpperCase() : (h.tokenId ? h.tokenId.toUpperCase().substring(0, 6) : 'UNK')}</div>
          </div>
        </div>
        <div class="holding-stats">
          <div class="holding-stat">
            <div class="holding-stat-label">·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê</div>
            <div class="holding-stat-value editable" data-field="amount" data-value="${h.amount}">${formatPrice(h.amount)}</div>
          </div>
          <div class="holding-stat">
            <div class="holding-stat-label">·É®·Éî·É°·Éß·Éò·Éì·Éï·Éò·É° ·É§·Éê·É°·Éò</div>
            <div class="holding-stat-value editable" data-field="buyPrice" data-value="${h.buyPrice}">$${formatPrice(h.buyPrice)}</div>
          </div>
          <div class="holding-stat">
            <div class="holding-stat-label">·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·É§·Éê·É°·Éò</div>
            <div class="holding-stat-value">$${formatPrice(price)}</div>
          </div>
          <div class="holding-stat">
            <div class="holding-stat-label">·É¶·Éò·É†·Éî·Éë·É£·Éö·Éî·Éë·Éê</div>
            <div class="holding-stat-value">$${formatPrice(value)}</div>
          </div>
          <div class="holding-stat">
            <div class="holding-stat-label">PNL</div>
            <div class="holding-stat-value ${plClass}">${plSign}$${formatPrice(Math.abs(pl))}</div>
          </div>
          <div class="holding-stat">
            <div class="holding-stat-label">ROI</div>
            <div class="holding-stat-value ${plClass}">${plSign}${plPct.toFixed(2)}%</div>
          </div>
        </div>
        <div class="holding-actions">
          <button class="edit-btn" onclick="editHolding('${id}', '${h.tokenId}', ${h.amount}, ${h.buyPrice})" title="·É†·Éî·Éì·Éê·É•·É¢·Éò·É†·Éî·Éë·Éê">‚úèÔ∏è ·É†·Éî·Éì·Éê·É•·É¢·Éò·É†·Éî·Éë·Éê</button>
          <button class="delete-btn" onclick="deleteHolding('${id}')" title="·É¨·Éê·É®·Éö·Éê">üóëÔ∏è ·É¨·Éê·É®·Éö·Éê</button>
        </div>
      </div>`;
  });
  
  // Store previous values for animation
  const prevTotalValue = parseFloat($('totalValue')?.textContent.replace(/[^0-9.-]/g, '') || '0');
  const prevPL = parseFloat($('totalPL')?.textContent.replace(/[^0-9.-]/g, '') || '0');
  const prevROI = parseFloat($('roi')?.textContent.replace(/[^0-9.-]/g, '') || '0');
  
  const pl = totalValue - totalCost;
  const roi = totalCost > 0 ? ((totalValue / totalCost - 1) * 100) : 0;
  
  // Animate value changes
  if ($('totalValue')) {
    const newValue = totalValue.toFixed(2);
    if (Math.abs(prevTotalValue - totalValue) > 0.01) {
      animateValue($('totalValue'), `$${prevTotalValue.toFixed(2)}`, `$${newValue}`, 800);
    } else {
      $('totalValue').textContent = `$${newValue}`;
    }
  }
  
  // Update Total P/L card with conditional colors and animation
  if ($('totalPL')) {
    const newPL = pl >= 0 ? `+$${pl.toFixed(2)}` : `-$${Math.abs(pl).toFixed(2)}`;
    if (Math.abs(prevPL - pl) > 0.01) {
      animateValue($('totalPL'), prevPL >= 0 ? `+$${Math.abs(prevPL).toFixed(2)}` : `-$${Math.abs(prevPL).toFixed(2)}`, newPL, 800);
    } else {
      $('totalPL').textContent = newPL;
    }
  $('totalPL').style.color = pl >= 0 ? '#10b981' : '#ef4444';
    
    // Update parent summary card colors
    const plCard = $('totalPL').closest('.summary-card');
    if (plCard) {
      if (pl >= 0) {
        plCard.style.borderColor = 'rgba(16,185,129,.3)';
        plCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(16,185,129,.08) 100%)';
        plCard.querySelector('.summary-value').style.background = 'linear-gradient(135deg,#10b981 0%,#059669 100%)';
        plCard.querySelector('.summary-value').style.webkitBackgroundClip = 'text';
        plCard.querySelector('.summary-value').style.backgroundClip = 'text';
        plCard.querySelector('.summary-value').style.webkitTextFillColor = 'transparent';
      } else {
        plCard.style.borderColor = 'rgba(239,68,68,.3)';
        plCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(239,68,68,.08) 100%)';
        plCard.querySelector('.summary-value').style.background = 'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)';
        plCard.querySelector('.summary-value').style.webkitBackgroundClip = 'text';
        plCard.querySelector('.summary-value').style.backgroundClip = 'text';
        plCard.querySelector('.summary-value').style.webkitTextFillColor = 'transparent';
      }
    }
  }
  
  // Update ROI card with conditional colors and animation
  if ($('roi')) {
    const newROI = totalCost > 0 ? `${roi >= 0 ? '+' : ''}${roi.toFixed(2)}%` : '0%';
    if (Math.abs(prevROI - roi) > 0.01) {
      animateValue($('roi'), `${prevROI >= 0 ? '+' : ''}${prevROI.toFixed(2)}%`, newROI, 800);
    } else {
      $('roi').textContent = newROI;
    }
    $('roi').style.color = roi >= 0 ? '#10b981' : '#ef4444';
    
    // Update parent summary card colors
    const roiCard = $('roi').closest('.summary-card');
    if (roiCard) {
      if (roi >= 0) {
        roiCard.style.borderColor = 'rgba(16,185,129,.3)';
        roiCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(16,185,129,.08) 100%)';
        roiCard.querySelector('.summary-value').style.background = 'linear-gradient(135deg,#10b981 0%,#059669 100%)';
        roiCard.querySelector('.summary-value').style.webkitBackgroundClip = 'text';
        roiCard.querySelector('.summary-value').style.backgroundClip = 'text';
        roiCard.querySelector('.summary-value').style.webkitTextFillColor = 'transparent';
      } else {
        roiCard.style.borderColor = 'rgba(239,68,68,.3)';
        roiCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(239,68,68,.08) 100%)';
        roiCard.querySelector('.summary-value').style.background = 'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)';
        roiCard.querySelector('.summary-value').style.webkitBackgroundClip = 'text';
        roiCard.querySelector('.summary-value').style.backgroundClip = 'text';
        roiCard.querySelector('.summary-value').style.webkitTextFillColor = 'transparent';
      }
    }
  }
  document.querySelectorAll('.editable').forEach(el => el.onclick = () => startEdit(el));
  
  // Update Portfolio Analytics
  updatePortfolioAnalytics(holdings, totalValue);
}

/* ---------- PORTFOLIO ANALYTICS ---------- */
function updatePortfolioAnalytics(holdings, totalValue) {
  if (!holdings || Object.keys(holdings).length === 0) {
    if ($('portfolioAnalytics')) $('portfolioAnalytics').style.display = 'none';
    return;
  }
  
  if ($('portfolioAnalytics')) $('portfolioAnalytics').style.display = 'block';
  
  // Calculate allocation with token IDs for categorization
  const allocation = {};
  const allocationByTokenId = {}; // Store by tokenId for categorization
  let totalAllocation = 0;
  
  Object.entries(holdings).forEach(([id, h]) => {
    if (!h || !h.tokenId) return;
    const price = prices[h.tokenId] || 0;
    const value = h.amount * price;
    if (value > 0) {
      const token = cryptoData.find(t => t.id === h.tokenId);
      const tokenName = token?.symbol?.toUpperCase() || h.tokenId.toUpperCase().substring(0, 4);
      allocation[tokenName] = (allocation[tokenName] || 0) + value;
      allocationByTokenId[h.tokenId] = (allocationByTokenId[h.tokenId] || 0) + value;
      totalAllocation += value;
    }
  });
  
  // Draw pie chart
  const canvas = $('allocationChart');
  if (canvas && totalAllocation > 0) {
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 10;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#a78bfa'];
    let currentAngle = -Math.PI / 2;
    
    const legendDiv = $('allocationLegend');
    if (legendDiv) legendDiv.innerHTML = '';
    
    Object.entries(allocation)
      .sort((a, b) => b[1] - a[1])
      .forEach(([token, value], idx) => {
        const percentage = (value / totalAllocation) * 100;
        const sliceAngle = (value / totalAllocation) * 2 * Math.PI;
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = colors[idx % colors.length];
        ctx.fill();
        
        // Add legend
        if (legendDiv && percentage > 2) {
          const legendItem = document.createElement('div');
          legendItem.style.display = 'flex';
          legendItem.style.alignItems = 'center';
          legendItem.style.gap = '10px';
          legendItem.style.padding = '12px 16px';
          legendItem.style.background = 'rgba(15,23,42,.4)';
          legendItem.style.borderRadius = '12px';
          legendItem.style.border = '2px solid rgba(99,102,241,.2)';
          legendItem.style.transition = 'all .4s cubic-bezier(.34,1.56,.64,1)';
          legendItem.style.cursor = 'pointer';
          legendItem.style.boxShadow = '0 4px 12px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.05)';
          legendItem.style.position = 'relative';
          legendItem.style.overflow = 'hidden';
          
          const colorBox = document.createElement('div');
          colorBox.style.width = '16px';
          colorBox.style.height = '16px';
          colorBox.style.borderRadius = '6px';
          colorBox.style.background = colors[idx % colors.length];
          colorBox.style.boxShadow = `0 4px 12px ${colors[idx % colors.length]}40, 0 2px 4px rgba(0,0,0,.3)`;
          colorBox.style.border = '2px solid rgba(255,255,255,.1)';
          colorBox.style.transition = 'all .3s';
          
          const tokenName = document.createElement('span');
          tokenName.style.color = '#cbd5e1';
          tokenName.style.fontSize = '14px';
          tokenName.style.fontWeight = '600';
          tokenName.style.textShadow = '0 1px 2px rgba(0,0,0,.3)';
          tokenName.textContent = token;
          
          const tokenPercent = document.createElement('span');
          tokenPercent.style.background = 'linear-gradient(135deg,#ffffff 0%,#e0e7ff 100%)';
          tokenPercent.style.webkitBackgroundClip = 'text';
          tokenPercent.style.webkitTextFillColor = 'transparent';
          tokenPercent.style.backgroundClip = 'text';
          tokenPercent.style.marginLeft = 'auto';
          tokenPercent.style.fontWeight = '700';
          tokenPercent.style.fontSize = '14px';
          tokenPercent.style.fontVariantNumeric = 'tabular-nums';
          tokenPercent.style.textShadow = '0 0 10px rgba(99,102,241,.3)';
          tokenPercent.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,.3))';
          tokenPercent.textContent = `${percentage.toFixed(1)}%`;
          
          legendItem.onmouseenter = function() {
            this.style.background = 'linear-gradient(145deg,#334155 0%,#1e293b 100%)';
            this.style.borderColor = 'rgba(99,102,241,.4)';
            this.style.transform = 'translateX(4px)';
            colorBox.style.transform = 'scale(1.2) rotate(5deg)';
            colorBox.style.boxShadow = `0 6px 20px ${colors[idx % colors.length]}60, 0 2px 4px rgba(0,0,0,.3)`;
          };
          legendItem.onmouseleave = function() {
            this.style.background = 'rgba(15,23,42,.4)';
            this.style.borderColor = 'rgba(99,102,241,.2)';
            this.style.transform = 'translateX(0)';
            colorBox.style.transform = 'scale(1) rotate(0deg)';
            colorBox.style.boxShadow = `0 4px 12px ${colors[idx % colors.length]}40, 0 2px 4px rgba(0,0,0,.3)`;
          };
          
          legendItem.appendChild(colorBox);
          legendItem.appendChild(tokenName);
          legendItem.appendChild(tokenPercent);
          legendDiv.appendChild(legendItem);
        }
        
        currentAngle += sliceAngle;
      });
  }
  
  // Calculate risk metrics
  const tokenCount = Object.keys(allocation).length;
  const largestPosition = Object.entries(allocation).sort((a, b) => b[1] - a[1])[0];
  const largestPercentage = largestPosition ? (largestPosition[1] / totalAllocation * 100) : 0;
  
  // Core-Satellite Model Target Allocations
  const CORE_ASSETS_TARGET = 0.60;      // Large-cap, long-term store of value
  const GROWTH_ASSETS_TARGET = 0.25;    // Mid-cap, ecosystem or infrastructure plays
  const HIGH_RISK_TARGET = 0.10;        // Small-cap, narrative or experimental tokens
  const STABLES_TARGET = 0.05;          // Stablecoins for liquidity and dip-buying
  
  // Define token categories by CoinGecko ID
  const CORE_ASSETS_IDS = ['bitcoin', 'ethereum'];
  const GROWTH_ASSETS_IDS = ['solana', 'chainlink', 'avalanche-2', 'arbitrum', 'cosmos', 'polkadot', 'matic-network', 'cardano', 'ripple', 'binancecoin', 'polygon', 'optimism-ethereum', 'near', 'aptos', 'sui', 'sei-network', 'injective-protocol', 'render-token'];
  const STABLES_IDS = ['usd-coin', 'tether', 'dai', 'binance-usd', 'true-usd', 'paxos-standard'];
  
  // Calculate actual allocations by category using token IDs
  let coreValue = 0;
  let growthValue = 0;
  let highRiskValue = 0;
  let stablesValue = 0;
  
  Object.entries(allocationByTokenId).forEach(([tokenId, value]) => {
    const tokenIdLower = tokenId.toLowerCase();
    // Check if token matches any category (exact or partial match)
    if (CORE_ASSETS_IDS.some(id => tokenIdLower === id || tokenIdLower.includes(id))) {
      coreValue += value;
    } else if (STABLES_IDS.some(id => tokenIdLower === id || tokenIdLower.includes(id))) {
      stablesValue += value;
    } else if (GROWTH_ASSETS_IDS.some(id => tokenIdLower === id || tokenIdLower.includes(id))) {
      growthValue += value;
    } else {
      // Everything else is considered HIGH_RISK
      highRiskValue += value;
    }
  });
  
  // Calculate percentages
  const corePercentage = totalAllocation > 0 ? coreValue / totalAllocation : 0;
  const growthPercentage = totalAllocation > 0 ? growthValue / totalAllocation : 0;
  const highRiskPercentage = totalAllocation > 0 ? highRiskValue / totalAllocation : 0;
  const stablesPercentage = totalAllocation > 0 ? stablesValue / totalAllocation : 0;
  
  // Calculate diversification score based on how close actual is to target
  // Score = 100 - (sum of absolute differences from target * penalty factor)
  const coreDiff = Math.abs(corePercentage - CORE_ASSETS_TARGET);
  const growthDiff = Math.abs(growthPercentage - GROWTH_ASSETS_TARGET);
  const highRiskDiff = Math.abs(highRiskPercentage - HIGH_RISK_TARGET);
  const stablesDiff = Math.abs(stablesPercentage - STABLES_TARGET);
  
  // Weighted penalty (core allocation is most important)
  // Normalize deviations to 0-1 scale, then apply weights
  const totalDeviation = (coreDiff * 2.0) + (growthDiff * 1.5) + (highRiskDiff * 1.0) + (stablesDiff * 0.5);
  
  // Maximum possible deviation (if all categories are 100% off target)
  // Core: 0.6*2.0 = 1.2, Growth: 0.25*1.5 = 0.375, HighRisk: 0.1*1.0 = 0.1, Stables: 0.05*0.5 = 0.025
  // Total max = 1.7
  const maxPossibleDeviation = 1.7;
  
  // Calculate score: 100 * (1 - normalized deviation)
  const normalizedDeviation = Math.min(1, totalDeviation / maxPossibleDeviation);
  const diversificationScore = Math.max(0, Math.min(100, Math.round(100 * (1 - normalizedDeviation))));
  
  // Debug logging
  console.log('Diversification Calculation:', {
    core: `${(corePercentage * 100).toFixed(1)}% (target: ${(CORE_ASSETS_TARGET * 100).toFixed(1)}%)`,
    growth: `${(growthPercentage * 100).toFixed(1)}% (target: ${(GROWTH_ASSETS_TARGET * 100).toFixed(1)}%)`,
    highRisk: `${(highRiskPercentage * 100).toFixed(1)}% (target: ${(HIGH_RISK_TARGET * 100).toFixed(1)}%)`,
    stables: `${(stablesPercentage * 100).toFixed(1)}% (target: ${(STABLES_TARGET * 100).toFixed(1)}%)`,
    totalDeviation,
    score: diversificationScore
  });
  
  if ($('diversificationScore')) $('diversificationScore').textContent = `${Math.round(diversificationScore)}/100`;
  if ($('diversificationBar')) $('diversificationBar').style.width = `${diversificationScore}%`;
  if ($('largestPosition')) $('largestPosition').textContent = largestPosition ? `${largestPosition[0]} (${largestPercentage.toFixed(1)}%)` : '-';
  if ($('tokenCount')) $('tokenCount').textContent = tokenCount;
}

// Toggle analytics visibility
if ($('toggleAnalytics')) {
  let analyticsVisible = true;
  $('toggleAnalytics').onclick = () => {
    analyticsVisible = !analyticsVisible;
    const analyticsDiv = $('portfolioAnalytics');
    if (analyticsDiv) {
      if (analyticsVisible) {
        analyticsDiv.style.display = 'block';
        $('toggleAnalytics').textContent = '·Éì·Éê·Éõ·Éê·Éö·Éï·Éê';
        $('toggleAnalytics').setAttribute('aria-expanded', 'true');
      } else {
        analyticsDiv.style.display = 'none';
        $('toggleAnalytics').textContent = '·É©·Éï·Éî·Éú·Éî·Éë·Éê';
        $('toggleAnalytics').setAttribute('aria-expanded', 'false');
      }
    }
  };
}

function startEdit(el) {
  if (el.querySelector('input')) return;
  const field = el.dataset.field;
  const value = el.dataset.value;
  const input = document.createElement('input');
  input.type = 'number';
  input.step = 'any';
  input.value = value;
  input.style.width = '80px';
  input.style.padding = '4px 8px';
  input.style.background = '#0a0a0a';
  input.style.border = '1px solid #8b5cf6';
  input.style.borderRadius = '8px';
  input.style.color = '#fff';
  input.style.fontSize = '14px';
  const saveBtn = document.createElement('span');
  saveBtn.textContent = 'Save';
  saveBtn.style.cursor = 'pointer';
  saveBtn.style.color = '#10b981';
  saveBtn.style.marginLeft = '8px';
  saveBtn.style.fontWeight = '700';
  const cancelBtn = document.createElement('span');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.style.cursor = 'pointer';
  cancelBtn.style.color = '#ef4444';
  cancelBtn.style.marginLeft = '8px';
  cancelBtn.style.fontWeight = '700';
  el.innerHTML = '';
  el.appendChild(input);
  el.appendChild(saveBtn);
  el.appendChild(cancelBtn);
  input.focus();
  const save = async () => {
    const newVal = parseFloat(input.value);
    if (isNaN(newVal) || newVal < 0) return alert('·Éê·É†·Éê·É°·É¨·Éù·É†·Éò ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éë·Éê');
    const holdingId = el.closest('.holding-row').dataset.id;
    await updateHolding(holdingId, field, newVal);
  };
  saveBtn.onclick = save;
  input.onkeypress = e => e.key === 'Enter' && save();
  cancelBtn.onclick = () => loadPortfolio();
}

function renderAlerts(alerts) {
  const list = $('alertsList');
  if (!list) return;
  list.innerHTML = '';
  if (!alerts || Object.keys(alerts).length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üîî</div>
        <div class="empty-state-title">·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éî·Éë·Éò ·Éê·É† ·Éê·É†·Éò·É°</div>
        <div class="empty-state-text">·Éì·Éê·Éê·Éõ·Éê·É¢·Éî·Éó ·É§·Éê·É°·Éò·É° ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éî·Éë·Éò, ·É†·Éê·Éó·Éê ·Éõ·Éò·Éò·É¶·Éù·Éó ·Éí·Éê·É§·É†·Éó·ÉÆ·Éò·Éö·Éî·Éë·Éî·Éë·Éò, ·É†·Éù·Éì·Éî·É°·Éê·É™ ·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò ·Éõ·Éò·Éê·É¶·É¨·Éî·Éï·Éî·Éú ·É°·Éê·Éõ·Éò·Éñ·Éú·Éî ·É§·Éê·É°·Éî·Éë·É°</div>
      </div>
    `;
    populateTokenSelect('alertToken');
    return;
  }
  Object.entries(alerts || {}).forEach(([id, a]) => {
    if (!a || !a.tokenId) return; // Skip invalid alerts
    const token = cryptoData.find(t => t.id === a.tokenId);
    const tokenName = token?.name || a.tokenId || 'Unknown Token';
    const tokenImage = token?.image || 'https://via.placeholder.com/32?text=?';
    const price = prices[a.tokenId] || 0;
    const triggered = (a.condition === 'above' && price >= a.target) || (a.condition === 'below' && price <= a.target);
    list.innerHTML += `
      <div class="alert-row ${triggered ? 'triggered' : ''}">
        <div class="token-icon-col"><img src="${tokenImage}" class="token-icon" onerror="this.src='https://via.placeholder.com/32?text=?'"></div>
        <div>${tokenName}</div>
        <div>${a.condition === 'above' ? '>' : '<'} $${formatPrice(a.target || 0)}</div>
        <div>$${formatPrice(price)}</div>
        <div class="delete-btn" onclick="deleteAlert('${id}')">X</div>
      </div>`;
    if (triggered && !a.notified) {
      // Haptic feedback on mobile
      vibrate([100, 50, 100, 50, 100]); // Strong vibration pattern for alert trigger
      
      if (typeof confetti !== 'undefined') {
      confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
      }
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('CCX ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê', { body: `${a.message || ''} ${tokenName} ·Éê·É†·Éò·É° ${a.condition === 'above' ? '·Éñ·Éî·Éõ·Éù·Éó' : '·É•·Éï·Éî·Éõ·Éù·Éó'} $${a.target}!` });
      }
      
      // Announce to screen readers
      const liveRegion = document.getElementById('liveRegion');
      if (liveRegion) {
        liveRegion.textContent = `·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê ·Éí·Éê·Éê·É•·É¢·Éò·É£·É†·Éì·Éê: ${tokenName} ·Éê·É†·Éò·É° ${a.condition === 'above' ? '·Éñ·Éî·Éõ·Éù·Éó' : '·É•·Éï·Éî·Éõ·Éù·Éó'} $${a.target}`;
        setTimeout(() => liveRegion.textContent = '', 1000);
      }
    }
  });
  populateTokenSelect('alertToken');
}

/* ---------- POPULATE SELECTS ---------- */
function populateTokenSelect(id) {
  const sel = $(id);
  if (!sel) return; // Element doesn't exist
  sel.innerHTML = '<option value="">·É¢·Éù·Éô·Éî·Éú·Éò·É° ·Éê·É†·É©·Éî·Éï·Éê</option>';
  if (!cryptoData || cryptoData.length === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = '·É¢·Éù·Éô·Éî·Éú·Éî·Éë·Éò ·Éõ·Éò·É£·É¨·Éï·Éì·Éù·Éõ·Éî·Éö·Éò·Éê';
    opt.disabled = true;
    sel.appendChild(opt);
    return;
  }
  cryptoData.forEach(t => {
    if (!t || !t.id) return; // Skip invalid tokens
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = `${t.name || t.id} (${(t.symbol || t.id.substring(0, 4)).toUpperCase()})`;
    sel.appendChild(opt);
  });
}

/* ---------- MODAL HANDLERS ---------- */
$('addTokenBtn').onclick = () => {
  $('addTokenModal').classList.add('show');
  $('tokenSearch').focus();
};
$('closeModal').onclick = () => {
  $('addTokenModal').classList.remove('show');
  $('tokenSearch').value = '';
  $('selectedToken').style.display = 'none';
  $('tokenSearchResults').style.display = 'none';
  selectedTokenId = null;
  $('confirmAdd').disabled = true;
};
$('cancelAdd').onclick = () => {
  $('addTokenModal').classList.remove('show');
  $('tokenSearch').value = '';
  $('selectedToken').style.display = 'none';
  $('tokenSearchResults').style.display = 'none';
  selectedTokenId = null;
  $('confirmAdd').disabled = true;
};
$('refreshBtn').onclick = () => fetchAll();

/* ---------- AUTO REFRESH ---------- */
let refreshIntervalId = null;
let refreshIntervalMs = 180000; // Default 3 minutes

function startAutoRefresh() {
  if (refreshIntervalId) clearInterval(refreshIntervalId);
  refreshIntervalId = setInterval(() => {
  fetchAll();
  if (currentUser) {
    loadPortfolio();
    loadAlerts();
  }
  }, refreshIntervalMs);
}

// Load quotes function
let quotesData = [];
function loadQuotes() {
  try {
    if (typeof firebase === 'undefined' || !firebase.database) {
      console.warn('Firebase not available for quotes');
      return;
    }
    
    const db = firebase.database();
    if (!db) return;
    
    db.ref('quotes').once('value').then(snapshot => {
      const quotes = snapshot.val() || {};
      quotesData = Object.values(quotes).filter(q => q && q.text);
      
      if (quotesData.length > 0) {
        displayRandomQuote();
        if ($('quotesSection')) $('quotesSection').style.display = 'block';
      } else {
        if ($('quotesSection')) $('quotesSection').style.display = 'none';
      }
    }).catch(error => {
      console.error('Error loading quotes:', error);
      if ($('quotesSection')) $('quotesSection').style.display = 'none';
    });
  } catch (e) {
    console.error('Error in loadQuotes:', e);
  }
}

function displayRandomQuote() {
  if (!quotesData || quotesData.length === 0) {
    $('quoteContent').innerHTML = '<div style="color:#6b7280;font-size:13px;">·É™·Éò·É¢·Éê·É¢·Éî·Éë·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê</div>';
    $('quoteAuthor').textContent = '';
    return;
  }
  
  const randomQuote = quotesData[Math.floor(Math.random() * quotesData.length)];
  $('quoteContent').innerHTML = `"${randomQuote.text}"`;
  $('quoteAuthor').textContent = randomQuote.author ? `‚Äî ${randomQuote.author}` : '';
}

// Setup refresh quote button
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    const refreshBtn = $('refreshQuote');
    if (refreshBtn) {
      refreshBtn.onclick = displayRandomQuote;
    }
  });
} else {
  const refreshBtn = $('refreshQuote');
  if (refreshBtn) {
    refreshBtn.onclick = displayRandomQuote;
  }
}

// Load settings and start auto-refresh
fetchAll();
startAutoRefresh();

// Load quotes after Firebase is initialized
if (typeof firebase !== 'undefined' && firebase.database) {
  // Wait for Firebase to be ready
  setTimeout(() => {
    try {
      const db = firebase.database();
      if (db) {
        loadQuotes();
        // Listen for new quotes
        db.ref('quotes').on('value', () => {
          loadQuotes();
        });
      }
    } catch (e) {
      console.error('Firebase database not available:', e);
    }
  }, 1000);
}

// Settings handler - ensure it's attached after DOM is ready
function initSettings() {
  const refreshIntervalSelect = $('refreshInterval');
  if (refreshIntervalSelect) {
    refreshIntervalSelect.onchange = (e) => {
      refreshIntervalMs = parseInt(e.target.value);
      startAutoRefresh();
      console.log(`Refresh interval changed to ${refreshIntervalMs / 1000} seconds`);
    };
    console.log('Settings panel initialized');
    return; // Success, stop retrying
  }
  // Only retry a few times to avoid infinite warnings
  if (!initSettings.retryCount) initSettings.retryCount = 0;
  if (initSettings.retryCount < 3) {
    initSettings.retryCount++;
    setTimeout(initSettings, 500);
  }
}

// Initialize settings when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSettings);
} else {
  initSettings();
}

if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();

// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  // Register immediately, don't wait for load
  navigator.serviceWorker.register('/sw.js', { scope: '/' })
    .then(registration => {
      console.log('‚úÖ Service Worker registered:', registration.scope);
      
      // Check for updates periodically
      setInterval(() => {
        registration.update();
      }, 60000); // Check every minute
      
      // Listen for updates
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        if (newWorker) {
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New version available
              console.log('üîÑ New service worker version available');
              if (confirm('·Éê·ÉÆ·Éê·Éö·Éò ·Éï·Éî·É†·É°·Éò·Éê ·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò·Éê! ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê?')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
              }
            }
          });
        }
      });
    })
    .catch(error => {
      console.error('‚ùå Service Worker registration failed:', error);
    });
  
  // Listen for service worker messages
  navigator.serviceWorker.addEventListener('message', event => {
    if (event.data && event.data.type === 'SW_UPDATED') {
      if (confirm('·Éê·Éû·Éö·Éò·Éô·Éê·É™·Éò·Éê ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éì·Éê! ·Éí·Éê·Éì·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê?')) {
        window.location.reload();
      }
    }
  });
}

// PWA Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install button (optional - you can add this to your UI)
  const installBtn = document.createElement('button');
  installBtn.textContent = 'üì± Install App';
  installBtn.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:12px 20px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);color:#fff;border:none;border-radius:12px;font-weight:600;font-size:13px;cursor:pointer;z-index:999;box-shadow:0 4px 16px rgba(139,92,246,.4);';
  installBtn.onclick = async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('User choice:', outcome);
      deferredPrompt = null;
      installBtn.remove();
    }
  };
  
  // Auto-hide after 10 seconds
  setTimeout(() => {
    if (installBtn.parentNode) {
      installBtn.style.opacity = '0';
      installBtn.style.transition = 'opacity 0.3s';
      setTimeout(() => installBtn.remove(), 300);
    }
  }, 10000);
  
  document.body.appendChild(installBtn);
});

// Handle app installed
window.addEventListener('appinstalled', () => {
  console.log('PWA installed successfully');
  deferredPrompt = null;
});

// Prevent zoom on double tap (iOS)
let lastTouchEnd = 0;
document.addEventListener('touchend', (e) => {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) {
    e.preventDefault();
  }
  lastTouchEnd = now;
}, false);
</script>

</body>
</html>
