<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Professional crypto dashboard with real-time market data, portfolio tracking, and price alerts">
<meta name="theme-color" content="#6366f1">
<meta name="msapplication-TileColor" content="#6366f1">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="application-name" content="CCX">
<meta name="format-detection" content="telephone=no">
<title>CRYPTO COLLECTIVE X - Desktop Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- ALKDots Font - Local from GitHub -->
<link rel="stylesheet" href="/fonts/alkdots.min.css">
<!-- BPG ExtraSquare Mtavruli Font - Local from GitHub -->
<link rel="stylesheet" href="/fonts/bpg-extrasquare-mtavruli.min.css">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<style>
@font-face {
  font-family: 'BPG ExtraSquare Mtavruli';
  src: url('/fonts/bpg-extrasquare-mtavruli-webfont.eot');
  src: url('/fonts/bpg-extrasquare-mtavruli-webfont.eot?#iefix') format('embedded-opentype'),
       url('/fonts/bpg-extrasquare-mtavruli-webfont.woff2') format('woff2'),
       url('/fonts/bpg-extrasquare-mtavruli-webfont.woff') format('woff'),
       url('/fonts/bpg-extrasquare-mtavruli-webfont.ttf') format('truetype'),
       url('/fonts/bpg-extrasquare-mtavruli-webfont.svg#BPGExtraSquareMtavruli') format('svg'),
       url('/public/fonts/bpg-extrasquare-mtavruli-webfont.woff2') format('woff2'),
       url('/public/fonts/bpg-extrasquare-mtavruli-webfont.woff') format('woff'),
       url('/public/fonts/bpg-extrasquare-mtavruli-webfont.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

* { margin:0; padding:0; box-sizing:border-box; }

/* ──── MODERN PREMIUM CRYPTO THEME ──── */
:root {
  /* Dark Theme - Premium Modern Style */
  --bg-primary: #0a0e14;
  --bg-secondary: #141920;
  --bg-tertiary: #1e2530;
  --bg-card: #141920;
  --bg-card-hover: #1e2530;
  --bg-overlay: rgba(10, 14, 20, 0.98);
  --bg-input: #141920;
  --bg-input-focus: #1e2530;
  
  --text-primary: #f8fafc;
  --text-secondary: #cbd5e1;
  --text-tertiary: #94a3b8;
  --text-muted: #64748b;
  
  --border-primary: rgba(255, 255, 255, 0.12);
  --border-secondary: rgba(255, 255, 255, 0.08);
  --border-accent: rgba(99, 102, 241, 0.4);
  
  --accent-primary: #6366f1;
  --accent-secondary: #818cf8;
  --accent-hover: #4f46e5;
  
  --success: #22c55e;
  --success-bg: rgba(34, 197, 94, 0.12);
  --error: #f43f5e;
  --error-bg: rgba(244, 63, 94, 0.12);
  --warning: #f59e0b;
  --warning-bg: rgba(245, 158, 11, 0.12);
  
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
  --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.25);
  
  --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
  --gradient-card: linear-gradient(145deg, #141920 0%, #0a0e14 100%);
  --gradient-text: linear-gradient(135deg, #f8fafc 0%, #cbd5e1 100%);
  --gradient-accent: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
  
  --blur: blur(16px);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
}

/* ASI Panel Glow Animation */
@keyframes asiGlow {
  0% {
    opacity: 0.08;
    transform: scale(1);
  }
  100% {
    opacity: 0.15;
    transform: scale(1.1);
  }
}

[data-theme="light"] {
  /* Light Theme - Clean Modern Style */
  --bg-primary: #f8fafc;
  --bg-secondary: #ffffff;
  --bg-tertiary: #f1f5f9;
  --bg-card: #ffffff;
  --bg-card-hover: #f8fafc;
  --bg-overlay: rgba(255, 255, 255, 0.98);
  --bg-input: #ffffff;
  --bg-input-focus: #f8fafc;
  
  --text-primary: #0f172a;
  --text-secondary: #1e293b;
  --text-tertiary: #475569;
  --text-muted: #64748b;
  
  --border-primary: rgba(0, 0, 0, 0.1);
  --border-secondary: rgba(0, 0, 0, 0.06);
  --border-accent: rgba(99, 102, 241, 0.3);
  
  --accent-primary: #6366f1;
  --accent-secondary: #818cf8;
  --accent-hover: #4f46e5;
  
  --success: #16a34a;
  --success-bg: rgba(22, 163, 74, 0.1);
  --error: #e11d48;
  --error-bg: rgba(225, 29, 72, 0.1);
  --warning: #ea580c;
  --warning-bg: rgba(234, 88, 12, 0.1);
  
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
  --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.2);
  
  --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
  --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
  --gradient-text: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  --gradient-accent: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
}

/* ──── ANIMATIONS ──── */
@keyframes fadeIn {from{opacity:0}to{opacity:1}}
@keyframes fadeInUp {from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn {from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
@keyframes shimmer {0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
@keyframes rotate {from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

/* ──── BODY & BACKGROUND ──── */
body{
  font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  min-height:100vh;
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  position:relative;
  transition:background-color 0.3s ease, color 0.3s ease;
}
.grain-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");opacity:0.03;pointer-events:none;z-index:1}
[data-theme="light"] .grain-overlay{opacity:0.01}
.navbar{background:var(--bg-secondary);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border-secondary);padding:0 32px;display:flex;justify-content:space-between;align-items:center;position:fixed;top:0;left:0;right:0;z-index:100;box-shadow:var(--shadow-sm);transition:background-color 0.3s ease, border-color 0.3s ease;height:70px}
.logo-section{display:flex;align-items:center;gap:16px}
.logo-icon{width:40px;height:40px;min-width:40px;min-height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;overflow:hidden;position:relative;flex-shrink:0}
.logo-icon img{width:100%;height:100%;object-fit:contain;max-width:40px;max-height:40px;filter:none}
.logo-text{display:flex;flex-direction:column}
.logo-title{font-size:18px;font-weight:600;letter-spacing:-0.3px;color:var(--text-primary);transition:color 0.3s ease}
.logo-subtitle{font-size:9px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1px;font-weight:500;transition:color 0.3s ease}
.nav-right{display:flex;align-items:center;gap:16px}
.theme-toggle{width:40px;height:40px;border-radius:10px;background:var(--bg-card);border:1px solid var(--border-primary);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;font-size:18px;color:var(--text-secondary);position:relative;overflow:hidden}
.theme-toggle:hover{background:var(--bg-card-hover);border-color:var(--accent-primary);transform:scale(1.05);color:var(--accent-primary)}
.theme-toggle::before{content:'';position:absolute;inset:0;background:var(--gradient-primary);opacity:0;transition:opacity .3s}
.theme-toggle:hover::before{opacity:0.1}
.auth-buttons{display:flex;gap:12px}
.auth-btn{padding:10px 20px;background:transparent;border:1px solid var(--border-primary);color:var(--text-secondary);font-size:13px;font-weight:500;border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;letter-spacing:0.2px}
.auth-btn:hover{background:var(--bg-card);border-color:var(--border-accent);color:var(--text-primary)}
.auth-btn.primary{background:var(--accent-primary);border-color:var(--accent-primary);color:#fff}
.auth-btn.primary:hover{background:var(--accent-hover);border-color:var(--accent-hover)}
.user-menu{display:flex;align-items:center;gap:12px}
.user-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--border-primary);box-shadow:var(--shadow-sm);transition:border-color 0.3s ease}
.user-name{font-size:14px;font-weight:500;color:var(--text-secondary);letter-spacing:0.2px;transition:color 0.3s ease}
.admin-controls{display:none;gap:12px;align-items:center}
.admin-controls.show{display:flex}
.admin-btn{padding:10px 20px;font-size:13px;font-weight:600;border-radius:10px;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);letter-spacing:0.3px}
.admin-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
.live-indicator{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--success-bg);border:1px solid var(--success);opacity:0.8;border-radius:12px;backdrop-filter:blur(10px);transition:all 0.3s ease}
.live-dot{width:8px;height:8px;background:var(--success);border-radius:50%;box-shadow:0 0 8px var(--success);animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.1)}}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}
@keyframes rotateGradient{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.live-text{font-size:12px;color:var(--success);font-weight:600;text-transform:uppercase;letter-spacing:0.8px;transition:color 0.3s ease}
.time-display{font-size:14px;color:var(--text-tertiary);font-weight:500;font-variant-numeric:tabular-nums;letter-spacing:0.5px;transition:color 0.3s ease}
/* SIDEBAR NAVIGATION - Modern Professional Design */
.app-sidebar{width:280px;min-width:280px;background:linear-gradient(180deg, rgba(15,23,42,0.98) 0%, rgba(30,41,59,0.95) 100%);border-right:1px solid rgba(255,255,255,0.08);position:fixed;left:0;top:70px;bottom:0;overflow-y:auto;overflow-x:hidden;z-index:90;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);display:none;flex-direction:column;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);box-shadow:4px 0 24px rgba(0,0,0,0.3)}
.app-sidebar.visible{display:flex}
.app-sidebar.collapsed{width:80px;min-width:80px}
.sidebar-header{padding:20px 16px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.2)}
.sidebar-logo{font-size:15px;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:10px;letter-spacing:-0.3px}
.sidebar-collapse-btn{width:32px;height:32px;border-radius:8px;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary);transition:all 0.2s;font-size:12px}
.sidebar-collapse-btn:hover{background:rgba(99,102,241,0.2);color:#6366f1;border-color:rgba(99,102,241,0.4);transform:scale(1.05)}
.sidebar-nav{flex:1;padding:12px 8px;display:flex;flex-direction:column;gap:2px}
.sidebar-nav-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:10px;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);color:var(--text-secondary);background:transparent;border:none;width:100%;text-align:left;font-size:14px;font-weight:500;position:relative;margin-bottom:2px}
.sidebar-nav-item:hover{background:rgba(99,102,241,0.1);color:var(--text-primary);transform:translateX(2px)}
.sidebar-nav-item.active{background:linear-gradient(135deg, rgba(99,102,241,0.2) 0%, rgba(139,92,246,0.15) 100%);color:#fff;box-shadow:0 4px 12px rgba(99,102,241,0.25), inset 0 1px 0 rgba(255,255,255,0.1);border:1px solid rgba(99,102,241,0.3)}
.sidebar-nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:70%;background:linear-gradient(180deg, #6366f1 0%, #8b5cf6 100%);border-radius:0 3px 3px 0;box-shadow:0 0 8px rgba(99,102,241,0.6)}
.sidebar-nav-icon{font-size:20px;width:24px;text-align:center;flex-shrink:0;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.2))}
.sidebar-nav-item.active .sidebar-nav-icon{filter:drop-shadow(0 0 4px rgba(99,102,241,0.4))}
.sidebar-nav-text{flex:1;white-space:nowrap;opacity:1;transition:opacity 0.2s;font-weight:500}
.app-sidebar.collapsed .sidebar-nav-text{opacity:0;width:0;overflow:hidden}
.sidebar-nav-badge{background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);color:#fff;font-size:9px;font-weight:700;padding:3px 7px;border-radius:8px;min-width:20px;text-align:center;box-shadow:0 2px 6px rgba(99,102,241,0.4);letter-spacing:0.5px}
.sidebar-divider{margin:12px 16px;height:1px;background:linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%)}
.sidebar-section-title{padding:16px 16px 8px;font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:rgba(255,255,255,0.4);font-weight:700}
.app-sidebar.collapsed .sidebar-section-title{opacity:0;height:0;padding:0;margin:0;overflow:hidden}
.sidebar-footer{padding:16px;border-top:1px solid rgba(255,255,255,0.08);display:flex;flex-direction:column;gap:8px;background:rgba(0,0,0,0.2)}
.app-sidebar.collapsed .sidebar-footer .sidebar-nav-text{display:none}

/* MOBILE BOTTOM NAVIGATION - Modern Professional */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg, rgba(15,23,42,0.98) 0%, rgba(30,41,59,0.95) 100%);border-top:1px solid rgba(255,255,255,0.08);z-index:100;padding:8px 0 max(8px,env(safe-area-inset-bottom));backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);box-shadow:0 -4px 24px rgba(0,0,0,0.3)}
.bottom-nav-items{display:flex;justify-content:space-around;align-items:center}
.bottom-nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);color:rgba(255,255,255,0.5);background:transparent;border:none;flex:1;min-width:0;position:relative}
.bottom-nav-item:hover{background:rgba(99,102,241,0.1);color:rgba(255,255,255,0.8)}
.bottom-nav-item.active{color:#6366f1}
.bottom-nav-item.active::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:40px;height:3px;background:linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);border-radius:0 0 3px 3px;box-shadow:0 0 8px rgba(99,102,241,0.6)}
.bottom-nav-icon{font-size:22px;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.2))}
.bottom-nav-item.active .bottom-nav-icon{filter:drop-shadow(0 0 4px rgba(99,102,241,0.4))}
.bottom-nav-text{font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;letter-spacing:0.3px}

/* MOBILE SIDEBAR (Old - Keep for compatibility) */
.sidebar{display:none}
.sidebar-menu{display:flex;flex-direction:column;gap:8px;padding:20px}
.sidebar-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s ease;color:var(--text-secondary);background:transparent;border:none;width:100%;text-align:left;font-size:15px;font-weight:500}
.sidebar-item:hover{background:var(--bg-tertiary);color:var(--text-primary)}
.sidebar-item.active{background:var(--accent-primary);color:#fff}
.sidebar-icon{font-size:20px;width:24px;text-align:center}
.sidebar-text{flex:1}
.sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:999;opacity:0;transition:opacity 0.3s ease}
.sidebar-overlay.active{display:block;opacity:1}
.sidebar-toggle{display:none;width:40px;height:40px;border-radius:10px;background:var(--bg-card);border:1px solid var(--border-primary);align-items:center;justify-content:center;cursor:pointer;transition:all .3s;font-size:20px;color:var(--text-secondary);flex-shrink:0}
.sidebar-toggle:hover{background:var(--bg-card-hover);border-color:var(--accent-primary);color:var(--accent-primary)}

/* MAIN CONTENT WITH SIDEBAR - Modern Professional Layout */
.main-layout{display:flex;min-height:100vh;margin-top:0}
.main-content{flex:1;margin-left:0;padding:32px;transition:margin-left 0.3s cubic-bezier(0.4,0,0.2,1);min-height:100vh;max-width:100vw;padding-top:102px;padding-bottom:80px}
.main-content.with-sidebar{margin-left:280px;max-width:calc(100vw - 280px)}
.main-content.sidebar-collapsed{margin-left:80px;max-width:calc(100vw - 80px)}
.main-content.no-sidebar{margin-left:0;max-width:100vw}
.container{max-width:100%;margin:0;padding:0;position:relative;z-index:2;width:100%;box-sizing:border-box}
.hero-section{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:32px;grid-auto-rows:minmax(90px,auto)}
.hero-stat{background:var(--bg-card);backdrop-filter:var(--blur);border-radius:var(--radius-md);padding:16px 20px;border:1px solid var(--border-secondary);transition:all .2s;display:flex;flex-direction:column;justify-content:space-between;min-height:90px;box-shadow:var(--shadow-sm)}
.hero-stat:hover{background:var(--bg-card-hover);border-color:var(--border-primary)}
.hero-stat-label{font-size:10px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-tertiary);margin-bottom:6px;font-weight:500}
.hero-stat-value{font-size:16px;font-weight:600;color:var(--text-primary);letter-spacing:-0.3px;line-height:1.2}
.hero-stat-change{font-size:11px;margin-top:6px;font-weight:500;padding:3px 8px;border-radius:var(--radius-sm);display:inline-block;width:fit-content}
.hero-stat-change.positive{color:var(--success);background:var(--success-bg)}
.hero-stat-change.negative{color:var(--error);background:var(--error-bg)}
.content-grid{display:block;width:100%;margin-bottom:48px}
.sidebar-section{display:flex;flex-direction:column;gap:20px}
.featured-card{background:var(--bg-card);backdrop-filter:var(--blur);border:1px solid var(--border-secondary);border-radius:var(--radius-lg);padding:24px;transition:all .2s}
.featured-card:hover{background:var(--bg-card-hover);border-color:var(--border-primary)}
.card-badge{display:inline-block;font-size:10px;text-transform:uppercase;letter-spacing:2px;font-weight:900;padding:6px 12px;border-radius:var(--radius-md);margin-bottom:20px}
.badge-gainer{background:var(--success-bg);color:var(--success);border:1px solid var(--success);opacity:0.8}
.badge-gold{background:var(--warning-bg);color:var(--warning);border:1px solid var(--warning);opacity:0.8}
.badge-loss{background:var(--error-bg);color:var(--error);border:1px solid var(--error);opacity:0.8}
.featured-header{display:flex;align-items:center;gap:20px;margin-bottom:24px}
.featured-icon{width:72px;height:72px;border-radius:50%;border:3px solid var(--border-secondary);box-shadow:var(--shadow-md);transition:all .4s}
.featured-card:hover .featured-icon{transform:rotate(10deg) scale(1.1);border-color:var(--accent-primary);box-shadow:var(--shadow-glow)}
.featured-info h3{font-size:22px;font-weight:800;margin-bottom:6px;color:var(--text-primary);transition:color 0.3s ease}
.featured-price{font-size:18px;color:var(--text-secondary);font-weight:700;transition:color 0.3s ease}
.progress-section{margin-top:24px}
.progress-label{display:flex;justify-content:space-between;margin-bottom:12px;font-size:13px;font-weight:700;color:var(--text-primary);transition:color 0.3s ease}
.progress-bar{height:12px;background:var(--bg-tertiary);border-radius:6px;overflow:hidden;position:relative;transition:background-color 0.3s ease}
.progress-fill{height:100%;border-radius:6px;position:relative;overflow:hidden;transition:width 1.2s cubic-bezier(.4,0,.2,1)}
.progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmerEffect 2s infinite}
.progress-fill.green{background:linear-gradient(90deg,var(--success),#059669);box-shadow:0 0 16px var(--success);opacity:0.8}
.progress-fill.gold{background:linear-gradient(90deg,var(--warning),#d97706);box-shadow:0 0 16px var(--warning);opacity:0.8}
.progress-fill.red{background:linear-gradient(90deg,var(--error),#dc2626);box-shadow:0 0 16px var(--error);opacity:0.8}
.progress-value{color:var(--success);font-size:18px;transition:color 0.3s ease}
.progress-value.negative{color:var(--error)}
.progress-value.gold{color:var(--warning)}
.main-section{background:var(--bg-card);backdrop-filter:var(--blur);border:1px solid var(--border-secondary);border-radius:var(--radius-lg);padding:24px;min-height:400px;transition:background-color 0.3s ease, border-color 0.3s ease;box-shadow:var(--shadow-md)}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border-secondary);transition:border-color 0.3s ease;flex-wrap:wrap;gap:12px}
.section-title{font-size:18px;font-weight:600;color:var(--text-primary);letter-spacing:-0.4px;transition:color 0.3s ease}
.filter-tabs{display:flex;gap:6px;background:var(--bg-tertiary);padding:4px;border-radius:10px;border:1px solid var(--border-secondary);transition:background-color 0.3s ease}
.filter-tab{padding:8px 16px;border:none;background:transparent;color:var(--text-tertiary);font-size:12px;font-weight:500;cursor:pointer;border-radius:var(--radius-sm);transition:all .2s}
.filter-tab:hover{color:var(--text-primary);background:var(--bg-card)}
.filter-tab.active{background:var(--accent-primary);color:#fff}
.table-header{display:grid;grid-template-columns:60px 2fr 1fr 1fr 1fr;gap:16px;padding:10px 16px;margin-bottom:8px;border-radius:8px;background:var(--bg-tertiary);border:1px solid var(--border-secondary);transition:background-color 0.3s ease}
.table-header-cell{font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:500;transition:color 0.3s ease}
.tokens-list{display:flex;flex-direction:column;gap:10px}
.token-row{display:grid;grid-template-columns:60px 2fr 1fr 1fr 1fr;gap:16px;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--border-secondary);border-radius:var(--radius-md);align-items:center;transition:all .2s;animation:fadeInUp .3s ease-out backwards;animation-delay:calc(var(--index)*.02s)}
.token-row:hover{background:var(--bg-card-hover);border-color:var(--border-primary);transform:translateX(2px)}
.token-icon-col{display:flex;align-items:center;justify-content:center}
.token-icon{width:40px;height:40px;border-radius:50%;border:2px solid var(--border-primary);transition:all .3s;box-shadow:var(--shadow-sm)}
.token-row:hover .token-icon{border-color:var(--accent-secondary);transform:scale(1.05);box-shadow:var(--shadow-glow)}
.token-name-col h3{font-size:14px;font-weight:600;margin-bottom:2px;color:var(--text-primary);letter-spacing:-0.3px;transition:color 0.3s ease}
.token-symbol{font-size:11px;color:var(--text-tertiary);font-weight:500;text-transform:uppercase;letter-spacing:0.8px;transition:color 0.3s ease}
.token-price-col{font-size:15px;font-weight:600;color:var(--text-primary);letter-spacing:-0.3px;transition:color 0.3s ease}
.token-change-col{text-align:right}
.change-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:var(--radius-sm);font-size:12px;font-weight:500;transition:all .2s}
.change-badge.positive{background:var(--success-bg);color:var(--success)}
.change-badge.negative{background:var(--error-bg);color:var(--error)}
.token-mcap-col{font-size:13px;font-weight:500;color:var(--text-tertiary);letter-spacing:0.2px;transition:color 0.3s ease}
.loading{text-align:center;padding:120px}
.spinner{width:48px;height:48px;border:3px solid var(--border-secondary);border-top:3px solid var(--accent-primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 24px}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes electricFlash{0%,100%{opacity:0;transform:scaleY(0);}10%,90%{opacity:1;transform:scaleY(1);}50%{opacity:0.8;transform:scaleY(0.8);}}
@keyframes electricPulse{0%,100%{opacity:0.3;transform:scale(1);filter:brightness(1);}50%{opacity:1;transform:scale(1.1);filter:brightness(1.5);}}
@keyframes scanLine{0%{top:-100%;opacity:0.8;}50%{opacity:1;}100%{top:100%;opacity:0.8;}}
@keyframes energyWave{0%{opacity:0;transform:scale(0.8);filter:blur(0px);}50%{opacity:1;transform:scale(1.2);filter:blur(2px);}100%{opacity:0;transform:scale(1.5);filter:blur(4px);}}
@keyframes sparkle{0%,100%{opacity:0;transform:translate(-50%,-50%) scale(0) rotate(0deg);}25%,75%{opacity:1;transform:translate(-50%,-50%) scale(1) rotate(180deg);}50%{opacity:0.8;transform:translate(-50%,-50%) scale(1.2) rotate(360deg);}}
@keyframes breathing{0%,100%{transform:translateX(10px) translateY(0px) scale(1);}50%{transform:translateX(10px) translateY(-3px) scale(1.02);}}
@keyframes headMovement{0%,100%{transform:translateX(10px) translateY(0px) rotate(0deg);}25%{transform:translateX(11px) translateY(-1px) rotate(0.5deg);}50%{transform:translateX(10px) translateY(-2px) rotate(0deg);}75%{transform:translateX(9px) translateY(-1px) rotate(-0.5deg);}}
@keyframes bodySway{0%,100%{transform:translateX(10px) translateY(0px) rotate(0deg);}33%{transform:translateX(12px) translateY(-1px) rotate(0.3deg);}66%{transform:translateX(8px) translateY(-1px) rotate(-0.3deg);}}
@keyframes naturalIdle{
  0%,100%{transform:translateX(10px) translateY(0px) scale(1) rotate(0deg);}
  8%{transform:translateX(10.5px) translateY(-1px) scale(1.005) rotate(0.2deg);}
  16%{transform:translateX(11px) translateY(-2px) scale(1.01) rotate(0.4deg);}
  24%{transform:translateX(10.8px) translateY(-2.5px) scale(1.015) rotate(0.3deg);}
  32%{transform:translateX(10px) translateY(-3px) scale(1.02) rotate(0deg);}
  40%{transform:translateX(9.5px) translateY(-2.8px) scale(1.018) rotate(-0.2deg);}
  48%{transform:translateX(9px) translateY(-2.5px) scale(1.015) rotate(-0.4deg);}
  56%{transform:translateX(9.2px) translateY(-2px) scale(1.01) rotate(-0.3deg);}
  64%{transform:translateX(9.5px) translateY(-1.5px) scale(1.008) rotate(-0.2deg);}
  72%{transform:translateX(10px) translateY(-1px) scale(1.005) rotate(0deg);}
  80%{transform:translateX(10.3px) translateY(-0.5px) scale(1.002) rotate(0.1deg);}
  88%{transform:translateX(10px) translateY(0px) scale(1) rotate(0deg);}
  96%{transform:translateX(10px) translateY(-0.3px) scale(1.001) rotate(0deg);}
}
@keyframes subtleBlink{
  0%,90%,100%{opacity:0.9;}
  92%,94%{opacity:0.85;}
  93%{opacity:0.8;}
}
.loading-text{font-size:15px;color:var(--text-tertiary);font-weight:500;letter-spacing:0.3px;transition:color 0.3s ease}
.error{background:var(--error-bg);border:1px solid var(--error);color:var(--error);border-radius:var(--radius-lg);padding:20px;margin:24px 0;font-weight:500;text-align:center;backdrop-filter:var(--blur);transition:background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease}

/* Hero Carousel Styles - Compact */
.hero-carousel-wrapper{position:relative;margin-bottom:20px;width:100%;padding:0 4px;display:flex;justify-content:center;align-items:center}
.carousel{display:flex;gap:8px;overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth;scrollbar-width:none;-ms-overflow-style:none;padding:4px 0 8px;-webkit-overflow-scrolling:touch;justify-content:center;max-width:100%}
.carousel::-webkit-scrollbar{display:none}
.carousel-card{min-width:200px;width:200px;background:var(--bg-card);backdrop-filter:var(--blur);border-radius:var(--radius-md);padding:12px 14px;border:1px solid var(--border-secondary);transition:all .25s cubic-bezier(.4,0,.2,1);flex-shrink:0;display:flex;flex-direction:column;position:relative;overflow:hidden}

/* Activity Carousel - Extra Compact */
.activity-carousel-wrapper{position:relative;margin-bottom:16px;width:100%;padding:0 2px;display:flex;justify-content:center;align-items:center}
.activity-carousel{display:flex;gap:6px;overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth;scrollbar-width:none;-ms-overflow-style:none;padding:2px 0 4px;-webkit-overflow-scrolling:touch;justify-content:flex-start;max-width:100%}
.activity-carousel::-webkit-scrollbar{display:none}
.activity-carousel .carousel-card{min-width:140px;width:140px;padding:8px 10px;border-radius:var(--radius-sm)}
.activity-carousel .carousel-card-value{font-size:13px;margin-bottom:2px}
.activity-carousel .carousel-card-title{font-size:8px;margin-bottom:4px}
.activity-carousel .carousel-card-change{font-size:9px}
.activity-carousel .carousel-card-subtitle{font-size:8px;margin-top:1px}
.carousel-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--border-primary),transparent);opacity:0;transition:opacity .3s}
.carousel-card:hover{background:var(--bg-card-hover);border-color:var(--border-primary);transform:translateY(-1px);box-shadow:var(--shadow-md)}
.carousel-card:hover::before{opacity:1}
.carousel-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;position:relative;z-index:1}
.carousel-card-title{font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1.2px;font-weight:700;font-family:'Inter',sans-serif;transition:color 0.3s ease}
.carousel-card-arrow{color:var(--accent-primary);font-size:13px;opacity:0.5;transition:all .2s;cursor:pointer;line-height:1}
.carousel-card:hover .carousel-card-arrow{opacity:0.8;transform:translateX(1px);color:var(--accent-secondary)}
.carousel-card-value{font-size:16px;font-weight:700;color:var(--text-primary);letter-spacing:-0.2px;margin-bottom:4px;line-height:1.2;font-family:'Inter',sans-serif;transition:color 0.3s ease}
.carousel-card-change{font-size:10px;font-weight:600;display:flex;align-items:center;gap:3px;margin-top:2px}
.carousel-card-change.positive{color:var(--success)}
.carousel-card-change.negative{color:var(--error)}
.carousel-card-subtitle{font-size:9px;color:var(--text-muted);margin-top:2px;line-height:1.3;font-weight:500;transition:color 0.3s ease}
.carousel-nav{position:absolute;top:50%;transform:translateY(-50%);width:32px;height:32px;border-radius:50%;background:var(--bg-secondary);backdrop-filter:var(--blur);border:1px solid var(--border-primary);color:var(--text-primary);font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;z-index:10;box-shadow:var(--shadow-sm);opacity:0.8}
.carousel-nav:hover{background:var(--bg-tertiary);border-color:var(--accent-primary);opacity:1;transform:translateY(-50%) scale(1.05)}
.carousel-nav:active{transform:translateY(-50%) scale(0.95)}
.carousel-nav-right{right:8px}
.carousel-nav-left{left:8px}

/* ANIMATED SVG ARROWS */
.change-arrow{width:18px;height:18px;transition:transform .3s ease,filter .3s ease;animation:arrowPulse 1.5s ease-in-out infinite}
@keyframes arrowPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.change-badge:hover .change-arrow{transform:translateY(-2px) scale(1.2);filter:drop-shadow(0 0 8px currentColor)}
.change-value{font-variant-numeric:tabular-nums}

/* USER TABS */
.user-tabs{display:none}
.user-content{display:none;min-height:400px}
.user-content.active{display:block!important}

/* PAGE CONTENT */
.page-content{display:none;min-height:400px;animation:fadeIn 0.3s ease}
.page-content.active{display:block!important}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-tertiary)}
.empty-state-icon{font-size:64px;margin-bottom:20px;opacity:0.5}
.empty-state-title{font-size:20px;font-weight:600;color:var(--text-secondary);margin-bottom:12px}
.empty-state-text{font-size:14px;color:var(--text-tertiary);line-height:1.6;max-width:400px;margin:0 auto 24px}
.empty-state-action{display:inline-block;padding:12px 24px;background:var(--accent-primary);color:#fff;border-radius:var(--radius-md);font-weight:500;text-decoration:none;transition:all 0.3s;box-shadow:var(--shadow-sm)}
.empty-state-action:hover{background:var(--accent-hover);transform:translateY(-2px);box-shadow:var(--shadow-md)}

/* PORTFOLIO - Bold Vibrant Design with Dynamic Effects */
.portfolio-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.summary-card{background:var(--bg-card);backdrop-filter:var(--blur);border:1px solid var(--border-secondary);border-radius:var(--radius-md);padding:14px 16px;transition:all .2s;position:relative;overflow:hidden;box-shadow:var(--shadow-sm)}
.summary-card:hover{background:var(--bg-card-hover);border-color:var(--border-primary);transform:translateY(-1px);box-shadow:var(--shadow-md)}
.summary-label{font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;font-weight:500;transition:color 0.3s ease}
.summary-value{font-size:18px;font-weight:700;color:var(--text-primary);letter-spacing:-0.3px;transition:color 0.3s ease;font-variant-numeric:tabular-nums}
.holdings-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;margin-bottom:20px}
.holding-row{display:flex;flex-direction:column;gap:10px;padding:14px 16px;background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:var(--radius-md);transition:all .2s;position:relative;overflow:hidden;box-shadow:var(--shadow-sm)}
.holding-row::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,var(--border-primary),transparent);transition:left .6s;opacity:0.3}
.holding-row:hover{background:var(--bg-card-hover);border-color:var(--border-primary);transform:translateY(-1px);box-shadow:var(--shadow-md)}
.holding-row:hover::before{left:100%}
.holding-header{display:flex;align-items:center;gap:14px;padding-bottom:14px;border-bottom:1px solid var(--border-secondary);position:relative}
.holding-header::after{content:'';position:absolute;bottom:-1px;left:0;width:0;height:1px;background:var(--gradient-primary);transition:width .4s}
.holding-row:hover .holding-header::after{width:100%}
.holding-icon-wrapper{width:52px;height:52px;border-radius:var(--radius-lg);background:var(--bg-tertiary);border:1px solid var(--border-primary);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;box-shadow:var(--shadow-sm);transition:all .3s}
.holding-row:hover .holding-icon-wrapper{transform:rotate(5deg) scale(1.1);border-color:var(--accent-primary);box-shadow:var(--shadow-md)}
.holding-icon-wrapper img{width:100%;height:100%;object-fit:cover;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.holding-info{flex:1;min-width:0}
.holding-name{font-size:16px;font-weight:700;color:var(--text-primary);letter-spacing:-0.3px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:color 0.3s ease}
.holding-symbol{font-size:12px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1px;font-weight:600;transition:color 0.3s ease}
.holding-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.holding-stat{display:flex;flex-direction:column;gap:6px;padding:10px;background:var(--bg-tertiary);border:1px solid var(--border-secondary);border-radius:var(--radius-md);transition:all .3s;position:relative;overflow:hidden}
.holding-stat::before{content:'';position:absolute;inset:0;background:var(--accent-primary);opacity:0.03;transition:opacity .3s}
.holding-stat:hover{background:var(--bg-card);border-color:var(--border-primary);transform:translateY(-2px)}
.holding-stat:hover::before{opacity:0.05}
.holding-stat-label{font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:1.2px;font-weight:700;transition:color 0.3s ease}
.holding-stat-value{font-size:14px;font-weight:700;color:var(--text-primary);letter-spacing:-0.2px;font-variant-numeric:tabular-nums;transition:color 0.3s ease}
.holding-stat-value.positive{color:var(--success)}
.holding-stat-value.negative{color:var(--error)}
.holding-actions{display:flex;gap:8px;padding-top:14px;border-top:1px solid var(--border-secondary);justify-content:flex-end;position:relative}
.holding-actions::before{content:'';position:absolute;top:-1px;left:0;width:0;height:1px;background:var(--gradient-primary);transition:width .4s}
.holding-row:hover .holding-actions::before{width:100%}
.edit-btn{background:var(--bg-tertiary);border:1px solid var(--accent-primary);color:var(--accent-primary);padding:8px 16px;border-radius:var(--radius-md);cursor:pointer;font-size:12px;font-weight:700;transition:all .3s;flex:1;text-align:center;text-transform:uppercase;letter-spacing:0.5px;box-shadow:var(--shadow-sm);position:relative;overflow:hidden}
.edit-btn::before{content:'';position:absolute;inset:0;background:var(--accent-primary);opacity:0;transition:opacity .3s}
.edit-btn:hover{background:var(--accent-primary);border-color:var(--accent-hover);color:#fff;transform:translateY(-2px) scale(1.05);box-shadow:var(--shadow-md)}
.edit-btn:hover::before{opacity:1}
.delete-btn{background:var(--bg-tertiary);border:1px solid var(--error);color:var(--error);padding:8px 16px;border-radius:var(--radius-md);cursor:pointer;font-size:12px;font-weight:700;transition:all .3s;flex:1;text-align:center;text-transform:uppercase;letter-spacing:0.5px;box-shadow:var(--shadow-sm);position:relative;overflow:hidden}
.delete-btn::before{content:'';position:absolute;inset:0;background:var(--error);opacity:0;transition:opacity .3s}
.delete-btn:hover{background:var(--error);border-color:var(--error);color:#fff;transform:translateY(-2px) scale(1.05);box-shadow:var(--shadow-md)}
.delete-btn:hover::before{opacity:1}
.editable{cursor:pointer;padding:4px 8px;border-radius:var(--radius-sm);transition:all .3s;display:inline-block;position:relative}
.editable:hover{background:var(--bg-tertiary);border:1px dashed var(--accent-primary);transform:scale(1.05);box-shadow:var(--shadow-sm)}
.add-holding-form{display:grid;grid-template-columns:1fr 1fr 1fr 80px;gap:12px;margin-top:24px}
.add-holding-form input,.add-holding-form select{padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;transition:all .2s}
.add-holding-form input:focus,.add-holding-form select:focus{outline:none;border-color:var(--accent-primary);background:var(--bg-input-focus)}
.add-holding-form button{background:var(--accent-primary);border:none;color:#fff;padding:10px 18px;border-radius:var(--radius-sm);font-weight:500;cursor:pointer;transition:all .2s;font-size:13px}
.add-holding-form button:hover{background:var(--accent-hover)}

/* ALERTS */
.alerts-list{display:flex;flex-direction:column;gap:10px}
.alert-row{display:grid;grid-template-columns:80px 2fr 1fr 1fr 80px;gap:16px;padding:16px 20px;background:var(--bg-tertiary);border:1px solid var(--border-secondary);border-radius:var(--radius-md);align-items:center;transition:all .2s}
.alert-row:hover{background:var(--bg-card-hover);border-color:var(--border-primary);transform:translateX(4px)}
.alert-row.triggered{background:var(--success-bg);border-color:var(--success)}
.add-alert-form{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 80px;gap:12px;margin-top:24px}
.add-alert-form select,.add-alert-form input{padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;transition:all .2s}
.add-alert-form select:focus,.add-alert-form input:focus{outline:none;border-color:var(--accent-primary);background:var(--bg-input-focus)}
.add-alert-form button{background:var(--accent-primary);border:none;color:#fff;padding:10px 18px;border-radius:var(--radius-sm);font-weight:500;cursor:pointer;transition:all .2s;font-size:13px}
.add-alert-form button:hover{background:var(--accent-hover)}

/* MODALS */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(12px);align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--bg-overlay);backdrop-filter:blur(20px);border:1px solid var(--border-primary);border-radius:var(--radius-lg);padding:32px;width:420px;max-width:90vw;box-shadow:var(--shadow-lg);animation:fadeIn .2s;transition:background-color 0.3s ease}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-size:20px;font-weight:600;color:var(--text-primary);letter-spacing:-0.3px;transition:color 0.3s ease}
.close-modal{cursor:pointer;color:var(--text-tertiary);font-size:24px;font-weight:300;transition:all .25s}
.close-modal:hover{color:var(--text-primary)}
.modal-input{margin-bottom:16px}
.modal-input label{display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500;transition:color 0.3s ease}
.modal-input input{width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;transition:all .2s}
.modal-input input:focus{outline:none;border-color:var(--accent-primary);background:var(--bg-input-focus)}
.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
.modal-btn{padding:12px 24px;border-radius:10px;font-weight:600;font-size:13px;cursor:pointer;transition:all .25s;letter-spacing:0.3px}
.modal-btn.cancel{background:transparent;border:1.5px solid var(--border-primary);color:var(--text-tertiary)}
.modal-btn.cancel:hover{background:var(--bg-card);color:var(--text-primary);border-color:var(--border-accent)}
.modal-btn.add{background:var(--accent-primary);border:none;color:#fff}
.modal-btn.add:hover{background:var(--accent-hover)}
.modal-btn.save{background:var(--success);border:none;color:#fff}
.modal-btn.save:hover{background:#16a34a}
.modal-close{background:transparent;border:none;color:var(--text-tertiary);font-size:28px;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);transition:all .25s}
.modal-close:hover{background:var(--bg-card);color:var(--text-primary)}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500;transition:color 0.3s ease}
.form-group input,.form-group select{width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;transition:all .2s}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--accent-primary);background:var(--bg-input-focus)}
.form-group input:disabled,.form-group select:disabled{opacity:.5;cursor:not-allowed}
.form-group small{display:block;margin-top:6px;font-size:11px;color:var(--text-muted);transition:color 0.3s ease}
.modal-header h3{font-size:20px;font-weight:600;color:var(--text-primary);letter-spacing:-0.3px;margin:0;transition:color 0.3s ease}

/* Sidebar Overlay for Mobile */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:85;backdrop-filter:blur(4px);transition:opacity 0.3s ease}
.sidebar-overlay.active{display:block}

.sidebar-toggle{display:none;width:40px;height:40px;background:var(--bg-card);border:1px solid var(--border-primary);border-radius:var(--radius-md);align-items:center;justify-content:center;cursor:pointer;color:var(--text-primary);font-size:20px;box-shadow:var(--shadow-sm);transition:all 0.3s ease}
.sidebar-toggle:hover{background:var(--bg-card-hover);border-color:var(--accent-primary);color:var(--accent-primary);transform:scale(1.05)}

/* ──── RESPONSIVE DESIGN ──── */

/* Tablet and Below (1024px and below) */
@media(max-width:1024px){
  .navbar{height:64px;padding:0 20px}
  .top-nav-tabs{flex-wrap:wrap;gap:4px;padding:0 12px;justify-content:flex-start;overflow-x:auto}
  .top-nav-tab{font-size:12px;padding:6px 12px;flex-shrink:0}
  .main-content{padding:20px 16px;padding-top:88px}
  .logo-title{font-size:16px}
  .logo-icon{width:36px;height:36px}
  .nav-right{gap:12px}
  .live-indicator{padding:6px 12px;font-size:11px}
  .time-display{font-size:12px}
  .hero-section{grid-template-columns:repeat(3,1fr);gap:10px}
  .hero-stat{padding:12px 16px;min-height:80px}
  .carousel-card{min-width:180px;padding:10px 12px}
  .content-grid{margin-bottom:32px}
}

/* Mobile Landscape and Below (768px and below) */
@media(max-width:768px){
  .navbar{height:60px;padding:0 12px}
  .top-nav-tabs{gap:2px;padding:0 8px}
  .top-nav-tab{font-size:11px;padding:6px 10px}
  .main-content{padding:16px 12px;padding-top:84px}
  .logo-title{font-size:14px}
  .logo-icon{width:32px;height:32px}
  .nav-right{gap:8px}
  .theme-toggle{width:36px;height:36px;font-size:16px}
  .auth-btn{padding:8px 14px;font-size:12px}
  .live-indicator{padding:4px 10px;font-size:10px}
  .time-display{font-size:11px;display:none}
  .hero-section{grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:20px}
  .hero-stat{padding:10px 12px;min-height:70px}
  .hero-stat-value{font-size:14px}
  .hero-stat-label{font-size:9px}
  .carousel-card{min-width:160px;padding:8px 10px}
  .carousel-card-value{font-size:14px}
  .carousel-card-title{font-size:9px}
  .section-title{font-size:18px}
  .section-header{flex-direction:column;align-items:flex-start;gap:12px}
  .filter-tabs{flex-wrap:wrap;gap:4px}
  .filter-tab{font-size:11px;padding:6px 10px}
  .token-row{padding:12px;gap:8px}
  .token-icon-col{width:32px;height:32px}
  .token-name-col h3{font-size:14px}
  .token-symbol{font-size:11px}
  .summary-card{padding:12px 14px}
  .summary-value{font-size:16px}
  .summary-label{font-size:9px}
  .main-section{padding:16px}
  .portfolio-summary{grid-template-columns:repeat(2,1fr);gap:10px}
  .holdings-list{grid-template-columns:1fr}
  .holding-row{padding:12px}
  .activity-carousel-wrapper{margin-bottom:12px}
  .activity-carousel .carousel-card{min-width:120px;padding:6px 8px}
  #asiAlliancePanel{padding:16px;min-height:250px!important}
  #asiAlliancePanel div[style*="width:200px"]:first-of-type{width:150px!important;opacity:0.6!important;transform:translateX(5px)!important}
  #asiAlliancePanel div[style*="padding-right:220px"]{padding-right:170px!important}
  #asiAlliancePanel div[style*="max-width:calc(100% - 220px)"]{max-width:calc(100% - 170px)!important}
  #asiTokensGrid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
}

/* Mobile Portrait (480px and below) */
@media(max-width:480px){
  .navbar{height:56px;padding:0 8px}
  .top-nav-tabs{gap:2px;padding:0 4px}
  .top-nav-tab{font-size:10px;padding:5px 8px}
  .main-content{padding:12px 8px;padding-top:80px}
  .logo-title{font-size:12px}
  .logo-icon{width:28px;height:28px}
  .nav-right{gap:6px}
  .theme-toggle{width:32px;height:32px;font-size:14px}
  .auth-btn{padding:6px 12px;font-size:11px}
  .live-indicator{padding:4px 8px;font-size:9px}
  .live-text{font-size:9px}
  .hero-section{grid-template-columns:1fr;gap:8px;margin-bottom:16px}
  .hero-stat{padding:10px;min-height:65px}
  .hero-stat-value{font-size:13px}
  .hero-stat-label{font-size:8px}
  .carousel-card{min-width:140px;padding:8px}
  .carousel-card-value{font-size:13px}
  .carousel-card-title{font-size:8px}
  .section-title{font-size:16px}
  .filter-tabs{gap:3px}
  .filter-tab{font-size:10px;padding:5px 8px}
  .table-header{display:none}
  .token-row{flex-direction:column;align-items:flex-start;gap:8px;padding:10px}
  .token-icon-col{width:28px;height:28px}
  .token-name-col h3{font-size:13px}
  .token-symbol{font-size:10px}
  .summary-card{padding:10px 12px}
  .summary-value{font-size:14px}
  .summary-label{font-size:8px}
  .main-section{padding:12px}
  .portfolio-summary{grid-template-columns:1fr;gap:8px}
  .holdings-list{grid-template-columns:1fr}
  .holding-row{padding:10px;flex-direction:column}
  .holding-stats{grid-template-columns:repeat(2,1fr);gap:8px}
  .activity-carousel-wrapper{margin-bottom:10px}
  .activity-carousel .carousel-card{min-width:110px;padding:6px}
  #asiAlliancePanel{padding:12px;margin-bottom:16px;min-height:200px!important}
  #asiAlliancePanel div[style*="width:200px"]:first-of-type{width:120px!important;opacity:0.55!important;transform:translateX(3px)!important}
  #asiAlliancePanel div[style*="padding-right:220px"]{padding-right:140px!important}
  #asiAlliancePanel div[style*="max-width:calc(100% - 220px)"]{max-width:calc(100% - 140px)!important}
  #asiTokensGrid{grid-template-columns:1fr;gap:8px}
  .container{padding:0}
}

/* Small Mobile (360px and below) */
@media(max-width:360px){
  .navbar{height:52px;padding:0 6px}
  .top-nav-tab{font-size:9px;padding:4px 6px}
  #asiAlliancePanel div[style*="width:200px"]:first-of-type{width:100px!important;opacity:0.5!important}
  #asiAlliancePanel div[style*="padding-right:220px"]{padding-right:120px!important}
  #asiAlliancePanel div[style*="max-width:calc(100% - 220px)"]{max-width:calc(100% - 120px)!important}
  .main-content{padding:10px 6px;padding-top:76px}
  .logo-title{font-size:11px}
  .logo-icon{width:24px;height:24px}
  .hero-stat{padding:8px;min-height:60px}
  .carousel-card{min-width:120px;padding:6px}
  .section-title{font-size:14px}
  .summary-card{padding:8px 10px}
  .summary-value{font-size:13px}
  #asiAlliancePanel{padding:10px}
}

/* Responsive Styles for All Screen Sizes */

/* Ultra-wide and Large Desktop (2560px+) */
@media(min-width:2560px){
  .container{max-width:2400px;padding:64px 80px}
  .carousel-card{min-width:320px;max-width:320px;padding:24px}
  .carousel-card-value{font-size:28px}
  .carousel-card-title{font-size:12px}
  .section-title{font-size:32px}
  .token-row{padding:20px 24px;gap:32px}
  .main-section{padding:48px}
}

/* Large Desktop (1920px - 2559px) */
@media(min-width:1920px) and (max-width:2559px){
  .container{max-width:1920px;padding:48px 60px}
  .carousel-card{min-width:300px;max-width:300px;padding:22px}
  .carousel-card-value{font-size:24px}
}

/* Standard Desktop (1440px - 1919px) */
@media(min-width:1440px) and (max-width:1919px){
  .container{max-width:1440px;padding:40px 48px}
  .carousel-card{min-width:280px;max-width:280px}
  .main-section{padding:32px}
}

/* Medium Desktop / Large Laptop (1280px - 1439px) */
@media(min-width:1280px) and (max-width:1439px){
  .container{max-width:1280px;padding:36px 40px}
  .carousel-card{min-width:260px;max-width:260px;padding:18px}
  .carousel-card-value{font-size:22px}
  .main-section{padding:28px}
}

/* Small Desktop / Laptop (1024px - 1279px) */
@media(min-width:1024px) and (max-width:1279px){
  .container{max-width:1024px;padding:32px 36px}
  .carousel-card{min-width:240px;max-width:240px;padding:16px}
  .carousel-card-value{font-size:20px}
  .main-section{padding:24px}
  .token-row{grid-template-columns:60px 2fr 1fr 1fr 1fr;gap:20px;padding:14px 18px}
}

/* Tablet Landscape (768px - 1023px) */
@media(min-width:768px) and (max-width:1023px){
  .container{max-width:100%;padding:24px 20px}
  .content-grid{grid-template-columns:1fr;gap:20px}
  .hero-carousel-wrapper{padding:0 40px;margin-bottom:24px}
  .carousel-card{min-width:240px;max-width:240px;padding:16px}
  .carousel-card-value{font-size:20px}
  .carousel-card-title{font-size:11px}
  .carousel-nav{width:36px;height:36px;font-size:18px}
  .main-section{padding:24px}
  .token-row{grid-template-columns:50px 1.5fr 1fr 1fr;gap:12px;padding:16px}
  .token-mcap-col{display:none}
  .table-header{grid-template-columns:50px 1.5fr 1fr 1fr;gap:12px;padding:12px 16px}
  .table-header-cell:last-child{display:none}
  .token-icon{width:40px;height:40px}
  .token-name-col h3{font-size:14px}
  .token-price-col{font-size:15px}
  .change-badge{padding:4px 10px;font-size:12px}
  .section-header{flex-direction:column;align-items:flex-start;gap:16px;margin-bottom:24px}
  .filter-tabs{flex-wrap:wrap;width:100%}
  .filter-tab{padding:8px 16px;font-size:12px}
  .user-tabs{flex-wrap:wrap;gap:8px}
  .user-tab{padding:10px 16px;font-size:12px}
  .portfolio-summary{grid-template-columns:1fr;gap:12px}
  .holdings-list{grid-template-columns:1fr;gap:10px}
  .holding-row{padding:14px;gap:10px}
  .holding-stats{grid-template-columns:repeat(2,1fr);gap:8px}
  .holding-stat-value{font-size:12px}
  .add-holding-form{grid-template-columns:1fr;gap:10px}
  .add-alert-form{grid-template-columns:1fr;gap:10px}
  .modal-content{width:95vw;max-width:500px;padding:24px}
  .admin-controls{flex-wrap:wrap;padding:12px 16px}
  .admin-btn{padding:8px 16px;font-size:12px}
}
@media(max-width:768px){
  .navbar{padding:12px 16px}
  .logo-icon{width:36px;height:36px;min-width:36px;min-height:36px}
  .logo-icon img{max-width:36px;max-height:36px}
  .logo-title{font-size:16px}
  .logo-subtitle{font-size:10px}
  .nav-right{gap:8px}
  .live-indicator{padding:6px 12px}
  .live-text{font-size:11px}
  .time-display{font-size:12px;display:none}
  .container{padding:16px 12px}
  .hero-carousel-wrapper{padding:0 32px;margin-bottom:20px}
  .carousel-card{min-width:220px;max-width:220px;padding:14px}
  .carousel-card-value{font-size:18px}
  .carousel-card-title{font-size:10px}
  .carousel-card-subtitle{font-size:10px}
  .carousel-nav{width:32px;height:32px;font-size:16px;right:4px}
  .content-grid{gap:16px}
  .main-section{padding:20px 16px;border-radius:16px}
  .section-title{font-size:22px}
  .token-row{grid-template-columns:40px 1.5fr 1fr;gap:8px;padding:12px;border-radius:12px}
  .token-icon{width:36px;height:36px}
  .token-name-col h3{font-size:13px;margin-bottom:2px}
  .token-symbol{font-size:11px}
  .token-price-col{font-size:14px}
  .token-change-col{display:none}
  .table-header{grid-template-columns:40px 1.5fr 1fr;gap:8px;padding:10px 12px}
  .table-header-cell:nth-child(4),.table-header-cell:nth-child(5){display:none}
  .filter-tabs{padding:4px;gap:4px}
  .filter-tab{padding:8px 12px;font-size:11px;letter-spacing:0.5px}
  .user-tabs{gap:6px;margin-bottom:20px}
  .user-tab{padding:10px 14px;font-size:11px}
  .portfolio-summary{grid-template-columns:1fr;gap:10px;margin-bottom:24px}
  .summary-card{padding:16px}
  .summary-value{font-size:20px}
  .holdings-list{grid-template-columns:1fr;gap:10px}
  .holding-row{padding:14px;gap:10px}
  .holding-header{gap:10px;padding-bottom:10px}
  .holding-icon-wrapper{width:40px;height:40px}
  .holding-name{font-size:14px}
  .holding-stats{grid-template-columns:repeat(2,1fr);gap:8px}
  .holding-stat-value{font-size:12px}
  .holding-actions{flex-direction:row;gap:6px;padding-top:10px}
  .edit-btn,.delete-btn{padding:8px 12px;font-size:11px}
  .add-holding-form{grid-template-columns:1fr;gap:8px;margin-top:20px}
  .add-alert-form{grid-template-columns:1fr;gap:8px;margin-top:20px}
  .modal-content{width:95vw;padding:20px;border-radius:16px}
  .modal-header{padding:20px;border-radius:16px 16px 0 0}
  .modal-title{font-size:18px}
  .modal-input input{padding:12px 14px;font-size:14px}
  .modal-btn{padding:10px 20px;font-size:12px}
  .admin-controls{flex-direction:column;align-items:stretch;gap:8px;padding:12px}
  .admin-btn{width:100%;justify-content:center}
  .sidebar-card{padding:20px;border-radius:14px}
  .quotes-list,.top-gainers-list{gap:8px}
}

/* SKELETON LOADING STATES */
.skeleton{background:linear-gradient(90deg,#1a1a1a 25%,#0f0f0f 50%,#1a1a1a 75%);background-size:200% 100%;animation:loading 1.5s ease-in-out infinite;border-radius:8px}
@keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-text{height:16px;margin:8px 0;border-radius:4px}
.skeleton-circle{width:56px;height:56px;border-radius:50%}
.skeleton-card{height:80px;border-radius:12px;margin-bottom:12px}

/* NOTIFICATION PANEL */
.notification-panel {
  position: fixed;
  top: 70px;
  right: 20px;
  width: 400px;
  max-width: 90vw;
  max-height: calc(100vh - 90px);
  background: var(--bg-card);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 20px rgba(99, 102, 241, 0.1);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.9;
  }
}

.notification-panel-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notification-panel-header h3 {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.notification-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.notification-item {
  padding: 12px 16px;
  margin-bottom: 8px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-secondary);
  border-radius: var(--radius-md);
  border-left: 3px solid var(--accent-primary);
  cursor: pointer;
  transition: all 0.2s;
}

.notification-item:hover {
  background: var(--bg-card-hover);
  border-color: var(--border-primary);
}

.notification-item.unread {
  background: rgba(99, 102, 241, 0.15);
  border-left-color: var(--accent-primary);
  border-left-width: 4px;
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
}

.notification-item-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.notification-item-message {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.notification-item-time {
  font-size: 11px;
  color: var(--text-tertiary);
}

.notification-panel-footer {
  padding: 12px 20px;
  border-top: 1px solid var(--border-secondary);
  text-align: center;
  background: var(--bg-tertiary);
}

.notification-panel-footer button {
  transition: all 0.2s;
}

.notification-panel-footer button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* DASHBOARD STAT CARDS */
.dashboard-stat-card {
  transition: all 0.3s ease;
  cursor: pointer;
}

.dashboard-stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2), 0 0 20px rgba(99, 102, 241, 0.1);
  border-color: var(--accent-primary);
}

.dashboard-action-btn {
  transition: all 0.3s ease;
}

.dashboard-action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  border-color: var(--border-primary);
}

/* ENHANCED ERROR HANDLING */
.error{background:rgba(239,68,68,.1);border:2px solid rgba(239,68,68,.3);color:#ef4444;border-radius:16px;padding:24px;margin:24px 0;font-weight:700;text-align:center;animation:fadeInUp .5s ease-out}
.error strong{display:block;margin-bottom:8px;font-size:16px}
.error small{display:block;margin-top:12px;opacity:.8;font-size:12px}
.warning{background:rgba(245,158,11,.1);border:2px solid rgba(245,158,11,.3);color:#f59e0b;border-radius:16px;padding:20px;margin:20px 0;font-weight:600}
.success{background:rgba(16,185,129,.1);border:2px solid rgba(16,185,129,.3);color:#10b981;border-radius:16px;padding:20px;margin:20px 0;font-weight:600}

/* ENHANCED RESPONSIVE DESIGN */
@media(max-width:1600px){
  .content-grid{grid-template-columns:340px 1fr}
  .chart-wrapper{height:280px}
}
@media(max-width:1400px){
  .content-grid{grid-template-columns:1fr}
  .hero-section{grid-template-columns:repeat(2,1fr)}
  .chart-wrapper{height:260px}
}
@media(max-width:1024px){
  .navbar{padding:16px 24px;flex-wrap:wrap;gap:12px}
  .nav-right{flex-wrap:wrap;gap:12px}
  .container{padding:24px}
  .token-row{grid-template-columns:50px 1.5fr 1fr 1fr;gap:12px;padding:16px}
  .token-mcap-col{display:none}
  .table-header{grid-template-columns:50px 1.5fr 1fr 1fr;gap:12px;padding:12px}
  .table-header-cell:last-child{display:none}
  .hero-section{grid-template-columns:repeat(2,1fr);gap:16px}
  .hero-stat{padding:16px}
  .chart-wrapper{height:250px}
  .token-detail-content{padding:24px;width:95%}
  .chart-header{flex-direction:column;align-items:flex-start}
  .chart-controls{width:100%;justify-content:flex-start}
}
@media(max-width:768px){
  .navbar{padding:12px 16px}
  .logo-title{font-size:18px}
  .logo-icon{width:36px;height:36px}
  .container{padding:16px}
  .hero-section{grid-template-columns:1fr;gap:12px}
  .content-grid{grid-template-columns:1fr;gap:24px}
  .token-row{grid-template-columns:40px 1fr 1fr;gap:8px;padding:12px}
  .table-header{grid-template-columns:40px 1fr 1fr;gap:8px}
  .token-price-col,.token-change-col{font-size:14px}
  .chart-wrapper{height:200px}
  .chart-controls{flex-wrap:wrap;width:100%}
  .chart-btn{flex:1;min-width:60px;text-align:center}
  .portfolio-summary{grid-template-columns:1fr;gap:12px}
  .holding-row{grid-template-columns:40px 1fr 1fr;gap:8px;padding:12px}
  .add-holding-form,.add-alert-form{grid-template-columns:1fr;gap:8px}
  .filter-tabs{flex-wrap:wrap}
  .user-tabs{flex-wrap:wrap}
  .token-detail-content{padding:20px;width:98%}
  .chart-container{padding:16px}
}

@media(max-width:480px){
  .navbar{flex-direction:column;align-items:flex-start;gap:12px}
  .nav-right{width:100%;justify-content:space-between}
  .auth-buttons{width:100%;flex-direction:column}
  .auth-btn{width:100%}
  .token-row{grid-template-columns:1fr;gap:8px;text-align:center}
  .token-icon-col{justify-self:center}
  .chart-wrapper{height:180px}
  .chart-btn{font-size:11px;padding:5px 12px}
  .token-detail-content{padding:16px;width:100%;max-height:95vh}
  .chart-container{padding:12px}
  .chart-title{font-size:16px}
  .quote-item,.gainer-item{padding:12px;border-radius:10px}
  .settings-panel{gap:12px}
  .setting-item{flex-direction:column;align-items:flex-start;gap:8px}
  .alert-row{grid-template-columns:40px 1fr 1fr 60px;gap:10px;padding:14px;font-size:12px}
  .alert-row>div:nth-child(3){display:none}
  #portfolioAnalytics{padding:20px}
  #analyticsGrid{grid-template-columns:1fr!important;gap:20px}
  #portfolioAnalytics>div:first-child{flex-direction:column;align-items:flex-start;gap:12px}
  #allocationChart{max-width:100%!important;height:auto!important}
  #tokenOfTheDay{padding:20px}
  #todStatsGrid{grid-template-columns:1fr!important;gap:12px}
}
/* Mobile Portrait (320px - 479px) */
@media(max-width:479px){
  .navbar{padding:10px 12px}
  .logo-icon{width:32px;height:32px;min-width:32px;min-height:32px}
  .logo-icon img{max-width:32px;max-height:32px}
  .logo-title{font-size:14px}
  .auth-btn{padding:6px 12px;font-size:11px}
  .container{padding:12px 8px}
  .hero-carousel-wrapper{padding:0 24px;margin-bottom:16px}
  .carousel-card{min-width:200px;max-width:200px;padding:12px}
  .carousel-card-value{font-size:16px}
  .carousel-card-title{font-size:9px}
  .carousel-card-subtitle{font-size:9px}
  .carousel-nav{width:28px;height:28px;font-size:14px;right:2px}
  .main-section{padding:16px 12px}
  .section-title{font-size:18px}
  .token-row{grid-template-columns:36px 1fr 1fr;padding:10px;gap:6px}
  .token-icon{width:32px;height:32px}
  .token-name-col h3{font-size:12px}
  .token-price-col{font-size:13px}
  .filter-tab{padding:6px 10px;font-size:10px}
  .user-tab{padding:8px 12px;font-size:10px}
  .holdings-list{grid-template-columns:1fr;gap:8px}
  .holding-row{padding:12px;gap:8px}
  .holding-header{gap:8px;padding-bottom:8px}
  .holding-icon-wrapper{width:36px;height:36px}
  .holding-name{font-size:13px}
  .holding-stats{grid-template-columns:repeat(2,1fr);gap:6px}
  .holding-stat-value{font-size:11px}
  .holding-actions{flex-direction:row;gap:4px;padding-top:8px}
  .edit-btn,.delete-btn{padding:6px 10px;font-size:10px}
  .modal-content{width:98vw;padding:16px}
  .modal-header{padding:16px}
  .modal-title{font-size:16px}
  .sidebar-card{padding:16px}
  .quote-item,.gainer-item{padding:10px}
  #portfolioAnalytics{padding:16px}
  #portfolioAnalytics>div:first-child{margin-bottom:16px}
  #allocationChart{width:100%!important;height:auto!important}
  #tokenOfTheDay{padding:16px}
  #tokenOfTheDay>div:first-child{flex-direction:column;gap:12px;margin-bottom:12px}
  #todTokenIcon{width:48px!important;height:48px!important}
  #etfDataMain{margin-bottom:24px}
  #etfCarousel,#activityCarousel{overflow-x:auto;scroll-snap-type:x mandatory}
  #etfCarousel .carousel-card,#activityCarousel .carousel-card{scroll-snap-align:start}
}

/* Very Small Mobile (max-width: 360px) */
@media(max-width:360px){
  .container{padding:10px 6px}
  .navbar{padding:8px 10px}
  .logo-title{font-size:12px}
  .logo-subtitle{font-size:9px}
  .auth-btn{padding:5px 10px;font-size:10px}
  .hero-carousel-wrapper{padding:0 20px}
  .carousel-card{min-width:180px;max-width:180px;padding:10px}
  .carousel-card-value{font-size:14px}
  .carousel-card-title{font-size:8px}
  .main-section{padding:12px 8px}
  .section-title{font-size:16px}
  .token-row{grid-template-columns:32px 1fr 1fr;padding:8px;gap:4px}
  .token-icon{width:28px;height:28px}
  .token-name-col h3{font-size:11px}
  .token-price-col{font-size:12px}
  .filter-tab{padding:5px 8px;font-size:9px}
  .user-tab{padding:6px 10px;font-size:9px}
  .modal-content{width:100vw;padding:12px;border-radius:12px}
  .modal-title{font-size:14px}
}
/* Landscape Orientation Optimizations */
@media(orientation:landscape) and (max-height:600px){
  .navbar{padding:8px 16px}
  .hero-carousel-wrapper{padding:0 24px;margin-bottom:16px}
  .carousel-card{min-width:180px;max-width:180px;padding:10px}
  .carousel-card-value{font-size:14px}
  .container{padding:16px 20px}
  .main-section{padding:20px 16px}
  .section-title{font-size:20px}
  .token-row{padding:12px 16px}
  .portfolio-summary{grid-template-columns:repeat(3,1fr);gap:12px}
}

/* High DPI / Retina Displays */
@media(-webkit-min-device-pixel-ratio:2),(min-resolution:192dpi){
  .token-icon,.logo-icon img{border-width:1.5px}
  .carousel-card{border-width:0.5px}
}

/* Print Styles */
@media print{
  .navbar,.admin-controls,.carousel-nav,.filter-tabs,.user-tabs{display:none}
  .container{max-width:100%;padding:20px}
  .main-section{box-shadow:none;border:none}
  .token-row,.holding-row{page-break-inside:avoid}
}
/* Touch-friendly improvements for mobile devices */
@media(hover:none) and (pointer:coarse){
  .auth-btn,.admin-btn,.modal-btn,.filter-tab,.user-tab{min-height:44px;min-width:44px}
  .edit-btn,.delete-btn{min-height:40px;min-width:40px;padding:10px 14px}
  .carousel-card:hover{transform:none}
  .token-row:hover{transform:none}
  .quote-item:hover,.gainer-item:hover{transform:none}
  .holding-row:hover{transform:none}
  button,select,input[type="text"],input[type="number"],input[type="email"],input[type="password"]{font-size:16px}
}

/* Prevent text size adjustment on iOS */
@media screen and (max-width:768px){
  input,select,textarea{font-size:16px!important}
  button{font-size:16px!important}
}

/* Smooth scrolling for all devices */
html{scroll-behavior:smooth}
body{overflow-x:hidden}

/* Ensure proper box-sizing */
*,*::before,*::after{box-sizing:border-box}

/* Improve carousel responsiveness and centering */
.hero-carousel-wrapper{width:100%;overflow:hidden;position:relative;display:flex;justify-content:center;align-items:center}
.carousel{width:100%;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;display:flex;justify-content:flex-start;align-items:center}
.carousel-card{flex-shrink:0}
/* Center carousel when content fits in viewport (handled by JavaScript) */
.carousel.centered{justify-content:center}

/* Responsive ETF and Activity carousels */
#etfCarousel,#activityCarousel{width:100%;overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
#etfCarousel .carousel-card,#activityCarousel .carousel-card{flex-shrink:0}

/* Responsive quotes section */
#quotesSection{width:100%;max-width:100%;overflow:hidden}

/* ETF Two-Column Layout Responsive */
#etfDataMainContent > div:first-of-type{display:grid;grid-template-columns:1fr 1fr;gap:20px}
@media(max-width:768px){
  #etfDataMainContent > div:first-of-type{grid-template-columns:1fr!important}
}

/* ═══════════════════════════════════════════════════════════════
   📱 PWA / MOBILE RESPONSIVE FIXES
   ═══════════════════════════════════════════════════════════════ */

/* Portfolio Analytics - Mobile Optimization */
@media(max-width:768px){
  /* Portfolio Analytics Header */
  #portfolioAnalytics > div:first-child{
    padding:16px 12px!important;
    margin-bottom:20px!important;
    flex-direction:column!important;
    align-items:flex-start!important;
    gap:12px!important;
  }
  #portfolioAnalytics > div:first-child > div:first-child{
    width:100%!important;
  }
  #portfolioAnalytics > div:first-child > div:first-child h3{
    font-size:18px!important;
  }
  #portfolioAnalytics > div:first-child > div:first-child > div{
    font-size:9px!important;
  }
  #toggleAnalytics{
    width:100%!important;
    padding:10px 16px!important;
    font-size:11px!important;
  }
  
  /* Allocation Section */
  #portfolioAnalytics > div:last-child{
    padding:16px 12px!important;
  }
  #portfolioAnalytics > div:last-child > div > div:first-child{
    flex-direction:column!important;
    align-items:flex-start!important;
    gap:12px!important;
    margin-bottom:16px!important;
  }
  
  /* Daily Change Display - Stack on Mobile */
  #portfolioAnalytics > div:last-child > div > div:first-child > div:last-child{
    width:100%!important;
    align-items:flex-start!important;
    padding:10px 14px!important;
  }
  #portfolio24hChange{
    font-size:18px!important;
  }
  #portfolio24hChangeUSD{
    font-size:12px!important;
  }
  
  /* Token Legend - Responsive Grid */
  #allocationLegend{
    grid-template-columns:repeat(2,1fr)!important;
    gap:8px!important;
  }
  #allocationLegend > div{
    padding:8px 10px!important;
    font-size:10px!important;
  }
  #allocationLegend > div > span:first-child{
    width:8px!important;
    height:8px!important;
  }
  #allocationLegend > div > span:nth-child(2){
    font-size:10px!important;
  }
  #allocationLegend > div > span:last-child{
    font-size:10px!important;
  }
}

@media(max-width:480px){
  /* Portfolio Analytics - Extra Small Mobile */
  #portfolioAnalytics > div:first-child{
    padding:12px 10px!important;
    margin-bottom:16px!important;
  }
  #portfolioAnalytics > div:first-child > div:first-child h3{
    font-size:16px!important;
  }
  #toggleAnalytics{
    padding:8px 12px!important;
    font-size:10px!important;
  }
  
  /* Allocation Section */
  #portfolioAnalytics > div:last-child{
    padding:12px 10px!important;
  }
  
  /* Daily Change */
  #portfolio24hChange{
    font-size:16px!important;
  }
  #portfolio24hChangeUSD{
    font-size:11px!important;
  }
  
  /* Token Legend - Single Column on Very Small Screens */
  #allocationLegend{
    grid-template-columns:1fr!important;
    gap:6px!important;
  }
  #allocationLegend > div{
    padding:6px 8px!important;
  }
}

/* Mobile Menu - Show/Hide Based on Screen Size */
@media(max-width:768px){
  /* Hide top nav tabs on mobile, show hamburger */
  .top-nav-tabs{
    display:none!important;
  }
  .sidebar-toggle{
    display:flex!important;
  }
  
  /* Show mobile sidebar */
  .sidebar{
    display:block!important;
    position:fixed!important;
    top:0!important;
    left:0!important;
    width:280px!important;
    max-width:85vw!important;
    height:100vh!important;
    background:var(--bg-secondary)!important;
    backdrop-filter:blur(20px)!important;
    border-right:1px solid var(--border-secondary)!important;
    z-index:1000!important;
    transform:translateX(-100%)!important;
    transition:transform 0.3s cubic-bezier(0.4,0,0.2,1)!important;
    box-shadow:4px 0 24px rgba(0,0,0,0.3)!important;
    overflow-y:auto!important;
    padding-top:70px!important;
  }
  .sidebar.active{
    transform:translateX(0)!important;
  }
  .sidebar-menu{
    display:flex!important;
    flex-direction:column!important;
    gap:8px!important;
    padding:20px 16px!important;
  }
  .sidebar-item{
    display:flex!important;
    align-items:center!important;
    gap:12px!important;
    padding:14px 16px!important;
    border-radius:12px!important;
    font-size:15px!important;
    font-weight:500!important;
    min-height:48px!important;
  }
  .sidebar-icon{
    display:inline-block!important;
    font-size:20px!important;
    width:24px!important;
    text-align:center!important;
  }
  .sidebar-text{
    display:inline-block!important;
    flex:1!important;
  }
  .sidebar-overlay{
    display:block!important;
  }
}

@media(min-width:769px){
  .sidebar-toggle{
    display:none!important;
  }
  .sidebar{
    display:none!important;
  }
  .sidebar-overlay{
    display:none!important;
  }
}

@media(max-width:480px){
  .top-nav-tabs{
    padding:0 4px!important;
  }
  .top-nav-tab{
    font-size:10px!important;
    padding:6px 10px!important;
  }
}

/* Main Content - Better Mobile Spacing */
@media(max-width:768px){
  .main-content{
    padding:16px 12px!important;
    padding-top:84px!important;
  }
  .container{
    padding:0!important;
  }
}

@media(max-width:480px){
  .main-content{
    padding:12px 8px!important;
    padding-top:80px!important;
  }
}

/* Hero Stats - Better Mobile Grid */
@media(max-width:480px){
  .hero-section{
    grid-template-columns:1fr!important;
    gap:8px!important;
  }
  .hero-stat{
    min-height:70px!important;
    padding:12px!important;
  }
}

/* Summary Cards - Mobile Optimization */
@media(max-width:768px){
  .portfolio-summary{
    grid-template-columns:repeat(2,1fr)!important;
    gap:10px!important;
  }
  .summary-card{
    padding:14px 12px!important;
  }
  .summary-value{
    font-size:18px!important;
  }
  .summary-label{
    font-size:9px!important;
  }
}

@media(max-width:480px){
  .portfolio-summary{
    grid-template-columns:1fr!important;
    gap:8px!important;
  }
  .summary-card{
    padding:12px 10px!important;
  }
  .summary-value{
    font-size:16px!important;
  }
}

/* Holdings List - Mobile Optimization */
@media(max-width:768px){
  .holdings-list{
    grid-template-columns:1fr!important;
    gap:10px!important;
  }
  .holding-row{
    padding:14px 12px!important;
    flex-direction:column!important;
    gap:12px!important;
  }
  .holding-stats{
    grid-template-columns:repeat(2,1fr)!important;
    gap:8px!important;
    width:100%!important;
  }
}

/* Token Rows - Mobile Optimization */
@media(max-width:768px){
  .token-row{
    grid-template-columns:40px 1fr 1fr!important;
    gap:8px!important;
    padding:12px 10px!important;
  }
  .token-icon{
    width:36px!important;
    height:36px!important;
  }
  .token-name-col h3{
    font-size:13px!important;
  }
  .token-price-col{
    font-size:14px!important;
  }
  .token-change-col{
    display:none!important;
  }
  .token-mcap-col{
    display:none!important;
  }
}

/* Carousel - Mobile Optimization */
@media(max-width:768px){
  .carousel-card{
    min-width:160px!important;
    max-width:160px!important;
    padding:10px 12px!important;
  }
  .carousel-card-value{
    font-size:16px!important;
  }
  .carousel-card-title{
    font-size:9px!important;
  }
}

@media(max-width:480px){
  .carousel-card{
    min-width:140px!important;
    max-width:140px!important;
    padding:8px 10px!important;
  }
  .carousel-card-value{
    font-size:14px!important;
  }
}

/* Forms - Mobile Optimization */
@media(max-width:768px){
  .add-holding-form,
  .add-alert-form,
  #addTargetForm{
    grid-template-columns:1fr!important;
    gap:10px!important;
  }
  input,select,textarea{
    font-size:16px!important;
    padding:12px 14px!important;
  }
  button[type="submit"]{
    padding:12px 20px!important;
    font-size:14px!important;
  }
}

/* Modals - Mobile Optimization */
@media(max-width:768px){
  .modal-content{
    width:95vw!important;
    max-width:95vw!important;
    padding:20px 16px!important;
    margin:20px auto!important;
  }
  .modal-title{
    font-size:18px!important;
  }
}

@media(max-width:480px){
  .modal-content{
    width:98vw!important;
    padding:16px 12px!important;
  }
  .modal-title{
    font-size:16px!important;
  }
}

/* ASI Panel - Mobile Optimization */
@media(max-width:768px){
  #asiAlliancePanel{
    padding:16px 12px!important;
    min-height:auto!important;
  }
  #asiTokensGrid{
    grid-template-columns:repeat(auto-fill,minmax(140px,1fr))!important;
    gap:8px!important;
  }
}

@media(max-width:480px){
  #asiAlliancePanel{
    padding:12px 10px!important;
  }
  #asiTokensGrid{
    grid-template-columns:1fr!important;
    gap:8px!important;
  }
}

/* Touch Targets - PWA Optimization */
@media(hover:none) and (pointer:coarse){
  .top-nav-tab,
  .auth-btn,
  .filter-tab,
  .user-tab,
  button,
  .edit-btn,
  .delete-btn{
    min-height:44px!important;
    min-width:44px!important;
  }
}



/* Professional pages - hide decorative elements */
#portfolioPage .grain-overlay,
#alertsPage .grain-overlay,
#targetsPage .grain-overlay,
#tradingJournalPage .grain-overlay {
  display: none !important;
}

#portfolioPage,
#alertsPage,
#targetsPage,
#tradingJournalPage {
  background: var(--bg-primary) !important;
}

#portfolioPage::before,
#alertsPage::before,
#targetsPage::before,
#tradingJournalPage::before {
  display: none !important;
}

/* Trading Journal Table Styles */
#tradesTable tbody tr:nth-child(even) {
  background: var(--bg-tertiary) !important;
}

#tradesTable tbody tr:nth-child(odd) {
  background: var(--bg-card) !important;
}

#tradesTable tbody tr:hover {
  background: var(--bg-card-hover) !important;
}

/* Tablet styles */
@media (max-width: 1024px) and (min-width: 769px) {
  .app-sidebar {
    width: 240px !important;
    min-width: 240px !important;
  }
  
  .app-sidebar.collapsed {
    width: 80px !important;
    min-width: 80px !important;
  }
}
</style>
</head>
<body>

<div class="grain-overlay"></div>

<!-- Notification Panel -->
<div id="notificationPanel" class="notification-panel" style="display:none;">
  <div class="notification-panel-header">
    <h3>Notifications</h3>
    <button onclick="closeNotificationPanel()" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:20px;">×</button>
  </div>
  <div id="notificationList" class="notification-list"></div>
  <div class="notification-panel-footer">
    <button onclick="clearAllNotifications()" style="padding:8px 16px;background:transparent;border:1px solid var(--border-primary);color:var(--text-secondary);border-radius:8px;cursor:pointer;font-size:12px;">Clear All</button>
  </div>
</div>

<nav class="navbar">
  <div class="logo-section">
    <div class="logo-icon"><img src="https://ta3bviqjtxy1kv7x.public.blob.vercel-storage.com/sticker.webp" alt="Logo"></div>
    <div class="logo-text">
      <div class="logo-title">CRYPTO COLLECTIVE X</div>
      <div class="logo-subtitle"></div>
    </div>
  </div>

  <!-- Top Navigation - Simplified (Logo and Actions Only) -->
  <div style="flex:1;display:flex;justify-content:center;align-items:center;">
    <!-- Search bar can go here in future -->
  </div>

  <div class="nav-right">
    <button class="theme-toggle" id="refreshButton" aria-label="Refresh data" title="Refresh data" style="position:relative;">
      <span id="refreshIcon">🔄</span>
    </button>
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme" title="Theme toggle">
      <span id="themeIcon">🌙</span>
    </button>
    <button class="theme-toggle" id="notificationToggle" aria-label="Notifications" title="Notifications" style="position:relative;">
      <span id="notificationIcon">🔔</span>
      <span id="notificationBadge" style="display:none;position:absolute;top:-6px;right:-6px;background:linear-gradient(135deg, #ef4444, #dc2626);color:#fff;border-radius:50%;width:20px;height:20px;font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid var(--bg-primary);box-shadow:0 2px 8px rgba(239,68,68,0.4);animation:pulse 2s infinite;">0</span>
    </button>
    <div class="live-indicator"><div class="live-dot"></div><div class="live-text">live</div></div>
    <div class="time-display" id="navTime">--:--:--</div>

    <div id="authContainer">
      <div class="auth-buttons">
        <button class="auth-btn" id="loginBtn">შესვლა</button>
        <button class="auth-btn primary" id="registerBtn">რეგისტრაცია</button>
      </div>
    </div>

    <div id="userContainer" class="user-menu" style="display:none;">
      <img id="userAvatar" class="user-avatar" src="" alt="ავატარი">
      <span id="userName" class="user-name"></span>
      <button class="auth-btn" id="logoutBtn">გასვლა</button>
    </div>

    <div id="adminControls" class="admin-controls" style="display:none;gap:12px;align-items:center;padding:14px 24px;background:rgba(15,20,30,.6);border:1px solid rgba(255,255,255,.12);border-radius:14px;backdrop-filter:blur(16px) saturate(180%);box-shadow:0 4px 16px rgba(0,0,0,.2);">
      <div style="display:flex;align-items:center;gap:10px;padding-right:16px;border-right:1px solid rgba(255,255,255,.1);">
        <span style="font-size:16px;opacity:0.9;">👑</span>
        <span style="font-size:11px;font-weight:600;color:#9aa0a6;text-transform:uppercase;letter-spacing:0.8px;">ადმინი</span>
    </div>
      <button class="admin-btn" id="addTokenBtn" style="padding:10px 20px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;color:#fff;font-size:13px;font-weight:600;border-radius:10px;cursor:pointer;transition:all .25s;box-shadow:0 2px 8px rgba(139,92,246,.25);letter-spacing:0.3px;">➕ ტოკენის დამატება</button>
      <button class="admin-btn" id="refreshBtn" style="padding:10px 20px;background:rgba(52,168,83,.12);border:1.5px solid rgba(52,168,83,.25);color:#34a853;font-size:13px;font-weight:600;border-radius:10px;cursor:pointer;transition:all .25s;letter-spacing:0.3px;">🔄 განახლება</button>
    </div>
    
  </div>
</nav>

<!-- Desktop Sidebar Navigation -->
<aside class="app-sidebar" id="appSidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">
      <span>📊</span>
      <span class="sidebar-nav-text">CCX</span>
    </div>
    <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" title="Collapse sidebar">◀</button>
  </div>
  <nav class="sidebar-nav">
    <div class="sidebar-nav-item active" data-page="dashboard">
      <span class="sidebar-nav-icon">🏠</span>
      <span class="sidebar-nav-text">Dashboard</span>
    </div>
    <div class="sidebar-nav-item" data-page="market">
      <span class="sidebar-nav-icon">📊</span>
      <span class="sidebar-nav-text">ბაზარი</span>
    </div>
    <div class="sidebar-nav-item" data-page="portfolio">
      <span class="sidebar-nav-icon">💼</span>
      <span class="sidebar-nav-text">პორტფოლიო</span>
    </div>
    <div class="sidebar-nav-item" data-page="targets">
      <span class="sidebar-nav-icon">🎯</span>
      <span class="sidebar-nav-text">Trade</span>
    </div>
    <div class="sidebar-nav-item" data-page="alerts">
      <span class="sidebar-nav-icon">🔔</span>
      <span class="sidebar-nav-text">შეტყობინებები</span>
    </div>
    <div class="sidebar-nav-item" data-page="tradingJournal">
      <span class="sidebar-nav-icon">📝</span>
      <span class="sidebar-nav-text">სავაჭრო ჟურნალი</span>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section-title">ადმინისტრაცია</div>
    <div class="sidebar-nav-item" data-page="admin" id="adminNavItem" style="display:none;">
      <span class="sidebar-nav-icon">⚙️</span>
      <span class="sidebar-nav-text">Admin Panel</span>
      <span class="sidebar-nav-badge" id="adminBadge" style="display:none;">ADMIN</span>
    </div>
    <div class="sidebar-nav-item" data-page="profile">
      <span class="sidebar-nav-icon">👤</span>
      <span class="sidebar-nav-text">პროფილი</span>
    </div>
  </nav>
  <div class="sidebar-footer">
    <div class="sidebar-nav-item" style="font-size:12px;opacity:0.7;">
      <span class="sidebar-nav-icon">ℹ️</span>
      <span class="sidebar-nav-text">v1.0.0</span>
    </div>
  </div>
</aside>


<div class="main-content" id="mainContent">
<div class="container">
    <div id="loading" class="loading"><div class="spinner"></div><div class="loading-text">ბაზრის მონაცემების ჩატვირთვა...</div></div>
  <div id="error"></div>

  <!-- Dashboard Page (New Home Page) -->
  <div id="dashboardPage" class="page-content" style="display:none;">
    <div class="main-section" style="width:100%;">
      <div class="section-header" style="margin-bottom:32px;">
        <div>
          <div class="section-title" style="font-size:28px;font-weight:700;background:var(--gradient-text);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px;">Dashboard Overview</div>
          <div style="font-size:14px;color:var(--text-tertiary);">Real-time portfolio analytics and insights</div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;">
          <button onclick="refreshDashboard()" style="padding:10px 20px;background:var(--bg-tertiary);border:1px solid var(--border-primary);color:var(--text-secondary);border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;display:flex;align-items:center;gap:8px;">
            <span>🔄</span> Refresh
          </button>
        </div>
      </div>

      <!-- Professional Dashboard Stats Grid -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;margin-bottom:40px;">
        <!-- Portfolio Value Card -->
        <div class="summary-card dashboard-stat-card" style="background:linear-gradient(135deg,rgba(99,102,241,0.15) 0%,rgba(139,92,246,0.08) 100%);border:1px solid rgba(99,102,241,0.3);position:relative;overflow:hidden;">
          <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:radial-gradient(circle,rgba(99,102,241,0.2),transparent);border-radius:50%;"></div>
          <div style="position:relative;z-index:1;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
              <div>
                <div class="summary-label" style="font-size:13px;opacity:0.8;margin-bottom:8px;">Portfolio Value</div>
                <div class="summary-value" id="dashboardPortfolioValue" style="font-size:32px;font-weight:700;line-height:1.2;">$0.00</div>
        </div>
              <div style="width:48px;height:48px;background:rgba(99,102,241,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;">💼</div>
        </div>
            <div style="font-size:13px;color:var(--text-secondary);margin-top:12px;display:flex;align-items:center;gap:6px;" id="dashboardPortfolioChange">
              <span>--</span>
        </div>
        </div>
      </div>

        <!-- Holdings Count Card -->
        <div class="summary-card dashboard-stat-card" style="background:linear-gradient(135deg,rgba(59,130,246,0.15) 0%,rgba(37,99,235,0.08) 100%);border:1px solid rgba(59,130,246,0.3);position:relative;overflow:hidden;">
          <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:radial-gradient(circle,rgba(59,130,246,0.2),transparent);border-radius:50%;"></div>
          <div style="position:relative;z-index:1;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
              <div>
                <div class="summary-label" style="font-size:13px;opacity:0.8;margin-bottom:8px;">Holdings</div>
                <div class="summary-value" id="dashboardHoldingsCount" style="font-size:32px;font-weight:700;line-height:1.2;">0</div>
              </div>
              <div style="width:48px;height:48px;background:rgba(59,130,246,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;">📊</div>
            </div>
            <div style="font-size:13px;color:var(--text-secondary);margin-top:12px;" id="dashboardHoldingsInfo">Tokens tracked</div>
          </div>
      </div>

        <!-- Active Targets Card -->
        <div class="summary-card dashboard-stat-card" style="background:linear-gradient(135deg,rgba(34,197,94,0.15) 0%,rgba(16,185,129,0.08) 100%);border:1px solid rgba(34,197,94,0.3);position:relative;overflow:hidden;">
          <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:radial-gradient(circle,rgba(34,197,94,0.2),transparent);border-radius:50%;"></div>
          <div style="position:relative;z-index:1;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
              <div>
                <div class="summary-label" style="font-size:13px;opacity:0.8;margin-bottom:8px;">Active Targets</div>
                <div class="summary-value" id="dashboardActiveTargets" style="font-size:32px;font-weight:700;line-height:1.2;">0</div>
        </div>
              <div style="width:48px;height:48px;background:rgba(34,197,94,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;">🎯</div>
          </div>
            <div style="font-size:13px;color:var(--text-secondary);margin-top:12px;">Reached: <span id="dashboardReachedTargets" style="color:var(--success);font-weight:600;">0</span></div>
        </div>
      </div>

        <!-- Active Alerts Card -->
        <div class="summary-card dashboard-stat-card" style="background:linear-gradient(135deg,rgba(245,158,11,0.15) 0%,rgba(217,119,6,0.08) 100%);border:1px solid rgba(245,158,11,0.3);position:relative;overflow:hidden;">
          <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:radial-gradient(circle,rgba(245,158,11,0.2),transparent);border-radius:50%;"></div>
          <div style="position:relative;z-index:1;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
              <div>
                <div class="summary-label" style="font-size:13px;opacity:0.8;margin-bottom:8px;">Active Alerts</div>
                <div class="summary-value" id="dashboardActiveAlerts" style="font-size:32px;font-weight:700;line-height:1.2;">0</div>
              </div>
              <div style="width:48px;height:48px;background:rgba(245,158,11,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;">🔔</div>
            </div>
            <div style="font-size:13px;color:var(--text-secondary);margin-top:12px;">Triggered: <span id="dashboardTriggeredAlerts" style="color:var(--warning);font-weight:600;">0</span></div>
          </div>
    </div>
  </div>

      <!-- Professional Performance Metrics -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;margin-bottom:40px;">
        <!-- Total P&L Card -->
        <div class="summary-card" style="background:var(--bg-card);border:1px solid var(--border-secondary);padding:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div>
              <div style="font-size:12px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;">Total P&L</div>
              <div id="dashboardTotalPL" style="font-size:28px;font-weight:700;color:var(--text-primary);">$0.00</div>
      </div>
            <div style="width:40px;height:40px;background:rgba(99,102,241,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">📈</div>
          </div>
          <div style="font-size:12px;color:var(--text-tertiary);">Unrealized profit/loss</div>
    </div>

        <!-- ROI Card -->
        <div class="summary-card" style="background:var(--bg-card);border:1px solid var(--border-secondary);padding:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div>
              <div style="font-size:12px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;">ROI</div>
              <div id="dashboardROI" style="font-size:28px;font-weight:700;color:var(--text-primary);">0%</div>
      </div>
            <div style="width:40px;height:40px;background:rgba(34,197,94,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">📊</div>
          </div>
          <div style="font-size:12px;color:var(--text-tertiary);">Return on investment</div>
    </div>

        <!-- Best Performer Card -->
        <div class="summary-card" style="background:var(--bg-card);border:1px solid var(--border-secondary);padding:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div>
              <div style="font-size:12px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;">Best Performer</div>
              <div id="dashboardBestPerformer" style="font-size:20px;font-weight:700;color:var(--text-primary);">--</div>
            </div>
            <div style="width:40px;height:40px;background:rgba(34,197,94,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">⭐</div>
          </div>
          <div style="font-size:12px;color:var(--text-tertiary);" id="dashboardBestPerformerROI">Highest ROI token</div>
        </div>
      </div>

      <!-- Advanced Analytics Section -->
      <div id="advancedAnalytics" style="display:none;margin-bottom:32px;">
        <div class="section-header" style="margin-bottom:20px;">
          <div class="section-title">📊 Advanced Analytics</div>
          <button onclick="toggleAdvancedAnalytics()" style="padding:8px 16px;background:var(--bg-tertiary);border:1px solid var(--border-primary);color:var(--text-secondary);border-radius:8px;cursor:pointer;font-size:12px;">Hide</button>
        </div>
        
        <!-- Performance Charts -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:24px;">
          <!-- Portfolio Performance Chart -->
          <div class="summary-card" style="padding:24px;">
            <h4 style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:16px;">Portfolio Performance</h4>
            <canvas id="portfolioPerformanceChart" style="max-height:300px;"></canvas>
          </div>
          
          <!-- Asset Allocation Chart -->
          <div class="summary-card" style="padding:24px;">
            <h4 style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:16px;">Asset Allocation</h4>
            <canvas id="assetAllocationChart" style="max-height:300px;"></canvas>
          </div>
        </div>

        <!-- P&L Tracking -->
        <div class="summary-card" style="padding:24px;margin-bottom:24px;">
          <h4 style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:16px;">Profit & Loss Tracking</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
            <div>
              <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px;">Total P&L</div>
              <div id="totalPL" style="font-size:24px;font-weight:700;color:var(--text-primary);">$0.00</div>
            </div>
            <div>
              <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px;">Realized P&L</div>
              <div id="realizedPL" style="font-size:24px;font-weight:700;color:var(--text-primary);">$0.00</div>
            </div>
            <div>
              <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px;">Unrealized P&L</div>
              <div id="unrealizedPL" style="font-size:24px;font-weight:700;color:var(--text-primary);">$0.00</div>
            </div>
            <div>
              <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px;">ROI</div>
              <div id="roiPercentage" style="font-size:24px;font-weight:700;color:var(--text-primary);">0%</div>
            </div>
          </div>
        </div>

      </div>

      <!-- Toggle Advanced Analytics Button -->
      <div style="text-align:center;margin-bottom:32px;">
        <button onclick="toggleAdvancedAnalytics()" id="toggleAnalyticsBtn" style="padding:12px 24px;background:var(--accent-primary);border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;">Show Advanced Analytics</button>
      </div>

      <!-- Professional Quick Actions -->
      <div style="margin-bottom:40px;">
        <div style="font-size:18px;font-weight:600;color:var(--text-primary);margin-bottom:20px;">Quick Actions</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;">
          <button onclick="showPage('portfolio')" class="dashboard-action-btn" style="padding:24px;background:linear-gradient(135deg,var(--bg-card) 0%,var(--bg-tertiary) 100%);border:1px solid var(--border-secondary);border-radius:16px;cursor:pointer;transition:all 0.3s;text-align:left;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgba(99,102,241,0.1),transparent);border-radius:50%;transform:translate(30px,-30px);"></div>
            <div style="position:relative;z-index:1;">
              <div style="font-size:32px;margin-bottom:12px;display:inline-block;width:56px;height:56px;background:rgba(99,102,241,0.15);border-radius:12px;display:flex;align-items:center;justify-content:center;">💼</div>
              <div style="font-weight:600;color:var(--text-primary);margin-bottom:6px;font-size:16px;">View Portfolio</div>
              <div style="font-size:13px;color:var(--text-tertiary);line-height:1.5;">Manage your holdings and track performance</div>
            </div>
        </button>
          <button onclick="showPage('targets')" class="dashboard-action-btn" style="padding:24px;background:linear-gradient(135deg,var(--bg-card) 0%,var(--bg-tertiary) 100%);border:1px solid var(--border-secondary);border-radius:16px;cursor:pointer;transition:all 0.3s;text-align:left;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgba(34,197,94,0.1),transparent);border-radius:50%;transform:translate(30px,-30px);"></div>
            <div style="position:relative;z-index:1;">
              <div style="font-size:32px;margin-bottom:12px;display:inline-block;width:56px;height:56px;background:rgba(34,197,94,0.15);border-radius:12px;display:flex;align-items:center;justify-content:center;">🎯</div>
              <div style="font-weight:600;color:var(--text-primary);margin-bottom:6px;font-size:16px;">Manage Targets</div>
              <div style="font-size:13px;color:var(--text-tertiary);line-height:1.5;">Set and track sell targets</div>
            </div>
        </button>
          <button onclick="showPage('market')" class="dashboard-action-btn" style="padding:24px;background:linear-gradient(135deg,var(--bg-card) 0%,var(--bg-tertiary) 100%);border:1px solid var(--border-secondary);border-radius:16px;cursor:pointer;transition:all 0.3s;text-align:left;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgba(59,130,246,0.1),transparent);border-radius:50%;transform:translate(30px,-30px);"></div>
            <div style="position:relative;z-index:1;">
              <div style="font-size:32px;margin-bottom:12px;display:inline-block;width:56px;height:56px;background:rgba(59,130,246,0.15);border-radius:12px;display:flex;align-items:center;justify-content:center;">📊</div>
              <div style="font-weight:600;color:var(--text-primary);margin-bottom:6px;font-size:16px;">Market Data</div>
              <div style="font-size:13px;color:var(--text-tertiary);line-height:1.5;">View real-time crypto prices</div>
            </div>
        </button>
          <button onclick="showPage('alerts')" class="dashboard-action-btn" style="padding:24px;background:linear-gradient(135deg,var(--bg-card) 0%,var(--bg-tertiary) 100%);border:1px solid var(--border-secondary);border-radius:16px;cursor:pointer;transition:all 0.3s;text-align:left;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgba(245,158,11,0.1),transparent);border-radius:50%;transform:translate(30px,-30px);"></div>
            <div style="position:relative;z-index:1;">
              <div style="font-size:32px;margin-bottom:12px;display:inline-block;width:56px;height:56px;background:rgba(245,158,11,0.15);border-radius:12px;display:flex;align-items:center;justify-content:center;">🔔</div>
              <div style="font-weight:600;color:var(--text-primary);margin-bottom:6px;font-size:16px;">Price Alerts</div>
              <div style="font-size:13px;color:var(--text-tertiary);line-height:1.5;">Set price notifications</div>
            </div>
        </button>
        </div>
      </div>

      <!-- Top Holdings Preview -->
      <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:20px;padding:28px;margin-bottom:32px;box-shadow:0 4px 20px rgba(0,0,0,0.1);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
          <div>
            <div class="section-title" style="font-size:20px;font-weight:600;margin-bottom:6px;">Top Holdings</div>
            <div style="font-size:13px;color:var(--text-tertiary);">Your best performing assets</div>
          </div>
          <button onclick="showPage('portfolio')" style="padding:8px 16px;background:var(--bg-tertiary);border:1px solid var(--border-primary);color:var(--text-secondary);border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s;">View All →</button>
        </div>
        <div id="dashboardTopHoldings" style="min-height:120px;">
          <div style="text-align:center;padding:40px;color:var(--text-tertiary);">
            <div style="font-size:32px;margin-bottom:12px;">💼</div>
            <div style="font-size:14px;">No holdings yet</div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:20px;padding:28px;box-shadow:0 4px 20px rgba(0,0,0,0.1);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
          <div>
            <div class="section-title" style="font-size:20px;font-weight:600;margin-bottom:6px;">Recent Activity</div>
            <div style="font-size:13px;color:var(--text-tertiary);">Your latest portfolio changes</div>
      </div>
        </div>
        <div id="dashboardRecentActivity" style="min-height:200px;">
          <div style="text-align:center;padding:40px;color:var(--text-tertiary);">
            <div style="font-size:32px;margin-bottom:12px;">📈</div>
            <div style="font-size:14px;">No recent activity</div>
          </div>
        </div>
      </div>
    </div>
  </div>

    <div class="hero-carousel-wrapper" id="heroStats" style="display:none;margin-bottom:24px;">
      <div class="carousel" id="heroCarousel">
        <!-- Cards will be rendered here -->
      </div>
      <button class="carousel-nav carousel-nav-right" id="carouselNext" aria-label="Next cards">→</button>
    </div>

    <!-- Recent Activity Carousel - Compact -->
    <div class="activity-carousel-wrapper" id="activityCarouselWrapper" style="display:none;margin-bottom:16px;">
      <div class="activity-carousel" id="activityCarousel">
        <!-- Activity cards will be rendered here -->
      </div>
      <button class="carousel-nav carousel-nav-right" id="activityCarouselNext" aria-label="Next cards">→</button>
    </div>

    <!-- Artificial Superintelligence Alliance Panel -->
    <div id="asiAlliancePanel" style="display:none;margin-bottom:24px;background:var(--bg-card);backdrop-filter:var(--blur);border:1px solid var(--border-secondary);border-radius:var(--radius-lg);padding:20px;position:relative;overflow:hidden;box-shadow:var(--shadow-md);transition:all 0.3s ease;min-height:300px;" role="region" aria-label="Artificial Superintelligence Alliance">
      <!-- Background Music Player -->
      <audio id="asiBackgroundMusic" loop preload="auto" style="display:none;" volume="0.5">
        <source src="/Inception.ogg" type="audio/ogg">
        <source src="Inception.ogg" type="audio/ogg">
      </audio>
      <!-- Music Control Button -->
      <button id="asiMusicToggle" onclick="toggleASIMusic()" style="position:absolute;top:12px;right:12px;width:36px;height:36px;background:rgba(99,102,241,0.2);backdrop-filter:blur(10px);border:1px solid rgba(99,102,241,0.4);border-radius:50%;cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center;color:var(--text-primary);font-size:14px;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(0,0,0,0.3);" aria-label="Toggle background music" title="Play/Pause Music" onmouseenter="this.style.transform='scale(1.1)';this.style.background='rgba(99,102,241,0.3)';" onmouseleave="if(!window.asiMusicPlaying){this.style.transform='scale(1)';this.style.background='rgba(99,102,241,0.2)';}else{this.style.transform='scale(1)';}">
        <span id="asiMusicIcon">▶</span>
      </button>
      <!-- Sophia Robot - Introducing the Panel -->
      <div style="position:absolute;top:0;right:0;width:200px;height:100%;pointer-events:none;z-index:1;opacity:0.9;background:url('sophia.png') no-repeat;background-size:contain;background-position:bottom right;filter:drop-shadow(0 0 25px rgba(99,102,241,0.5));transform:translateX(10px);animation:naturalIdle 12s ease-in-out infinite, subtleBlink 4s ease-in-out infinite;transform-origin:center bottom;"></div>
      <div style="position:absolute;top:0;right:0;width:200px;height:100%;pointer-events:none;z-index:0;opacity:0.25;background:radial-gradient(ellipse at 80% 50%, rgba(99,102,241,0.6) 0%, rgba(139,92,246,0.4) 40%, transparent 70%);filter:blur(15px);"></div>
      
      <!-- Electric Flash Effects -->
      <div style="position:absolute;top:20%;right:20px;width:3px;height:60px;background:linear-gradient(180deg, transparent, rgba(99,102,241,1), rgba(139,92,246,1), rgba(99,102,241,1), transparent);opacity:0;z-index:2;transform-origin:top;animation:electricFlash 2s ease-in-out infinite;box-shadow:0 0 20px rgba(99,102,241,0.8), 0 0 40px rgba(139,92,246,0.6);"></div>
      <div style="position:absolute;top:50%;right:40px;width:2px;height:40px;background:linear-gradient(180deg, transparent, rgba(139,92,246,1), rgba(236,72,153,1), rgba(139,92,246,1), transparent);opacity:0;z-index:2;transform-origin:top;animation:electricFlash 1.5s ease-in-out infinite 0.3s;box-shadow:0 0 15px rgba(139,92,246,0.7), 0 0 30px rgba(236,72,153,0.5);"></div>
      <div style="position:absolute;top:70%;right:30px;width:2.5px;height:50px;background:linear-gradient(180deg, transparent, rgba(99,102,241,1), rgba(139,92,246,1), transparent);opacity:0;z-index:2;transform-origin:top;animation:electricFlash 1.8s ease-in-out infinite 0.6s;box-shadow:0 0 18px rgba(99,102,241,0.7);"></div>
      
      <!-- Pulsing Energy Orb -->
      <div style="position:absolute;top:30%;right:60px;width:8px;height:8px;background:radial-gradient(circle, rgba(99,102,241,1), rgba(139,92,246,0.8));border-radius:50%;opacity:0.6;z-index:2;animation:electricPulse 2s ease-in-out infinite;box-shadow:0 0 20px rgba(99,102,241,0.9), 0 0 40px rgba(139,92,246,0.6), 0 0 60px rgba(99,102,241,0.4);"></div>
      <div style="position:absolute;top:65%;right:50px;width:6px;height:6px;background:radial-gradient(circle, rgba(139,92,246,1), rgba(236,72,153,0.8));border-radius:50%;opacity:0.5;z-index:2;animation:electricPulse 1.7s ease-in-out infinite 0.5s;box-shadow:0 0 15px rgba(139,92,246,0.8), 0 0 30px rgba(236,72,153,0.5);"></div>
      
      <!-- Scanning Lines -->
      <div style="position:absolute;top:0;right:0;width:200px;height:2px;background:linear-gradient(90deg, transparent, rgba(99,102,241,0.8), rgba(139,92,246,1), rgba(99,102,241,0.8), transparent);opacity:0;z-index:2;animation:scanLine 3s linear infinite;box-shadow:0 0 10px rgba(99,102,241,0.6);"></div>
      <div style="position:absolute;top:0;right:0;width:200px;height:1px;background:linear-gradient(90deg, transparent, rgba(139,92,246,0.6), rgba(236,72,153,0.8), rgba(139,92,246,0.6), transparent);opacity:0;z-index:2;animation:scanLine 2.5s linear infinite 1s;box-shadow:0 0 8px rgba(139,92,246,0.5);"></div>
      
      <!-- Energy Waves -->
      <div style="position:absolute;top:40%;right:100px;width:120px;height:120px;border:2px solid rgba(99,102,241,0.6);border-radius:50%;opacity:0;z-index:1;animation:energyWave 3s ease-out infinite;box-shadow:0 0 30px rgba(99,102,241,0.4);"></div>
      <div style="position:absolute;top:40%;right:100px;width:120px;height:120px;border:2px solid rgba(139,92,246,0.5);border-radius:50%;opacity:0;z-index:1;animation:energyWave 3s ease-out infinite 0.5s;box-shadow:0 0 25px rgba(139,92,246,0.3);"></div>
      
      <!-- Sparkle Effects -->
      <div style="position:absolute;top:25%;right:80px;width:4px;height:4px;background:radial-gradient(circle, rgba(255,255,255,1), rgba(99,102,241,0.8));border-radius:50%;opacity:0;z-index:3;animation:sparkle 2s ease-in-out infinite;box-shadow:0 0 10px rgba(255,255,255,0.8), 0 0 20px rgba(99,102,241,0.6);"></div>
      <div style="position:absolute;top:55%;right:70px;width:3px;height:3px;background:radial-gradient(circle, rgba(255,255,255,1), rgba(139,92,246,0.8));border-radius:50%;opacity:0;z-index:3;animation:sparkle 1.8s ease-in-out infinite 0.4s;box-shadow:0 0 8px rgba(255,255,255,0.7), 0 0 16px rgba(139,92,246,0.5);"></div>
      <div style="position:absolute;top:75%;right:90px;width:3.5px;height:3.5px;background:radial-gradient(circle, rgba(255,255,255,1), rgba(236,72,153,0.8));border-radius:50%;opacity:0;z-index:3;animation:sparkle 2.2s ease-in-out infinite 0.8s;box-shadow:0 0 9px rgba(255,255,255,0.7), 0 0 18px rgba(236,72,153,0.5);"></div>
      
      <!-- Futuristic Background Effect - Inspired by AI Humanoid -->
      <div style="position:absolute;top:0;right:0;width:100%;height:100%;opacity:0.18;pointer-events:none;z-index:0;background:radial-gradient(ellipse at 85% 30%, rgba(99,102,241,0.5) 0%, rgba(139,92,246,0.3) 30%, transparent 60%), radial-gradient(ellipse at 75% 70%, rgba(236,72,153,0.3) 0%, transparent 50%);background-size:cover;background-position:center right;filter:blur(1px);"></div>
      <div style="position:absolute;top:-80px;right:-80px;width:350px;height:350px;opacity:0.15;pointer-events:none;z-index:0;background:radial-gradient(circle, rgba(99,102,241,0.6) 0%, rgba(139,92,246,0.4) 40%, transparent 70%);border-radius:50%;filter:blur(50px);animation:asiGlow 8s ease-in-out infinite alternate;"></div>
      <div style="position:absolute;bottom:-40px;right:40px;width:250px;height:250px;opacity:0.12;pointer-events:none;z-index:0;background:radial-gradient(circle, rgba(139,92,246,0.5) 0%, rgba(236,72,153,0.3) 50%, transparent 70%);border-radius:50%;filter:blur(40px);animation:asiGlow 6s ease-in-out infinite alternate-reverse;"></div>
      
      <!-- Glowing Accent Lines - Inspired by Cyborg Suit -->
      <div style="position:absolute;top:0;right:0;width:3px;height:100%;background:linear-gradient(180deg, transparent 0%, rgba(99,102,241,0.6) 15%, rgba(139,92,246,0.8) 30%, rgba(99,102,241,0.6) 50%, rgba(236,72,153,0.4) 70%, transparent 100%);opacity:0.4;z-index:1;box-shadow:0 0 10px rgba(99,102,241,0.3);"></div>
      <div style="position:absolute;top:0;right:0;width:100%;height:2px;background:linear-gradient(90deg, transparent 0%, rgba(99,102,241,0.5) 20%, rgba(139,92,246,0.7) 40%, rgba(99,102,241,0.5) 60%, transparent 100%);opacity:0.3;z-index:1;box-shadow:0 2px 8px rgba(99,102,241,0.2);"></div>
      
      <!-- Subtle Grid Pattern -->
      <div style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:0.03;pointer-events:none;z-index:0;background-image:linear-gradient(rgba(99,102,241,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(99,102,241,0.1) 1px, transparent 1px);background-size:30px 30px;"></div>
      
      <div style="position:relative;z-index:2;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border-secondary);padding-right:220px;">
        <p style="font-family: 'BPG ExtraSquare Mtavruli', sans-serif;font-size:18px;color:#cbd5e1;margin:0;font-weight:bold;line-height:1.7;letter-spacing:0.5px;opacity:0.95;font-style:italic;text-align:left;text-shadow:0 2px 6px rgba(99,102,241,0.2), 0 0 12px rgba(139,92,246,0.15);">წარმატება მოდის იმათთან, ვინც დარჩა, როცა სხვები წავიდნენ!</p>
      </div>
      <div id="asiTokensGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;position:relative;z-index:2;max-width:calc(100% - 220px);">
        <!-- ASI tokens will be rendered here -->
      </div>
      </div>

    <div class="content-grid" id="contentGrid" style="display:none;">
      <!-- Market Page Content -->
      <div id="marketPage" class="page-content active">
        <div class="main-section" style="width:100%;">
        <div class="section-header">
            <div class="section-title">კრიპტო აქტივები</div>
          <div class="filter-tabs">
              <button class="filter-tab" onclick="sortBy('name')" id="sortName">სახელი</button>
              <button class="filter-tab" onclick="sortBy('price')" id="sortPrice">ფასი</button>
              <button class="filter-tab active" onclick="sortBy('change')" id="sortChange">24სთ</button>
              <button class="filter-tab" onclick="sortBy('mcap')" id="sortMcap">კაპიტალიზაცია</button>
          </div>
        </div>

        <div class="table-header">
          <div class="table-header-cell">#</div>
            <div class="table-header-cell">აქტივი</div>
            <div class="table-header-cell">ფასი</div>
            <div class="table-header-cell">24სთ ცვლილება</div>
            <div class="table-header-cell">საბაზრო კაპიტალიზაცია</div>
        </div>

        <div class="tokens-list" id="tokensList"></div>
        </div>
      </div>

      <!-- Portfolio Page Content -->
      <div id="portfolioPage" class="page-content">
        <div class="main-section" style="width:100%;">
        <div class="portfolio-summary">
            <div class="summary-card" id="totalValueCard">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div class="summary-label">საერთო ღირებულება</div>
                <button id="toggleVisibility" style="background:transparent;border:none;color:#71717a;cursor:pointer;padding:4px;font-size:16px;transition:all .2s;opacity:0.7;" title="ხილვადობის გადართვა" aria-label="პორტფოლიოს ხილვადობის გადართვა">👁️</button>
          </div>
              <div class="summary-value" id="totalValue" aria-live="polite">$0.00</div>
            </div>
            <div class="summary-card" id="totalPLCard">
              <div class="summary-label">PNL</div>
              <div class="summary-value" id="totalPL" aria-live="polite">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">ROI</div>
              <div class="summary-value" id="roi" aria-live="polite">0%</div>
            </div>
          </div>

          <!-- Portfolio Analytics Section - Premium Professional Design -->
          <div id="portfolioAnalytics" style="display:none;margin-bottom:32px;position:relative;">
            <!-- Premium Header with Gradient Accent -->
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;padding:20px 24px;background:linear-gradient(135deg, rgba(15,23,42,0.95) 0%, rgba(30,41,59,0.8) 100%);border:1px solid rgba(99,102,241,0.3);border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);backdrop-filter:blur(20px);position:relative;overflow:hidden;">
              <!-- Animated Background Gradient -->
              <div style="position:absolute;top:0;right:0;width:200px;height:100%;background:radial-gradient(ellipse at center, rgba(99,102,241,0.15) 0%, transparent 70%);pointer-events:none;"></div>
              
              <div style="display:flex;align-items:center;gap:16px;position:relative;z-index:1;">
                <div style="width:4px;height:40px;background:linear-gradient(180deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);border-radius:2px;box-shadow:0 0 16px rgba(99,102,241,0.6);"></div>
                <div>
                  <h3 style="font-size:24px;font-weight:700;color:var(--text-primary);margin:0;letter-spacing:-0.4px;background:linear-gradient(135deg, #ffffff 0%, #e0e7ff 50%, #c7d2fe 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-shadow:0 2px 8px rgba(99,102,241,0.3);">📊 პორტფოლიოს ანალიტიკა</h3>
                  <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:6px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;"></div>
                </div>
              </div>
              <button id="toggleAnalytics" style="background:linear-gradient(135deg, rgba(99,102,241,0.2) 0%, rgba(139,92,246,0.15) 100%);border:1px solid rgba(99,102,241,0.4);color:var(--text-primary);padding:12px 24px;border-radius:12px;cursor:pointer;font-size:12px;font-weight:700;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);letter-spacing:0.5px;backdrop-filter:blur(10px);position:relative;overflow:hidden;box-shadow:0 2px 8px rgba(99,102,241,0.2);" aria-label="ანალიტიკის ხილვის გადართვა" aria-expanded="true" onmouseenter="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(99,102,241,0.4)';this.style.borderColor='rgba(99,102,241,0.6)';this.style.background='linear-gradient(135deg, rgba(99,102,241,0.3) 0%, rgba(139,92,246,0.2) 100%)'" onmouseleave="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(99,102,241,0.2)';this.style.borderColor='rgba(99,102,241,0.4)';this.style.background='linear-gradient(135deg, rgba(99,102,241,0.2) 0%, rgba(139,92,246,0.15) 100%)'">
                <span style="position:relative;z-index:1;">დამალვა</span>
              </button>
            </div>
            
            <!-- Allocation Section - Tokens Only with Portfolio 24h Change -->
            <div style="background:rgba(15,23,42,0.95);border:1px solid rgba(99,102,241,0.3);border-radius:14px;padding:20px;position:relative;box-shadow:0 3px 16px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05) inset, 0 0 50px rgba(99,102,241,0.15);backdrop-filter:blur(16px);overflow:visible;">
              <div style="position:relative;z-index:2;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                  <div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-bottom:4px;text-transform:uppercase;letter-spacing:1px;font-weight:600;">აქტივების განაწილება</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);font-weight:500;"></div>
                  </div>
                  <!-- Portfolio Daily Change -->
                  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;padding:12px 18px;background:rgba(0,0,0,0.4);border-radius:12px;border:1px solid rgba(99,102,241,0.3);backdrop-filter:blur(10px);box-shadow:0 2px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);">
                    <div style="font-size:9px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:2px;">Daily Change</div>
                    <div id="portfolio24hChange" style="font-size:22px;font-weight:700;font-variant-numeric:tabular-nums;transition:all 0.3s ease;line-height:1.2;margin-bottom:4px;">
                      <span style="color:rgba(255,255,255,0.6);">-</span>
                    </div>
                    <div id="portfolio24hChangeUSD" style="font-size:14px;font-weight:600;font-variant-numeric:tabular-nums;transition:all 0.3s ease;line-height:1;">
                      <span style="color:rgba(255,255,255,0.5);">-</span>
                    </div>
                  </div>
                </div>
                
                <!-- Token Legend - 4 Column Grid -->
                <div id="allocationLegend" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;position:relative;z-index:2;align-content:start;" role="list" aria-label="ტოკენების განაწილების პროცენტები"></div>
              </div>
          </div>
        </div>

        <div class="holdings-list" id="holdingsList"></div>

        <form class="add-holding-form" id="addHoldingForm">
          <select id="holdingToken" required></select>
            <input type="number" step="any" placeholder="რაოდენობა" id="holdingAmount" required>
            <input type="number" step="any" placeholder="შესყიდვის ფასი" id="buyPrice" required>
            <button type="submit">დამატება</button>
        </form>
        </div>
      </div>

      <!-- Targets Page Content -->
      <div id="targetsPage" class="page-content">
        <div class="main-section" style="width:100%;">
          <div class="section-header">
            <div class="section-title"></div>
          </div>

          <!-- Two-Panel Layout -->
          <div style="display:grid;grid-template-columns:320px 1fr;gap:16px;height:calc(100vh - 200px);min-height:600px;">
            <!-- Left Panel: Token List -->
            <div style="display:flex;flex-direction:column;background:rgba(20,20,30,.4);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.05);border-radius:12px;overflow:hidden;">
              <div style="padding:16px;border-bottom:1px solid rgba(255,255,255,.05);">
                <h3 style="font-size:14px;font-weight:600;color:#fafafa;margin-bottom:12px;">ტოკენები</h3>
                <form id="addTargetForm" style="display:flex;flex-direction:column;gap:8px;">
                  <select id="targetToken" required style="width:100%;padding:8px 12px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:12px;">
                    <option value="">აირჩიეთ ტოკენი</option>
                  </select>
                  <input type="number" step="any" id="targetSellPrice" placeholder="სამიზნე ფასი" required style="width:100%;padding:8px 12px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:12px;">
                  <input type="number" step="any" min="0" max="100" id="targetSellPercentage" placeholder="გასაყიდი %" required style="width:100%;padding:8px 12px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:12px;">
                  <button type="submit" style="padding:8px 16px;background:#6366f1;border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px;transition:all .2s;">დამატება</button>
                </form>
              </div>
              <div id="targetsTokenList" style="flex:1;overflow-y:auto;padding:8px;">
                <!-- Token list will be rendered here -->
              </div>
            </div>

            <!-- Right Panel: Target Details -->
            <div style="background:rgba(20,20,30,.4);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:24px;overflow-y:auto;">
              <div id="targetDetailsContent">
                <div style="text-align:center;padding:60px 20px;color:var(--text-tertiary);">
                  <div style="font-size:48px;margin-bottom:16px;">🎯</div>
                  <div style="font-size:16px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;">აირჩიეთ ტოკენი</div>
                  <div style="font-size:13px;color:var(--text-tertiary);">აირჩიეთ ტოკენი მარცხნივ, რათა ნახოთ მიზნები</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Alerts Page Content -->
      <div id="alertsPage" class="page-content">
        <div class="main-section" style="width:100%;">
          <div class="section-header">
            <div class="section-title">შეტყობინებები</div>
          </div>

        <div class="alerts-list" id="alertsList"></div>

        <form class="add-alert-form" id="addAlertForm">
          <select id="alertToken" required></select>
          <select id="alertCondition" required>
              <option value="above">ზემოთ</option>
              <option value="below">ქვემოთ</option>
          </select>
            <input type="number" step="any" placeholder="სამიზნე ფასი" id="targetPrice" required>
            <input type="text" placeholder="შეტყობინება (არასავალდებულო)" id="alertMessage">
            <button type="submit">დაყენება</button>
        </form>
      </div>
    </div>

      <!-- Trading Journal Page -->
      <div id="tradingJournalPage" class="page-content" style="display:none;">
        <div class="main-section" style="width:100%;">
          <div class="section-header" style="margin-bottom:24px;">
            <div>
              <div class="section-title" style="font-size:24px;font-weight:700;margin-bottom:4px;">სავაჭრო ჟურნალი</div>
              <div style="font-size:13px;color:var(--text-tertiary);">თვალყურს ადევნეთ თქვენს ტრანზაქციებს და გაანალიზეთ შესრულება</div>
            </div>
          </div>

          <!-- Metrics Dashboard -->
          <div style="background:var(--bg-tertiary);border:1px solid var(--border-secondary);border-radius:12px;padding:20px;margin-bottom:24px;">
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border-secondary);border:1px solid var(--border-secondary);border-radius:8px;overflow:hidden;">
              <!-- Header Row -->
              <div style="background:var(--bg-card);padding:12px;font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-primary);border-right:1px solid var(--border-secondary);">მეტრიკა</div>
              <div style="background:var(--bg-card);padding:12px;font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-primary);text-align:right;border-right:1px solid var(--border-secondary);">მნიშვნელობა</div>
              <div style="background:var(--bg-card);padding:12px;font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-primary);">აღწერა</div>

              <!-- Total Trades -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">სულ ტრანზაქციები</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--text-primary);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricTotalTrades">0</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">ტრანზაქციების საერთო რაოდენობა</div>

              <!-- Winners -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">მომგებიანი</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--success);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricWinners">0</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">მომგებიანი ტრანზაქციების რაოდენობა</div>

              <!-- Losers -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">ზარალისმომტანი</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--error);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricLosers">0</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">სულ ტრანზაქციები მინუს მომგებიანი</div>

              <!-- Total Profits -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">სულ მოგება</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--success);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricTotalProfits">
                <div>$0.00</div>
                <div style="font-size:11px;color:var(--text-tertiary);font-weight:500;" id="metricTotalProfitsPercent">0.00%</div>
              </div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">მომგებიან ტრანზაქციებზე სულ მოგება ($ და %)</div>

              <!-- Total Losses -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">სულ ზარალი</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--error);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricTotalLosses">
                <div>$0.00</div>
                <div style="font-size:11px;color:var(--text-tertiary);font-weight:500;" id="metricTotalLossesPercent">0.00%</div>
              </div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">ზარალისმომტან ტრანზაქციებზე სულ ზარალი ($ და %)</div>

              <!-- Net P&L -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">წმინდა P&L</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricNetPL">
                <div>$0.00</div>
                <div style="font-size:11px;color:var(--text-tertiary);font-weight:500;" id="metricNetPLPercent">0.00%</div>
              </div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">სულ მოგება მინუს სულ ზარალი ($ და %)</div>

              <!-- Odds of Winning -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">მოგების შანსი</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--text-primary);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricOddsWinning">0.00%</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">მომგებიანი გაყოფილი სულ ტრანზაქციებზე</div>

              <!-- Odds of Losing -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">ზარალის შანსი</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--text-primary);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricOddsLosing">0.00%</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">ზარალისმომტანი გაყოფილი სულ ტრანზაქციებზე</div>

              <!-- Average Win -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">საშუალო მოგება</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--success);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricAvgWin">
                <div>$0.00</div>
                <div style="font-size:11px;color:var(--text-tertiary);font-weight:500;" id="metricAvgWinPercent">0.00%</div>
              </div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">სულ მოგება გაყოფილი მომგებიანზე ($ და %)</div>

              <!-- Average Loss -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">საშუალო ზარალი</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--error);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricAvgLoss">
                <div>$0.00</div>
                <div style="font-size:11px;color:var(--text-tertiary);font-weight:500;" id="metricAvgLossPercent">0.00%</div>
              </div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">სულ ზარალი გაყოფილი ზარალისმომტანზე ($ და %)</div>

              <!-- W -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">W</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--text-primary);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricW">
                <div>$0.00</div>
                <div style="font-size:11px;color:var(--text-tertiary);font-weight:500;" id="metricWPercent">0.00%</div>
              </div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">საშუალო მოგება გამრავლებული მოგების შანსზე ($ და %)</div>

              <!-- L -->
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">L</div>
              <div style="background:var(--bg-card);padding:10px 12px;font-weight:700;color:var(--error);text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricL">
                <div>$0.00</div>
                <div style="font-size:11px;color:var(--text-tertiary);font-weight:500;" id="metricLPercent">0.00%</div>
              </div>
              <div style="background:var(--bg-card);padding:10px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-secondary);">საშუალო ზარალი გამრავლებული ზარალის შანსზე ($ და %)</div>

              <!-- Expectancy (Highlighted) -->
              <div style="background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);padding:10px 12px;font-weight:700;color:#1f2937;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);">მოსალოდნელი მნიშვნელობა</div>
              <div style="background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);padding:10px 12px;font-weight:700;color:#1f2937;text-align:right;border-top:1px solid var(--border-secondary);border-right:1px solid var(--border-secondary);" id="metricExpectancy">
                <div>$0.00</div>
                <div style="font-size:11px;color:#1f2937;font-weight:600;opacity:0.8;" id="metricExpectancyPercent">0.00%</div>
              </div>
              <div style="background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);padding:10px 12px;font-size:12px;color:#1f2937;font-weight:600;border-top:1px solid var(--border-secondary);">W პლუს L (სადაც L უარყოფითია) ($ და %)</div>
            </div>
          </div>

          <!-- CSV Import Section -->
          <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:12px;padding:24px;margin-bottom:24px;">
            <div style="font-size:18px;font-weight:600;color:var(--text-primary);margin-bottom:16px;">CSV/Excel იმპორტი</div>
            <div style="display:flex;gap:16px;align-items:end;flex-wrap:wrap;">
              <div style="flex:1;min-width:200px;">
                <label style="display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">CSV/Excel ფაილი</label>
                <input type="file" id="csvFileInput" accept=".csv,.xlsx,.xls" style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:'Arial',sans-serif;cursor:pointer;">
              </div>
              <button type="button" id="importCsvBtn" style="padding:12px 24px;background:var(--accent-primary);border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;font-family:'Arial',sans-serif;white-space:nowrap;">იმპორტი</button>
              <button type="button" id="clearPreviewBtn" style="padding:12px 24px;background:var(--bg-tertiary);border:1px solid var(--border-primary);color:var(--text-secondary);border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;font-family:'Arial',sans-serif;white-space:nowrap;display:none;">გასუფთავება</button>
            </div>
            <div id="csvPreview" style="margin-top:20px;display:none;">
              <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px;">პრევიუ (<span id="previewCount">0</span> ტრანზაქცია)</div>
              <div style="max-height:300px;overflow-y:auto;border:1px solid var(--border-secondary);border-radius:8px;">
                <table id="csvPreviewTable" style="width:100%;border-collapse:collapse;font-family:'Arial',sans-serif;font-size:12px;">
                  <thead>
                    <tr style="background:var(--bg-tertiary);position:sticky;top:0;">
                      <th style="padding:8px;text-align:center;font-weight:700;color:var(--text-primary);border-right:1px solid var(--border-secondary);border-bottom:1px solid var(--border-secondary);">ტოკენი</th>
                      <th style="padding:8px;text-align:center;font-weight:700;color:var(--text-primary);border-right:1px solid var(--border-secondary);border-bottom:1px solid var(--border-secondary);">შესვლის ფასი</th>
                      <th style="padding:8px;text-align:center;font-weight:700;color:var(--text-primary);border-right:1px solid var(--border-secondary);border-bottom:1px solid var(--border-secondary);">გასვლის ფასი</th>
                      <th style="padding:8px;text-align:center;font-weight:700;color:var(--text-primary);border-right:1px solid var(--border-secondary);border-bottom:1px solid var(--border-secondary);">P&L</th>
                      <th style="padding:8px;text-align:center;font-weight:700;color:var(--text-primary);border-right:1px solid var(--border-secondary);border-bottom:1px solid var(--border-secondary);">თარიღი</th>
                    </tr>
                  </thead>
                  <tbody id="csvPreviewBody"></tbody>
                </table>
              </div>
              <div style="margin-top:12px;display:flex;gap:12px;justify-content:flex-end;">
                <button type="button" id="confirmImportBtn" style="padding:10px 20px;background:var(--success);border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s;font-family:'Arial',sans-serif;">დადასტურება და იმპორტი</button>
              </div>
            </div>
            <div id="csvImportStatus" style="margin-top:12px;display:none;padding:12px;border-radius:8px;font-size:13px;font-weight:600;"></div>
          </div>

          <!-- Form Section -->
          <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:12px;padding:24px;margin-bottom:24px;">
            <div style="font-size:18px;font-weight:600;color:var(--text-primary);margin-bottom:16px;">ტრანზაქციის დამატება</div>
            <form id="tradingJournalForm" style="display:grid;grid-template-columns:repeat(5,1fr);gap:16px;align-items:end;">
              <div>
                <label style="display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">ტოკენი</label>
                <input type="text" id="tradeToken" placeholder="BTC, ETH..." style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:'Arial',sans-serif;">
              </div>
              <div>
                <label style="display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">შესვლის ფასი</label>
                <input type="number" step="0.01" id="entryPrice" placeholder="0.00" required style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:'Arial',sans-serif;">
              </div>
              <div>
                <label style="display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">გასვლის ფასი</label>
                <input type="number" step="0.01" id="exitPrice" placeholder="0.00" required style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:'Arial',sans-serif;">
              </div>
              <div>
                <label style="display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">წმინდა P&L</label>
                <input type="number" step="0.01" id="netPL" placeholder="0.00" required style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:'Arial',sans-serif;">
              </div>
              <div>
                <label style="display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">თარიღი</label>
                <input type="date" id="tradeDate" style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:'Arial',sans-serif;">
              </div>
              <div>
                <label style="display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">ლევერაჟი</label>
                <input type="number" step="0.1" id="leverage" placeholder="1x" style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:'Arial',sans-serif;">
              </div>
              <div>
                <label style="display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">Stop Loss</label>
                <input type="number" step="0.01" id="stopLoss" placeholder="0.00" style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:'Arial',sans-serif;">
              </div>
              <div>
                <label style="display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">Take Profit</label>
                <input type="number" step="0.01" id="takeProfit" placeholder="0.00" style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:'Arial',sans-serif;">
              </div>
              <div style="grid-column:span 2;"></div>
              <div style="grid-column:span 5;display:flex;gap:12px;justify-content:flex-end;">
                <button type="submit" style="padding:12px 24px;background:var(--success);border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;font-family:'Arial',sans-serif;">დამატება</button>
                <button type="button" id="clearAllTradesBtn" style="padding:12px 24px;background:var(--error);border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;font-family:'Arial',sans-serif;">ყველას წაშლა</button>
              </div>
            </form>
          </div>

          <!-- Table Section -->
          <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:12px;padding:24px;overflow-x:auto;">
            <div style="font-size:18px;font-weight:600;color:var(--text-primary);margin-bottom:16px;">ტრანზაქციების ისტორია</div>
            <table id="tradesTable" style="width:100%;border-collapse:collapse;font-family:'Arial',sans-serif;">
              <thead>
                <tr style="background:var(--bg-tertiary);border-bottom:2px solid var(--border-secondary);">
                  <th style="padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border-secondary);">ტრანზაქცია-#</th>
                  <th style="padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border-secondary);">ტოკენი</th>
                  <th style="padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border-secondary);">შესვლის ფასი</th>
                  <th style="padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border-secondary);">გასვლის ფასი</th>
                  <th style="padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border-secondary);">ლევერაჟი</th>
                  <th style="padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border-secondary);">წმინდა</th>
                  <th style="padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border-secondary);">მოგება</th>
                  <th style="padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border-secondary);">ზარალი</th>
                  <th style="padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border-secondary);">თარიღი</th>
                  <th style="padding:12px;text-align:center;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.5px;">მოქმედება</th>
                </tr>
              </thead>
              <tbody id="tradesTableBody">
                <tr>
                  <td colspan="10" style="padding:40px;text-align:center;color:var(--text-tertiary);font-size:14px;">ჯერ არ არის ტრანზაქციები</td>
                </tr>
              </tbody>
            </table>
          </div>
      </div>
    </div>

      <!-- Admin Panel Page -->
      <div id="adminPage" class="page-content" style="display:none;">
        <div class="main-section" style="width:100%;">
          <div class="section-header">
            <div class="section-title">⚙️ Admin Panel - CMS</div>
            <div style="font-size:12px;color:var(--text-tertiary);">Content Management System</div>
  </div>

          <!-- Admin Tabs -->
          <div style="display:flex;gap:8px;margin-bottom:24px;border-bottom:1px solid var(--border-secondary);padding-bottom:12px;">
            <button class="admin-tab-btn active" data-admin-tab="tokens" style="padding:10px 20px;background:var(--accent-primary);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;">🪙 Token Management</button>
            <button class="admin-tab-btn" data-admin-tab="users" style="padding:10px 20px;background:transparent;border:1px solid var(--border-primary);color:var(--text-secondary);border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;">👥 User Management</button>
            <button class="admin-tab-btn" data-admin-tab="settings" style="padding:10px 20px;background:transparent;border:1px solid var(--border-primary);color:var(--text-secondary);border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;">⚙️ Settings</button>
            <button class="admin-tab-btn" data-admin-tab="analytics" style="padding:10px 20px;background:transparent;border:1px solid var(--border-primary);color:var(--text-secondary);border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;">📊 Analytics</button>
            <button class="admin-tab-btn" data-admin-tab="audit" style="padding:10px 20px;background:transparent;border:1px solid var(--border-primary);color:var(--text-secondary);border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;">📋 Audit Log</button>
</div>

          <!-- Token Management Tab -->
          <div id="adminTokensTab" class="admin-tab-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
              <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);">Token Management</h3>
              <button id="addTokenBtnAdmin" style="padding:10px 20px;background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;">➕ Add Token</button>
            </div>
            
            <!-- Token List -->
            <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:12px;overflow:hidden;">
              <div style="display:grid;grid-template-columns:60px 2fr 1fr 1fr 1fr 1fr auto;gap:16px;padding:16px;background:var(--bg-tertiary);border-bottom:1px solid var(--border-secondary);">
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Icon</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Token</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Price</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">24h Change</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Market Cap</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Status</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Actions</div>
              </div>
              <div id="adminTokensList" style="max-height:600px;overflow-y:auto;">
                <!-- Tokens will be rendered here -->
              </div>
            </div>
          </div>

          <!-- User Management Tab -->
          <div id="adminUsersTab" class="admin-tab-content" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
              <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);">User Management</h3>
              <div style="display:flex;gap:8px;">
                <input type="text" id="adminUserSearch" placeholder="Search users..." style="padding:10px 16px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:13px;width:250px;">
                <button onclick="adminExportUsers()" style="padding:10px 20px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:#22c55e;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;">📥 Export</button>
              </div>
            </div>
            
            <!-- User Stats -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px;">
              <div class="summary-card">
                <div class="summary-label">Total Users</div>
                <div class="summary-value" id="adminTotalUsers">0</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Active Users</div>
                <div class="summary-value" id="adminActiveUsers">0</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Users with Portfolio</div>
                <div class="summary-value" id="adminUsersWithPortfolio">0</div>
              </div>
            </div>

            <!-- User List -->
            <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:12px;overflow:hidden;">
              <div style="display:grid;grid-template-columns:50px 2fr 1fr 1fr 1fr auto;gap:16px;padding:16px;background:var(--bg-tertiary);border-bottom:1px solid var(--border-secondary);">
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Avatar</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">User</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Email</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Portfolio Value</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Status</div>
                <div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Actions</div>
              </div>
              <div id="adminUsersList" style="max-height:600px;overflow-y:auto;">
                <!-- Users will be rendered here -->
              </div>
            </div>
          </div>

          <!-- Settings Tab -->
          <div id="adminSettingsTab" class="admin-tab-content" style="display:none;">
            <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);margin-bottom:24px;">System Settings</h3>
            
            <div style="display:grid;gap:24px;">
              <!-- API Settings -->
              <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:12px;padding:24px;">
                <h4 style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:16px;">API Configuration</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                  <div>
                    <label style="display:block;font-size:12px;color:var(--text-tertiary);margin-bottom:8px;font-weight:600;">CoinGecko API Key (Optional)</label>
                    <input type="text" id="adminCoinGeckoKey" placeholder="Enter CoinGecko API key" style="width:100%;padding:12px 16px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:13px;">
                    <small style="display:block;margin-top:6px;font-size:11px;color:var(--text-tertiary);">For higher rate limits</small>
                  </div>
                  <button onclick="adminSaveApiSettings()" style="padding:10px 20px;background:var(--accent-primary);border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;align-self:flex-start;">💾 Save Settings</button>
                </div>
              </div>

              <!-- System Settings -->
              <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:12px;padding:24px;">
                <h4 style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:16px;">System Configuration</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-tertiary);border-radius:8px;">
                    <div>
                      <div style="font-weight:600;color:var(--text-primary);margin-bottom:4px;">Auto Refresh Interval</div>
                      <div style="font-size:12px;color:var(--text-tertiary);">How often to refresh market data</div>
                    </div>
                    <select id="adminRefreshInterval" style="padding:8px 12px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:6px;color:var(--text-primary);font-size:13px;">
                      <option value="60000">1 minute</option>
                      <option value="300000" selected>5 minutes</option>
                      <option value="600000">10 minutes</option>
                      <option value="900000">15 minutes</option>
                    </select>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-tertiary);border-radius:8px;">
                    <div>
                      <div style="font-weight:600;color:var(--text-primary);margin-bottom:4px;">Cache Duration</div>
                      <div style="font-size:12px;color:var(--text-tertiary);">How long to cache API responses</div>
                    </div>
                    <select id="adminCacheDuration" style="padding:8px 12px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:6px;color:var(--text-primary);font-size:13px;">
                      <option value="30000">30 seconds</option>
                      <option value="60000" selected>1 minute</option>
                      <option value="300000">5 minutes</option>
                    </select>
                  </div>
                  <button onclick="adminSaveSystemSettings()" style="padding:10px 20px;background:var(--accent-primary);border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;align-self:flex-start;">💾 Save Settings</button>
                </div>
              </div>

              <!-- Maintenance -->
              <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:12px;padding:24px;">
                <h4 style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:16px;">Maintenance</h4>
                <div style="display:flex;flex-direction:column;gap:12px;">
                  <button onclick="adminClearCache()" style="padding:12px 20px;background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);color:#f59e0b;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;text-align:left;">🗑️ Clear All Cache</button>
                  <button onclick="adminRefreshAllData()" style="padding:12px 20px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:#22c55e;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;text-align:left;">🔄 Force Refresh All Data</button>
                  <button onclick="adminExportDatabase()" style="padding:12px 20px;background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:#3b82f6;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;text-align:left;">📥 Export Database</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Analytics Tab -->
          <div id="adminAnalyticsTab" class="admin-tab-content" style="display:none;">
            <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);margin-bottom:24px;">System Analytics</h3>
            
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:32px;">
              <div class="summary-card">
                <div class="summary-label">Total Tokens</div>
                <div class="summary-value" id="adminAnalyticsTokens">0</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Total Portfolios</div>
                <div class="summary-value" id="adminAnalyticsPortfolios">0</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Total Targets</div>
                <div class="summary-value" id="adminAnalyticsTargets">0</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">Total Alerts</div>
                <div class="summary-value" id="adminAnalyticsAlerts">0</div>
              </div>
            </div>

            <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:12px;padding:24px;">
              <h4 style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:16px;">Usage Statistics</h4>
              <div id="adminUsageStats" style="min-height:200px;">
                <!-- Stats will be rendered here -->
              </div>
            </div>
          </div>

          <!-- Audit Log Tab -->
          <div id="adminAuditTab" class="admin-tab-content" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
              <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);">Audit Log</h3>
              <div style="display:flex;gap:8px;">
                <select id="auditFilter" style="padding:8px 12px;background:var(--bg-input);border:1px solid var(--border-primary);border-radius:6px;color:var(--text-primary);font-size:13px;">
                  <option value="all">All Actions</option>
                  <option value="user">User Actions</option>
                  <option value="admin">Admin Actions</option>
                  <option value="security">Security Events</option>
                </select>
                <button onclick="exportAuditLog()" style="padding:8px 16px;background:var(--accent-primary);border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">Export</button>
              </div>
            </div>
            <div style="background:var(--bg-card);border:1px solid var(--border-secondary);border-radius:12px;padding:24px;">
              <div id="auditLogList" style="max-height:600px;overflow-y:auto;">
                <!-- Audit logs will be rendered here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Page Content -->
      <div id="profilePage" class="page-content">
        <div class="main-section" style="width:100%;">
          <div class="section-header">
            <div class="section-title">პროფილის მართვა</div>
  </div>

          <!-- Change Name Section -->
          <div style="background:rgba(20,20,30,.4);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.05);border-radius:16px;padding:24px;margin-bottom:24px;">
            <h3 style="font-size:18px;font-weight:600;color:#fafafa;margin-bottom:16px;">სახელის შეცვლა</h3>
            <form id="changeNameForm" style="display:flex;gap:12px;align-items:flex-end;">
              <div style="flex:1;">
                <label style="display:block;font-size:12px;color:#9aa0a6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500;">ახალი სახელი</label>
                <input type="text" id="newName" placeholder="შეიყვანეთ ახალი სახელი" required
                  style="width:100%;padding:12px 16px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:14px;">
              </div>
              <button type="submit" style="padding:12px 24px;background:#6366f1;border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all .2s;white-space:nowrap;">შეცვლა</button>
            </form>
            <div id="nameStatus" style="margin-top:12px;padding:12px;border-radius:8px;display:none;font-size:13px;"></div>
</div>

          <!-- Change Email Section -->
          <div style="background:rgba(20,20,30,.4);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.05);border-radius:16px;padding:24px;margin-bottom:24px;">
            <h3 style="font-size:18px;font-weight:600;color:#fafafa;margin-bottom:16px;">ელფოსტის შეცვლა</h3>
            <form id="changeEmailForm" style="display:flex;flex-direction:column;gap:12px;">
              <div>
                <label style="display:block;font-size:12px;color:#9aa0a6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500;">ახალი ელფოსტა</label>
                <input type="email" id="newEmail" placeholder="შეიყვანეთ ახალი ელფოსტა" required
                  style="width:100%;padding:12px 16px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:14px;">
              </div>
              <div>
                <label style="display:block;font-size:12px;color:#9aa0a6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500;">მიმდინარე პაროლი</label>
                <input type="password" id="emailPassword" placeholder="დაადასტურეთ პაროლით" required
                  style="width:100%;padding:12px 16px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:14px;">
              </div>
              <button type="submit" style="padding:12px 24px;background:#6366f1;border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all .2s;align-self:flex-start;">შეცვლა</button>
            </form>
            <div id="emailStatus" style="margin-top:12px;padding:12px;border-radius:8px;display:none;font-size:13px;"></div>
          </div>

          <!-- Change Password Section -->
          <div style="background:rgba(20,20,30,.4);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.05);border-radius:16px;padding:24px;">
            <h3 style="font-size:18px;font-weight:600;color:#fafafa;margin-bottom:16px;">პაროლის შეცვლა</h3>
            <form id="changePasswordForm" style="display:flex;flex-direction:column;gap:12px;">
              <div>
                <label style="display:block;font-size:12px;color:#9aa0a6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500;">მიმდინარე პაროლი</label>
                <input type="password" id="currentPassword" placeholder="შეიყვანეთ მიმდინარე პაროლი" required
                  style="width:100%;padding:12px 16px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:14px;">
              </div>
              <div>
                <label style="display:block;font-size:12px;color:#9aa0a6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500;">ახალი პაროლი</label>
                <input type="password" id="newPassword" placeholder="შეიყვანეთ ახალი პაროლი" required minlength="6"
                  style="width:100%;padding:12px 16px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:14px;">
              </div>
              <div>
                <label style="display:block;font-size:12px;color:#9aa0a6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500;">დაადასტურეთ ახალი პაროლი</label>
                <input type="password" id="confirmPassword" placeholder="გაიმეორეთ ახალი პაროლი" required minlength="6"
                  style="width:100%;padding:12px 16px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:14px;">
              </div>
              <button type="submit" style="padding:12px 24px;background:#6366f1;border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all .2s;align-self:flex-start;">შეცვლა</button>
            </form>
            <div id="passwordStatus" style="margin-top:12px;padding:12px;border-radius:8px;display:none;font-size:13px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Holding Modal -->
<div id="editHoldingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>პოზიციის რედაქტირება</h3>
      <button class="modal-close" onclick="$('editHoldingModal').classList.remove('show')">×</button>
    </div>
    <form id="editHoldingForm">
      <input type="hidden" id="editHoldingId">
      <div class="form-group">
        <label>ტოკენი</label>
        <select id="editHoldingToken" required disabled></select>
        <small style="color: #888;">ტოკენი ვერ შეიცვლება</small>
      </div>
      <div class="form-group">
        <label>რაოდენობა</label>
        <input type="number" step="any" id="editHoldingAmount" required>
      </div>
      <div class="form-group">
        <label>შესყიდვის ფასი (USD)</label>
        <input type="number" step="any" id="editHoldingBuyPrice" required>
    </div>
    <div class="modal-actions">
        <button type="button" class="modal-btn cancel" onclick="$('editHoldingModal').classList.remove('show')">გაუქმება</button>
        <button type="submit" class="modal-btn save">ცვლილებების შენახვა</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Target Modal -->
<div id="editTargetModal" class="modal">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header">
      <h3>დონის რედაქტირება</h3>
      <button class="modal-close" onclick="closeEditTargetModal()">×</button>
    </div>
    <form id="editTargetForm" style="padding:24px;">
      <input type="hidden" id="editTargetId">
      <div class="form-group" style="margin-bottom:20px;">
        <label style="display:block;font-size:12px;color:#9aa0a6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">სამიზნე ფასი (USD)</label>
        <input type="number" step="any" id="editTargetPrice" required 
          style="width:100%;padding:12px 16px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:14px;transition:all .2s;"
          onfocus="this.style.borderColor='#6366f1';this.style.background='rgba(10,14,26,.8)'"
          onblur="this.style.borderColor='rgba(255,255,255,.1)';this.style.background='rgba(10,14,26,.6)'">
        <small style="display:block;margin-top:6px;color:#71717a;font-size:11px;">მიმდინარე ფასი: <span id="editTargetCurrentPrice" style="color:#fafafa;font-weight:600;">$0.00</span></small>
      </div>
      <div class="form-group" style="margin-bottom:24px;">
        <label style="display:block;font-size:12px;color:#9aa0a6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">გასაყიდი პროცენტი (%)</label>
        <input type="number" step="any" min="0" max="100" id="editTargetPercentage" required
          style="width:100%;padding:12px 16px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e8eaed;font-size:14px;transition:all .2s;"
          onfocus="this.style.borderColor='#6366f1';this.style.background='rgba(10,14,26,.8)'"
          onblur="this.style.borderColor='rgba(255,255,255,.1)';this.style.background='rgba(10,14,26,.6)'">
        <div style="margin-top:8px;">
          <input type="range" min="0" max="100" step="1" id="editTargetPercentageSlider" 
            style="width:100%;height:6px;background:rgba(255,255,255,.1);border-radius:3px;outline:none;cursor:pointer;"
            oninput="document.getElementById('editTargetPercentage').value = this.value">
          <div style="display:flex;justify-content:space-between;margin-top:4px;">
            <span style="font-size:10px;color:#71717a;">0%</span>
            <span style="font-size:10px;color:#71717a;">50%</span>
            <span style="font-size:10px;color:#71717a;">100%</span>
          </div>
        </div>
      </div>
      <div id="editTargetStatus" style="margin-bottom:16px;padding:12px;border-radius:8px;display:none;font-size:13px;"></div>
      <div class="modal-actions" style="display:flex;gap:12px;justify-content:flex-end;">
        <button type="button" class="modal-btn cancel" onclick="closeEditTargetModal()" 
          style="padding:12px 24px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:#e8eaed;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all .2s;">
          გაუქმება
        </button>
        <button type="submit" class="modal-btn save"
          style="padding:12px 24px;background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all .2s;box-shadow:0 4px 12px rgba(99,102,241,.3);">
          შენახვა
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modals and other shared components -->
<div id="addTokenModal" class="modal">
  <div class="modal-content" style="max-width:600px;width:90vw;">
    <div class="modal-header" style="background:rgba(15,20,30,.95);backdrop-filter:blur(24px) saturate(180%);padding:24px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,.08);">
      <div class="modal-title" style="font-size:20px;font-weight:600;color:#e8eaed;letter-spacing:-0.3px;">🔍 კრიპტო ტოკენის დამატება</div>
      <span class="close-modal" id="closeModal" style="color:#9aa0a6;font-size:28px;cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:transparent;transition:all .25s;">×</span>
    </div>
    <div style="padding:28px;background:rgba(15,20,30,.95);backdrop-filter:blur(24px) saturate(180%);">
      <div class="modal-input" style="margin-bottom:20px;">
        <label style="display:block;font-size:12px;font-weight:500;color:#9aa0a6;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.8px;">ტოკენის ძიება</label>
        <div style="position:relative;">
          <input type="text" id="tokenSearch" placeholder="ჩაწერეთ ძიებისთვის (მაგ. bitcoin, ethereum, solana)..." 
            style="width:100%;padding:14px 18px;background:rgba(10,14,26,.6);border:1.5px solid rgba(255,255,255,.1);border-radius:12px;color:#e8eaed;font-size:14px;transition:all .25s;backdrop-filter:blur(10px);"
            autocomplete="off">
          <div id="tokenSearchResults" style="position:absolute;top:100%;left:0;right:0;margin-top:8px;background:rgba(15,20,30,.98);backdrop-filter:blur(24px) saturate(180%);border:1px solid rgba(255,255,255,.12);border-radius:12px;max-height:300px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 12px 40px rgba(0,0,0,.5);"></div>
    </div>
        <div id="selectedToken" style="margin-top:16px;padding:16px;background:rgba(139,92,246,.1);border:1.5px solid rgba(139,92,246,.25);border-radius:12px;display:none;backdrop-filter:blur(10px);">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-weight:600;color:#e8eaed;font-size:15px;letter-spacing:-0.2px;" id="selectedTokenName"></div>
              <div style="font-size:12px;color:#9aa0a6;margin-top:4px;font-weight:400;" id="selectedTokenId"></div>
            </div>
            <button id="clearSelection" style="padding:8px 14px;background:rgba(234,67,53,.12);border:1.5px solid rgba(234,67,53,.25);color:#ea4335;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;transition:all .25s;letter-spacing:0.2px;">გასუფთავება</button>
          </div>
        </div>
      </div>
      <div class="modal-actions" style="display:flex;gap:12px;justify-content:flex-end;">
        <button class="modal-btn cancel" id="cancelAdd" style="padding:12px 24px;background:transparent;border:1.5px solid rgba(255,255,255,.15);color:#9aa0a6;border-radius:10px;cursor:pointer;font-weight:600;transition:all .25s;letter-spacing:0.3px;">გაუქმება</button>
        <button class="modal-btn add" id="confirmAdd" style="padding:12px 24px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;color:#fff;border-radius:10px;cursor:pointer;font-weight:600;transition:all .25s;box-shadow:0 2px 8px rgba(139,92,246,.25);letter-spacing:0.3px;" disabled>ტოკენის დამატება</button>
      </div>
      <div id="addTokenStatus" style="margin-top:16px;padding:14px;border-radius:10px;display:none;font-size:13px;font-weight:500;backdrop-filter:blur(10px);"></div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebase config - Complete web app configuration
const firebaseConfig = { 
  apiKey: "AIzaSyARWG4t3i_pCpu-pOZPqauRufMQhZaI14U",
  authDomain: "ccx-dashboard.firebaseapp.com",
  databaseURL: "https://ccx-dashboard-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ccx-dashboard",
  storageBucket: "ccx-dashboard.firebasestorage.app",
  messagingSenderId: "413950601775",
  appId: "1:413950601775:web:53ca78e202ef7ec884b4da"
};
// Initialize Firebase app
let app;
try {
  app = firebase.initializeApp(firebaseConfig);
} catch (e) {
  // App already initialized
  app = firebase.app();
}
const auth = firebase.auth();

/* ---------- GLOBALS ---------- */
let cryptoData = [], prices = {}, globalData = null, fearGreedData = null, etfFlowsData = null;
let sortColumn = 'change', sortDirection = 'desc';
let currentUser = null;
let sellTargets = {}; // Initialize early to prevent "before initialization" errors
let portfolioHoldings = {}; // Store portfolio holdings for buy price calculation

/* ---------- HELPERS ---------- */
function $(id){return document.getElementById(id);}
function formatPrice(p){return p>=1000?p.toLocaleString('en-US',{maximumFractionDigits:0}):p>=1?p.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):p>=.01?p.toFixed(4):p.toFixed(6);}
function formatMarketCap(m){return m>=1e12?`${(m/1e12).toFixed(2)}T`:m>=1e9?`${(m/1e9).toFixed(2)}B`:m>=1e6?`${(m/1e6).toFixed(2)}M`:m.toLocaleString();}
function updateTime(){$('navTime').textContent=new Date().toLocaleTimeString('en-US',{hour12:false});}
updateTime();setInterval(updateTime,1000);

/* ---------- AUTH (same as before) ---------- */
$('loginBtn').onclick = () => authModal('login');
$('registerBtn').onclick = () => authModal('register');
$('logoutBtn').onclick = async () => {
  try {
    await auth.signOut();
    // Sidebar will be hidden automatically via onAuthStateChanged
    // Redirect to market page
    showPage('market');
  } catch (e) {
    console.error('Logout error:', e);
    alert('გასვლის შეცდომა: ' + e.message);
  }
};

function authModal(mode){
  const email = prompt(`შეიყვანეთ ელფოსტა:`);
  if(!email) return;
  const password = prompt('შეიყვანეთ პაროლი:');
  if(!password) return;
  
  // Ensure Firebase Auth is initialized
  if (!auth) {
    try {
      auth = firebase.auth();
    } catch (e) {
      console.error('Firebase Auth initialization error:', e);
      alert('ავტორიზაციის სერვისი მიუწვდომელია. გთხოვთ განაახლოთ გვერდი.');
      return;
    }
  }
  
  const authMethod = mode === 'login' ? auth.signInWithEmailAndPassword : auth.createUserWithEmailAndPassword;
  
  authMethod.call(auth, email, password)
    .then(() => {
      if(mode === 'register') {
        alert('რეგისტრაცია წარმატებულია! ახლა შეხვედით სისტემაში.');
      }
      // Sidebar will be shown automatically via onAuthStateChanged
      // Redirect to dashboard for new users
      if(mode === 'register') {
        setTimeout(() => showPage('dashboard'), 500);
      }
    })
    .catch(e => {
      console.error('Auth error:', e);
      let errorMsg = e.message;
      // Provide more helpful error messages
      if(e.code === 'auth/email-already-in-use') {
        errorMsg = 'ეს ელფოსტა უკვე რეგისტრირებულია. გთხოვთ შეხვიდეთ.';
      } else if(e.code === 'auth/weak-password') {
        errorMsg = 'პაროლი ძალიან სუსტია. გთხოვთ გამოიყენოთ მინიმუმ 6 სიმბოლო.';
      } else if(e.code === 'auth/invalid-email') {
        errorMsg = 'არასწორი ელფოსტის მისამართი. გთხოვთ შეამოწმოთ და სცადოთ თავიდან.';
      } else if(e.code === 'auth/user-not-found') {
        errorMsg = 'ამ ელფოსტით ანგარიში არ მოიძებნა. გთხოვთ ჯერ დარეგისტრირდეთ.';
      } else if(e.code === 'auth/wrong-password') {
        errorMsg = 'არასწორი პაროლი. გთხოვთ სცადოთ თავიდან.';
      } else if(e.message && e.message.includes('_delegate')) {
        errorMsg = 'ავტორიზაციის სერვისის შეცდომა. გთხოვთ განაახლოთ გვერდი და სცადოთ თავიდან.';
      }
      alert(errorMsg);
    });
}

// Firebase real-time listener for tokens (auto-update when tokens are added/removed)
let tokensListener = null;
let initialTokensLoaded = false;

function setupTokensListener() {
  // Remove existing listener if any
  if (tokensListener) {
    const db = firebase.database();
    db.ref('tokens').off('value', tokensListener);
  }
  
  const db = firebase.database();
  const tokensRef = db.ref('tokens');
  
  tokensListener = tokensRef.on('value', (snapshot) => {
    const tokens = snapshot.val() || {};
    const tokenCount = Object.keys(tokens).length;
    console.log(`🔄 Tokens updated in Firebase: ${tokenCount} tokens detected`);
    
    // On first load, just mark as loaded (don't refresh yet)
    if (!initialTokensLoaded) {
      initialTokensLoaded = true;
      console.log('Initial tokens loaded, waiting for changes...');
      return;
    }
    
    // Auto-refresh when tokens change (added or removed)
    if (tokenCount > 0) {
      console.log('✨ Auto-refreshing market data due to token changes...');
      // Debounce: wait 1.5 seconds before refreshing to avoid multiple rapid updates
      clearTimeout(window.tokenRefreshTimeout);
      window.tokenRefreshTimeout = setTimeout(() => {
        fetchAll();
      }, 1500);
    } else if (tokenCount === 0 && cryptoData.length > 0) {
      // If all tokens were removed, clear the display
      console.log('All tokens removed, clearing display...');
      cryptoData = [];
      renderAll();
    }
  }, (error) => {
    console.error('Error listening to tokens:', error);
  });
  
  console.log('✅ Tokens listener set up - will auto-update when tokens are added/removed');
}

// Set up tokens listener immediately (works for both logged in and logged out users)
// This ensures tokens auto-update when admin adds them from admin.html
setTimeout(() => {
  setupTokensListener();
}, 1000); // Wait 1 second for Firebase to fully initialize

auth.onAuthStateChanged(user=>{
  currentUser = user;
  if(user){
    $('authContainer').style.display='none';
    $('userContainer').style.display='flex';
    $('userName').textContent = user.email.split('@')[0];
    $('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=8b5cf6&color=fff&size=64`;
    const userTabs = $('userTabs');
    if (userTabs) userTabs.style.display='flex';
    if(user.email === 'testireba5@gmail.com') $('adminControls').classList.add('show');
    
    // Update sidebar visibility for authenticated user
    if (typeof window.updateSidebarVisibility === 'function') {
      window.updateSidebarVisibility();
    }
    if (typeof updateAdminNavVisibility === 'function') {
      updateAdminNavVisibility();
    }
    
    // Load user data when authenticated
    // Wait a bit to ensure Firebase is fully initialized
    setTimeout(() => {
      loadPortfolio();
      loadAlerts();
      loadTargets();
    }, 500);
  }else{
    $('authContainer').style.display='flex';
    $('userContainer').style.display='none';
    const userTabs = $('userTabs');
    if (userTabs) userTabs.style.display='none';
    $('adminControls').style.display='none';
    
    // Hide sidebar for unauthenticated user
    if (typeof window.updateSidebarVisibility === 'function') {
      window.updateSidebarVisibility();
    }
    
    // Redirect to market page if on protected pages
    const currentPage = window.location.hash.replace('#', '') || 'market';
    const protectedPages = ['dashboard', 'portfolio', 'targets', 'alerts', 'profile', 'admin'];
    if (protectedPages.includes(currentPage)) {
      showPage('market');
    }
  }
});

/* ---------- USER TABS (same as before) ---------- */
document.querySelectorAll('.user-tab').forEach(tab=>{
  tab.onclick = () => {
    document.querySelectorAll('.user-tab,.user-content').forEach(el=>el.classList.remove('active'));
    tab.classList.add('active');
    $(tab.dataset.tab + 'Content').classList.add('active');
  };
});

/* ---------- RENDER FUNCTIONS ---------- */
function renderAll() {
  renderHeroStats();
  renderTokens();
  renderASIAlliance();
  if (cryptoData && cryptoData.length > 0) {
    loadETFData();
    renderRecentActivity();
  }
  populateTokenSelect('holdingToken');
  populateTokenSelect('alertToken');
}

// Crypto ETF Data from SoSoValue
let etfDataCache = null;
async function loadETFData() {
  const etfList = $('etfDataList');
  if (!etfList) {
    console.warn('etfDataList element not found');
    return;
  }
  
  try {
    const res = await fetch('/api/etf-data');
    const data = await res.json();
    
    if (!res.ok || !data.success) {
      etfList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">ETF მონაცემები მიუწვდომელია</div>';
      return;
    }
    
    etfDataCache = data;
    renderETFData(data);
  } catch (error) {
    console.error('Error loading ETF data:', error);
    etfList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">ETF მონაცემების ჩატვირთვის შეცდომა</div>';
  }
}

function renderETFData(data) {
  const etfList = $('etfDataList');
  if (!etfList) return;
  
  const formatFlow = (value) => {
    if (!value && value !== 0) return 'N/A';
    const abs = Math.abs(value);
    if (abs >= 1000000000) return `${value >= 0 ? '+' : ''}$${(value / 1000000000).toFixed(2)}B`;
    if (abs >= 1000000) return `${value >= 0 ? '+' : ''}$${(value / 1000000).toFixed(2)}M`;
    return `${value >= 0 ? '+' : ''}$${value.toFixed(0)}`;
  };
  
  const formatAUM = (value) => {
    if (!value && value !== 0) return 'N/A';
    const abs = Math.abs(value);
    if (abs >= 1000000000) return `$${(value / 1000000000).toFixed(2)}B`;
    if (abs >= 1000000) return `$${(value / 1000000).toFixed(2)}M`;
    return `$${value.toFixed(0)}`;
  };
  
  // Extract BTC and ETH ETF data - handle various response formats
  let btcData = data.btc || data.data?.btc || null;
  let ethData = data.eth || data.data?.eth || null;
  
  // If data is nested differently, try to extract it
  if (!btcData && data.data && typeof data.data === 'object') {
    // Check if data.data is an array or object with BTC/ETH keys
    if (Array.isArray(data.data)) {
      btcData = data.data.find(item => item.symbol === 'BTC' || item.name?.toLowerCase().includes('bitcoin'));
      ethData = data.data.find(item => item.symbol === 'ETH' || item.name?.toLowerCase().includes('ethereum'));
    } else if (data.data.bitcoin) {
      btcData = data.data.bitcoin;
    } else if (data.data.ethereum) {
      ethData = data.data.ethereum;
    }
  }
  
  let html = '';
  
  // Bitcoin ETF - using SoSoValue API format
  if (btcData) {
    // Extract data from SoSoValue API response structure
    const dailyNetInflow = btcData.dailyNetInflow?.value || 0;
    const dailyNetInflowDate = btcData.dailyNetInflow?.lastUpdateDate || null;
    const totalNetAssets = btcData.totalNetAssets?.value || 0;
    const totalNetAssetsDate = btcData.totalNetAssets?.lastUpdateDate || null;
    const totalNetAssetsPercentage = btcData.totalNetAssetsPercentage?.value || 0;
    const cumNetInflow = btcData.cumNetInflow?.value || 0;
    const cumNetInflowDate = btcData.cumNetInflow?.lastUpdateDate || null;
    const totalTokenHoldings = btcData.totalTokenHoldings?.value || 0;
    const totalTokenHoldingsDate = btcData.totalTokenHoldings?.lastUpdateDate || null;
    const dailyTotalValueTraded = btcData.dailyTotalValueTraded?.value || 0;
    const dailyTotalValueTradedDate = btcData.dailyTotalValueTraded?.lastUpdateDate || null;
    const flowColor = dailyNetInflow >= 0 ? '#22c55e' : '#ef4444';
    
    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ka-GE', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch {
        return dateStr;
      }
    };
    
    html += `
      <div class="etf-item" style="padding:14px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:10px;margin-bottom:10px;transition:all .25s;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.05);">
          <span style="font-size:18px;">₿</span>
          <span style="font-weight:600;font-size:14px;color:#e8eaed;">Bitcoin ETF</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">წმინდა შემოდინება (დღეს)</div>
            <div style="font-size:15px;font-weight:600;color:${flowColor};margin-bottom:2px;">${formatFlow(dailyNetInflow)}</div>
            ${dailyNetInflowDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(dailyNetInflowDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">კუმულაციური შემოდინება</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatFlow(cumNetInflow)}</div>
            ${cumNetInflowDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(cumNetInflowDate)}</div>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">საერთო აქტივები</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatAUM(totalNetAssets)}</div>
            ${totalNetAssetsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalNetAssetsDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">აქტივების %</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${(totalNetAssetsPercentage * 100).toFixed(2)}%</div>
            ${totalNetAssetsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalNetAssetsDate)}</div>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">ტოკენების რაოდენობა</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${totalTokenHoldings >= 1000 ? `${(totalTokenHoldings / 1000).toFixed(2)}K` : totalTokenHoldings.toFixed(0)}</div>
            ${totalTokenHoldingsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalTokenHoldingsDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">დღიური ვაჭრობა</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatAUM(dailyTotalValueTraded)}</div>
            ${dailyTotalValueTradedDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(dailyTotalValueTradedDate)}</div>` : ''}
          </div>
        </div>
      </div>
    `;
  }
  
  // Ethereum ETF - using SoSoValue API format
  if (ethData) {
    // Extract data from SoSoValue API response structure
    const dailyNetInflow = ethData.dailyNetInflow?.value || 0;
    const dailyNetInflowDate = ethData.dailyNetInflow?.lastUpdateDate || null;
    const totalNetAssets = ethData.totalNetAssets?.value || 0;
    const totalNetAssetsDate = ethData.totalNetAssets?.lastUpdateDate || null;
    const totalNetAssetsPercentage = ethData.totalNetAssetsPercentage?.value || 0;
    const cumNetInflow = ethData.cumNetInflow?.value || 0;
    const cumNetInflowDate = ethData.cumNetInflow?.lastUpdateDate || null;
    const totalTokenHoldings = ethData.totalTokenHoldings?.value || 0;
    const totalTokenHoldingsDate = ethData.totalTokenHoldings?.lastUpdateDate || null;
    const dailyTotalValueTraded = ethData.dailyTotalValueTraded?.value || 0;
    const dailyTotalValueTradedDate = ethData.dailyTotalValueTraded?.lastUpdateDate || null;
    const flowColor = dailyNetInflow >= 0 ? '#22c55e' : '#ef4444';
    
    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ka-GE', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch {
        return dateStr;
      }
    };
    
    html += `
      <div class="etf-item" style="padding:14px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:10px;transition:all .25s;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.05);">
          <span style="font-size:18px;">Ξ</span>
          <span style="font-weight:600;font-size:14px;color:#e8eaed;">Ethereum ETF</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">წმინდა შემოდინება (დღეს)</div>
            <div style="font-size:15px;font-weight:600;color:${flowColor};margin-bottom:2px;">${formatFlow(dailyNetInflow)}</div>
            ${dailyNetInflowDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(dailyNetInflowDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">კუმულაციური შემოდინება</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatFlow(cumNetInflow)}</div>
            ${cumNetInflowDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(cumNetInflowDate)}</div>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">საერთო აქტივები</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatAUM(totalNetAssets)}</div>
            ${totalNetAssetsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalNetAssetsDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">აქტივების %</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${(totalNetAssetsPercentage * 100).toFixed(2)}%</div>
            ${totalNetAssetsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalNetAssetsDate)}</div>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">ტოკენების რაოდენობა</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${totalTokenHoldings >= 1000 ? `${(totalTokenHoldings / 1000).toFixed(2)}K` : totalTokenHoldings.toFixed(0)}</div>
            ${totalTokenHoldingsDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(totalTokenHoldingsDate)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:9px;color:#9aa0a6;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px;">დღიური ვაჭრობა</div>
            <div style="font-size:13px;font-weight:600;color:#fafafa;margin-bottom:2px;">${formatAUM(dailyTotalValueTraded)}</div>
            ${dailyTotalValueTradedDate ? `<div style="font-size:8px;color:#6b7280;">${formatDate(dailyTotalValueTradedDate)}</div>` : ''}
          </div>
        </div>
      </div>
    `;
  }
  
  if (!html) {
    etfList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">ETF მონაცემები არ არის ხელმისაწვდომი</div>';
    return;
  }
  
  etfList.innerHTML = html;
  
  // Add hover effects
  etfList.querySelectorAll('.etf-item').forEach(item => {
    item.onmouseenter = () => {
      item.style.background = 'rgba(255,255,255,.05)';
      item.style.borderColor = 'rgba(255,255,255,.1)';
      item.style.transform = 'translateX(2px)';
    };
    item.onmouseleave = () => {
      item.style.background = 'rgba(255,255,255,.03)';
      item.style.borderColor = 'rgba(255,255,255,.05)';
      item.style.transform = 'translateX(0)';
    };
  });
}

// Option 5: Token Categories Breakdown
function renderTokenCategories() {
  const categoriesList = $('tokenCategoriesList');
  if (!categoriesList) {
    console.warn('tokenCategoriesList element not found');
    return;
  }
  
  if (!cryptoData || cryptoData.length === 0) {
    categoriesList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">ბაზრის მონაცემები მიუწვდომელია</div>';
    return;
  }
  
  // Categorize tokens (simple categorization based on common patterns)
  const categories = {
    'Layer 1': ['bitcoin', 'ethereum', 'solana', 'cardano', 'polkadot', 'avalanche', 'cosmos', 'near', 'aptos', 'sui'],
    'Layer 2': ['polygon', 'arbitrum', 'optimism', 'base'],
    'DeFi': ['uniswap', 'aave', 'compound', 'maker', 'curve', 'pancakeswap', 'sushiswap'],
    'Stablecoins': ['tether', 'usd-coin', 'dai', 'binance-usd', 'tether-gold'],
    'Meme': ['dogecoin', 'shiba-inu', 'pepe', 'floki', 'bonk'],
    'Exchange': ['binancecoin', 'ethereum-classic', 'chainlink']
  };
  
  const categoryCounts = {};
  Object.keys(categories).forEach(cat => {
    categoryCounts[cat] = cryptoData.filter(t => 
      categories[cat].some(id => t.id.includes(id) || t.name.toLowerCase().includes(id))
    ).length;
  });
  
  // Add "Other" category
  const categorized = Object.values(categories).flat();
  categoryCounts['სხვა'] = cryptoData.filter(t => 
    !categorized.some(id => t.id.includes(id) || t.name.toLowerCase().includes(id))
  ).length;
  
  const total = cryptoData.length;
  
  categoriesList.innerHTML = Object.entries(categoryCounts)
    .filter(([_, count]) => count > 0)
    .sort((a, b) => b[1] - a[1])
    .map(([category, count]) => {
      const percentage = ((count / total) * 100).toFixed(0);
      const barWidth = (count / total) * 100;
      return `
        <div style="padding:10px;background:rgba(255,255,255,.03);border-radius:8px;border:1px solid rgba(255,255,255,.05);margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <span style="font-size:12px;font-weight:500;color:#e8eaed;">${category}</span>
            <span style="font-size:12px;font-weight:600;color:#fafafa;">${count} (${percentage}%)</span>
          </div>
          <div style="height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;">
            <div style="height:100%;width:${barWidth}%;background:linear-gradient(90deg,#6366f1 0%,#8b5cf6 100%);border-radius:3px;transition:width .3s;"></div>
          </div>
        </div>
      `;
    }).join('');
}

// Option 6: Recent Activity Feed (Carousel Style)
let activityFeed = [];
function renderRecentActivity() {
  const carousel = $('activityCarousel');
  if (!carousel) {
    console.warn('activityCarousel element not found');
    return;
  }
  
  if (!cryptoData || cryptoData.length === 0) {
    carousel.innerHTML = '<div style="padding:40px;text-align:center;color:#9aa0a6;font-size:13px;">ბაზრის მონაცემები მიუწვდომელია</div>';
    return;
  }
  
  // Generate recent activity from price changes
  const newActivities = [];
  cryptoData.forEach(token => {
    const change = token.price_change_percentage_24h || 0;
    if (Math.abs(change) > 5) { // Significant moves (>5%)
      newActivities.push({
        type: change > 0 ? 'surge' : 'drop',
        token: token.symbol?.toUpperCase() || token.id,
        tokenName: token.name || token.id,
        change: change,
        price: token.current_price || 0,
        timestamp: Date.now() - Math.random() * 3600000 // Random time in last hour
      });
    }
  });
  
  // Merge with existing activities and sort by timestamp
  activityFeed = [...activityFeed, ...newActivities]
    .sort((a, b) => b.timestamp - a.timestamp)
    .slice(0, 10); // Keep last 10 activities
  
  // Show the activity carousel wrapper
  const activityWrapper = $('activityCarouselWrapper');
  if (activityWrapper) activityWrapper.style.display = 'block';
  
  if (activityFeed.length === 0) {
    carousel.innerHTML = '<div style="padding:40px;text-align:center;color:#9aa0a6;font-size:13px;">ბოლო აქტივობა არ არის</div>';
    return;
  }
  
  // Render as compact carousel cards
  carousel.innerHTML = activityFeed.map(activity => {
    const timeAgo = Math.floor((Date.now() - activity.timestamp) / 60000);
    const timeText = timeAgo < 1 ? 'ახლა' : timeAgo < 60 ? `${timeAgo}წთ` : `${Math.floor(timeAgo / 60)}სთ`;
    const changeColor = activity.type === 'surge' ? '#22c55e' : '#ef4444';
    const icon = activity.type === 'surge' ? '📈' : '📉';
    
    return `
      <div class="carousel-card">
        <div class="carousel-card-header" style="margin-bottom:6px;">
          <div class="carousel-card-title">${icon} ${activity.token}</div>
        </div>
        <div class="carousel-card-value" style="color:${changeColor};">
          ${activity.change >= 0 ? '+' : ''}${activity.change.toFixed(2)}%
        </div>
        <div class="carousel-card-subtitle" style="margin-top:2px;">$${formatPrice(activity.price)} • ${timeText}</div>
      </div>
    `;
  }).join('');
  
  setupCarouselNavigation('activityCarousel', 'activityCarouselNext');
}



function renderQuotes() {
  const quotesList = $('quotesList');
  if (!quotesList) {
    console.warn('quotesList element not found');
    return;
  }
  
  if (!cryptoData || cryptoData.length === 0) {
    quotesList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">ბაზრის მონაცემები მიუწვდომელია</div>';
    return;
  }
  
  // Show top 5 losers (biggest 24h drops) from tracked tokens
  const topLosers = [...cryptoData]
    .filter(t => {
      const change = t.price_change_percentage_24h || 0;
      return !isNaN(change) && isFinite(change);
    })
    .sort((a, b) => {
      // Sort by lowest 24h change (most negative first)
      const changeA = a.price_change_percentage_24h || 0;
      const changeB = b.price_change_percentage_24h || 0;
      return changeA - changeB;
    })
    .slice(0, 5);
  
  if (topLosers.length === 0) {
    quotesList.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">მონაცემები მიუწვდომელია</div>';
    return;
  }
  
  quotesList.innerHTML = topLosers.map(token => {
    const change = token.price_change_percentage_24h || 0;
    return `
      <div class="quote-item" style="padding:14px;background:rgba(234,67,53,.06);border:1px solid rgba(234,67,53,.15);border-radius:12px;display:flex;justify-content:space-between;align-items:center;transition:all .25s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(10px);">
        <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">
          <img src="${token.image || 'https://via.placeholder.com/24'}" style="width:24px;height:24px;border-radius:50%;border:1px solid rgba(255,255,255,.1);flex-shrink:0;" onerror="this.src='https://via.placeholder.com/24?text=?'">
          <div style="min-width:0;flex:1;">
            <div style="font-weight:600;font-size:13px;color:#e8eaed;letter-spacing:-0.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${token.symbol?.toUpperCase() || token.id}</div>
            <div style="font-size:11px;color:#9aa0a6;margin-top:2px;font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${(token.name || token.id).substring(0, 15)}${(token.name || token.id).length > 15 ? '...' : ''}</div>
          </div>
        </div>
        <div style="text-align:right;flex-shrink:0;margin-left:12px;">
          <div style="font-weight:600;font-size:13px;color:#e8eaed;letter-spacing:-0.2px;">$${formatPrice(token.current_price || 0)}</div>
          <div class="change-badge negative" style="font-size:11px;padding:3px 8px;border-radius:6px;display:inline-block;margin-top:4px;background:rgba(234,67,53,.15);color:#ea4335;border:1px solid rgba(234,67,53,.25);font-weight:600;">
            ↓ ${Math.abs(change).toFixed(2)}%
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Add hover effect
  quotesList.querySelectorAll('.quote-item').forEach(item => {
    item.onmouseenter = () => {
      item.style.background = 'rgba(234,67,53,.1)';
      item.style.borderColor = 'rgba(234,67,53,.25)';
      item.style.transform = 'translateX(3px)';
      item.style.boxShadow = '0 4px 12px rgba(234,67,53,.2)';
    };
    item.onmouseleave = () => {
      item.style.background = 'rgba(234,67,53,.06)';
      item.style.borderColor = 'rgba(234,67,53,.15)';
      item.style.transform = 'translateX(0)';
      item.style.boxShadow = 'none';
    };
  });
}

function renderHeroStats() {
  const hero = $('heroStats');
  const carousel = $('heroCarousel');
  if (!globalData || !carousel) return;
  
  const marketCap = globalData.total_market_cap?.usd || 0;
  const volume = globalData.total_volume?.usd || 0;
  const btcDominance = globalData.market_cap_percentage?.btc || 0;
  const ethDominance = globalData.market_cap_percentage?.eth || 0;
  const marketCapChange = globalData.market_cap_change_percentage_24h_usd || 0;
  
  const fearGreedValue = fearGreedData?.value || 'N/A';
  const fearGreedClassification = fearGreedData?.value_classification || 'N/A';
  
  const getFearGreedColor = (value) => {
    if (value <= 25) return '#ef4444';
    if (value <= 45) return '#f59e0b';
    if (value <= 55) return '#eab308';
    if (value <= 75) return '#84cc16';
    return '#22c55e';
  };
  
  // Translate Fear & Greed classification to Georgian
  const translateFearGreed = (classification) => {
    const translations = {
      'Extreme Fear': 'ექსტრემალური შიში',
      'Fear': 'შიში',
      'Neutral': 'ნეიტრალური',
      'Greed': 'სიხარბე',
      'Extreme Greed': 'ექსტრემალური სიხარბე'
    };
    return translations[classification] || classification;
  };
  
  // Altcoin Season Index calculation
  const calculateAltcoinSeason = (btcDominance) => {
    // Altcoin season index: 0-100
    // Lower BTC dominance = higher altcoin season (more altcoins performing)
    // Formula: 100 - (BTC dominance * 1.5), capped between 0-100
    const index = Math.max(0, Math.min(100, Math.round(100 - (btcDominance * 1.5))));
    return index;
  };
  
  const getAltcoinSeasonColor = (btcDominance) => {
    const index = calculateAltcoinSeason(btcDominance);
    if (index >= 75) return '#22c55e'; // Strong altcoin season
    if (index >= 50) return '#84cc16'; // Moderate altcoin season
    if (index >= 25) return '#f59e0b'; // Weak altcoin season
    return '#ef4444'; // BTC season
  };
  
  const getAltcoinSeasonLabel = (btcDominance) => {
    const index = calculateAltcoinSeason(btcDominance);
    if (index >= 75) return 'ძლიერი ალტ-სეზონი';
    if (index >= 50) return 'საშუალო ალტ-სეზონი';
    if (index >= 25) return 'სუსტი ალტ-სეზონი';
    return 'BTC სეზონი';
  };
  
  // Top Gainer Card (Green, before XAUT)
  const getTopGainerCard = () => {
    if (!cryptoData || cryptoData.length === 0) {
      return `
        <div class="carousel-card" style="border-color:rgba(34,197,94,.2);background:linear-gradient(135deg,rgba(18,18,23,.85) 0%,rgba(20,30,20,.9) 100%);">
          <div class="carousel-card-header">
            <div class="carousel-card-title" style="color:#22c55e;">🚀  Top Gainer</div>
            <span class="carousel-card-arrow" style="color:#22c55e;">→</span>
          </div>
          <div class="carousel-card-value" style="color:#22c55e;text-shadow:0 0 10px rgba(34,197,94,.3);">N/A</div>
          <div class="carousel-card-subtitle" style="color:#16a34a;">
            მონაცემები მიუწვდომელია
          </div>
        </div>
      `;
    }
    
    // Select token with highest 24h gain % from tracked tokens
    const token = [...cryptoData]
      .filter(t => {
        const change = t.price_change_percentage_24h || 0;
        return !isNaN(change) && isFinite(change);
      })
      .sort((a, b) => {
        const changeA = a.price_change_percentage_24h || 0;
        const changeB = b.price_change_percentage_24h || 0;
        return changeB - changeA;
      })[0];
    
    if (!token) {
      return `
        <div class="carousel-card" style="border-color:rgba(34,197,94,.2);background:linear-gradient(135deg,rgba(18,18,23,.85) 0%,rgba(20,30,20,.9) 100%);">
          <div class="carousel-card-header">
            <div class="carousel-card-title" style="color:#22c55e;">🚀 დღის ტოპ გეინერი</div>
            <span class="carousel-card-arrow" style="color:#22c55e;">→</span>
          </div>
          <div class="carousel-card-value" style="color:#22c55e;text-shadow:0 0 10px rgba(34,197,94,.3);">N/A</div>
          <div class="carousel-card-subtitle" style="color:#16a34a;">
            ტოკენები არ მოიძებნა
          </div>
        </div>
      `;
    }
    
    const change = token.price_change_percentage_24h || 0;
    
    return `
      <div class="carousel-card" style="border-color:rgba(34,197,94,.2);background:linear-gradient(135deg,rgba(18,18,23,.85) 0%,rgba(20,30,20,.9) 100%);">
        <div class="carousel-card-header">
          <div class="carousel-card-title" style="color:#22c55e;">🚀 დღის ტოპ გეინერი</div>
          <span class="carousel-card-arrow" style="color:#22c55e;">→</span>
        </div>
        <div class="carousel-card-value" style="color:#22c55e;text-shadow:0 0 10px rgba(34,197,94,.3);">+${change.toFixed(2)}%</div>
        <div class="carousel-card-subtitle" style="color:#16a34a;">
          ${token.symbol?.toUpperCase() || token.id.toUpperCase()}
        </div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(34,197,94,.2);font-size:11px;color:#9aa0a6;">
          $${formatPrice(token.current_price || 0)}
        </div>
      </div>
    `;
  };
  
  // XAUT (Tether Gold) card
  const getXAUTCard = () => {
    const xaut = cryptoData.find(t => t.id === 'tether-gold' || t.symbol?.toLowerCase() === 'xaut');
    
    if (!xaut) {
      return `
        <div class="carousel-card" style="border-color:rgba(212,175,55,.2);">
          <div class="carousel-card-header">
            <div class="carousel-card-title">XAUT (ოქრო)</div>
            <span class="carousel-card-arrow" style="color:#d4af37;">→</span>
          </div>
          <div class="carousel-card-value" style="color:#d4af37;">N/A</div>
          <div class="carousel-card-subtitle" style="color:#8b6f1e;">
            ტოკენი არ მოიძებნა
          </div>
        </div>
      `;
    }
    
    const price = xaut.current_price || 0;
    const change = xaut.price_change_percentage_24h || 0;
    const changeColor = change >= 0 ? '#d4af37' : '#b8860b';
    
    return `
      <div class="carousel-card" style="border-color:rgba(212,175,55,.2);background:linear-gradient(135deg,rgba(18,18,23,.85) 0%,rgba(30,25,15,.9) 100%);">
        <div class="carousel-card-header">
          <div class="carousel-card-title" style="color:#d4af37;">XAUT (ოქრო)</div>
          <span class="carousel-card-arrow" style="color:#d4af37;">→</span>
        </div>
        <div class="carousel-card-value" style="color:#d4af37;text-shadow:0 0 10px rgba(212,175,55,.3);">$${formatPrice(price)}</div>
        <div class="carousel-card-change" style="color:${changeColor};">
          ${change >= 0 ? '↑' : '↓'} ${Math.abs(change).toFixed(2)}%
        </div>
      </div>
    `;
  };
  
  carousel.innerHTML = `
    <div class="carousel-card">
      <div class="carousel-card-header">
        <div class="carousel-card-title">საბაზრო კაპიტალიზაცია</div>
        <span class="carousel-card-arrow">→</span>
      </div>
      <div class="carousel-card-value">$${formatMarketCap(marketCap)}</div>
      <div class="carousel-card-change ${marketCapChange >= 0 ? 'positive' : 'negative'}">
        ${marketCapChange >= 0 ? '↑' : '↓'} ${Math.abs(marketCapChange).toFixed(2)}%
      </div>
    </div>
    
    <div class="carousel-card">
      <div class="carousel-card-header">
        <div class="carousel-card-title">შიში და სიხარბე</div>
        <span class="carousel-card-arrow">→</span>
      </div>
      <div class="carousel-card-value" style="color:${getFearGreedColor(parseInt(fearGreedValue) || 50)};">${fearGreedValue}</div>
      <div class="carousel-card-subtitle" style="color:${getFearGreedColor(parseInt(fearGreedValue) || 50)};">
        ${translateFearGreed(fearGreedClassification)}
      </div>
    </div>
    
    <div class="carousel-card">
      <div class="carousel-card-header">
        <div class="carousel-card-title">ალტ-სეზონის ინდექსი</div>
        <span class="carousel-card-arrow">→</span>
      </div>
      <div class="carousel-card-value" style="color:${getAltcoinSeasonColor(btcDominance)};">${calculateAltcoinSeason(btcDominance)}</div>
      <div class="carousel-card-subtitle" style="color:${getAltcoinSeasonColor(btcDominance)};">
        ${getAltcoinSeasonLabel(btcDominance)}
      </div>
    </div>
    
    ${getTopGainerCard()}
    
    ${getXAUTCard()}
  `;
  
  // Setup carousel navigation
  setupCarouselNavigation('heroCarousel', 'carouselNext');
  
  // Center carousel after rendering
  setTimeout(() => {
    const carousel = $('heroCarousel');
    if (carousel) {
      if (carousel.scrollWidth <= carousel.clientWidth) {
        carousel.style.justifyContent = 'center';
        carousel.classList.add('centered');
      } else {
        carousel.style.justifyContent = 'flex-start';
        carousel.classList.remove('centered');
      }
    }
  }, 200);
}

function setupCarouselNavigation(carouselId = 'heroCarousel', nextBtnId = 'carouselNext') {
  const carousel = $(carouselId);
  const nextBtn = $(nextBtnId);
  
  if (!carousel || !nextBtn) return;
  
  // Scroll right on button click
  nextBtn.onclick = () => {
    carousel.scrollBy({ left: 300, behavior: 'smooth' });
  };
  
  // Center carousel if content is smaller than viewport
  const centerCarousel = () => {
    if (carousel.scrollWidth <= carousel.clientWidth) {
      carousel.style.justifyContent = 'center';
      carousel.classList.add('centered');
      nextBtn.style.display = 'none';
    } else {
      carousel.style.justifyContent = 'flex-start';
      carousel.classList.remove('centered');
      nextBtn.style.display = 'flex';
    }
  };
  
  // Show/hide navigation based on scroll position
  const updateNavVisibility = () => {
    const maxScroll = carousel.scrollWidth - carousel.clientWidth;
    if (maxScroll <= 0) {
      nextBtn.style.display = 'none';
      centerCarousel();
    } else {
      nextBtn.style.display = 'flex';
      carousel.style.justifyContent = 'flex-start';
    }
  };
  
  // Center on load and resize
  setTimeout(centerCarousel, 100);
  window.addEventListener('resize', centerCarousel);
  carousel.addEventListener('scroll', updateNavVisibility);
  updateNavVisibility();
  
  // Touch/swipe support for mobile
  let isDown = false;
  let startX;
  let scrollLeft;
  
  carousel.addEventListener('mousedown', (e) => {
    isDown = true;
    startX = e.pageX - carousel.offsetLeft;
    scrollLeft = carousel.scrollLeft;
    carousel.style.cursor = 'grabbing';
  });
  
  carousel.addEventListener('mouseleave', () => {
    isDown = false;
    carousel.style.cursor = 'grab';
  });
  
  carousel.addEventListener('mouseup', () => {
    isDown = false;
    carousel.style.cursor = 'grab';
  });
  
  carousel.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - carousel.offsetLeft;
    const walk = (x - startX) * 2;
    carousel.scrollLeft = scrollLeft - walk;
  });
  
  carousel.style.cursor = 'grab';
}

function renderTokens() {
  const list = $('tokensList');
  if (!list) return;
  
  list.innerHTML = '';
  if (!cryptoData || cryptoData.length === 0) {
    list.innerHTML = '<div class="error">ტოკენები არ მოიძებნა. დაამატეთ ტოკენები ადმინ პანელში.</div>';
    return;
  }
  cryptoData.sort((a, b) => {
    if (sortColumn === 'name') return sortDirection * a.name.localeCompare(b.name);
    if (sortColumn === 'price') return sortDirection * (a.current_price - b.current_price);
    if (sortColumn === 'change') return sortDirection * (a.price_change_percentage_24h - b.price_change_percentage_24h);
    if (sortColumn === 'mcap') return sortDirection * (a.market_cap - b.market_cap);
    return 0;
  }).forEach((coin, idx) => {
    const change = coin.price_change_percentage_24h || 0;
    const changeClass = change >= 0 ? 'positive' : 'negative';
    list.innerHTML += `
      <div class="token-row" style="--index: ${idx};">
        <div class="token-icon-col"><img src="${coin.image}" class="token-icon" alt="${coin.name}"></div>
        <div class="token-name-col">
          <h3>${coin.name}</h3>
          <span class="token-symbol">${coin.symbol.toUpperCase()}</span>
        </div>
        <div class="token-price-col">$${formatPrice(coin.current_price)}</div>
        <div class="token-change-col">
          <span class="change-badge ${changeClass}">
            ${change >= 0 ? '↑' : '↓'} ${Math.abs(change).toFixed(2)}%
          </span>
        </div>
        <div class="token-mcap-col">$${formatMarketCap(coin.market_cap)}</div>
      </div>
    `;
  });
}

/* ---------- ARTIFICIAL SUPERINTELLIGENCE ALLIANCE PANEL ---------- */
function renderASIAlliance() {
  const panel = $('asiAlliancePanel');
  const grid = $('asiTokensGrid');
  if (!panel || !grid) return;
  
  if (!cryptoData || cryptoData.length === 0) {
    panel.style.display = 'none';
    return;
  }
  
  // ASI Alliance token IDs (CoinGecko IDs)
  const asiTokens = [
    { id: 'singularitynet', symbol: 'AGIX', name: 'SingularityNET' },
    { id: 'ocean-protocol', symbol: 'OCEAN', name: 'Ocean Protocol' },
    { id: 'rejuve-ai', symbol: 'RJV', name: 'Rejuve.AI' },
    { id: 'sophiaverse', symbol: 'SOPH', name: 'SophiaVerse' },
    { id: 'saffron-finance', symbol: 'SFI', name: 'Saffron Finance' },
    { id: 'nunet', symbol: 'NTX', name: 'NuNet' },
    { id: 'twin-protocol', symbol: 'TWIN', name: 'Twin Protocol' },
    { id: 'hypercycle', symbol: 'HYPC', name: 'HyperCycle' }
  ];
  
  // Find tokens in cryptoData
  const foundTokens = [];
  asiTokens.forEach(tokenDef => {
    const token = cryptoData.find(t => 
      t.id === tokenDef.id || 
      t.symbol?.toLowerCase() === tokenDef.symbol.toLowerCase() ||
      t.name?.toLowerCase().includes(tokenDef.name.toLowerCase())
    );
    if (token) {
      foundTokens.push({
        ...tokenDef,
        ...token,
        symbol: token.symbol || tokenDef.symbol
      });
    }
  });
  
  if (foundTokens.length === 0) {
    panel.style.display = 'none';
    return;
  }
  
  // Update panel icon - use robot emoji as default
  const iconContainer = $('asiPanelIcon');
  const iconImg = $('asiPanelIconImg');
  if (iconContainer && iconImg) {
    iconImg.style.display = 'none';
    iconContainer.innerHTML = '🤖';
  }
  
  panel.style.display = 'block';
  grid.innerHTML = foundTokens.map(token => {
    const change = token.price_change_percentage_24h || 0;
    const changeColor = change >= 0 ? '#22c55e' : '#ef4444';
    const changeBg = change >= 0 ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)';
    
    return `
      <div style="background:var(--bg-tertiary);border:1px solid var(--border-secondary);border-radius:var(--radius-md);padding:16px;transition:all 0.2s ease;position:relative;overflow:hidden;cursor:pointer;" 
           onmouseenter="this.style.background='var(--bg-card-hover)';this.style.borderColor='var(--border-primary)';this.style.transform='translateY(-2px)';this.style.boxShadow='var(--shadow-md)'"
           onmouseleave="this.style.background='var(--bg-tertiary)';this.style.borderColor='var(--border-secondary)';this.style.transform='translateY(0)';this.style.boxShadow='none'">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
          <div style="width:40px;height:40px;border-radius:var(--radius-sm);overflow:hidden;flex-shrink:0;border:1px solid var(--border-secondary);background:var(--bg-primary);display:flex;align-items:center;justify-content:center;">
            ${token.image ? `<img src="${token.image}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.parentElement.innerHTML='🤖';">` : '🤖'}
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${token.name}</div>
            <div style="font-size:11px;color:var(--text-tertiary);font-weight:500;">${token.symbol.toUpperCase()}</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div>
            <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px;">ფასი</div>
            <div style="font-size:16px;font-weight:700;color:var(--text-primary);font-variant-numeric:tabular-nums;">$${formatPrice(token.current_price || 0)}</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding-top:8px;border-top:1px solid var(--border-secondary);">
            <div>
              <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px;">24სთ</div>
              <div style="font-size:13px;font-weight:600;color:${changeColor};padding:4px 8px;border-radius:6px;background:${changeBg};display:inline-block;">
                ${change >= 0 ? '↑' : '↓'} ${Math.abs(change).toFixed(2)}%
              </div>
            </div>
            ${token.market_cap ? `
            <div style="text-align:right;">
              <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px;">კაპიტალიზაცია</div>
              <div style="font-size:11px;font-weight:600;color:var(--text-secondary);font-variant-numeric:tabular-nums;">$${formatMarketCap(token.market_cap)}</div>
            </div>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

window.sortBy = function(col) {
  if (sortColumn === col) {
    sortDirection *= -1;
  } else {
    sortColumn = col;
    sortDirection = col === 'name' ? 1 : -1;
  }
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  $(`sort${col.charAt(0).toUpperCase() + col.slice(1)}`).classList.add('active');
  renderTokens();
};


/* ---------- PORTFOLIO VISIBILITY TOGGLE (Enhanced Privacy Mode) ---------- */
let portfolioVisible = true;
let privacyMode = false;

// Animate number counter
function animateValue(element, start, end, duration = 1000) {
  if (!element) return;
  const startVal = parseFloat(start.toString().replace(/[^0-9.-]/g, '')) || 0;
  const endVal = parseFloat(end.toString().replace(/[^0-9.-]/g, '')) || 0;
  const isCurrency = start.toString().includes('$');
  const isPercent = start.toString().includes('%');
  const isNegative = start.toString().startsWith('-');
  
  const startTime = performance.now();
  const animate = (currentTime) => {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
    const current = startVal + (endVal - startVal) * easeOutQuart;
    
    let formatted;
    if (isCurrency) {
      formatted = `${isNegative && current < 0 ? '-' : ''}$${Math.abs(current).toFixed(2)}`;
    } else if (isPercent) {
      formatted = `${current >= 0 ? '+' : ''}${current.toFixed(2)}%`;
    } else {
      formatted = current.toFixed(2);
    }
    
    element.textContent = formatted;
    
    if (progress < 1) {
      requestAnimationFrame(animate);
    }
  };
  requestAnimationFrame(animate);
}

/* ──── THEME TOGGLE FUNCTIONALITY ──── */
function initTheme() {
  const themeToggle = $('themeToggle');
  const themeIcon = $('themeIcon');
  if (!themeToggle || !themeIcon) return;
  
  // Get saved theme or default to dark
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  updateThemeIcon(savedTheme);
  
  themeToggle.onclick = () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
  };
}

function updateThemeIcon(theme) {
  const themeIcon = $('themeIcon');
  if (!themeIcon) return;
  themeIcon.textContent = theme === 'dark' ? '🌙' : '☀️';
}

// Initialize theme on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initTheme);
} else {
  initTheme();
}

/* ──── PAGE NAVIGATION ──── */
function showPage(pageName) {
  // Ensure contentGrid is visible
  const contentGrid = document.getElementById('contentGrid');
  if (contentGrid) {
    contentGrid.style.display = 'block';
  }
  
  // Hide/show carousel elements based on page
  const heroStatsEl = document.getElementById('heroStats');
  const activityCarouselEl = document.getElementById('activityCarouselWrapper');
  const asiPanelEl = document.getElementById('asiAlliancePanel');
  
  // Show carousels only on market page, hide on dashboard, portfolio, alerts, profile, and tradingJournal pages
  const pagesToHide = ['dashboard', 'portfolio', 'alerts', 'profile', 'tradingJournal'];
  const shouldHide = pagesToHide.includes(pageName);
  
  if (heroStatsEl) {
    heroStatsEl.style.display = shouldHide ? 'none' : 'grid';
  }
  if (activityCarouselEl) {
    activityCarouselEl.style.display = shouldHide ? 'none' : 'block';
  }
  if (asiPanelEl) {
    asiPanelEl.style.display = shouldHide ? 'none' : 'block';
  }
  
  // Hide all pages
  document.querySelectorAll('.page-content').forEach(page => {
    page.classList.remove('active');
  });
  
  // Show selected page
  const targetPage = document.getElementById(pageName + 'Page');
  if (targetPage) {
    targetPage.classList.add('active');
  }
  
  // Update top navigation active state
  document.querySelectorAll('.top-nav-tab').forEach(tab => {
    tab.classList.remove('active');
    if (tab.getAttribute('data-page') === pageName) {
      tab.classList.add('active');
    }
  });
  
  // Load data for the page
  if (pageName === 'portfolio' && currentUser) {
    loadPortfolio();
  } else if (pageName === 'targets' && currentUser) {
    loadTargets();
    populateTargetTokenSelect();
  } else if (pageName === 'alerts' && currentUser) {
    loadAlerts();
  } else if (pageName === 'tradingJournal' && currentUser) {
    loadTrades();
  }
  
  // No sidebar to close
}

// Initialize top navigation
function initTopNavigation() {
  const navTabs = document.querySelectorAll('.top-nav-tab[data-page]');
  navTabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
      e.preventDefault();
      const pageName = tab.getAttribute('data-page');
      if (pageName) {
        showPage(pageName);
      }
    });
  });
  
  // Show market page by default
  showPage('market');
}

// Initialize on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initTopNavigation);
} else {
  initTopNavigation();
}

// Top navigation is always visible, no toggle needed

if ($('toggleVisibility')) {
  $('toggleVisibility').onclick = () => {
    privacyMode = !privacyMode;
    portfolioVisible = !privacyMode;
    const totalValueCard = $('totalValueCard');
    const totalPLCard = $('totalPLCard');
    const totalValue = $('totalValue');
    const totalPL = $('totalPL');
    const toggleBtn = $('toggleVisibility');
    
    // Hide/show all dollar values across dashboard
    const allDollarValues = document.querySelectorAll('[id*="Value"], [id*="PL"], .holding-row [style*="color"]');
    
    if (privacyMode) {
      // Hide all dollar values
      if (totalValue) totalValue.style.display = 'none';
      if (totalPL) totalPL.style.display = 'none';
      if (totalValueCard) totalValueCard.style.opacity = '0.4';
      if (totalPLCard) totalPLCard.style.opacity = '0.4';
      
      // Hide dollar values in holdings
      document.querySelectorAll('.holding-row').forEach(row => {
        const valueCells = row.querySelectorAll('div');
        valueCells.forEach(cell => {
          if (cell.textContent.includes('$') && !cell.textContent.includes('%')) {
            cell.style.opacity = '0';
          }
        });
      });
      
      toggleBtn.textContent = '👁️‍🗨️';
      toggleBtn.style.opacity = '1';
      toggleBtn.title = 'მნიშვნელობების ჩვენება';
      toggleBtn.setAttribute('aria-label', 'პორტფოლიოს მნიშვნელობების ჩვენება');
    } else {
      // Show all dollar values
      if (totalValue) totalValue.style.display = 'block';
      if (totalPL) totalPL.style.display = 'block';
      if (totalValueCard) totalValueCard.style.opacity = '1';
      if (totalPLCard) totalPLCard.style.opacity = '1';
      
      // Show dollar values in holdings
      document.querySelectorAll('.holding-row').forEach(row => {
        const valueCells = row.querySelectorAll('div');
        valueCells.forEach(cell => {
          if (cell.textContent.includes('$')) {
            cell.style.opacity = '1';
          }
        });
      });
      
      toggleBtn.textContent = '👁️';
      toggleBtn.style.opacity = '0.7';
      toggleBtn.title = 'მნიშვნელობების დამალვა';
      toggleBtn.setAttribute('aria-label', 'პორტფოლიოს მნიშვნელობების დამალვა');
    }
  };
}


/* ---------- TOP GAINER OF DAY (Sidebar) ---------- */
function renderTopGainerSidebar() {
  const container = $('topGainerSidebar');
  if (!container) return;
  
  if (!cryptoData || cryptoData.length === 0) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">მონაცემები მიუწვდომელია</div>';
    return;
  }
  
  // Select token with highest 24h gain % from tracked tokens
  const token = [...cryptoData]
    .filter(t => {
      // Only include tokens with valid price change data
      const change = t.price_change_percentage_24h || 0;
      return !isNaN(change) && isFinite(change);
    })
    .sort((a, b) => {
      // Sort by highest 24h gain percentage (descending)
      const changeA = a.price_change_percentage_24h || 0;
      const changeB = b.price_change_percentage_24h || 0;
      return changeB - changeA;
    })[0];
  
  if (!token) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">ტოკენები არ მოიძებნა</div>';
    return;
  }
  
  const change = token.price_change_percentage_24h || 0;
  const changeColor = change >= 0 ? '#22c55e' : '#ef4444';
  
  container.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;padding:16px;background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.2);border-radius:12px;">
      <div style="width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0;border:2px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;background:rgba(20,20,30,.5);">
        ${token.image ? `<img src="${token.image}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML='💰'">` : '💰'}
      </div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;font-size:14px;color:#fafafa;letter-spacing:-0.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${token.name || token.id}</div>
        <div style="font-size:11px;color:#71717a;margin-top:2px;">${(token.symbol || token.id).toUpperCase()}</div>
        <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
          <div style="font-size:13px;font-weight:600;color:#fafafa;">$${formatPrice(token.current_price || 0)}</div>
          <div style="font-size:12px;font-weight:600;padding:3px 8px;border-radius:6px;background:${changeColor}20;color:${changeColor};border:1px solid ${changeColor}40;">
            ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ---------- HAPTIC FEEDBACK (Mobile) ---------- */
function vibrate(pattern = [50]) {
  if ('vibrate' in navigator) {
    navigator.vibrate(pattern);
  }
}

// Add haptic feedback to alerts
const originalAddAlert = window.addAlert;
if (originalAddAlert) {
  window.addAlert = async function(alertData) {
    const result = await originalAddAlert.call(this, alertData);
    vibrate([50, 50, 50]); // Short vibration pattern when adding alert
    return result;
  };
}

/* ---------- SCREEN READER OPTIMIZATION ---------- */
// Add ARIA labels to interactive elements
document.addEventListener('DOMContentLoaded', () => {
  // Add labels to buttons
  document.querySelectorAll('button').forEach(btn => {
    if (!btn.getAttribute('aria-label') && !btn.textContent.trim()) {
      btn.setAttribute('aria-label', btn.title || 'Button');
    }
  });
  
  // Add labels to inputs
  document.querySelectorAll('input, select').forEach(input => {
    if (!input.getAttribute('aria-label') && !input.id.includes('holding') && !input.id.includes('alert')) {
      const label = input.previousElementSibling?.textContent || input.placeholder || 'Input field';
      input.setAttribute('aria-label', label);
    }
  });
  
  // Add role attributes
  const mainContent = document.querySelector('.main-section');
  if (mainContent && !mainContent.getAttribute('role')) {
    mainContent.setAttribute('role', 'main');
  }
  
  // Add live regions for dynamic content
  if (!document.getElementById('liveRegion')) {
    const liveRegion = document.createElement('div');
    liveRegion.id = 'liveRegion';
    liveRegion.setAttribute('aria-live', 'polite');
    liveRegion.setAttribute('aria-atomic', 'true');
    liveRegion.style.position = 'absolute';
    liveRegion.style.left = '-9999px';
    liveRegion.style.width = '1px';
    liveRegion.style.height = '1px';
    liveRegion.style.overflow = 'hidden';
    document.body.appendChild(liveRegion);
  }
});

// Sidebar active state is now handled by showPage() function

/* ---------- INITIAL LOAD ---------- */
/* ---------- API CACHING SYSTEM (Moved to top) ---------- */
const API_CACHE_KEY = 'crypto_api_cache';
const CACHE_DURATION = 60000; // 1 minute cache (adjustable)

// Load data on page load
fetchAll();

/* ---------- FETCH MARKET DATA (via Vercel API) ---------- */
async function fetchAll(forceRefresh = false){
  const err = $('error'), load = $('loading');
  err.innerHTML = '';
  
  // Check cache first (unless forced refresh)
  if (!forceRefresh) {
    const cachedData = getCachedData();
    if (cachedData) {
      // Use cached data
      cryptoData = cachedData.cryptoData || [];
      cryptoData.forEach(t => prices[t.id] = t.current_price);
      globalData = cachedData.globalData;
      fearGreedData = cachedData.fearGreed;
      etfFlowsData = cachedData.etfFlows;
      
      renderAll();
      if (cryptoData && cryptoData.length > 0) {
        renderRecentActivity();
      }
      $('contentGrid').style.display = 'block';
      showPage('market');
      $('heroStats').style.display = 'grid';
      
      if (currentUser) {
        loadPortfolio();
        loadAlerts();
        loadTargets();
      }
      populateTargetTokenSelect();
      if (Object.keys(sellTargets).length > 0) {
        renderTargets();
      }
      
      load.style.display = 'none';
      
      // Fetch fresh data in background (non-blocking)
      fetchAll(true).catch(e => console.log('Background refresh failed:', e));
      return;
    }
  }
  
  load.style.display = 'block';
  
  // Show skeleton loading in tokens list
  const tokensList = $('tokensList');
  if (tokensList && (!cryptoData || cryptoData.length === 0)) {
    tokensList.innerHTML = Array(5).fill(0).map(() => `
      <div class="skeleton-card skeleton" style="display:grid;grid-template-columns:80px 2fr 1fr 1fr 1fr;gap:24px;padding:20px 24px;align-items:center;">
        <div class="skeleton-circle skeleton"></div>
        <div><div class="skeleton-text skeleton"></div><div class="skeleton-text skeleton" style="width:60%"></div></div>
        <div class="skeleton-text skeleton"></div>
        <div class="skeleton-text skeleton" style="width:80%"></div>
        <div class="skeleton-text skeleton" style="width:70%"></div>
      </div>
    `).join('');
  }
  
  try {
    console.log('Fetching market data from /api/portfolio...');
    
    const res = await fetch('/api/portfolio', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      cache: 'no-cache'
    }).catch(fetchError => {
      console.error('Network fetch error:', fetchError);
      throw new Error('Network error: Unable to reach the server. Please check your internet connection.');
    });
    
    console.log('Response status:', res.status, res.statusText);
    
    let data;
    try {
      data = await res.json();
      console.log('Response data:', data);
    } catch (jsonError) {
      console.error('Failed to parse JSON response:', jsonError);
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      // API returned an error response
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      const hint = data.hint || '';
      const requiredVars = data.requiredVars || [];
      
      let errorHtml = `<div class="error"><strong>შეცდომა: ${errorMsg}</strong>`;
      if (hint) errorHtml += `<br><br>${hint}`;
      if (requiredVars.length) {
        errorHtml += `<br><br><strong>საჭირო გარემოს ცვლადები:</strong><br>${requiredVars.join(', ')}`;
        errorHtml += `<br><br>გადადით Vercel Dashboard → Settings → Environment Variables და დააყენეთ ეს მნიშვნელობები.`;
      }
      errorHtml += `<br><br><small>დამატებითი დეტალებისთვის შეამოწმეთ ბრაუზერის კონსოლი (F12) და Vercel ლოგები</small></div>`;
      
      err.innerHTML = errorHtml;
      $('contentGrid').style.display = 'grid';
      $('heroStats').style.display = 'grid';
      load.style.display = 'none';
      return;
    }
    
    // Success - process data (even if some data is missing due to rate limiting)
    cryptoData = data.cryptoData || [];
    cryptoData.forEach(t => prices[t.id] = t.current_price);
    globalData = data.globalData;
    fearGreedData = data.fearGreed;
    etfFlowsData = data.etfFlows;
    
    // Cache the successful response
    setCachedData({
      cryptoData,
      globalData,
      fearGreedData,
      etfFlowsData
    });
    
    if (data.cached && !data.stale) {
      // Silently use cached data - no warning needed for fresh cache
      console.log('Using cached data');
    }
    
    if (data.warning || data.stale) {
      const warningMsg = data.warning || 'API შეცდომის გამო გამოიყენება დაკეშილი მონაცემები';
      console.warn('API Warning:', warningMsg);
      // Show a subtle warning to user
      const warningEl = document.createElement('div');
      warningEl.className = 'error';
      warningEl.style.background = 'rgba(245,158,11,.1)';
      warningEl.style.borderColor = 'rgba(245,158,11,.3)';
      warningEl.style.color = '#f59e0b';
      warningEl.innerHTML = `<strong>⚠️ ${data.stale ? 'დაკეშილი მონაცემები' : 'სიჩქარის ლიმიტის გაფრთხილება'}:</strong> ${warningMsg}. ზოგიერთი მონაცემი შეიძლება არასრული იყოს.`;
      const errorDiv = $('error');
      if (errorDiv && !errorDiv.querySelector('.error')) {
        errorDiv.appendChild(warningEl);
        setTimeout(() => warningEl.remove(), 10000); // Remove after 10 seconds
      }
    }
    
    if (data.retryAfter) {
      console.warn('API Rate Limited - Retry after:', data.retryAfter, 'seconds');
      const errorEl = document.createElement('div');
      errorEl.className = 'error';
      errorEl.innerHTML = `<strong>⚠️ სიჩქარის ლიმიტი გადაჭარბებულია:</strong> ${data.message || 'CoinGecko API სიჩქარის ლიმიტი გადაჭარბებულია'}. გთხოვთ დაელოდოთ ${data.retryAfter} წამს განახლებამდე.`;
      $('error').innerHTML = '';
      $('error').appendChild(errorEl);
    }
    
           console.log(`Loaded ${cryptoData.length} tokens`);
           
    renderAll();
    $('contentGrid').style.display = 'block';
    // Show market page by default
    showPage('market');
           // Load portfolio, alerts, and targets after market data is loaded
           if(currentUser) { 
             loadPortfolio(); 
             loadAlerts();
             loadTargets();
           }
           // Populate target token select
           populateTargetTokenSelect();
           // Refresh targets display when prices update
           if (Object.keys(sellTargets).length > 0) {
             renderTargets();
           }
  } catch (e) {
    console.error('Fetch error:', e);
    console.error('Error details:', e.message, e.stack);
    
    // Enhanced error messages with better formatting
    let errorHtml = '';
    if (e.message && (e.message.includes('503') || e.message.includes('Rate Limit'))) {
      errorHtml = `<div class="error">
        <strong>⚠️ Rate Limit Exceeded</strong>
        <p style="margin:12px 0;">CoinGecko API rate limit has been exceeded. Please wait a minute and refresh the page.</p>
        <small>The system will automatically retry, but you may need to wait a bit longer.</small>
      </div>`;
    } else if (e.message && e.message.includes('Network error')) {
      errorHtml = `<div class="error">
        <strong>🌐 Network Error</strong>
        <p style="margin:12px 0;">${e.message}</p>
        <p style="margin:8px 0;text-align:left;">Please check:</p>
        <ul style="text-align:left;margin:8px 0;padding-left:20px;">
          <li>Your internet connection</li>
          <li>If the server is accessible</li>
          <li>Try refreshing the page</li>
        </ul>
        <small>If the problem persists, check browser console (F12) for more details</small>
      </div>`;
    } else {
      errorHtml = `<div class="error">
        <strong>❌ Error: ${e.message || 'Unknown error'}</strong>
        <p style="margin:12px 0;">This could mean:</p>
        <ul style="text-align:left;margin:8px 0;padding-left:20px;">
          <li>The API endpoint is not responding</li>
          <li>There's a network connectivity issue</li>
          <li>The serverless function crashed</li>
          <li>API rate limiting (429 errors)</li>
        </ul>
        <small>Check browser console (F12) and Vercel deployment logs for details</small>
      </div>`;
    }
    
    err.innerHTML = errorHtml;
    $('contentGrid').style.display = 'grid';
    $('heroStats').style.display = 'grid';
    
    // Clear skeleton loading
    const tokensList = $('tokensList');
    if (tokensList) tokensList.innerHTML = '';
  } finally {
    load.style.display = 'none';
  }
}

/* ---------- PORTFOLIO (via Vercel API) ---------- */
async function loadPortfolio(){
  if(!currentUser) {
    console.log('No user logged in, skipping portfolio load');
    return;
  }
  
  try {
    console.log('Loading portfolio for user:', currentUser.uid);
    
    // Fetch user holdings directly from Firebase Realtime Database
    const userId = currentUser.uid;
    const db = firebase.database();
    const holdingsRef = db.ref(`users/${userId}/holdings`);
    
    holdingsRef.once('value', (snapshot) => {
      const holdings = snapshot.val() || {};
      portfolioHoldings = holdings; // Store globally for targets calculation
      console.log('Portfolio holdings loaded:', Object.keys(holdings).length, 'items');
      renderPortfolio(holdings);
      // Refresh targets display with updated buy prices
      if (Object.keys(sellTargets).length > 0) {
        renderTargets();
      }
    }, (error) => {
      console.error('Database read error:', error);
      // Only show alert if it's a real error, not just empty data
      if (error.code !== 'PERMISSION_DENIED') {
        console.error('Failed to load portfolio: ' + error.message);
        // Don't show alert, just log it
      } else {
        console.log('Permission denied - user may not have holdings yet');
      }
      // Always render portfolio (even if empty) to show empty state
      renderPortfolio({});
    });
  } catch (e) {
    console.error('Load portfolio error:', e);
    // Always render portfolio (even if empty) to show empty state
    renderPortfolio({});
  }
}

async function updateHolding(id, field, value) {
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/portfolio', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id, field, value })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // Reload portfolio after update
    await loadPortfolio();
  } catch (e) {
    alert('Update error: ' + e.message);
    console.error('Update holding error:', e);
  }
}

window.editHolding = function(id, tokenId, amount, buyPrice) {
  // Populate the edit modal with current values
  $('editHoldingId').value = id;
  $('editHoldingToken').value = tokenId;
  $('editHoldingAmount').value = amount;
  $('editHoldingBuyPrice').value = buyPrice;
  
  // Populate token select (in case it's not already populated)
  const tokenSelect = $('editHoldingToken');
  if (tokenSelect.options.length === 0) {
    cryptoData.forEach(token => {
      const option = document.createElement('option');
      option.value = token.id;
      option.textContent = `${token.name} (${token.symbol.toUpperCase()})`;
      if (token.id === tokenId) option.selected = true;
      tokenSelect.appendChild(option);
    });
  }
  
  // Show the modal
  $('editHoldingModal').classList.add('show');
};

window.deleteHolding = async (id) => {
  if(!confirm('Delete?')) return;
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/portfolio', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // Reload portfolio after delete
    await loadPortfolio();
  } catch (e) {
    alert('წაშლის შეცდომა: ' + e.message);
    console.error('Delete holding error:', e);
  }
};

$('addHoldingForm').onsubmit = async e => {
  e.preventDefault();
  const tokenId = $('holdingToken').value;
  const amount = parseFloat($('holdingAmount').value);
  const buyPrice = parseFloat($('buyPrice').value);
  if(!tokenId || isNaN(amount) || isNaN(buyPrice)) return alert('გთხოვთ შეავსოთ ყველა ველი');
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/portfolio', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ holding: { tokenId, amount, buyPrice } })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    e.target.reset();
    // Reload portfolio immediately after adding
    console.log('Holding added, reloading portfolio...');
    await loadPortfolio();
  } catch (e) {
    alert('დამატების შეცდომა: ' + e.message);
    console.error('Add holding error:', e);
  }
};

// Edit holding form handler
$('editHoldingForm').onsubmit = async e => {
  e.preventDefault();
  const id = $('editHoldingId').value;
  const amount = parseFloat($('editHoldingAmount').value);
  const buyPrice = parseFloat($('editHoldingBuyPrice').value);
  
  if (!id || isNaN(amount) || isNaN(buyPrice) || amount <= 0 || buyPrice <= 0) {
    return alert('გთხოვთ შეიყვანოთ სწორი მნიშვნელობები რაოდენობისა და შესყიდვის ფასისთვის');
  }
  
  try {
    // Update both fields
    const token = await currentUser.getIdToken();
    
    // Update amount
    let res = await fetch('/api/portfolio', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id, field: 'amount', value: amount })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // Update buy price
    res = await fetch('/api/portfolio', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id, field: 'buyPrice', value: buyPrice })
    });
    
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // Close modal and reload portfolio
    $('editHoldingModal').classList.remove('show');
    await loadPortfolio();
  } catch (e) {
    alert('განახლების შეცდომა: ' + e.message);
    console.error('Edit holding error:', e);
  }
};

/* ---------- ALERTS (via Vercel API) ---------- */
async function loadAlerts(){
  if(!currentUser) return;
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/alerts', {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    let data;
    try {
      const text = await res.text();
      if (!text) {
        data = {};
      } else {
        data = JSON.parse(text);
      }
    } catch (jsonError) {
      console.error('Failed to parse alerts response:', jsonError);
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText}). Response: ${(await res.text()).substring(0, 100)}`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    const alertsData = data || {};
    alerts = alertsData; // Store globally for dashboard
    renderAlerts(alertsData);
    // Update dashboard if on dashboard page
    if (currentUser && document.getElementById('dashboardPage')?.style.display !== 'none') {
      updateDashboardStats(portfolioHoldings || {}, sellTargets || {}, alerts);
    }
  } catch (e) {
    console.error('Load alerts error:', e);
    // Don't show alert if it's just empty alerts
    if (!e.message.includes('404') && !e.message.includes('invalid response')) {
      console.warn('შეტყობინებების ჩატვირთვის შეცდომა: ' + e.message);
    }
    // Always render alerts (even if empty) to show empty state
    alerts = {};
    renderAlerts({});
  }
}

async function addAlert(alert) {
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/alerts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ alert })
    });
    if (res.status !== 200) throw new Error('დამატება ვერ მოხერხდა');
    loadAlerts();
  } catch (e) {
    alert('დამატების შეცდომა: ' + e.message);
  }
}

window.deleteAlert = async (id) => {
  if(!confirm('წაშლა?')) return;
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch(`/api/alerts?id=${encodeURIComponent(id)}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      const text = await res.text();
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText}): ${text.substring(0, 100)}`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    loadAlerts();
  } catch (e) {
    alert('შეტყობინების წაშლის შეცდომა: ' + e.message);
    console.error('Delete alert error:', e);
  }
};

$('addAlertForm').onsubmit = async e => {
  e.preventDefault();
  const tokenId = $('alertToken').value;
  const condition = $('alertCondition').value;
  const target = parseFloat($('targetPrice').value);
  const message = $('alertMessage').value;
  if(!tokenId || isNaN(target)) return alert('გთხოვთ შეავსოთ ყველა ველი');
  await addAlert({ tokenId, condition, target, message });
  e.target.reset();
};

$('addTargetForm').onsubmit = async e => {
  e.preventDefault();
  await addTarget();
};

/* ---------- PROFILE MANAGEMENT ---------- */
// Tab switching
document.querySelectorAll('.user-tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.user-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.user-content').forEach(c => {
      c.classList.remove('active');
      c.style.display = 'none';
    });
    tab.classList.add('active');
    const tabName = tab.getAttribute('data-tab');
    const contentEl = $(tabName + 'Content');
    if (contentEl) {
      contentEl.classList.add('active');
      contentEl.style.display = 'block';
    }
  };
});

// Change Name Form
$('changeNameForm').onsubmit = async (e) => {
  e.preventDefault();
  if (!currentUser) {
    alert('გთხოვთ შეხვიდეთ სისტემაში');
    return;
  }

  const name = $('newName').value.trim();
  if (!name) {
    showStatus('nameStatus', 'გთხოვთ შეიყვანოთ სახელი', 'error');
    return;
  }

  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/profile', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ action: 'updateName', name })
    });

    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || data.message || 'სახელის შეცვლა ვერ მოხერხდა');
    }

    showStatus('nameStatus', data.message || 'სახელი წარმატებით შეიცვალა', 'success');
    $('newName').value = '';
    
    // Reload user data
    await currentUser.reload();
  } catch (error) {
    showStatus('nameStatus', error.message || 'შეცდომა სახელის შეცვლისას', 'error');
  }
};

// Change Email Form
$('changeEmailForm').onsubmit = async (e) => {
  e.preventDefault();
  if (!currentUser) {
    alert('გთხოვთ შეხვიდეთ სისტემაში');
    return;
  }

  const email = $('newEmail').value.trim();
  const password = $('emailPassword').value;

  if (!email || !email.includes('@')) {
    showStatus('emailStatus', 'გთხოვთ შეიყვანოთ სწორი ელფოსტა', 'error');
    return;
  }

  if (!password) {
    showStatus('emailStatus', 'გთხოვთ შეიყვანოთ პაროლი', 'error');
    return;
  }

  try {
    // Verify password by re-authenticating
    const credential = firebase.auth.EmailAuthProvider.credential(
      currentUser.email,
      password
    );
    await currentUser.reauthenticateWithCredential(credential);

    const token = await currentUser.getIdToken();
    const res = await fetch('/api/profile', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ action: 'updateEmail', email, currentPassword: password })
    });

    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || data.message || 'ელფოსტის შეცვლა ვერ მოხერხდა');
    }

    showStatus('emailStatus', data.message || 'ელფოსტა წარმატებით შეიცვალა', 'success');
    $('newEmail').value = '';
    $('emailPassword').value = '';
    
    // Reload user data
    await currentUser.reload();
  } catch (error) {
    if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
      showStatus('emailStatus', 'არასწორი პაროლი', 'error');
    } else {
      showStatus('emailStatus', error.message || 'შეცდომა ელფოსტის შეცვლისას', 'error');
    }
  }
};

// Change Password Form
$('changePasswordForm').onsubmit = async (e) => {
  e.preventDefault();
  if (!currentUser) {
    alert('გთხოვთ შეხვიდეთ სისტემაში');
    return;
  }

  const currentPassword = $('currentPassword').value;
  const newPassword = $('newPassword').value;
  const confirmPassword = $('confirmPassword').value;

  if (!currentPassword || !newPassword || !confirmPassword) {
    showStatus('passwordStatus', 'გთხოვთ შეავსოთ ყველა ველი', 'error');
    return;
  }

  if (newPassword.length < 6) {
    showStatus('passwordStatus', 'ახალი პაროლი უნდა იყოს მინიმუმ 6 სიმბოლო', 'error');
    return;
  }

  if (newPassword !== confirmPassword) {
    showStatus('passwordStatus', 'პაროლები არ ემთხვევა', 'error');
    return;
  }

  try {
    // Verify current password by re-authenticating
    const credential = firebase.auth.EmailAuthProvider.credential(
      currentUser.email,
      currentPassword
    );
    await currentUser.reauthenticateWithCredential(credential);

    const token = await currentUser.getIdToken();
    const res = await fetch('/api/profile', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ 
        action: 'updatePassword', 
        currentPassword, 
        newPassword, 
        confirmPassword 
      })
    });

    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || data.message || 'პაროლის შეცვლა ვერ მოხერხდა');
    }

    showStatus('passwordStatus', data.message || 'პაროლი წარმატებით შეიცვალა', 'success');
    $('currentPassword').value = '';
    $('newPassword').value = '';
    $('confirmPassword').value = '';
  } catch (error) {
    if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
      showStatus('passwordStatus', 'არასწორი მიმდინარე პაროლი', 'error');
    } else {
      showStatus('passwordStatus', error.message || 'შეცდომა პაროლის შეცვლისას', 'error');
    }
  }
};

/* ---------- SELL TARGETS MANAGEMENT ---------- */
// sellTargets and portfolioHoldings are declared in GLOBALS section above

async function loadTargets() {
  if (!currentUser) return;
  
  try {
    const userId = currentUser.uid;
    const db = firebase.database();
    const targetsRef = db.ref(`users/${userId}/sellTargets`);
    
    targetsRef.once('value', (snapshot) => {
      sellTargets = snapshot.val() || {};
      renderTargets(); // Always render to show empty state if needed
    }, (error) => {
      console.error('Failed to load targets:', error);
      sellTargets = {};
      renderTargets(); // Always render to show empty state
    });
  } catch (e) {
    console.error('Load targets error:', e);
    sellTargets = {};
    renderTargets(); // Always render to show empty state
  }
}

let selectedTargetTokenId = null;

function renderTargets() {
  const tokenListContainer = $('targetsTokenList');
  const detailsContainer = $('targetDetailsContent');
  if (!tokenListContainer || !detailsContainer) return;
  
  // Ensure sellTargets is initialized
  if (!sellTargets) {
    sellTargets = {};
  }
  
  const targetsArray = Object.entries(sellTargets).map(([id, target]) => ({ id, ...target }));
  
  if (targetsArray.length === 0) {
    tokenListContainer.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:var(--text-tertiary);">
        <div style="font-size:32px;margin-bottom:12px;">🎯</div>
        <div style="font-size:13px;color:var(--text-tertiary);">გასაყიდი ტოკენი არ არის</div>
      </div>
    `;
    return;
  }
  
  // Group by token
  const grouped = {};
  targetsArray.forEach(target => {
    if (!grouped[target.tokenId]) {
      grouped[target.tokenId] = [];
    }
    grouped[target.tokenId].push(target);
  });
  
  // Render token list on left
  let tokenListHtml = '';
  Object.entries(grouped).forEach(([tokenId, targets]) => {
    const token = cryptoData.find(t => t.id === tokenId);
    const currentPrice = token?.current_price || prices[tokenId] || 0;
    const tokenName = token?.name || tokenId;
    const tokenSymbol = token?.symbol?.toUpperCase() || tokenId.toUpperCase();
    const tokenImage = token?.image || '';
    const isSelected = selectedTargetTokenId === tokenId;
    const targetCount = targets.length;
    
    // Count reached targets
    const reachedCount = targets.filter(t => currentPrice >= t.targetPrice).length;
    
    tokenListHtml += `
      <div onclick="selectTargetToken('${tokenId}')" style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:${isSelected ? 'rgba(99,102,241,.2)' : 'rgba(10,14,26,.3)'};border:1px solid ${isSelected ? 'rgba(99,102,241,.4)' : 'rgba(255,255,255,.05)'};border-radius:8px;cursor:pointer;transition:all .2s;margin-bottom:6px;">
        ${tokenImage ? `<img src="${tokenImage}" style="width:32px;height:32px;border-radius:50%;border:1px solid rgba(255,255,255,.1);flex-shrink:0;">` : '<div style="width:32px;height:32px;border-radius:50%;background:rgba(99,102,241,.2);display:flex;align-items:center;justify-content:center;font-size:14px;color:#6366f1;flex-shrink:0;">💰</div>'}
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;font-size:13px;color:#fafafa;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${tokenName}</div>
          <div style="font-size:10px;color:#71717a;margin-top:2px;">${tokenSymbol}</div>
        </div>
        <div style="text-align:right;flex-shrink:0;">
          <div style="font-size:10px;color:#9aa0a6;margin-bottom:2px;">${targetCount} დონე</div>
          ${reachedCount > 0 ? `<div style="font-size:10px;color:#22c55e;font-weight:600;">✓ ${reachedCount}</div>` : ''}
        </div>
      </div>
    `;
  });
  
  tokenListContainer.innerHTML = tokenListHtml;
  
  // Render details on right if token is selected
  if (selectedTargetTokenId && grouped[selectedTargetTokenId]) {
    renderTargetDetails(selectedTargetTokenId, grouped[selectedTargetTokenId]);
  } else if (Object.keys(grouped).length > 0 && !selectedTargetTokenId) {
    // Auto-select first token
    const firstTokenId = Object.keys(grouped)[0];
    selectTargetToken(firstTokenId);
  }
}

window.selectTargetToken = function(tokenId) {
  selectedTargetTokenId = tokenId;
  renderTargets();
};

function renderTargetDetails(tokenId, targets) {
  const detailsContainer = $('targetDetailsContent');
  if (!detailsContainer) return;
  
  const token = cryptoData.find(t => t.id === tokenId);
  const currentPrice = token?.current_price || prices[tokenId] || 0;
  const tokenName = token?.name || tokenId;
  const tokenSymbol = token?.symbol?.toUpperCase() || tokenId.toUpperCase();
  const tokenImage = token?.image || '';
  
  // Find buy price from portfolio holdings
  let buyPrice = 0;
  const holding = Object.values(portfolioHoldings).find(h => h.tokenId === tokenId);
  if (holding && holding.buyPrice) {
    buyPrice = parseFloat(holding.buyPrice);
  }
  
  targets.sort((a, b) => a.targetPrice - b.targetPrice);
  
  let html = `
    <div style="margin-bottom:24px;">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,.05);">
        ${tokenImage ? `<img src="${tokenImage}" style="width:48px;height:48px;border-radius:50%;border:2px solid rgba(255,255,255,.1);">` : '<div style="width:48px;height:48px;border-radius:50%;background:rgba(99,102,241,.2);display:flex;align-items:center;justify-content:center;font-size:20px;color:#6366f1;">💰</div>'}
        <div style="flex:1;">
          <div style="font-weight:600;font-size:18px;color:#fafafa;margin-bottom:4px;">${tokenName}</div>
          <div style="font-size:12px;color:#71717a;">${tokenSymbol}</div>
        </div>
        <div style="display:flex;gap:24px;text-align:right;">
          ${buyPrice > 0 ? `
            <div>
              <div style="font-size:11px;color:#9aa0a6;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">შესყიდვის ფასი</div>
              <div style="font-weight:600;font-size:16px;color:#fafafa;">$${formatPrice(buyPrice)}</div>
            </div>
          ` : ''}
          <div>
            <div style="font-size:11px;color:#9aa0a6;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">მიმდინარე ფასი</div>
            <div style="font-weight:600;font-size:20px;color:#fafafa;">$${formatPrice(currentPrice)}</div>
          </div>
        </div>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:10px;">
  `;
  
  targets.forEach(target => {
    // Calculate distance from buy price (if available) or current price
    const basePrice = buyPrice > 0 ? buyPrice : currentPrice;
    const distance = basePrice > 0 ? ((target.targetPrice - basePrice) / basePrice * 100) : 0;
    const distanceColor = distance >= 0 ? '#22c55e' : '#ef4444';
    const distanceText = distance >= 0 ? `+${distance.toFixed(2)}%` : `${distance.toFixed(2)}%`;
    
    // Determine if target is reached - only for take-profit (target must be above buy price)
    // Target is reached when current price is at or above target price
    let isReached = currentPrice >= target.targetPrice;
    
    // Progress calculation: Shows percentage from current price to target price
    // Formula: (currentPrice / targetPrice) * 100
    // Example: Current $150, Target $200 → Progress = (150/200) * 100 = 75%
    // Example: Current $200, Target $200 → Progress = 100% (reached)
    let progress = 0;
    if (currentPrice > 0 && target.targetPrice > 0) {
      if (target.targetPrice >= currentPrice) {
        progress = (currentPrice / target.targetPrice) * 100;
      } else {
        // Current price is above target, so target is reached
        progress = 100;
      }
      
      // Clamp between 0% and 100%
      progress = Math.min(100, Math.max(0, progress));
    }
    
    html += `
      <div style="background:rgba(10,14,26,.4);border:1px solid ${isReached ? 'rgba(34,197,94,.3)' : 'rgba(255,255,255,.08)'};border-radius:10px;padding:16px;transition:all .2s;">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:16px;align-items:center;margin-bottom:12px;">
          <div>
            <div style="font-size:10px;color:#9aa0a6;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">სამიზნე ფასი</div>
            <div style="font-weight:600;font-size:16px;color:#fafafa;">$${formatPrice(target.targetPrice)}</div>
          </div>
          <div>
            <div style="font-size:10px;color:#9aa0a6;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">PNL</div>
            <div style="font-weight:600;font-size:16px;color:${distanceColor};text-shadow:0 0 8px ${distanceColor}40;">${distanceText}</div>
          </div>
          <div>
            <div style="font-size:10px;color:#9aa0a6;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">გასაყიდი %</div>
            <div style="font-weight:600;font-size:16px;color:#fafafa;">${target.percentage}%</div>
          </div>
          <div>
            <div style="font-size:10px;color:#9aa0a6;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">სტატუსი</div>
            <div style="font-weight:600;font-size:13px;color:${isReached ? '#22c55e' : '#9aa0a6'};">
              ${isReached ? '✓ მიღწეული' : 'მოლოდინში'}
            </div>
          </div>
          <div style="display:flex;gap:6px;">
            <button onclick="editTarget('${target.id}')" style="padding:8px 14px;background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.3);color:#6366f1;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;transition:all .2s;">რედაქტირება</button>
            <button onclick="deleteTarget('${target.id}')" style="padding:8px 14px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:#ef4444;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;transition:all .2s;">წაშლა</button>
          </div>
        </div>
        ${!isReached && basePrice > 0 && target.targetPrice > 0 ? `
          <div style="margin-top:12px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
              <span style="font-size:10px;color:#9aa0a6;">პროგრესი</span>
              <span style="font-size:10px;color:#9aa0a6;">${progress.toFixed(1)}%</span>
            </div>
            <div style="height:6px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden;position:relative;">
              <div style="height:100%;background:linear-gradient(90deg, #6366f1, #8b5cf6);width:${progress}%;transition:width .5s;border-radius:3px;box-shadow:0 0 8px rgba(99,102,241,.4);"></div>
              <div style="position:absolute;right:0;top:0;bottom:0;width:2px;background:rgba(34,197,94,.6);box-shadow:0 0 4px rgba(34,197,94,.4);" title="Target: $${formatPrice(target.targetPrice)}"></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:4px;">
              <span style="font-size:9px;color:#71717a;" title="Buy Price">$${formatPrice(basePrice)}</span>
              <span style="font-size:9px;color:#71717a;" title="Current Price">$${formatPrice(currentPrice)}</span>
              <span style="font-size:9px;color:#22c55e;font-weight:600;" title="Target Price">$${formatPrice(target.targetPrice)}</span>
            </div>
            <div style="margin-top:6px;padding:6px 10px;background:rgba(99,102,241,.08);border-radius:6px;text-align:center;">
              <span style="font-size:11px;color:#9aa0a6;font-weight:500;">
                ${!isReached ? (
                  `დარჩენილია: <span style="color:#6366f1;font-weight:700;">${(100 - progress).toFixed(1)}%</span>`
                ) : 'მიზანი მიღწეულია!'}
              </span>
            </div>
          </div>
        ` : isReached ? `
          <div style="margin-top:12px;padding:8px 12px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:6px;text-align:center;">
            <span style="font-size:11px;color:#22c55e;font-weight:600;">✓ მიზანი მიღწეულია! (100%)</span>
          </div>
        ` : basePrice === 0 ? `
          <div style="margin-top:12px;padding:8px 12px;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:6px;text-align:center;">
            <span style="font-size:10px;color:#f59e0b;">ℹ️ პროგრესის გამოსათვლელად საჭიროა შესყიდვის ფასი</span>
          </div>
        ` : ''}
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
  `;
  
  detailsContainer.innerHTML = html;
}

async function addTarget() {
  if (!currentUser) {
    alert('გთხოვთ შეხვიდეთ სისტემაში');
    return;
  }
  
  const tokenId = $('targetToken')?.value;
  const targetPrice = parseFloat($('targetSellPrice')?.value);
  const percentage = parseFloat($('targetSellPercentage')?.value);
  
  if (!tokenId || !tokenId.trim()) {
    alert('გთხოვთ აირჩიოთ ტოკენი');
    return;
  }
  
  if (isNaN(targetPrice) || targetPrice <= 0) {
    alert('გთხოვთ შეიყვანოთ სწორი სამიზნე ფასი');
    return;
  }
  
  if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
    alert('გასაყიდი პროცენტი უნდა იყოს 0-100 დიაპაზონში');
    return;
  }
  
  try {
    const userId = currentUser.uid;
    const db = firebase.database();
    const targetsRef = db.ref(`users/${userId}/sellTargets`);
    const newTargetRef = targetsRef.push();
    
    await newTargetRef.set({
      tokenId,
      targetPrice,
      percentage
    });
    
    $('addTargetForm').reset();
    await loadTargets();
    // Auto-select the newly added token
    if (tokenId) {
      selectedTargetTokenId = tokenId;
      renderTargets();
    }
  } catch (e) {
    alert('მიზნის დამატების შეცდომა: ' + e.message);
    console.error('Add target error:', e);
  }
}

async function deleteTarget(targetId) {
  if (!confirm('დარწმუნებული ხართ, რომ გსურთ ამ მიზნის წაშლა?')) return;
  
  if (!currentUser) return;
  
  try {
    const userId = currentUser.uid;
    const db = firebase.database();
    await db.ref(`users/${userId}/sellTargets/${targetId}`).remove();
    await loadTargets();
  } catch (e) {
    alert('მიზნის წაშლის შეცდომა: ' + e.message);
    console.error('Delete target error:', e);
  }
}

window.editTarget = function(targetId) {
  // Ensure sellTargets is initialized
  if (!sellTargets) {
    sellTargets = {};
  }
  const target = sellTargets[targetId];
  if (!target) {
    alert('დონე ვერ მოიძებნა');
    return;
  }
  
  // Get token info for display
  const token = cryptoData.find(t => t.id === target.tokenId);
  const currentPrice = token?.current_price || prices[target.tokenId] || 0;
  
  // Populate modal
  $('editTargetId').value = targetId;
  $('editTargetPrice').value = target.targetPrice;
  $('editTargetPercentage').value = target.percentage;
  $('editTargetPercentageSlider').value = target.percentage;
  $('editTargetCurrentPrice').textContent = `$${formatPrice(currentPrice)}`;
  
  // Hide status message
  const statusEl = $('editTargetStatus');
  statusEl.style.display = 'none';
  
  // Show modal
  $('editTargetModal').classList.add('show');
  
  // Focus on price input
  setTimeout(() => {
    $('editTargetPrice').focus();
    $('editTargetPrice').select();
  }, 100);
};

function closeEditTargetModal() {
  $('editTargetModal').classList.remove('show');
  $('editTargetForm').reset();
  const statusEl = $('editTargetStatus');
  statusEl.style.display = 'none';
}

// Sync slider with input
if ($('editTargetPercentage')) {
  $('editTargetPercentage').oninput = function() {
    const value = Math.min(100, Math.max(0, parseFloat(this.value) || 0));
    $('editTargetPercentageSlider').value = value;
    this.value = value;
  };
  
  $('editTargetPercentageSlider').oninput = function() {
    $('editTargetPercentage').value = this.value;
  };
}

// Handle form submission
if ($('editTargetForm')) {
  $('editTargetForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const targetId = $('editTargetId').value;
    const targetPrice = parseFloat($('editTargetPrice').value);
    const percentage = parseFloat($('editTargetPercentage').value);
    const statusEl = $('editTargetStatus');
    
    // Validation
    if (isNaN(targetPrice) || targetPrice <= 0) {
      statusEl.style.display = 'block';
      statusEl.style.background = 'rgba(239,68,68,.15)';
      statusEl.style.border = '1px solid rgba(239,68,68,.3)';
      statusEl.style.color = '#ef4444';
      statusEl.textContent = 'გთხოვთ შეიყვანოთ სწორი სამიზნე ფასი';
      return;
    }
    
    if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
      statusEl.style.display = 'block';
      statusEl.style.background = 'rgba(239,68,68,.15)';
      statusEl.style.border = '1px solid rgba(239,68,68,.3)';
      statusEl.style.color = '#ef4444';
      statusEl.textContent = 'პროცენტი უნდა იყოს 0-100 დიაპაზონში';
      return;
    }
    
    // Show loading
    statusEl.style.display = 'block';
    statusEl.style.background = 'rgba(99,102,241,.15)';
    statusEl.style.border = '1px solid rgba(99,102,241,.3)';
    statusEl.style.color = '#6366f1';
    statusEl.textContent = 'განახლება...';
    
    try {
      await updateTarget(targetId, targetPrice, percentage);
      
      // Show success
      statusEl.style.background = 'rgba(34,197,94,.15)';
      statusEl.style.border = '1px solid rgba(34,197,94,.3)';
      statusEl.style.color = '#22c55e';
      statusEl.textContent = '✓ დონე წარმატებით განახლდა!';
      
      // Close modal after short delay
      setTimeout(() => {
        closeEditTargetModal();
      }, 1000);
    } catch (error) {
      statusEl.style.background = 'rgba(239,68,68,.15)';
      statusEl.style.border = '1px solid rgba(239,68,68,.3)';
      statusEl.style.color = '#ef4444';
      statusEl.textContent = 'შეცდომა: ' + (error.message || 'დონის განახლება ვერ მოხერხდა');
    }
  };
}

async function updateTarget(targetId, targetPrice, percentage) {
  if (!currentUser) return;
  
  if (percentage <= 0 || percentage > 100) {
    alert('პროცენტი უნდა იყოს 0-100 დიაპაზონში');
    return;
  }
  
  try {
    const userId = currentUser.uid;
    const db = firebase.database();
    await db.ref(`users/${userId}/sellTargets/${targetId}`).update({
      targetPrice,
      percentage
    });
    await loadTargets();
  } catch (e) {
    alert('მიზნის განახლების შეცდომა: ' + e.message);
    console.error('Update target error:', e);
  }
}

function populateTargetTokenSelect() {
  const select = $('targetToken');
  if (!select || !cryptoData || cryptoData.length === 0) return;
  
  select.innerHTML = '<option value="">აირჩიეთ ტოკენი</option>';
  cryptoData.forEach(token => {
    const option = document.createElement('option');
    option.value = token.id;
    option.textContent = `${token.name} (${token.symbol?.toUpperCase() || token.id})`;
    select.appendChild(option);
  });
}

// Helper function to show status messages
function showStatus(elementId, message, type) {
  const element = $(elementId);
  if (!element) return;
  
  element.textContent = message;
  element.style.display = 'block';
  
  if (type === 'success') {
    element.style.background = 'rgba(34,197,94,.1)';
    element.style.border = '1px solid rgba(34,197,94,.25)';
    element.style.color = '#22c55e';
  } else {
    element.style.background = 'rgba(239,68,68,.1)';
    element.style.border = '1px solid rgba(239,68,68,.25)';
    element.style.color = '#ef4444';
  }
  
  // Auto-hide after 5 seconds
  setTimeout(() => {
    element.style.display = 'none';
  }, 5000);
}

/* ---------- ADMIN ADD TOKEN (with CoinGecko Search) ---------- */
let selectedTokenId = null;
let searchTimeout = null;

// Token search functionality
$('tokenSearch').oninput = async (e) => {
  const query = e.target.value.trim();
  const resultsDiv = $('tokenSearchResults');
  
  if (query.length < 2) {
    resultsDiv.style.display = 'none';
    selectedTokenId = null;
    $('selectedToken').style.display = 'none';
    $('confirmAdd').disabled = true;
    return;
  }
  
  // Debounce search
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    try {
      resultsDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">ძიება...</div>';
      resultsDiv.style.display = 'block';
      
      const res = await fetch(`/api/search-tokens?query=${encodeURIComponent(query)}`);
      const data = await res.json();
      
      if (!res.ok || !data.success) {
        throw new Error(data.error || 'ძიება ვერ მოხერხდა');
      }
      
      if (data.tokens.length === 0) {
        resultsDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">ტოკენები არ მოიძებნა</div>';
        return;
      }
      
      resultsDiv.innerHTML = data.tokens.map(token => `
        <div class="token-result-item" onclick="selectToken('${token.id}', '${token.name}', '${token.symbol}')" 
          style="padding:14px 18px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.06);transition:all .25s;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:600;color:#e8eaed;font-size:14px;letter-spacing:-0.2px;">${token.name}</div>
            <div style="font-size:12px;color:#9aa0a6;margin-top:3px;font-weight:400;">${token.symbol} • ${token.id}</div>
          </div>
          <span style="color:#8b5cf6;font-size:18px;opacity:0.7;">→</span>
        </div>
      `).join('');
      
      // Add hover effect
      resultsDiv.querySelectorAll('.token-result-item').forEach(item => {
        item.onmouseenter = () => {
          item.style.background = 'rgba(139,92,246,.08)';
          item.style.borderBottomColor = 'rgba(255,255,255,.1)';
        };
        item.onmouseleave = () => {
          item.style.background = 'transparent';
          item.style.borderBottomColor = 'rgba(255,255,255,.06)';
        };
      });
      
    } catch (error) {
      console.error('Search error:', error);
      resultsDiv.innerHTML = `<div style="padding:20px;text-align:center;color:#ef4444;">შეცდომა: ${error.message}</div>`;
    }
  }, 300);
};

// Select token from search results
window.selectToken = (id, name, symbol) => {
  selectedTokenId = id;
  $('tokenSearch').value = name;
  $('tokenSearchResults').style.display = 'none';
  $('selectedTokenName').textContent = `${name} (${symbol})`;
  $('selectedTokenId').textContent = `ID: ${id}`;
  $('selectedToken').style.display = 'block';
  $('confirmAdd').disabled = false;
};

// Clear selection
$('clearSelection').onclick = () => {
  selectedTokenId = null;
  $('tokenSearch').value = '';
  $('selectedToken').style.display = 'none';
  $('confirmAdd').disabled = true;
  $('tokenSearchResults').style.display = 'none';
};

// Close search results when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('#tokenSearch') && !e.target.closest('#tokenSearchResults')) {
    $('tokenSearchResults').style.display = 'none';
  }
});

// Add token
$('confirmAdd').onclick = async () => {
  if (!selectedTokenId) return alert('გთხოვთ აირჩიოთ ტოკენი');
  
  const statusDiv = $('addTokenStatus');
  statusDiv.style.display = 'block';
  statusDiv.style.background = 'rgba(59,130,246,.1)';
  statusDiv.style.border = '1px solid rgba(59,130,246,.3)';
  statusDiv.style.color = '#3b82f6';
  statusDiv.textContent = 'ტოკენის დამატება...';
  $('confirmAdd').disabled = true;
  
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id: selectedTokenId })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    statusDiv.style.background = 'rgba(16,185,129,.1)';
    statusDiv.style.border = '1px solid rgba(16,185,129,.3)';
    statusDiv.style.color = '#10b981';
    statusDiv.textContent = `✅ ${data.message || `ტოკენი "${selectedTokenId}" წარმატებით დაემატა!`}`;
    
    setTimeout(() => {
    $('addTokenModal').classList.remove('show');
      $('tokenSearch').value = '';
      $('selectedToken').style.display = 'none';
      selectedTokenId = null;
      $('confirmAdd').disabled = true;
      statusDiv.style.display = 'none';
    fetchAll();
    }, 1500);
    
  } catch (e) {
    statusDiv.style.background = 'rgba(239,68,68,.1)';
    statusDiv.style.border = '1px solid rgba(239,68,68,.3)';
    statusDiv.style.color = '#ef4444';
    statusDiv.textContent = `❌ შეცდომა: ${e.message}`;
    $('confirmAdd').disabled = false;
    console.error('Token add error:', e);
  }
};

/* ---------- RENDER FUNCTIONS (same as before) ---------- */
function renderPortfolio(holdings) {
  const list = $('holdingsList');
  if (!list) {
    console.warn('holdingsList element not found');
    return;
  }
  
  list.innerHTML = '';
  let totalValue = 0, totalCost = 0;
  
  if (!holdings || Object.keys(holdings).length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">💼</div>
        <div class="empty-state-title">პორტფოლიო ცარიელია</div>
        <div class="empty-state-text">დაამატეთ ტოკენები თქვენს პორტფოლიოში, რათა დაიწყოთ თქვენი ინვესტიციების თვალყურდევნება</div>
      </div>
    `;
    if ($('totalValue')) $('totalValue').textContent = '$0.00';
    if ($('totalPL')) {
      $('totalPL').textContent = '$0.00';
      $('totalPL').style.color = '#9aa0a6';
      // Reset card colors to default
      const plCard = $('totalPL').closest('.summary-card');
      if (plCard) {
        plCard.style.borderColor = 'rgba(139,92,246,.15)';
        plCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(26,10,46,.6) 100%)';
        const valueEl = plCard.querySelector('.summary-value');
        if (valueEl) {
          valueEl.style.background = 'linear-gradient(135deg,#ffffff 0%,#e9d5ff 100%)';
          valueEl.style.webkitBackgroundClip = 'text';
          valueEl.style.backgroundClip = 'text';
          valueEl.style.webkitTextFillColor = 'transparent';
        }
      }
    }
    if ($('roi')) {
      $('roi').textContent = '0%';
      $('roi').style.color = '#9aa0a6';
      // Reset card colors to default
      const roiCard = $('roi').closest('.summary-card');
      if (roiCard) {
        roiCard.style.borderColor = 'rgba(139,92,246,.15)';
        roiCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(26,10,46,.6) 100%)';
        const valueEl = roiCard.querySelector('.summary-value');
        if (valueEl) {
          valueEl.style.background = 'linear-gradient(135deg,#ffffff 0%,#e9d5ff 100%)';
          valueEl.style.webkitBackgroundClip = 'text';
          valueEl.style.backgroundClip = 'text';
          valueEl.style.webkitTextFillColor = 'transparent';
        }
      }
    }
    return;
  }
  
  Object.entries(holdings || {}).forEach(([id, h]) => {
    if (!h || !h.tokenId) return; // Skip invalid holdings
    const token = cryptoData.find(t => t.id === h.tokenId) || { 
      name: h.tokenId || 'Unknown Token', 
      symbol: h.tokenId ? h.tokenId.toUpperCase().substring(0, 4) : 'UNK', 
      image: 'https://via.placeholder.com/32?text=?' 
    };
    const price = token.current_price || prices[h.tokenId] || 0;
    const value = h.amount * price;
    const cost = h.amount * (h.buyPrice || 0);
    totalValue += value;
    totalCost += cost;
    const pl = value - cost;
    const plPct = cost > 0 ? (pl / cost * 100) : 0;
    const plClass = pl >= 0 ? 'positive' : 'negative';
    const plSign = pl >= 0 ? '+' : '';
    
    list.innerHTML += `
      <div class="holding-row" data-id="${id}">
        <div class="holding-header">
          <div class="holding-icon-wrapper">
            <img src="${token.image || 'https://via.placeholder.com/44'}" onerror="this.parentElement.innerHTML='<span style=\\'font-size:20px;color:#6366f1\\'>💰</span>'">
        </div>
          <div class="holding-info">
            <div class="holding-name">${token.name || h.tokenId || 'Unknown'}</div>
            <div class="holding-symbol">${token.symbol ? token.symbol.toUpperCase() : (h.tokenId ? h.tokenId.toUpperCase().substring(0, 6) : 'UNK')}</div>
          </div>
        </div>
        <div class="holding-stats">
          <div class="holding-stat">
            <div class="holding-stat-label">რაოდენობა</div>
            <div class="holding-stat-value editable" data-field="amount" data-value="${h.amount}">${formatPrice(h.amount)}</div>
          </div>
          <div class="holding-stat">
            <div class="holding-stat-label">შესყიდვის ფასი</div>
            <div class="holding-stat-value editable" data-field="buyPrice" data-value="${h.buyPrice}">$${formatPrice(h.buyPrice)}</div>
          </div>
          <div class="holding-stat">
            <div class="holding-stat-label">მიმდინარე ფასი</div>
            <div class="holding-stat-value">$${formatPrice(price)}</div>
          </div>
          <div class="holding-stat">
            <div class="holding-stat-label">ღირებულება</div>
            <div class="holding-stat-value">$${formatPrice(value)}</div>
          </div>
          <div class="holding-stat">
            <div class="holding-stat-label">PNL</div>
            <div class="holding-stat-value ${plClass}">${plSign}$${formatPrice(Math.abs(pl))}</div>
          </div>
          <div class="holding-stat">
            <div class="holding-stat-label">ROI</div>
            <div class="holding-stat-value ${plClass}">${plSign}${plPct.toFixed(2)}%</div>
          </div>
        </div>
        <div class="holding-actions">
          <button class="edit-btn" onclick="editHolding('${id}', '${h.tokenId}', ${h.amount}, ${h.buyPrice})" title="რედაქტირება">✏️ რედაქტირება</button>
          <button class="delete-btn" onclick="deleteHolding('${id}')" title="წაშლა">🗑️ წაშლა</button>
        </div>
      </div>`;
  });
  
  // Store previous values for animation
  const prevTotalValue = parseFloat($('totalValue')?.textContent.replace(/[^0-9.-]/g, '') || '0');
  const prevPL = parseFloat($('totalPL')?.textContent.replace(/[^0-9.-]/g, '') || '0');
  const prevROI = parseFloat($('roi')?.textContent.replace(/[^0-9.-]/g, '') || '0');
  
  const pl = totalValue - totalCost;
  let roi = totalCost > 0 ? ((totalValue / totalCost - 1) * 100) : 0;
  
  // Ensure ROI is a valid number
  if (isNaN(roi) || !isFinite(roi)) {
    roi = 0;
  }
  
  // Update dashboard stats
  updateDashboardStats(holdings, sellTargets || {}, alerts || {});
  
  // Animate value changes
  if ($('totalValue')) {
    const newValue = totalValue.toFixed(2);
    if (Math.abs(prevTotalValue - totalValue) > 0.01) {
      animateValue($('totalValue'), `$${prevTotalValue.toFixed(2)}`, `$${newValue}`, 800);
    } else {
      $('totalValue').textContent = `$${newValue}`;
    }
  }
  
  // Update Total P/L card with conditional colors and animation
  if ($('totalPL')) {
    const newPL = pl >= 0 ? `+$${pl.toFixed(2)}` : `-$${Math.abs(pl).toFixed(2)}`;
    if (Math.abs(prevPL - pl) > 0.01) {
      animateValue($('totalPL'), prevPL >= 0 ? `+$${Math.abs(prevPL).toFixed(2)}` : `-$${Math.abs(prevPL).toFixed(2)}`, newPL, 800);
    } else {
      $('totalPL').textContent = newPL;
    }
  $('totalPL').style.color = pl >= 0 ? '#10b981' : '#ef4444';
    
    // Update parent summary card colors
    const plCard = $('totalPL').closest('.summary-card');
    if (plCard) {
      if (pl >= 0) {
        plCard.style.borderColor = 'rgba(16,185,129,.3)';
        plCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(16,185,129,.08) 100%)';
        plCard.querySelector('.summary-value').style.background = 'linear-gradient(135deg,#10b981 0%,#059669 100%)';
        plCard.querySelector('.summary-value').style.webkitBackgroundClip = 'text';
        plCard.querySelector('.summary-value').style.backgroundClip = 'text';
        plCard.querySelector('.summary-value').style.webkitTextFillColor = 'transparent';
      } else {
        plCard.style.borderColor = 'rgba(239,68,68,.3)';
        plCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(239,68,68,.08) 100%)';
        plCard.querySelector('.summary-value').style.background = 'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)';
        plCard.querySelector('.summary-value').style.webkitBackgroundClip = 'text';
        plCard.querySelector('.summary-value').style.backgroundClip = 'text';
        plCard.querySelector('.summary-value').style.webkitTextFillColor = 'transparent';
      }
    }
  }
  
  // Update ROI card with conditional colors and animation
  if ($('roi')) {
    const safeROI = isNaN(roi) || !isFinite(roi) ? 0 : roi;
    const safePrevROI = isNaN(prevROI) || !isFinite(prevROI) ? 0 : prevROI;
    const newROI = totalCost > 0 ? `${safeROI >= 0 ? '+' : ''}${safeROI.toFixed(2)}%` : '0%';
    if (Math.abs(safePrevROI - safeROI) > 0.01) {
      animateValue($('roi'), `${safePrevROI >= 0 ? '+' : ''}${safePrevROI.toFixed(2)}%`, newROI, 800);
    } else {
      $('roi').textContent = newROI;
    }
    $('roi').style.color = safeROI >= 0 ? '#10b981' : '#ef4444';
    
    // Update parent summary card colors
    const roiCard = $('roi').closest('.summary-card');
    if (roiCard) {
      if (safeROI >= 0) {
        roiCard.style.borderColor = 'rgba(16,185,129,.3)';
        roiCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(16,185,129,.08) 100%)';
        roiCard.querySelector('.summary-value').style.background = 'linear-gradient(135deg,#10b981 0%,#059669 100%)';
        roiCard.querySelector('.summary-value').style.webkitBackgroundClip = 'text';
        roiCard.querySelector('.summary-value').style.backgroundClip = 'text';
        roiCard.querySelector('.summary-value').style.webkitTextFillColor = 'transparent';
      } else {
        roiCard.style.borderColor = 'rgba(239,68,68,.3)';
        roiCard.style.background = 'linear-gradient(135deg,rgba(10,14,26,.6) 0%,rgba(239,68,68,.08) 100%)';
        roiCard.querySelector('.summary-value').style.background = 'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)';
        roiCard.querySelector('.summary-value').style.webkitBackgroundClip = 'text';
        roiCard.querySelector('.summary-value').style.backgroundClip = 'text';
        roiCard.querySelector('.summary-value').style.webkitTextFillColor = 'transparent';
      }
    }
  }
  document.querySelectorAll('.editable').forEach(el => el.onclick = () => startEdit(el));
  
  // Update Portfolio Analytics
  updatePortfolioAnalytics(holdings, totalValue);
}

/* ---------- PORTFOLIO ANALYTICS ---------- */
function updatePortfolioAnalytics(holdings, totalValue) {
  if (!holdings || Object.keys(holdings).length === 0) {
    if ($('portfolioAnalytics')) $('portfolioAnalytics').style.display = 'none';
    return;
  }
  
  if ($('portfolioAnalytics')) $('portfolioAnalytics').style.display = 'block';
  
  // Calculate allocation with token IDs for categorization
  const allocation = {};
  const allocationByTokenId = {}; // Store by tokenId for categorization
  const token24hPNL = {}; // Store 24h PNL for each token
  let totalAllocation = 0;
  let total24hPNL = 0; // Total portfolio 24h PNL (sum of all token gains/losses)
  let total24hChange = 0; // Total portfolio 24h change percentage (calculated from total PNL)
  
  // Calculate total allocation and 24h PNL from all holdings
  Object.entries(holdings).forEach(([id, h]) => {
    if (!h || !h.tokenId) return;
    const price = prices[h.tokenId] || 0;
    const value = h.amount * price;
    if (value > 0) {
      const token = cryptoData.find(t => t.id === h.tokenId);
      const tokenName = token?.symbol?.toUpperCase() || h.tokenId.toUpperCase().substring(0, 4);
      allocation[tokenName] = (allocation[tokenName] || 0) + value;
      allocationByTokenId[h.tokenId] = (allocationByTokenId[h.tokenId] || 0) + value;
      totalAllocation += value;
      
      // Calculate daily PNL for each holding
      // PNL = current_value * (price_change_percentage / 100)
      const priceChange24h = token?.price_change_percentage_24h || 0;
      if (!isNaN(priceChange24h) && isFinite(priceChange24h)) {
        const pnl24h = value * (priceChange24h / 100);
        total24hPNL += pnl24h;
        
        if (!token24hPNL[tokenName]) {
          token24hPNL[tokenName] = { value: value, pnl: 0, token: token };
        }
        token24hPNL[tokenName].pnl += pnl24h;
      }
    }
  });
  
  // Calculate portfolio daily change percentage from total PNL
  // This is the actual portfolio gain/loss percentage: (total_PNL / total_value) * 100
  if (totalAllocation > 0) {
    total24hChange = (total24hPNL / totalAllocation) * 100;
  }
  
  // Update Portfolio Daily Change Display
  const portfolio24hChangeEl = $('portfolio24hChange');
  const portfolio24hChangeUSDEl = $('portfolio24hChangeUSD');
  
  if (portfolio24hChangeEl) {
    const changeSign = total24hChange >= 0 ? '+' : '';
    const changeColor = total24hChange >= 0 ? '#22c55e' : '#ef4444';
    portfolio24hChangeEl.innerHTML = `<span style="color:${changeColor};text-shadow:0 0 12px ${changeColor}80;">${changeSign}${total24hChange.toFixed(2)}%</span>`;
  }
  
  if (portfolio24hChangeUSDEl) {
    const changeSignUSD = total24hPNL >= 0 ? '+' : '';
    const changeColorUSD = total24hPNL >= 0 ? '#22c55e' : '#ef4444';
    portfolio24hChangeUSDEl.innerHTML = `<span style="color:${changeColorUSD};text-shadow:0 0 8px ${changeColorUSD}60;">${changeSignUSD}$${formatPrice(Math.abs(total24hPNL))}</span>`;
  }
  
  // Render token legend only (no chart)
  const legendDiv = $('allocationLegend');
  if (legendDiv) legendDiv.innerHTML = '';
  
  if (totalAllocation > 0) {
    const colors = ['#8b5cf6', '#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#a78bfa'];
    
    Object.entries(allocation)
      .sort((a, b) => b[1] - a[1])
      .forEach(([token, value], idx) => {
        const percentage = (value / totalAllocation) * 100;
        
        // Add compact 4-column legend
        if (legendDiv && percentage > 1) {
          const legendItem = document.createElement('div');
          legendItem.style.display = 'flex';
          legendItem.style.alignItems = 'center';
          legendItem.style.gap = '6px';
          legendItem.style.padding = '8px 10px';
          legendItem.style.background = 'rgba(0,0,0,0.3)';
          legendItem.style.borderRadius = '8px';
          legendItem.style.transition = 'all 0.25s cubic-bezier(0.4,0,0.2,1)';
          legendItem.style.cursor = 'pointer';
          legendItem.style.border = `1px solid ${colors[idx % colors.length]}30`;
          legendItem.style.backdropFilter = 'blur(8px)';
          
          const colorBox = document.createElement('div');
          colorBox.style.width = '10px';
          colorBox.style.height = '10px';
          colorBox.style.borderRadius = '2px';
          colorBox.style.background = colors[idx % colors.length];
          colorBox.style.flexShrink = '0';
          colorBox.style.boxShadow = `0 0 6px ${colors[idx % colors.length]}, 0 0 12px ${colors[idx % colors.length]}60`;
          colorBox.style.border = '1px solid rgba(255,255,255,0.15)';
          
          const tokenName = document.createElement('span');
          tokenName.style.color = 'rgba(255,255,255,0.85)';
          tokenName.style.fontSize = '11px';
          tokenName.style.fontWeight = '600';
          tokenName.style.letterSpacing = '0.05px';
          tokenName.style.flex = '1';
          tokenName.style.minWidth = '0';
          tokenName.style.overflow = 'hidden';
          tokenName.style.textOverflow = 'ellipsis';
          tokenName.style.whiteSpace = 'nowrap';
          tokenName.textContent = token;
          
          const tokenPercent = document.createElement('span');
          tokenPercent.style.color = 'rgba(255,255,255,0.95)';
          tokenPercent.style.fontWeight = '700';
          tokenPercent.style.fontSize = '11px';
          tokenPercent.style.fontVariantNumeric = 'tabular-nums';
          tokenPercent.style.textShadow = `0 0 6px ${colors[idx % colors.length]}80`;
          tokenPercent.style.flexShrink = '0';
          tokenPercent.textContent = `${percentage.toFixed(1)}%`;
          
          legendItem.appendChild(colorBox);
          legendItem.appendChild(tokenName);
          legendItem.appendChild(tokenPercent);
          
          legendItem.onmouseenter = function() {
            this.style.background = `rgba(${colors[idx % colors.length].substring(1).match(/.{2}/g).map(x => parseInt(x, 16)).join(',')}, 0.15)`;
            this.style.borderColor = colors[idx % colors.length] + '60';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = `0 4px 12px ${colors[idx % colors.length]}40`;
            colorBox.style.boxShadow = `0 0 10px ${colors[idx % colors.length]}, 0 0 20px ${colors[idx % colors.length]}80`;
          };
          legendItem.onmouseleave = function() {
            this.style.background = 'rgba(0,0,0,0.3)';
            this.style.borderColor = colors[idx % colors.length] + '30';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
            colorBox.style.boxShadow = `0 0 6px ${colors[idx % colors.length]}, 0 0 12px ${colors[idx % colors.length]}60`;
          };
          
          legendDiv.appendChild(legendItem);
        }
      });
  }
  
  // Calculate risk metrics
  const tokenCount = Object.keys(allocation).length;
  const largestPosition = Object.entries(allocation).sort((a, b) => b[1] - a[1])[0];
  const largestPercentage = largestPosition ? (largestPosition[1] / totalAllocation * 100) : 0;
  
  // Calculate proper diversification score
  const diversificationScore = computeDiversificationScore(holdings, totalAllocation, allocationByTokenId);
  
  if ($('diversificationScore')) {
    $('diversificationScore').textContent = `${Math.round(diversificationScore)}/100`;
  }
  if ($('diversificationBar')) {
    $('diversificationBar').style.width = `${diversificationScore}%`;
    setTimeout(() => {
      if ($('diversificationBar')) {
        $('diversificationBar').style.width = `${diversificationScore}%`;
      }
    }, 100);
  }
  
  if ($('largestPosition')) $('largestPosition').textContent = largestPosition ? `${largestPosition[0]} (${largestPercentage.toFixed(1)}%)` : '-';
  if ($('tokenCount')) $('tokenCount').textContent = tokenCount;
}

/* ---------- DIVERSIFICATION SCORE CALCULATION ---------- */
function computeDiversificationScore(holdings, totalAllocation, allocationByTokenId) {
  if (!holdings || Object.keys(holdings).length === 0 || totalAllocation <= 0) {
    return 0;
  }
  
  // Prepare assets array with weights
  const assets = [];
  const categories = {};
  const stables = ['usd-coin', 'tether', 'dai', 'binance-usd', 'true-usd', 'paxos-standard', 'tether-gold'];
  
  Object.entries(holdings).forEach(([id, h]) => {
    if (!h || !h.tokenId) return;
    const value = allocationByTokenId[h.tokenId] || 0;
    const weight = value / totalAllocation;
    if (weight <= 0) return;
    
    const token = cryptoData.find(t => t.id === h.tokenId);
    const tokenIdLower = h.tokenId.toLowerCase();
    
    // Determine category
    let category = 'Other';
    if (stables.some(s => tokenIdLower.includes(s))) {
      category = 'Stablecoin';
    } else if (['bitcoin', 'ethereum'].some(c => tokenIdLower.includes(c))) {
      category = 'Layer1';
    } else if (['solana', 'cardano', 'polkadot', 'avalanche', 'cosmos', 'near', 'aptos', 'sui'].some(c => tokenIdLower.includes(c))) {
      category = 'Layer1';
    } else if (['polygon', 'arbitrum', 'optimism', 'base', 'matic-network'].some(c => tokenIdLower.includes(c))) {
      category = 'Layer2';
    } else if (['uniswap', 'aave', 'compound', 'maker', 'curve', 'pancakeswap'].some(c => tokenIdLower.includes(c))) {
      category = 'DeFi';
    }
    
    // Estimate volatility (use historical price change as proxy)
    const priceChange = Math.abs(token?.price_change_percentage_24h || 0) / 100;
    const volatility = Math.min(1.5, Math.max(0.1, priceChange * 365)); // Annualized estimate
    
    assets.push({
      symbol: token?.symbol?.toUpperCase() || h.tokenId.toUpperCase(),
      weight: weight,
      volatility: volatility,
      category: category,
      isStable: stables.some(s => tokenIdLower.includes(s))
    });
    
    categories[category] = (categories[category] || 0) + weight;
  });
  
  if (assets.length === 0) return 0;
  
  const n = assets.length;
  const params = { sigmaTarget: 0.6, stableTarget: 0.10 };
  
  // 1. Concentration (S_c) - Herfindahl Index
  const H = assets.reduce((sum, a) => sum + Math.pow(a.weight, 2), 0);
  const H_min = 1 / n;
  const S_c = n > 1 ? Math.max(0, Math.min(1, 1 - ((H - H_min) / (1 - H_min)))) : 0;
  
  // 2. Portfolio Volatility (S_v)
  // Simplified: use weighted average volatility
  const sigma_p = Math.sqrt(assets.reduce((sum, a) => sum + Math.pow(a.weight * a.volatility, 2), 0));
  const S_v = Math.max(0, Math.min(1, 1 - sigma_p / params.sigmaTarget));
  
  // 3. Correlation (S_rho) - Simplified average correlation
  // For crypto, assume average correlation of 0.5-0.7
  const avgCorr = 0.6; // Typical crypto correlation
  const S_rho = Math.max(0, Math.min(1, 1 - (avgCorr + 1) / 2));
  
  // 4. Category Diversity (S_d)
  const categoryKeys = Object.keys(categories);
  const K = categoryKeys.length;
  let S_d = 0;
  if (K > 1) {
    const H_cat = -categoryKeys.reduce((sum, cat) => {
      const p_k = categories[cat];
      return sum + (p_k > 0 ? p_k * Math.log(p_k) : 0);
    }, 0);
    S_d = Math.max(0, Math.min(1, H_cat / Math.log(K)));
  }
  
  // 5. Stablecoin Buffer (S_s)
  const w_stable = assets.filter(a => a.isStable).reduce((sum, a) => sum + a.weight, 0);
  const S_s = Math.max(0, Math.min(1, w_stable / params.stableTarget));
  
  // Final Score
  const score = 100 * (0.25 * S_c + 0.25 * S_v + 0.20 * S_rho + 0.15 * S_d + 0.15 * S_s);
  
  return Math.max(0, Math.min(100, Math.round(score)));
}

// Toggle analytics visibility
if ($('toggleAnalytics')) {
  let analyticsVisible = true;
  $('toggleAnalytics').onclick = () => {
    analyticsVisible = !analyticsVisible;
    const analyticsDiv = $('portfolioAnalytics');
    const toggleBtn = $('toggleAnalytics');
    if (analyticsDiv && toggleBtn) {
      if (analyticsVisible) {
        analyticsDiv.style.display = 'block';
        const span = toggleBtn.querySelector('span');
        if (span) span.textContent = 'დამალვა';
        toggleBtn.setAttribute('aria-expanded', 'true');
      } else {
        analyticsDiv.style.display = 'none';
        const span = toggleBtn.querySelector('span');
        if (span) span.textContent = 'ჩვენება';
        toggleBtn.setAttribute('aria-expanded', 'false');
      }
    }
  };
}

function startEdit(el) {
  if (el.querySelector('input')) return;
  const field = el.dataset.field;
  const value = el.dataset.value;
  const input = document.createElement('input');
  input.type = 'number';
  input.step = 'any';
  input.value = value;
  input.style.width = '80px';
  input.style.padding = '4px 8px';
  input.style.background = '#0a0a0a';
  input.style.border = '1px solid #8b5cf6';
  input.style.borderRadius = '8px';
  input.style.color = '#fff';
  input.style.fontSize = '14px';
  const saveBtn = document.createElement('span');
  saveBtn.textContent = 'Save';
  saveBtn.style.cursor = 'pointer';
  saveBtn.style.color = '#10b981';
  saveBtn.style.marginLeft = '8px';
  saveBtn.style.fontWeight = '700';
  const cancelBtn = document.createElement('span');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.style.cursor = 'pointer';
  cancelBtn.style.color = '#ef4444';
  cancelBtn.style.marginLeft = '8px';
  cancelBtn.style.fontWeight = '700';
  el.innerHTML = '';
  el.appendChild(input);
  el.appendChild(saveBtn);
  el.appendChild(cancelBtn);
  input.focus();
  const save = async () => {
    const newVal = parseFloat(input.value);
    if (isNaN(newVal) || newVal < 0) return alert('არასწორი მნიშვნელობა');
    const holdingId = el.closest('.holding-row').dataset.id;
    await updateHolding(holdingId, field, newVal);
  };
  saveBtn.onclick = save;
  input.onkeypress = e => e.key === 'Enter' && save();
  cancelBtn.onclick = () => loadPortfolio();
}

function renderAlerts(alerts) {
  const list = $('alertsList');
  if (!list) return;
  list.innerHTML = '';
  if (!alerts || Object.keys(alerts).length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">🔔</div>
        <div class="empty-state-title">შეტყობინებები არ არის</div>
        <div class="empty-state-text">დაამატეთ ფასის შეტყობინებები, რათა მიიღოთ გაფრთხილებები, როდესაც ტოკენები მიაღწევენ სამიზნე ფასებს</div>
      </div>
    `;
    populateTokenSelect('alertToken');
    return;
  }
  Object.entries(alerts || {}).forEach(([id, a]) => {
    if (!a || !a.tokenId) return; // Skip invalid alerts
    const token = cryptoData.find(t => t.id === a.tokenId);
    const tokenName = token?.name || a.tokenId || 'Unknown Token';
    const tokenImage = token?.image || 'https://via.placeholder.com/32?text=?';
    const price = prices[a.tokenId] || 0;
    const triggered = (a.condition === 'above' && price >= a.target) || (a.condition === 'below' && price <= a.target);
    list.innerHTML += `
      <div class="alert-row ${triggered ? 'triggered' : ''}">
        <div class="token-icon-col"><img src="${tokenImage}" class="token-icon" onerror="this.src='https://via.placeholder.com/32?text=?'"></div>
        <div>${tokenName}</div>
        <div>${a.condition === 'above' ? '>' : '<'} $${formatPrice(a.target || 0)}</div>
        <div>$${formatPrice(price)}</div>
        <div class="delete-btn" onclick="deleteAlert('${id}')">X</div>
      </div>`;
    if (triggered && !a.notified) {
      // Haptic feedback on mobile
      vibrate([100, 50, 100, 50, 100]); // Strong vibration pattern for alert trigger
      
      if (typeof confetti !== 'undefined') {
      confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
      }
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('CCX შეტყობინება', { body: `${a.message || ''} ${tokenName} არის ${a.condition === 'above' ? 'ზემოთ' : 'ქვემოთ'} $${a.target}!` });
      }
      
      // Announce to screen readers
      const liveRegion = document.getElementById('liveRegion');
      if (liveRegion) {
        liveRegion.textContent = `შეტყობინება გააქტიურდა: ${tokenName} არის ${a.condition === 'above' ? 'ზემოთ' : 'ქვემოთ'} $${a.target}`;
        setTimeout(() => liveRegion.textContent = '', 1000);
      }
    }
  });
  populateTokenSelect('alertToken');
}

/* ---------- POPULATE SELECTS ---------- */
function populateTokenSelect(id) {
  const sel = $(id);
  if (!sel) return; // Element doesn't exist
  sel.innerHTML = '<option value="">ტოკენის არჩევა</option>';
  if (!cryptoData || cryptoData.length === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'ტოკენები მიუწვდომელია';
    opt.disabled = true;
    sel.appendChild(opt);
    return;
  }
  cryptoData.forEach(t => {
    if (!t || !t.id) return; // Skip invalid tokens
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = `${t.name || t.id} (${(t.symbol || t.id.substring(0, 4)).toUpperCase()})`;
    sel.appendChild(opt);
  });
}

/* ---------- MODAL HANDLERS ---------- */
$('addTokenBtn').onclick = () => {
  $('addTokenModal').classList.add('show');
  $('tokenSearch').focus();
};
$('closeModal').onclick = () => {
  $('addTokenModal').classList.remove('show');
  $('tokenSearch').value = '';
  $('selectedToken').style.display = 'none';
  $('tokenSearchResults').style.display = 'none';
  selectedTokenId = null;
  $('confirmAdd').disabled = true;
};
$('cancelAdd').onclick = () => {
  $('addTokenModal').classList.remove('show');
  $('tokenSearch').value = '';
  $('selectedToken').style.display = 'none';
  $('tokenSearchResults').style.display = 'none';
  selectedTokenId = null;
  $('confirmAdd').disabled = true;
};
$('refreshBtn').onclick = () => fetchAll(true); // Force refresh
$('refreshButton').onclick = () => {
  const icon = $('refreshIcon');
  if (icon) {
    icon.style.animation = 'rotate 1s linear';
    setTimeout(() => {
      icon.style.animation = '';
    }, 1000);
  }
  fetchAll(true); // Force refresh (bypass cache)
  if (currentUser) {
    loadPortfolio();
    loadAlerts();
  }
};

function getCachedData() {
  try {
    const cached = localStorage.getItem(API_CACHE_KEY);
    if (!cached) return null;
    
    const { data, timestamp } = JSON.parse(cached);
    const age = Date.now() - timestamp;
    
    // Return cached data if still fresh
    if (age < CACHE_DURATION) {
      console.log(`Using cached data (${Math.round(age/1000)}s old)`);
      return data;
    }
    
    // Cache expired
    localStorage.removeItem(API_CACHE_KEY);
    return null;
  } catch (e) {
    console.error('Cache read error:', e);
    return null;
  }
}

function setCachedData(data) {
  try {
    localStorage.setItem(API_CACHE_KEY, JSON.stringify({
      data,
      timestamp: Date.now()
    }));
    console.log('Data cached successfully');
  } catch (e) {
    console.error('Cache write error:', e);
  }
}

/* ---------- AUTO REFRESH ---------- */
let refreshIntervalId = null;
let refreshIntervalMs = 300000; // 5 minutes (increased to reduce API calls)

function startAutoRefresh() {
  if (refreshIntervalId) clearInterval(refreshIntervalId);
  refreshIntervalId = setInterval(() => {
fetchAll();
  if (currentUser) {
    loadPortfolio();
    loadAlerts();
  }
  }, refreshIntervalMs);
}

// Quotes section removed

// Load settings and start auto-refresh
  fetchAll();
startAutoRefresh();

// Quotes section removed - no longer loading quotes

/* ---------- ASI PANEL MUSIC CONTROL ---------- */
window.asiMusicPlaying = false;
window.toggleASIMusic = function() {
  const audio = document.getElementById('asiBackgroundMusic');
  const icon = document.getElementById('asiMusicIcon');
  const button = document.getElementById('asiMusicToggle');
  
  if (!audio || !icon || !button) return;
  
  try {
    if (window.asiMusicPlaying) {
      audio.pause();
      icon.textContent = '▶';
      button.style.background = 'rgba(99,102,241,0.2)';
      button.style.borderColor = 'rgba(99,102,241,0.4)';
      window.asiMusicPlaying = false;
    } else {
      audio.volume = 0.5; // Set volume to 50%
      audio.play().then(() => {
        icon.textContent = '⏸';
        button.style.background = 'rgba(99,102,241,0.4)';
        button.style.borderColor = 'rgba(99,102,241,0.6)';
        button.style.boxShadow = '0 0 15px rgba(99,102,241,0.5)';
        window.asiMusicPlaying = true;
      }).catch(err => {
        console.error('Error playing music:', err);
        // Try alternative paths
        const paths = ['Inception.ogg', '/Inception.ogg', '/public/Inception.ogg'];
        let pathIndex = 0;
        const tryNextPath = () => {
          if (pathIndex < paths.length) {
            audio.src = paths[pathIndex];
            audio.volume = 0.5; // Set volume to 50%
            audio.play().then(() => {
              icon.textContent = '⏸';
              button.style.background = 'rgba(99,102,241,0.4)';
              button.style.borderColor = 'rgba(99,102,241,0.6)';
              button.style.boxShadow = '0 0 15px rgba(99,102,241,0.5)';
              window.asiMusicPlaying = true;
            }).catch(e => {
              pathIndex++;
              tryNextPath();
            });
          } else {
            console.error('Failed to play music from all paths');
          }
        };
        tryNextPath();
      });
    }
  } catch (err) {
    console.error('Music toggle error:', err);
  }
};

// Add hover effect to music button
document.addEventListener('DOMContentLoaded', function() {
  const musicButton = document.getElementById('asiMusicToggle');
  if (musicButton) {
    musicButton.addEventListener('mouseenter', function() {
      this.style.transform = 'scale(1.1)';
      this.style.background = 'rgba(99,102,241,0.3)';
    });
    musicButton.addEventListener('mouseleave', function() {
      this.style.transform = 'scale(1)';
      if (!window.asiMusicPlaying) {
        this.style.background = 'rgba(99,102,241,0.2)';
      }
    });
  }
});

// Settings handler - ensure it's attached after DOM is ready
function initSettings() {
  const refreshIntervalSelect = $('refreshInterval');
  if (refreshIntervalSelect) {
    refreshIntervalSelect.onchange = (e) => {
      refreshIntervalMs = parseInt(e.target.value);
      startAutoRefresh();
      console.log(`Refresh interval changed to ${refreshIntervalMs / 1000} seconds`);
    };
    console.log('Settings panel initialized');
    return; // Success, stop retrying
  }
  // Only retry a few times to avoid infinite warnings
  if (!initSettings.retryCount) initSettings.retryCount = 0;
  if (initSettings.retryCount < 3) {
    initSettings.retryCount++;
    setTimeout(initSettings, 500);
  }
}

// Initialize settings when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSettings);
} else {
  initSettings();
}

/* ---------- SIDEBAR NAVIGATION ---------- */
let sidebarCollapsed = false;

function initSidebarNavigation() {
  const sidebar = document.getElementById('appSidebar');
  const collapseBtn = document.getElementById('sidebarCollapseBtn');
  const mainContent = document.getElementById('mainContent');
  const sidebarNavItems = document.querySelectorAll('.sidebar-nav-item');
  const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
  const topNavTabs = document.querySelectorAll('.top-nav-tab');
  
  // Show/hide sidebar based on authentication - Modern implementation
  function updateSidebarVisibility() {
    const isAuthenticated = currentUser !== null && currentUser !== undefined;
    if (sidebar) {
      if (isAuthenticated) {
        sidebar.classList.add('visible');
        if (mainContent) {
          mainContent.classList.add('with-sidebar');
          const savedState = localStorage.getItem('sidebarCollapsed');
          if (savedState === 'true') {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
            mainContent.classList.remove('with-sidebar');
          }
        }
      } else {
        sidebar.classList.remove('visible', 'collapsed');
        if (mainContent) {
          mainContent.classList.remove('with-sidebar', 'sidebar-collapsed');
        }
      }
    }
  }
  
  // Initial visibility check - wait for auth to initialize
  setTimeout(() => {
    updateSidebarVisibility();
  }, 100);
  
  // Also listen to auth state changes via the existing handler
  // The auth.onAuthStateChanged handler will call updateSidebarVisibility
  
  // Sidebar collapse toggle - Modern implementation
  if (collapseBtn) {
    collapseBtn.onclick = () => {
      if (!currentUser) return; // Don't collapse if not authenticated
      sidebarCollapsed = !sidebarCollapsed;
      if (sidebar) {
        sidebar.classList.toggle('collapsed', sidebarCollapsed);
        collapseBtn.textContent = sidebarCollapsed ? '▶' : '◀';
        collapseBtn.style.transform = sidebarCollapsed ? 'rotate(0deg)' : 'rotate(180deg)';
      }
      if (mainContent) {
        if (sidebarCollapsed) {
          mainContent.classList.remove('with-sidebar');
          mainContent.classList.add('sidebar-collapsed');
        } else {
          mainContent.classList.remove('sidebar-collapsed');
          mainContent.classList.add('with-sidebar');
        }
      }
      localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
    };
    
    // Load saved state only if user is authenticated
  if (currentUser) {
      const savedState = localStorage.getItem('sidebarCollapsed');
      if (savedState === 'true') {
        sidebarCollapsed = true;
        if (sidebar) sidebar.classList.add('collapsed');
        if (mainContent) {
          mainContent.classList.add('sidebar-collapsed');
          mainContent.classList.remove('with-sidebar');
        }
        collapseBtn.textContent = '▶';
        collapseBtn.style.transform = 'rotate(0deg)';
      } else {
        collapseBtn.style.transform = 'rotate(180deg)';
      }
    }
  }
  
  // Navigation item click handlers
  function handleNavClick(page) {
    showPage(page);
    // Update active states
    sidebarNavItems.forEach(item => {
      item.classList.toggle('active', item.dataset.page === page);
    });
    bottomNavItems.forEach(item => {
      item.classList.toggle('active', item.dataset.page === page);
    });
    topNavTabs.forEach(tab => {
      tab.classList.toggle('active', tab.dataset.page === page);
    });
  }
  
  sidebarNavItems.forEach(item => {
    item.onclick = () => handleNavClick(item.dataset.page);
  });
  
  bottomNavItems.forEach(item => {
    item.onclick = () => handleNavClick(item.dataset.page);
  });
  
  topNavTabs.forEach(tab => {
    tab.onclick = () => handleNavClick(tab.dataset.page);
  });
  
  // Mobile menu toggle
  const mobileMenuToggle = document.getElementById('mobileMenuToggle');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const mobileSidebar = document.getElementById('sidebar');
  
  if (mobileMenuToggle && mobileSidebar) {
    mobileMenuToggle.onclick = () => {
      mobileSidebar.classList.toggle('active');
      if (sidebarOverlay) sidebarOverlay.classList.toggle('active');
    };
  }
  
  if (sidebarOverlay) {
    sidebarOverlay.onclick = () => {
      if (mobileSidebar) mobileSidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
    };
  }
  
  // Show/hide admin nav based on user role
  updateAdminNavVisibility();
}

// Update showPage to handle new pages - Modern Professional Implementation
const originalShowPage = window.showPage;
window.showPage = function(page) {
  // Check authentication for protected pages
  const protectedPages = ['dashboard', 'portfolio', 'targets', 'alerts', 'profile', 'admin', 'tradingJournal'];
  const isAuthenticated = currentUser !== null && currentUser !== undefined;
  
  if (protectedPages.includes(page) && !isAuthenticated) {
    // Redirect to market if trying to access protected page without auth
    page = 'market';
    console.log('Redirecting to market - authentication required');
  }
  
  // Hide all page containers
  const pageContainers = [
    'dashboardPage', 'marketPage', 'portfolioPage', 'targetsPage', 
    'alertsPage', 'profilePage', 'adminPage', 'tradingJournalPage', 'contentGrid'
  ];
  pageContainers.forEach(pageId => {
    const pageEl = document.getElementById(pageId);
    if (pageEl) pageEl.style.display = 'none';
  });
  
  // Hide hero stats and activity carousel on portfolio, alerts, and trade pages for professional look
  const heroStats = document.getElementById('heroStats');
  const activityCarousel = document.getElementById('activityCarouselWrapper');
  const asiPanel = document.getElementById('asiAlliancePanel');
  
  const hideHeroElements = ['portfolio', 'alerts', 'targets', 'tradingJournal'];
  if (hideHeroElements.includes(page)) {
    if (heroStats) heroStats.style.display = 'none';
    if (activityCarousel) activityCarousel.style.display = 'none';
    if (asiPanel) asiPanel.style.display = 'none';
  }
  
  // Show selected page
  let pageId = page + 'Page';
  if (page === 'market') {
    // Market page uses contentGrid
    const contentGrid = document.getElementById('contentGrid');
    if (contentGrid) {
      contentGrid.style.display = 'grid';
      // Show hero stats and activity carousel only on market page
      if (heroStats) heroStats.style.display = 'block';
      if (activityCarousel) activityCarousel.style.display = 'block';
      if (asiPanel) asiPanel.style.display = 'block';
    }
  } else {
    const pageEl = document.getElementById(pageId);
    if (pageEl) {
      pageEl.style.display = 'block';
      
      // Load page-specific data
      if (page === 'dashboard') {
        updateDashboard();
        // Show hero elements on dashboard too
        if (heroStats) heroStats.style.display = 'block';
        if (activityCarousel) activityCarousel.style.display = 'block';
      } else if (page === 'admin') {
        // Check admin access
        const isAdmin = currentUser && (currentUser.email === 'testireba5@gmail.com' || currentUser.email === 'admin@example.com');
        if (isAdmin) {
          loadAdminData();
        } else {
          showPage('dashboard'); // Redirect non-admins
          return;
        }
      } else if (page === 'portfolio' && isAuthenticated) {
    loadPortfolio();
      } else if (page === 'targets' && isAuthenticated) {
        loadTargets();
        populateTargetTokenSelect();
      } else if (page === 'alerts' && isAuthenticated) {
    loadAlerts();
      } else if (page === 'tradingJournal' && isAuthenticated) {
        loadTrades();
  }
    }
  }
  
  // Call original showPage if it exists (for backward compatibility)
  if (originalShowPage && typeof originalShowPage === 'function' && originalShowPage !== window.showPage) {
    try {
      originalShowPage(page);
    } catch (e) {
      console.log('Original showPage not compatible, using new implementation');
    }
  }
  
  // Update navigation active states
  document.querySelectorAll('.sidebar-nav-item, .bottom-nav-item, .top-nav-tab, .sidebar-item').forEach(item => {
    if (item.dataset.page === page) {
      item.classList.add('active');
    } else {
      item.classList.remove('active');
    }
  });
  
  // Update URL hash
  window.location.hash = page;
};

// Dashboard update function
function updateDashboard() {
  if (!currentUser) return;
  
  // Update portfolio value
  const totalValue = Object.values(portfolioHoldings || {}).reduce((sum, h) => {
    const price = prices[h.tokenId] || 0;
    return sum + (h.amount * price);
  }, 0);
  
  const dashboardPortfolioValue = document.getElementById('dashboardPortfolioValue');
  if (dashboardPortfolioValue) {
    dashboardPortfolioValue.textContent = `$${formatPrice(totalValue)}`;
  }
  
  // Update active targets
  const activeTargets = Object.keys(sellTargets || {}).length;
  const reachedTargets = Object.values(sellTargets || {}).filter(t => {
    const token = cryptoData.find(c => c.id === t.tokenId);
    const currentPrice = token?.current_price || prices[t.tokenId] || 0;
    return currentPrice >= t.targetPrice;
  }).length;
  
  const dashboardActiveTargets = document.getElementById('dashboardActiveTargets');
  const dashboardReachedTargets = document.getElementById('dashboardReachedTargets');
  if (dashboardActiveTargets) dashboardActiveTargets.textContent = activeTargets;
  if (dashboardReachedTargets) dashboardReachedTargets.textContent = reachedTargets;
  
  // Update holdings count
  const holdingsCount = Object.keys(portfolioHoldings || {}).length;
  const dashboardHoldingsCount = document.getElementById('dashboardHoldingsCount');
  if (dashboardHoldingsCount) dashboardHoldingsCount.textContent = holdingsCount;
  
  // Update alerts (placeholder)
  const dashboardActiveAlerts = document.getElementById('dashboardActiveAlerts');
  if (dashboardActiveAlerts) dashboardActiveAlerts.textContent = '0';
}

// Admin panel functions
function loadAdminData() {
  // Load admin data
  renderAdminTokens();
  renderAdminUsers();
  updateAdminAnalytics();
}

function renderAdminTokens() {
  const container = document.getElementById('adminTokensList');
  if (!container) return;
  
  let html = '';
  cryptoData.forEach(token => {
    const change24h = token.price_change_percentage_24h || 0;
    const changeColor = change24h >= 0 ? '#22c55e' : '#ef4444';
    
    html += `
      <div style="display:grid;grid-template-columns:60px 2fr 1fr 1fr 1fr 1fr auto;gap:16px;padding:16px;border-bottom:1px solid var(--border-secondary);align-items:center;">
        <img src="${token.image || ''}" style="width:32px;height:32px;border-radius:50%;" onerror="this.style.display='none'">
        <div>
          <div style="font-weight:600;color:var(--text-primary);">${token.name}</div>
          <div style="font-size:11px;color:var(--text-tertiary);">${token.symbol?.toUpperCase()}</div>
        </div>
        <div style="font-weight:600;color:var(--text-primary);">$${formatPrice(token.current_price)}</div>
        <div style="color:${changeColor};font-weight:600;">${change24h >= 0 ? '+' : ''}${change24h.toFixed(2)}%</div>
        <div style="color:var(--text-secondary);">$${formatPrice(token.market_cap)}</div>
        <div style="padding:4px 8px;background:rgba(34,197,94,0.15);color:#22c55e;border-radius:4px;font-size:11px;font-weight:600;text-align:center;">Active</div>
        <div style="display:flex;gap:8px;">
          <button onclick="adminEditToken('${token.id}')" style="padding:6px 12px;background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:#3b82f6;border-radius:6px;cursor:pointer;font-size:11px;">Edit</button>
          <button onclick="adminDeleteToken('${token.id}')" style="padding:6px 12px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#ef4444;border-radius:6px;cursor:pointer;font-size:11px;">Delete</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html || '<div style="padding:40px;text-align:center;color:var(--text-tertiary);">No tokens found</div>';
}

function renderAdminUsers() {
  // Placeholder - implement user loading from Firebase
  const container = document.getElementById('adminUsersList');
  if (container) {
    container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-tertiary);">User management coming soon</div>';
  }
}

function updateAdminAnalytics() {
  const tokensCount = cryptoData.length;
  const portfoliosCount = 0; // TODO: Get from Firebase
  const targetsCount = Object.keys(sellTargets || {}).length;
  const alertsCount = 0; // TODO: Get from Firebase
  
  const analyticsTokens = document.getElementById('adminAnalyticsTokens');
  const analyticsPortfolios = document.getElementById('adminAnalyticsPortfolios');
  const analyticsTargets = document.getElementById('adminAnalyticsTargets');
  const analyticsAlerts = document.getElementById('adminAnalyticsAlerts');
  
  if (analyticsTokens) analyticsTokens.textContent = tokensCount;
  if (analyticsPortfolios) analyticsPortfolios.textContent = portfoliosCount;
  if (analyticsTargets) analyticsTargets.textContent = targetsCount;
  if (analyticsAlerts) analyticsAlerts.textContent = alertsCount;
}

function updateAdminNavVisibility() {
  const adminNavItem = document.getElementById('adminNavItem');
  const adminBadge = document.getElementById('adminBadge');
  
  // Check if user is admin (using the same check as existing code)
  const isAdmin = currentUser && (currentUser.email === 'testireba5@gmail.com' || currentUser.email === 'admin@example.com');
  
  if (adminNavItem) {
    adminNavItem.style.display = isAdmin ? 'flex' : 'none';
  }
  if (adminBadge) {
    adminBadge.style.display = isAdmin ? 'inline-block' : 'none';
  }
}

// Global function to update sidebar visibility (can be called from anywhere)
window.updateSidebarVisibility = function() {
  const sidebar = document.getElementById('appSidebar');
  const mainContent = document.getElementById('mainContent');
  const isAuthenticated = currentUser !== null && currentUser !== undefined;
  
  if (sidebar) {
    if (isAuthenticated) {
      sidebar.classList.add('visible');
      if (mainContent) {
        mainContent.classList.add('with-sidebar');
        const savedState = localStorage.getItem('sidebarCollapsed');
        if (savedState === 'true') {
          sidebar.classList.add('collapsed');
          mainContent.classList.add('sidebar-collapsed');
          mainContent.classList.remove('with-sidebar');
        }
      }
    } else {
      sidebar.classList.remove('visible', 'collapsed');
      if (mainContent) {
        mainContent.classList.remove('with-sidebar', 'sidebar-collapsed');
      }
    }
  }
  
  
  // Update admin nav visibility
  if (typeof updateAdminNavVisibility === 'function') {
    updateAdminNavVisibility();
  }
};

// Admin tab switching
document.addEventListener('DOMContentLoaded', () => {
  const adminTabBtns = document.querySelectorAll('.admin-tab-btn');
  adminTabBtns.forEach(btn => {
    btn.onclick = () => {
      const tab = btn.dataset.adminTab;
      
      // Update button states
      adminTabBtns.forEach(b => {
        b.classList.toggle('active', b === btn);
        if (b === btn) {
          b.style.background = 'var(--accent-primary)';
          b.style.color = '#fff';
          b.style.border = 'none';
        } else {
          b.style.background = 'transparent';
          b.style.color = 'var(--text-secondary)';
          b.style.border = '1px solid var(--border-primary)';
        }
      });
      
      // Show/hide tab content
      const tabs = ['adminTokensTab', 'adminUsersTab', 'adminSettingsTab', 'adminAnalyticsTab', 'adminAuditTab'];
      tabs.forEach(tabId => {
        const tabEl = document.getElementById(tabId);
        if (tabEl) {
          const expectedTabId = `admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`;
          tabEl.style.display = tabId === expectedTabId ? 'block' : 'none';
        }
      });
    };
  });
});

// Initialize sidebar navigation on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSidebarNavigation);
} else {
  initSidebarNavigation();
}


// Admin panel helper functions
window.adminEditToken = function(tokenId) {
  alert(`Edit token: ${tokenId} - Coming soon!`);
};

window.adminDeleteToken = function(tokenId) {
  if (confirm(`Are you sure you want to delete token ${tokenId}?`)) {
    alert(`Delete token: ${tokenId} - Coming soon!`);
  }
};

window.adminExportUsers = function() {
  alert('Export users - Coming soon!');
};

window.adminSaveApiSettings = function() {
  const apiKey = document.getElementById('adminCoinGeckoKey')?.value;
  if (apiKey) {
    localStorage.setItem('coingecko_api_key', apiKey);
    alert('API settings saved!');
  }
};

window.adminSaveSystemSettings = function() {
  const refreshInterval = document.getElementById('adminRefreshInterval')?.value;
  const cacheDuration = document.getElementById('adminCacheDuration')?.value;
  
  if (refreshInterval) {
    refreshIntervalMs = parseInt(refreshInterval);
    startAutoRefresh();
    localStorage.setItem('refreshIntervalMs', refreshIntervalMs);
  }
  
  if (cacheDuration) {
    CACHE_DURATION = parseInt(cacheDuration);
    localStorage.setItem('cacheDuration', CACHE_DURATION);
  }
  
  alert('System settings saved!');
};

window.adminClearCache = function() {
  if (confirm('Clear all cached data?')) {
    localStorage.removeItem(API_CACHE_KEY);
    alert('Cache cleared!');
  }
};

window.adminRefreshAllData = function() {
  fetchAll(true);
  if (currentUser) {
    loadPortfolio();
    loadAlerts();
  }
  alert('Refreshing all data...');
};

window.adminExportDatabase = function() {
  alert('Export database - Coming soon!');
};

// Initialize page on load - Modern implementation
function initializePage() {
  const hash = window.location.hash.replace('#', '');
  const protectedPages = ['dashboard', 'portfolio', 'targets', 'alerts', 'profile', 'admin'];
  
  // Check if user is authenticated
  const isAuthenticated = currentUser !== null && currentUser !== undefined;
  
  if (hash && hash !== '') {
    // If trying to access protected page without auth, redirect to market
    if (protectedPages.includes(hash) && !isAuthenticated) {
      showPage('market');
      window.location.hash = 'market';
    } else {
      showPage(hash);
    }
  } else {
    // Default page based on auth status
    if (isAuthenticated) {
      showPage('dashboard');
      window.location.hash = 'dashboard';
    } else {
      showPage('market');
      window.location.hash = 'market';
    }
  }
}

// Initialize page after DOM and auth are ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initializePage, 300);
  });
} else {
  setTimeout(initializePage, 300);
}

if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();

// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  // Register immediately, don't wait for load
  navigator.serviceWorker.register('/sw.js', { scope: '/' })
    .then(registration => {
      console.log('✅ Service Worker registered:', registration.scope);
      
      // Check for updates periodically
      setInterval(() => {
        registration.update();
      }, 60000); // Check every minute
      
      // Listen for updates
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        if (newWorker) {
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New version available
              console.log('🔄 New service worker version available');
              if (confirm('ახალი ვერსია ხელმისაწვდომია! განახლება?')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
              }
            }
          });
        }
      });
    })
    .catch(error => {
      console.error('❌ Service Worker registration failed:', error);
    });
  
  // Listen for service worker messages
  navigator.serviceWorker.addEventListener('message', event => {
    if (event.data && event.data.type === 'SW_UPDATED') {
      if (confirm('აპლიკაცია განახლდა! გადატვირთვა?')) {
        window.location.reload();
      }
    }
  });
}

// PWA Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install button (optional - you can add this to your UI)
  const installBtn = document.createElement('button');
  installBtn.textContent = '📱 Install App';
  installBtn.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:12px 20px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);color:#fff;border:none;border-radius:12px;font-weight:600;font-size:13px;cursor:pointer;z-index:999;box-shadow:0 4px 16px rgba(139,92,246,.4);';
  installBtn.onclick = async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('User choice:', outcome);
      deferredPrompt = null;
      installBtn.remove();
    }
  };
  
  // Auto-hide after 10 seconds
  setTimeout(() => {
    if (installBtn.parentNode) {
      installBtn.style.opacity = '0';
      installBtn.style.transition = 'opacity 0.3s';
      setTimeout(() => installBtn.remove(), 300);
    }
  }, 10000);
  
  document.body.appendChild(installBtn);
});

// Handle app installed
window.addEventListener('appinstalled', () => {
  console.log('PWA installed successfully');
  deferredPrompt = null;
});

// Prevent zoom on double tap (iOS)
let lastTouchEnd = 0;
document.addEventListener('touchend', (e) => {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) {
    e.preventDefault();
  }
  lastTouchEnd = now;
}, false);

/* ---------- MOBILE MENU HANDLERS ---------- */
function initMobileMenu() {
  const mobileMenuToggle = document.getElementById('mobileMenuToggle');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const menuIcon = document.getElementById('menuIcon');
  
  if (!mobileMenuToggle || !sidebar || !sidebarOverlay) return;
  
  // Toggle mobile menu
  function toggleMobileMenu() {
    const isOpen = sidebar.classList.contains('active');
    if (isOpen) {
      closeMobileMenu();
    } else {
      openMobileMenu();
    }
  }
  
  function openMobileMenu() {
    sidebar.classList.add('active');
    sidebarOverlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    if (menuIcon) menuIcon.textContent = '✕';
  }
  
  function closeMobileMenu() {
    sidebar.classList.remove('active');
    sidebarOverlay.classList.remove('active');
    document.body.style.overflow = '';
    if (menuIcon) menuIcon.textContent = '☰';
  }
  
  // Menu toggle button
  mobileMenuToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleMobileMenu();
  });
  
  // Close on overlay click
  sidebarOverlay.addEventListener('click', closeMobileMenu);
  
  // Close on sidebar item click (mobile)
  const sidebarItems = sidebar.querySelectorAll('.sidebar-item');
  sidebarItems.forEach(item => {
    item.addEventListener('click', (e) => {
      const page = item.dataset.page;
      if (page) {
        // Navigate to page
        showPage(page);
        // Update active states
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.top-nav-tab').forEach(t => t.classList.remove('active'));
        item.classList.add('active');
        const topNavTab = document.querySelector(`.top-nav-tab[data-page="${page}"]`);
        if (topNavTab) topNavTab.classList.add('active');
        // Close menu after navigation
        setTimeout(closeMobileMenu, 300);
      }
    });
  });
  
  // Close on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && sidebar.classList.contains('active')) {
      closeMobileMenu();
    }
  });
  
  // Handle window resize
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768 && sidebar.classList.contains('active')) {
      closeMobileMenu();
    }
  });
}

// Initialize mobile menu when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMobileMenu);
} else {
  initMobileMenu();
}

// Ensure top nav tabs also work (for desktop)
function initTopNavigation() {
  const topNavTabs = document.querySelectorAll('.top-nav-tab');
  topNavTabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
      const page = tab.dataset.page;
      if (page) {
        showPage(page);
        // Update active states
        topNavTabs.forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        tab.classList.add('active');
        const sidebarItem = document.querySelector(`.sidebar-item[data-page="${page}"]`);
        if (sidebarItem) sidebarItem.classList.add('active');
      }
    });
  });
}

// Initialize top navigation
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initTopNavigation);
} else {
  initTopNavigation();
}

/* ========== PROFESSIONAL UPGRADES ========== */

/* 1. ADVANCED DASHBOARD ANALYTICS */
let portfolioPerformanceChart = null;
let assetAllocationChart = null;
let performanceComparisonChart = null;
let portfolioHistory = [];

function toggleAdvancedAnalytics() {
  const analytics = document.getElementById('advancedAnalytics');
  const btn = document.getElementById('toggleAnalyticsBtn');
  if (analytics && btn) {
    if (analytics.style.display === 'none' || !analytics.style.display) {
      analytics.style.display = 'block';
      btn.textContent = 'Hide Advanced Analytics';
      initAdvancedAnalytics();
    } else {
      analytics.style.display = 'none';
      btn.textContent = 'Show Advanced Analytics';
    }
  }
}

function initAdvancedAnalytics() {
  if (!currentUser) return;
  
  loadPortfolioHistory();
  renderPortfolioPerformanceChart();
  renderAssetAllocationChart();
  renderPerformanceComparisonChart();
  updatePLMetrics();
}

function loadPortfolioHistory() {
  const stored = localStorage.getItem('portfolioHistory');
  if (stored) {
    portfolioHistory = JSON.parse(stored);
  } else {
    portfolioHistory = [{
      date: new Date().toISOString(),
      value: calculatePortfolioValue(),
      holdings: Object.keys(portfolioHoldings || {}).length
    }];
    savePortfolioHistory();
  }
}

function savePortfolioHistory() {
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  portfolioHistory = portfolioHistory.filter(h => new Date(h.date) > thirtyDaysAgo);
  
  const currentValue = calculatePortfolioValue();
  portfolioHistory.push({
    date: new Date().toISOString(),
    value: currentValue,
    holdings: Object.keys(portfolioHoldings || {}).length
  });
  
  localStorage.setItem('portfolioHistory', JSON.stringify(portfolioHistory));
}

function calculatePortfolioValue() {
  if (!portfolioHoldings || !cryptoData) return 0;
  let total = 0;
  Object.values(portfolioHoldings).forEach(holding => {
    const token = cryptoData.find(c => c.id === holding.tokenId);
    if (token) {
      total += holding.amount * token.current_price;
    }
  });
  return total;
}

function renderPortfolioPerformanceChart() {
  const canvas = document.getElementById('portfolioPerformanceChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (portfolioPerformanceChart) {
    portfolioPerformanceChart.destroy();
  }
  
  const labels = portfolioHistory.map(h => new Date(h.date).toLocaleDateString());
  const values = portfolioHistory.map(h => h.value);
  
  portfolioPerformanceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Portfolio Value',
        data: values,
        borderColor: '#6366f1',
        backgroundColor: 'rgba(99, 102, 241, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          ticks: {
            callback: function(value) {
              return '$' + formatPrice(value);
            }
          }
        }
      }
    }
  });
}

function renderAssetAllocationChart() {
  const canvas = document.getElementById('assetAllocationChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (assetAllocationChart) {
    assetAllocationChart.destroy();
  }
  
  if (!portfolioHoldings || !cryptoData) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    return;
  }
  
  const allocation = {};
  Object.values(portfolioHoldings).forEach(holding => {
    const token = cryptoData.find(c => c.id === holding.tokenId);
    if (token) {
      const value = holding.amount * token.current_price;
      allocation[token.symbol] = (allocation[token.symbol] || 0) + value;
    }
  });
  
  const labels = Object.keys(allocation);
  const data = Object.values(allocation);
  const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444'];
  
  assetAllocationChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors.slice(0, labels.length),
        borderWidth: 2,
        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-card') || '#141920'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return context.label + ': $' + formatPrice(context.parsed) + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

function renderPerformanceComparisonChart() {
  const canvas = document.getElementById('performanceComparisonChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (performanceComparisonChart) {
    performanceComparisonChart.destroy();
  }
  
  const btc = cryptoData?.find(c => c.id === 'bitcoin');
  const eth = cryptoData?.find(c => c.id === 'ethereum');
  const portfolioValue = calculatePortfolioValue();
  
  if (!btc || !eth || !portfolioHistory.length) return;
  
  const initialPortfolio = portfolioHistory[0]?.value || portfolioValue;
  const initialBTC = btc.current_price;
  const initialETH = eth.current_price;
  
  const portfolioChange = initialPortfolio > 0 ? ((portfolioValue - initialPortfolio) / initialPortfolio) * 100 : 0;
  const btcChange = btc.price_change_percentage_24h || 0;
  const ethChange = eth.price_change_percentage_24h || 0;
  
  performanceComparisonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Your Portfolio', 'Bitcoin', 'Ethereum'],
      datasets: [{
        label: '24h Change (%)',
        data: [portfolioChange, btcChange, ethChange],
        backgroundColor: [
          portfolioChange >= 0 ? '#22c55e' : '#ef4444',
          btcChange >= 0 ? '#22c55e' : '#ef4444',
          ethChange >= 0 ? '#22c55e' : '#ef4444'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          ticks: {
            callback: function(value) {
              return value.toFixed(2) + '%';
            }
          }
        }
      }
    }
  });
}

function updatePLMetrics() {
  if (!portfolioHoldings || !cryptoData) return;
  
  let totalPL = 0;
  let realizedPL = 0;
  let unrealizedPL = 0;
  let totalCost = 0;
  
  Object.values(portfolioHoldings).forEach(holding => {
    const token = cryptoData.find(c => c.id === holding.tokenId);
    if (token) {
      const currentValue = holding.amount * token.current_price;
      const costBasis = holding.amount * (holding.buyPrice || token.current_price);
      const pl = currentValue - costBasis;
      
      totalCost += costBasis;
      unrealizedPL += pl;
    }
  });
  
  totalPL = realizedPL + unrealizedPL;
  const roi = totalCost > 0 ? (totalPL / totalCost) * 100 : 0;
  
  const totalPLEl = document.getElementById('totalPL');
  const realizedPLEl = document.getElementById('realizedPL');
  const unrealizedPLEl = document.getElementById('unrealizedPL');
  const roiEl = document.getElementById('roiPercentage');
  
  if (totalPLEl) {
    totalPLEl.textContent = '$' + formatPrice(totalPL);
    totalPLEl.style.color = totalPL >= 0 ? '#22c55e' : '#ef4444';
  }
  
  if (realizedPLEl) {
    realizedPLEl.textContent = '$' + formatPrice(realizedPL);
    realizedPLEl.style.color = realizedPL >= 0 ? '#22c55e' : '#ef4444';
  }
  
  if (unrealizedPLEl) {
    unrealizedPLEl.textContent = '$' + formatPrice(unrealizedPL);
    unrealizedPLEl.style.color = unrealizedPL >= 0 ? '#22c55e' : '#ef4444';
  }
  
  if (roiEl) {
    roiEl.textContent = roi.toFixed(2) + '%';
    roiEl.style.color = roi >= 0 ? '#22c55e' : '#ef4444';
  }
}

// Update analytics when portfolio changes
const originalLoadPortfolio = window.loadPortfolio;
if (originalLoadPortfolio) {
  window.loadPortfolio = function() {
    originalLoadPortfolio.apply(this, arguments);
    if (document.getElementById('advancedAnalytics')?.style.display === 'block') {
      setTimeout(initAdvancedAnalytics, 100);
    }
    savePortfolioHistory();
  };
}

/* 4. NOTIFICATION SYSTEM */
let notifications = [];
let notificationPermission = 'default';

function requestNotificationPermission() {
  if ('Notification' in window) {
    Notification.requestPermission().then(permission => {
      notificationPermission = permission;
      if (permission === 'granted') {
        logAuditEvent('system', 'notification_permission_granted', {});
      }
    });
  }
}

if ('Notification' in window) {
  notificationPermission = Notification.permission;
  if (notificationPermission === 'default') {
    requestNotificationPermission();
  }
}

function showNotification(title, message, type = 'info', data = {}) {
  const notification = {
    id: Date.now().toString(),
    title,
    message,
    type,
    timestamp: new Date().toISOString(),
    read: false,
    data
  };
  
  notifications.unshift(notification);
  if (notifications.length > 100) notifications = notifications.slice(0, 100);
  saveNotifications();
  updateNotificationUI();
  
  if (notificationPermission === 'granted') {
    new Notification(title, {
      body: message,
      icon: '/icon-192.png',
      badge: '/icon-192.png',
      tag: notification.id
    });
  }
  
  logAuditEvent('user', 'notification_created', { title, type });
}

function saveNotifications() {
  localStorage.setItem('notifications', JSON.stringify(notifications));
}

function loadNotifications() {
  const stored = localStorage.getItem('notifications');
  if (stored) {
    notifications = JSON.parse(stored);
  }
  updateNotificationUI();
}

function updateNotificationUI() {
  const badge = document.getElementById('notificationBadge');
  const unreadCount = notifications.filter(n => !n.read).length;
  
  if (badge) {
    if (unreadCount > 0) {
      badge.style.display = 'flex';
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
    } else {
      badge.style.display = 'none';
    }
  }
  
  renderNotificationList();
}

function renderNotificationList() {
  const list = document.getElementById('notificationList');
  if (!list) return;
  
  if (notifications.length === 0) {
    list.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-tertiary);">No notifications</div>';
    return;
  }
  
  list.innerHTML = notifications.map(notif => `
    <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="markNotificationRead('${notif.id}')">
      <div class="notification-item-title">${notif.title}</div>
      <div class="notification-item-message">${notif.message}</div>
      <div class="notification-item-time">${new Date(notif.timestamp).toLocaleString()}</div>
    </div>
  `).join('');
}

function markNotificationRead(id) {
  const notif = notifications.find(n => n.id === id);
  if (notif) {
    notif.read = true;
    saveNotifications();
    updateNotificationUI();
  }
}

function clearAllNotifications() {
  notifications = [];
  saveNotifications();
  updateNotificationUI();
}

function closeNotificationPanel() {
  const panel = document.getElementById('notificationPanel');
  if (panel) panel.style.display = 'none';
}

document.getElementById('notificationToggle')?.addEventListener('click', function() {
  const panel = document.getElementById('notificationPanel');
  if (panel) {
    if (panel.style.display === 'none' || !panel.style.display) {
      panel.style.display = 'flex';
      loadNotifications();
    } else {
      panel.style.display = 'none';
    }
  }
});

document.addEventListener('click', function(e) {
  const panel = document.getElementById('notificationPanel');
  const toggle = document.getElementById('notificationToggle');
  if (panel && toggle && !panel.contains(e.target) && !toggle.contains(e.target)) {
    panel.style.display = 'none';
  }
});

/* 5. DARK/LIGHT THEME WITH AUTO-DETECTION */
function initTheme() {
  const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const savedTheme = localStorage.getItem('theme');
  let theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
  
  document.documentElement.setAttribute('data-theme', theme);
  updateThemeIcon(theme);
  
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      const newTheme = e.matches ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      updateThemeIcon(newTheme);
    }
  });
}

function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  updateThemeIcon(newTheme);
  
  showNotification('Theme Changed', `Switched to ${newTheme} theme`, 'info');
  logAuditEvent('user', 'theme_changed', { theme: newTheme });
}

function updateThemeIcon(theme) {
  const icon = document.getElementById('themeIcon');
  if (icon) {
    icon.textContent = theme === 'dark' ? '🌙' : '☀️';
  }
}

document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);
initTheme();

/* 15. AUDIT LOGGING */
let auditLogs = [];

function logAuditEvent(userType, action, details = {}) {
  const log = {
    id: Date.now().toString(),
    timestamp: new Date().toISOString(),
    userType: userType,
    userId: currentUser?.uid || 'anonymous',
    userEmail: currentUser?.email || 'anonymous',
    action: action,
    details: details,
    ip: 'N/A',
    userAgent: navigator.userAgent
  };
  
  auditLogs.unshift(log);
  if (auditLogs.length > 1000) {
    auditLogs = auditLogs.slice(0, 1000);
  }
  
  saveAuditLogs();
  
  if (userType === 'admin' && currentUser) {
    sendAuditLogToServer(log);
  }
}

function saveAuditLogs() {
  localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
}

function loadAuditLogs() {
  const stored = localStorage.getItem('auditLogs');
  if (stored) {
    auditLogs = JSON.parse(stored);
  }
  renderAuditLogs();
}

function renderAuditLogs(filter = 'all') {
  const list = document.getElementById('auditLogList');
  if (!list) return;
  
  let filteredLogs = auditLogs;
  if (filter !== 'all') {
    filteredLogs = auditLogs.filter(log => {
      if (filter === 'user') return log.userType === 'user';
      if (filter === 'admin') return log.userType === 'admin';
      if (filter === 'security') return log.action.includes('security') || log.action.includes('auth');
      return true;
    });
  }
  
  if (filteredLogs.length === 0) {
    list.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-tertiary);">No audit logs</div>';
    return;
  }
  
  list.innerHTML = filteredLogs.map(log => {
    const typeColor = log.userType === 'admin' ? '#ef4444' : log.userType === 'system' ? '#3b82f6' : '#6366f1';
    return `
      <div style="padding:12px;margin-bottom:8px;background:var(--bg-tertiary);border:1px solid var(--border-secondary);border-radius:8px;border-left:3px solid ${typeColor};">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
          <div>
            <div style="font-size:13px;font-weight:600;color:var(--text-primary);">${log.action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
            <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px;">${log.userEmail}</div>
          </div>
          <div style="font-size:11px;color:var(--text-tertiary);">${new Date(log.timestamp).toLocaleString()}</div>
        </div>
        <div style="font-size:11px;color:var(--text-secondary);">
          <span style="padding:2px 6px;background:${typeColor}20;color:${typeColor};border-radius:4px;font-weight:600;">${log.userType}</span>
          ${Object.keys(log.details).length > 0 ? '<div style="margin-top:4px;">' + JSON.stringify(log.details) + '</div>' : ''}
        </div>
      </div>
    `;
  }).join('');
}

function exportAuditLog() {
  const csv = [
    ['Timestamp', 'User Type', 'User Email', 'Action', 'Details'].join(','),
    ...auditLogs.map(log => [
      log.timestamp,
      log.userType,
      log.userEmail,
      log.action,
      JSON.stringify(log.details)
    ].join(','))
  ].join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `audit-log-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  logAuditEvent('admin', 'audit_log_exported', { count: auditLogs.length });
}

function sendAuditLogToServer(log) {
  try {
    const db = firebase.database();
    db.ref('auditLogs').push(log).catch(err => {
      console.error('Failed to save audit log:', err);
    });
  } catch (e) {
    console.error('Audit log save error:', e);
  }
}

document.getElementById('auditFilter')?.addEventListener('change', function(e) {
  renderAuditLogs(e.target.value);
});

document.querySelectorAll('.admin-tab-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    if (this.dataset.adminTab === 'audit') {
      loadAuditLogs();
    }
  });
});

logAuditEvent('system', 'page_loaded', { page: window.location.hash || 'market' });

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    logAuditEvent('user', 'user_logged_in', { email: user.email });
  } else {
    logAuditEvent('user', 'user_logged_out', {});
  }
});

/* ========== DASHBOARD STATS UPDATE FUNCTION ========== */
let alerts = {}; // Global alerts storage

function updateDashboardStats(holdings, targets, alertsData) {
  if (!holdings) holdings = {};
  if (!targets) targets = {};
  if (!alertsData) alertsData = {};
  alerts = alertsData; // Store globally
  
  // Calculate portfolio value
  let totalValue = 0;
  let totalCost = 0;
  let holdingsCount = 0;
  let bestPerformer = null;
  let bestROI = -Infinity;
  
  Object.entries(holdings).forEach(([id, h]) => {
    if (!h || !h.tokenId) return;
    const token = cryptoData?.find(t => t.id === h.tokenId);
    const price = token?.current_price || prices[h.tokenId] || 0;
    const value = h.amount * price;
    const cost = h.amount * (h.buyPrice || price);
    totalValue += value;
    totalCost += cost;
    holdingsCount++;
    
    // Find best performer
    if (cost > 0) {
      const roi = ((value - cost) / cost) * 100;
      if (roi > bestROI) {
        bestROI = roi;
        bestPerformer = {
          name: token?.name || h.tokenId,
          symbol: token?.symbol?.toUpperCase() || h.tokenId.toUpperCase(),
          roi: roi
        };
      }
    }
  });
  
  const pl = totalValue - totalCost;
  const roi = totalCost > 0 ? ((totalValue / totalCost - 1) * 100) : 0;
  
  // Update Portfolio Value
  const portfolioValueEl = document.getElementById('dashboardPortfolioValue');
  if (portfolioValueEl) {
    portfolioValueEl.textContent = '$' + formatPrice(totalValue);
  }
  
  // Update Portfolio Change
  const portfolioChangeEl = document.getElementById('dashboardPortfolioChange');
  if (portfolioChangeEl) {
    const prevValue = parseFloat(localStorage.getItem('prevPortfolioValue') || '0');
    if (prevValue > 0 && totalValue > 0) {
      const change = ((totalValue - prevValue) / prevValue) * 100;
      const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;
      portfolioChangeEl.innerHTML = `<span style="color:${change >= 0 ? '#22c55e' : '#ef4444'};font-weight:600;">${changeText}</span> <span style="opacity:0.7;">vs last update</span>`;
    } else {
      portfolioChangeEl.innerHTML = '<span style="opacity:0.7;">--</span>';
    }
    localStorage.setItem('prevPortfolioValue', totalValue.toString());
  }
  
  // Update Holdings Count
  const holdingsCountEl = document.getElementById('dashboardHoldingsCount');
  if (holdingsCountEl) {
    holdingsCountEl.textContent = holdingsCount;
  }
  
  const holdingsInfoEl = document.getElementById('dashboardHoldingsInfo');
  if (holdingsInfoEl) {
    holdingsInfoEl.textContent = holdingsCount === 1 ? 'Token tracked' : 'Tokens tracked';
  }
  
  // Update Targets
  const targetsArray = Object.values(targets || {});
  const activeTargetsEl = document.getElementById('dashboardActiveTargets');
  if (activeTargetsEl) {
    activeTargetsEl.textContent = targetsArray.length;
  }
  
  // Count reached targets
  let reachedCount = 0;
  targetsArray.forEach(target => {
    const token = cryptoData?.find(t => t.id === target.tokenId);
    const currentPrice = token?.current_price || prices[target.tokenId] || 0;
    if (currentPrice >= target.targetPrice) {
      reachedCount++;
    }
  });
  
  const reachedTargetsEl = document.getElementById('dashboardReachedTargets');
  if (reachedTargetsEl) {
    reachedTargetsEl.textContent = reachedCount;
  }
  
  // Update Alerts
  const alertsArray = Object.values(alertsData || {});
  const activeAlertsEl = document.getElementById('dashboardActiveAlerts');
  if (activeAlertsEl) {
    activeAlertsEl.textContent = alertsArray.length;
  }
  
  // Count triggered alerts
  let triggeredCount = 0;
  alertsArray.forEach(alert => {
    const token = cryptoData?.find(t => t.id === alert.tokenId);
    const currentPrice = token?.current_price || prices[alert.tokenId] || 0;
    if (alert.condition === 'above' && currentPrice >= alert.price) {
      triggeredCount++;
    } else if (alert.condition === 'below' && currentPrice <= alert.price) {
      triggeredCount++;
    }
  });
  
  const triggeredAlertsEl = document.getElementById('dashboardTriggeredAlerts');
  if (triggeredAlertsEl) {
    triggeredAlertsEl.textContent = triggeredCount;
  }
  
  // Update Total P&L
  const totalPLEl = document.getElementById('dashboardTotalPL');
  if (totalPLEl) {
    totalPLEl.textContent = (pl >= 0 ? '+' : '') + '$' + formatPrice(pl);
    totalPLEl.style.color = pl >= 0 ? '#22c55e' : '#ef4444';
  }
  
  // Update ROI
  const roiEl = document.getElementById('dashboardROI');
  if (roiEl) {
    roiEl.textContent = (roi >= 0 ? '+' : '') + roi.toFixed(2) + '%';
    roiEl.style.color = roi >= 0 ? '#22c55e' : '#ef4444';
  }
  
  // Update Best Performer
  const bestPerformerEl = document.getElementById('dashboardBestPerformer');
  const bestPerformerROIEl = document.getElementById('dashboardBestPerformerROI');
  if (bestPerformerEl && bestPerformer) {
    bestPerformerEl.textContent = `${bestPerformer.name} (${bestPerformer.symbol})`;
    if (bestPerformerROIEl) {
      bestPerformerROIEl.textContent = `${bestPerformer.roi >= 0 ? '+' : ''}${bestPerformer.roi.toFixed(2)}% ROI`;
    }
  } else if (bestPerformerEl) {
    bestPerformerEl.textContent = '--';
    if (bestPerformerROIEl) {
      bestPerformerROIEl.textContent = 'No holdings yet';
    }
  }
  
  // Update Top Holdings Preview
  updateTopHoldingsPreview(holdings);
}

function updateTopHoldingsPreview(holdings) {
  const container = document.getElementById('dashboardTopHoldings');
  if (!container) return;
  
  if (!holdings || Object.keys(holdings).length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--text-tertiary);">
        <div style="font-size:32px;margin-bottom:12px;">💼</div>
        <div style="font-size:14px;">No holdings yet</div>
      </div>
    `;
    return;
  }
  
  // Calculate performance for each holding
  const holdingsWithPerformance = Object.entries(holdings).map(([id, h]) => {
    if (!h || !h.tokenId) return null;
    const token = cryptoData?.find(t => t.id === h.tokenId);
    const price = token?.current_price || prices[h.tokenId] || 0;
    const value = h.amount * price;
    const cost = h.amount * (h.buyPrice || price);
    const pl = value - cost;
    const roi = cost > 0 ? (pl / cost * 100) : 0;
    
    return {
      id,
      holding: h,
      token,
      value,
      pl,
      roi
    };
  }).filter(h => h !== null);
  
  // Sort by value (descending) and take top 5
  holdingsWithPerformance.sort((a, b) => b.value - a.value);
  const topHoldings = holdingsWithPerformance.slice(0, 5);
  
  if (topHoldings.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--text-tertiary);">
        <div style="font-size:32px;margin-bottom:12px;">💼</div>
        <div style="font-size:14px;">No holdings yet</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = topHoldings.map((item, idx) => {
    const token = item.token || { name: item.holding.tokenId, symbol: item.holding.tokenId.toUpperCase(), image: '' };
    const plColor = item.pl >= 0 ? '#22c55e' : '#ef4444';
    const roiColor = item.roi >= 0 ? '#22c55e' : '#ef4444';
    
    return `
      <div style="display:flex;align-items:center;gap:16px;padding:16px;background:var(--bg-tertiary);border:1px solid var(--border-secondary);border-radius:12px;margin-bottom:12px;transition:all 0.2s;cursor:pointer;" onclick="showPage('portfolio')" onmouseenter="this.style.background='var(--bg-card-hover)';this.style.borderColor='var(--border-primary)';this.style.transform='translateX(4px)'" onmouseleave="this.style.background='var(--bg-tertiary)';this.style.borderColor='var(--border-secondary)';this.style.transform='translateX(0)'">
        <div style="width:40px;height:40px;border-radius:50%;background:rgba(99,102,241,0.15);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">
          ${token.image ? `<img src="${token.image}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.parentElement.innerHTML='💰'">` : '💰'}
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;color:var(--text-primary);font-size:15px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${token.name || item.holding.tokenId}</div>
          <div style="font-size:12px;color:var(--text-tertiary);">${token.symbol?.toUpperCase() || item.holding.tokenId.toUpperCase()}</div>
        </div>
        <div style="text-align:right;flex-shrink:0;">
          <div style="font-weight:600;color:var(--text-primary);font-size:15px;margin-bottom:4px;">$${formatPrice(item.value)}</div>
          <div style="font-size:12px;color:${roiColor};font-weight:600;">${item.roi >= 0 ? '+' : ''}${item.roi.toFixed(2)}%</div>
        </div>
      </div>
    `;
  }).join('');
}

function refreshDashboard() {
  if (currentUser) {
    loadPortfolio();
    loadTargets();
    loadAlerts();
    fetchAll(true);
    showNotification('Dashboard Refreshed', 'All data has been updated', 'success');
  } else {
    fetchAll(true);
  }
}

// Update dashboard when page is shown (check if already wrapped)
if (window.showPage && !window._dashboardWrapped) {
  const originalShowPage = window.showPage;
  window._dashboardWrapped = true;
  window.showPage = function(page) {
    originalShowPage.apply(this, arguments);
    if (page === 'dashboard' && currentUser) {
      setTimeout(() => {
        updateDashboardStats(portfolioHoldings || {}, sellTargets || {}, alerts || {});
      }, 500);
    }
  };
}

// Update alerts when they're loaded
const originalRenderAlerts = window.renderAlerts;
if (originalRenderAlerts) {
  window.renderAlerts = function(alertsData) {
    originalRenderAlerts.apply(this, arguments);
    alerts = alertsData || {};
    if (currentUser) {
      updateDashboardStats(portfolioHoldings || {}, sellTargets || {}, alerts);
    }
  };
} else {
  // If renderAlerts doesn't exist, hook into loadAlerts
  const originalLoadAlerts = window.loadAlerts;
  if (originalLoadAlerts) {
    window.loadAlerts = async function() {
      await originalLoadAlerts.apply(this, arguments);
      // Alerts will be updated when renderAlerts is called
    };
  }
}

/* ──── TRADING JOURNAL CALCULATOR ──── */
let trades = [];
let nextTradeNumber = 1;

// Initialize date field to today
if (document.getElementById('tradeDate')) {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('tradeDate').value = today;
}

// Load trades from Firebase
async function loadTrades() {
  if (!currentUser) {
    trades = [];
    nextTradeNumber = 1;
    updateMetrics();
    renderTradesTable();
    return;
  }

  try {
    const userId = currentUser.uid;
    const db = firebase.database();
    const snapshot = await db.ref(`users/${userId}/trades`).once('value');
    const tradesData = snapshot.val() || {};
    
    // Convert to array and sort by tradeNumber
    trades = Object.values(tradesData).sort((a, b) => a.tradeNumber - b.tradeNumber);
    
    // Set next trade number
    if (trades.length > 0) {
      nextTradeNumber = Math.max(...trades.map(t => t.tradeNumber)) + 1;
    } else {
      nextTradeNumber = 1;
    }
    
    updateMetrics();
    renderTradesTable();
  } catch (error) {
    console.error('Error loading trades:', error);
    trades = [];
    nextTradeNumber = 1;
    updateMetrics();
    renderTradesTable();
  }
}

// Save trades to Firebase
async function saveTrades() {
  if (!currentUser) return;

  try {
    const userId = currentUser.uid;
    const db = firebase.database();
    const tradesObj = {};
    
    trades.forEach(trade => {
      tradesObj[trade.id] = trade;
    });
    
    await db.ref(`users/${userId}/trades`).set(tradesObj);
  } catch (error) {
    console.error('Error saving trades:', error);
    alert('Error saving trades: ' + error.message);
  }
}

// Calculate percentage from entry to target price
function calculatePercentage(entry, target) {
  if (!entry || !target || entry === 0) return null;
  return ((target - entry) / entry) * 100;
}

// Add trade
async function addTrade(token, entryPrice, exitPrice, netPL, date, leverage, stopLoss, takeProfit) {
  const entry = parseFloat(entryPrice);
  const stopLossPrice = stopLoss ? parseFloat(stopLoss) : null;
  const takeProfitPrice = takeProfit ? parseFloat(takeProfit) : null;
  
  const stopLossPercent = stopLossPrice ? calculatePercentage(entry, stopLossPrice) : null;
  const takeProfitPercent = takeProfitPrice ? calculatePercentage(entry, takeProfitPrice) : null;
  
  const trade = {
    id: Date.now().toString(),
    tradeNumber: nextTradeNumber++,
    token: token || '',
    entryPrice: entry,
    exitPrice: parseFloat(exitPrice),
    leverage: leverage ? parseFloat(leverage) : null,
    stopLoss: stopLossPrice,
    stopLossPercent: stopLossPercent,
    takeProfit: takeProfitPrice,
    takeProfitPercent: takeProfitPercent,
    net: parseFloat(netPL),
    date: date || new Date().toISOString().split('T')[0]
  };
  
  trades.push(trade);
  await saveTrades();
  updateMetrics();
  renderTradesTable();
}

// Delete trade
async function deleteTrade(tradeId) {
  const index = trades.findIndex(t => t.id === tradeId);
  if (index === -1) return;
  
  trades.splice(index, 1);
  
  // Renumber trades
  trades.sort((a, b) => a.tradeNumber - b.tradeNumber);
  trades.forEach((trade, idx) => {
    trade.tradeNumber = idx + 1;
  });
  nextTradeNumber = trades.length + 1;
  
  await saveTrades();
  updateMetrics();
  renderTradesTable();
}

// Clear all trades
async function clearAllTrades() {
  if (!confirm('დარწმუნებული ხართ, რომ გსურთ ყველა ტრანზაქციის წაშლა? ეს მოქმედება ვერ გაუქმდება.')) {
    return;
  }
  
  trades = [];
  nextTradeNumber = 1;
  await saveTrades();
  updateMetrics();
  renderTradesTable();
}

// Calculate and update metrics
function updateMetrics() {
  const totalTrades = trades.length;
  const winners = trades.filter(t => t.net > 0).length;
  const losers = trades.filter(t => t.net < 0).length;
  
  const totalProfits = trades.filter(t => t.net > 0).reduce((sum, t) => sum + t.net, 0);
  const totalLosses = Math.abs(trades.filter(t => t.net < 0).reduce((sum, t) => sum + t.net, 0));
  
  const oddsWinning = totalTrades > 0 ? (winners / totalTrades) * 100 : 0;
  const oddsLosing = totalTrades > 0 ? (losers / totalTrades) * 100 : 0;
  
  const avgWin = winners > 0 ? totalProfits / winners : 0;
  const avgLoss = losers > 0 ? totalLosses / losers : 0;
  
  const w = avgWin * (oddsWinning / 100);
  const l = avgLoss * (oddsLosing / 100);
  const expectancy = w - l; // L is already positive, so we subtract
  
  // Calculate total capital (sum of all entry prices) for percentage calculations
  const totalCapital = trades.reduce((sum, t) => sum + (t.entryPrice || 0), 0);
  const avgEntryPrice = totalTrades > 0 ? totalCapital / totalTrades : 0;
  const totalAbsoluteValue = totalProfits + totalLosses;
  
  // Calculate Net P&L (Total Profits - Total Losses)
  const netPL = totalProfits - totalLosses;
  
  // Calculate percentages
  const totalProfitsPercent = totalCapital > 0 ? (totalProfits / totalCapital) * 100 : 0;
  const totalLossesPercent = totalCapital > 0 ? (totalLosses / totalCapital) * 100 : 0;
  const netPLPercent = totalCapital > 0 ? (netPL / totalCapital) * 100 : 0;
  const avgWinPercent = avgEntryPrice > 0 ? (avgWin / avgEntryPrice) * 100 : 0;
  const avgLossPercent = avgEntryPrice > 0 ? (avgLoss / avgEntryPrice) * 100 : 0;
  const wPercent = avgEntryPrice > 0 ? (w / avgEntryPrice) * 100 : 0;
  const lPercent = avgEntryPrice > 0 ? (l / avgEntryPrice) * 100 : 0;
  const expectancyPercent = avgEntryPrice > 0 ? (expectancy / avgEntryPrice) * 100 : 0;
  
  // Update UI - Dollar values
  document.getElementById('metricTotalTrades').textContent = totalTrades;
  document.getElementById('metricWinners').textContent = winners;
  document.getElementById('metricLosers').textContent = losers;
  
  // Update Total Profits (dollar and percentage)
  const totalProfitsEl = document.getElementById('metricTotalProfits');
  if (totalProfitsEl) {
    const firstChild = totalProfitsEl.querySelector('div:first-child');
    const secondChild = document.getElementById('metricTotalProfitsPercent');
    if (firstChild) {
      firstChild.textContent = '$' + totalProfits.toFixed(2);
    }
    if (secondChild) {
      secondChild.textContent = (totalProfitsPercent >= 0 ? '+' : '') + totalProfitsPercent.toFixed(2) + '%';
    }
  }
  
  // Update Total Losses (dollar and percentage)
  const totalLossesEl = document.getElementById('metricTotalLosses');
  if (totalLossesEl) {
    const firstChild = totalLossesEl.querySelector('div:first-child');
    const secondChild = document.getElementById('metricTotalLossesPercent');
    if (firstChild) {
      firstChild.textContent = '$' + totalLosses.toFixed(2);
    }
    if (secondChild) {
      secondChild.textContent = (totalLossesPercent >= 0 ? '+' : '') + totalLossesPercent.toFixed(2) + '%';
    }
  }
  
  // Update Net P&L (dollar and percentage)
  const netPLEl = document.getElementById('metricNetPL');
  if (netPLEl) {
    const firstChild = netPLEl.querySelector('div:first-child');
    const secondChild = document.getElementById('metricNetPLPercent');
    const netPLColor = netPL >= 0 ? 'var(--success)' : 'var(--error)';
    if (firstChild) {
      firstChild.textContent = (netPL >= 0 ? '+' : '') + '$' + Math.abs(netPL).toFixed(2);
      firstChild.style.color = netPLColor;
    }
    if (secondChild) {
      secondChild.textContent = (netPLPercent >= 0 ? '+' : '') + netPLPercent.toFixed(2) + '%';
      secondChild.style.color = netPLColor;
    }
    netPLEl.style.color = netPLColor;
  }
  
  document.getElementById('metricOddsWinning').textContent = oddsWinning.toFixed(2) + '%';
  document.getElementById('metricOddsLosing').textContent = oddsLosing.toFixed(2) + '%';
  
  // Update Average Win (dollar and percentage)
  const avgWinEl = document.getElementById('metricAvgWin');
  if (avgWinEl) {
    const firstChild = avgWinEl.querySelector('div:first-child');
    const secondChild = document.getElementById('metricAvgWinPercent');
    if (firstChild) {
      firstChild.textContent = '$' + avgWin.toFixed(2);
    }
    if (secondChild) {
      secondChild.textContent = (avgWinPercent >= 0 ? '+' : '') + avgWinPercent.toFixed(2) + '%';
    }
  }
  
  // Update Average Loss (dollar and percentage)
  const avgLossEl = document.getElementById('metricAvgLoss');
  if (avgLossEl) {
    const firstChild = avgLossEl.querySelector('div:first-child');
    const secondChild = document.getElementById('metricAvgLossPercent');
    if (firstChild) {
      firstChild.textContent = '$' + avgLoss.toFixed(2);
    }
    if (secondChild) {
      secondChild.textContent = (avgLossPercent >= 0 ? '+' : '') + avgLossPercent.toFixed(2) + '%';
    }
  }
  
  // Update W (dollar and percentage)
  const wEl = document.getElementById('metricW');
  if (wEl) {
    const firstChild = wEl.querySelector('div:first-child');
    const secondChild = document.getElementById('metricWPercent');
    if (firstChild) {
      firstChild.textContent = '$' + w.toFixed(2);
    }
    if (secondChild) {
      secondChild.textContent = (wPercent >= 0 ? '+' : '') + wPercent.toFixed(2) + '%';
    }
  }
  
  // Update L (dollar and percentage)
  const lEl = document.getElementById('metricL');
  if (lEl) {
    const firstChild = lEl.querySelector('div:first-child');
    const secondChild = document.getElementById('metricLPercent');
    if (firstChild) {
      firstChild.textContent = '$' + l.toFixed(2);
    }
    if (secondChild) {
      secondChild.textContent = (lPercent >= 0 ? '+' : '') + lPercent.toFixed(2) + '%';
    }
  }
  
  // Update Expectancy (dollar and percentage)
  const expectancyEl = document.getElementById('metricExpectancy');
  if (expectancyEl) {
    const firstChild = expectancyEl.querySelector('div:first-child');
    const secondChild = document.getElementById('metricExpectancyPercent');
    if (firstChild) {
      firstChild.textContent = '$' + expectancy.toFixed(2);
    }
    if (secondChild) {
      secondChild.textContent = (expectancyPercent >= 0 ? '+' : '') + expectancyPercent.toFixed(2) + '%';
    }
  }
}

// Render trades table
function renderTradesTable() {
  const tbody = document.getElementById('tradesTableBody');
  if (!tbody) return;
  
  if (trades.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="padding:40px;text-align:center;color:var(--text-tertiary);font-size:14px;">ჯერ არ არის ტრანზაქციები</td></tr>';
    return;
  }
  
  tbody.innerHTML = trades.map(trade => {
    const isPositive = trade.net > 0;
    const profit = isPositive ? trade.net.toFixed(2) : '';
    const loss = !isPositive ? '(' + Math.abs(trade.net).toFixed(2) + ')' : '';
    
    const leverageDisplay = trade.leverage ? trade.leverage + 'x' : '-';
    
    return `
      <tr style="border-bottom:1px solid var(--border-secondary);background:var(--bg-card);transition:background 0.2s;" onmouseenter="this.style.background='var(--bg-tertiary)'" onmouseleave="this.style.background='var(--bg-card)'">
        <td style="padding:12px;text-align:center;font-weight:600;color:var(--text-primary);border-right:1px solid var(--border-secondary);">${trade.tradeNumber}</td>
        <td style="padding:12px;text-align:center;color:var(--text-primary);font-weight:600;border-right:1px solid var(--border-secondary);">${trade.token || '-'}</td>
        <td style="padding:12px;text-align:center;color:var(--text-primary);border-right:1px solid var(--border-secondary);">${trade.entryPrice.toFixed(2)}</td>
        <td style="padding:12px;text-align:center;color:var(--text-primary);border-right:1px solid var(--border-secondary);">${trade.exitPrice.toFixed(2)}</td>
        <td style="padding:12px;text-align:center;color:var(--text-primary);font-weight:600;border-right:1px solid var(--border-secondary);">${leverageDisplay}</td>
        <td style="padding:12px;text-align:center;font-weight:600;color:${isPositive ? 'var(--success)' : 'var(--error)'};border-right:1px solid var(--border-secondary);">${trade.net >= 0 ? '+' : ''}${trade.net.toFixed(2)}</td>
        <td style="padding:12px;text-align:center;color:var(--success);font-weight:600;border-right:1px solid var(--border-secondary);">${profit}</td>
        <td style="padding:12px;text-align:center;color:var(--error);font-weight:600;border-right:1px solid var(--border-secondary);">${loss}</td>
        <td style="padding:12px;text-align:center;color:var(--text-secondary);border-right:1px solid var(--border-secondary);">${trade.date}</td>
        <td style="padding:12px;text-align:center;">
          <button onclick="deleteTrade('${trade.id}')" style="padding:6px 12px;background:var(--error);border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s;font-family:'Arial',sans-serif;" onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">წაშლა</button>
        </td>
      </tr>
    `;
  }).join('');
}

// Form submission handler
if (document.getElementById('tradingJournalForm')) {
  document.getElementById('tradingJournalForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const token = document.getElementById('tradeToken').value.trim();
    const entryPrice = document.getElementById('entryPrice').value;
    const exitPrice = document.getElementById('exitPrice').value;
    const netPL = document.getElementById('netPL').value;
    const date = document.getElementById('tradeDate').value || new Date().toISOString().split('T')[0];
    const leverage = document.getElementById('leverage').value;
    const stopLoss = document.getElementById('stopLoss').value;
    const takeProfit = document.getElementById('takeProfit').value;
    
    if (!entryPrice || !exitPrice || !netPL) {
      alert('გთხოვთ შეავსოთ ყველა სავალდებულო ველი');
      return;
    }
    
    await addTrade(token, entryPrice, exitPrice, netPL, date, leverage, stopLoss, takeProfit);
    
    // Clear form
    document.getElementById('tradingJournalForm').reset();
    document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
  });
}

// Clear all trades button
if (document.getElementById('clearAllTradesBtn')) {
  document.getElementById('clearAllTradesBtn').addEventListener('click', clearAllTrades);
}

/* ──── CSV IMPORT FUNCTIONALITY ──── */
let csvPreviewData = [];

// Parse CSV file
function parseCSV(text) {
  const lines = text.split('\n').filter(line => line.trim());
  if (lines.length === 0) return [];
  
  // Detect delimiter (comma, semicolon, or tab)
  const firstLine = lines[0];
  let delimiter = ',';
  if (firstLine.includes(';') && firstLine.split(';').length > firstLine.split(',').length) {
    delimiter = ';';
  } else if (firstLine.includes('\t') && firstLine.split('\t').length > firstLine.split(',').length) {
    delimiter = '\t';
  }
  
  // Parse header
  const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
  
  // Parse rows
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    // Handle quoted fields
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let j = 0; j < line.length; j++) {
      const char = line[j];
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if ((char === delimiter || char === '\n') && !inQuotes) {
        values.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    values.push(current.trim());
    
    if (values.length === headers.length) {
      const row = {};
      headers.forEach((header, idx) => {
        row[header.toLowerCase()] = values[idx] || '';
      });
      rows.push(row);
    }
  }
  
  return { headers, rows };
}

// Map CSV columns to trade fields (flexible mapping for different exchanges)
function mapCSVRowToTrade(row) {
  const trade = {
    token: '',
    entryPrice: null,
    exitPrice: null,
    netPL: null,
    date: null,
    leverage: null,
    stopLoss: null,
    takeProfit: null
  };
  
  // Token/Symbol mapping (Binance Futures format: "Futures" column)
  const tokenKeys = ['futures', 'symbol', 'token', 'pair', 'market', 'coin', 'asset', 'currency', 'instrument'];
  for (const key of tokenKeys) {
    if (row[key]) {
      let tokenValue = String(row[key]).trim();
      // Remove common suffixes like /USDT, /USD, etc.
      tokenValue = tokenValue.replace(/\/USDT?$/i, '').replace(/\/USD$/i, '').replace(/\/PERP$/i, '');
      trade.token = tokenValue.toUpperCase().replace(/[^A-Z0-9]/g, '');
      break;
    }
  }
  
  // Entry Price mapping (Binance: "Avg Entry Price")
  const entryKeys = ['avg entry price', 'avgentryprice', 'entry', 'entryprice', 'entry price', 'buy price', 'buyprice', 'open', 'openprice', 'open price', 'price', 'executed price', 'average entry price'];
  for (const key of entryKeys) {
    if (row[key] && !isNaN(parseFloat(row[key]))) {
      trade.entryPrice = parseFloat(row[key]);
      break;
    }
  }
  
  // Exit Price mapping (Binance: "Avg Close Price")
  const exitKeys = ['avg close price', 'avgcloseprice', 'exit', 'exitprice', 'exit price', 'sell price', 'sellprice', 'close', 'closeprice', 'close price', 'average close price'];
  for (const key of exitKeys) {
    if (row[key] && !isNaN(parseFloat(row[key]))) {
      trade.exitPrice = parseFloat(row[key]);
      break;
    }
  }
  
  // Net P&L mapping (Binance: "Realized PNL")
  const pnlKeys = ['realized pnl', 'realizedpnl', 'realized p&l', 'pnl', 'profit', 'profit/loss', 'profit loss', 'net', 'net pnl', 'total', 'total pnl', 'realized profit'];
  for (const key of pnlKeys) {
    if (row[key] && !isNaN(parseFloat(row[key]))) {
      trade.netPL = parseFloat(row[key]);
      break;
    }
  }
  
  // If P&L not found, calculate from entry/exit
  if (!trade.netPL && trade.entryPrice && trade.exitPrice) {
    // Check direction for futures (Long/Short)
    const direction = row['direction'] || row['side'] || row['type'] || '';
    const isLong = direction.toLowerCase().includes('long') || direction.toLowerCase().includes('buy');
    const isShort = direction.toLowerCase().includes('short') || direction.toLowerCase().includes('sell');
    
    if (isLong) {
      trade.netPL = trade.exitPrice - trade.entryPrice;
    } else if (isShort) {
      trade.netPL = trade.entryPrice - trade.exitPrice;
    } else {
      // Default: assume long position
      trade.netPL = trade.exitPrice - trade.entryPrice;
    }
  }
  
  // Date mapping (Binance: "Close Time" or "Open Time")
  const dateKeys = ['close time', 'closetime', 'closed date', 'date', 'time', 'datetime', 'timestamp', 'executed date', 'open time', 'opentime'];
  for (const key of dateKeys) {
    if (row[key]) {
      const dateStr = String(row[key]).trim();
      if (!dateStr || dateStr === '') continue;
      
      // Try to parse various date formats
      let date = null;
      
      // Handle Unix timestamp (milliseconds or seconds)
      if (/^\d+$/.test(dateStr)) {
        const timestamp = parseInt(dateStr);
        date = new Date(timestamp > 1000000000000 ? timestamp : timestamp * 1000);
      }
      // Handle ISO format with T
      else if (dateStr.includes('T')) {
        date = new Date(dateStr);
      }
      // Handle date with slashes
      else if (dateStr.includes('/')) {
        const parts = dateStr.split(/[/\s-]/);
        if (parts.length >= 3) {
          // Try different date formats
          if (parts[0].length === 4) {
            date = new Date(parts[0] + '-' + parts[1] + '-' + parts[2]);
          } else {
            date = new Date(parts[2] + '-' + parts[0] + '-' + parts[1]);
          }
        }
      }
      // Handle date with dashes
      else if (dateStr.includes('-')) {
        date = new Date(dateStr);
      }
      
      if (date && !isNaN(date.getTime())) {
        trade.date = date.toISOString().split('T')[0];
        break;
      }
    }
  }
  
  // Leverage mapping (Binance: "Margin Mode" - extract from isolated margin or cross margin, or look for leverage column)
  const leverageKeys = ['leverage', 'lev', 'margin ratio', 'marginratio'];
  for (const key of leverageKeys) {
    if (row[key] && !isNaN(parseFloat(row[key]))) {
      trade.leverage = parseFloat(row[key]);
      break;
    }
  }
  
  // Try to extract leverage from margin mode (e.g., "Isolated 10x" or "Cross 5x")
  if (!trade.leverage) {
    const marginMode = row['margin mode'] || row['marginmode'] || '';
    const marginMatch = String(marginMode).match(/(\d+(?:\.\d+)?)\s*x/i);
    if (marginMatch) {
      trade.leverage = parseFloat(marginMatch[1]);
    }
  }
  
  // Stop Loss mapping
  const stopLossKeys = ['stop loss', 'stoploss', 'sl', 'stop', 'stop loss price'];
  for (const key of stopLossKeys) {
    if (row[key] && !isNaN(parseFloat(row[key]))) {
      trade.stopLoss = parseFloat(row[key]);
      break;
    }
  }
  
  // Take Profit mapping
  const takeProfitKeys = ['take profit', 'takeprofit', 'tp', 'target', 'take profit price'];
  for (const key of takeProfitKeys) {
    if (row[key] && !isNaN(parseFloat(row[key]))) {
      trade.takeProfit = parseFloat(row[key]);
      break;
    }
  }
  
  return trade;
}

// Parse Excel file
function parseExcel(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Get first sheet
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        // Convert to JSON
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
        
        if (jsonData.length === 0) {
          reject(new Error('Excel ფაილი ცარიელია'));
          return;
        }
        
        // First row is headers
        const headers = jsonData[0].map(h => String(h).trim().toLowerCase());
        
        // Convert rows to objects
        const rows = [];
        for (let i = 1; i < jsonData.length; i++) {
          const row = {};
          headers.forEach((header, idx) => {
            row[header] = jsonData[i][idx] !== undefined ? String(jsonData[i][idx]).trim() : '';
          });
          rows.push(row);
        }
        
        resolve({ headers, rows });
      } catch (error) {
        reject(error);
      }
    };
    reader.onerror = () => reject(new Error('ფაილის წაკითხვის შეცდომა'));
    reader.readAsArrayBuffer(file);
  });
}

// Handle CSV/Excel file import
async function handleCSVImport() {
  const fileInput = document.getElementById('csvFileInput');
  const file = fileInput.files[0];
  
  if (!file) {
    showCSVStatus('გთხოვთ აირჩიოთ CSV ან Excel ფაილი', 'error');
    return;
  }
  
  const fileName = file.name.toLowerCase();
  const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
  
  try {
    let headers, rows;
    
    if (isExcel) {
      // Parse Excel file
      if (typeof XLSX === 'undefined') {
        showCSVStatus('Excel ბიბლიოთეკა არ არის ჩატვირთული', 'error');
        return;
      }
      
      const result = await parseExcel(file);
      headers = result.headers;
      rows = result.rows;
    } else {
      // Parse CSV file
      const reader = new FileReader();
      const text = await new Promise((resolve, reject) => {
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(new Error('ფაილის წაკითხვის შეცდომა'));
        reader.readAsText(file);
      });
      
      const result = parseCSV(text);
      headers = result.headers;
      rows = result.rows;
    }
    
    if (rows.length === 0) {
      showCSVStatus('ფაილში ტრანზაქციები ვერ მოიძებნა', 'error');
      return;
    }
    
    // Map rows to trades
    csvPreviewData = rows.map(row => mapCSVRowToTrade(row))
      .filter(trade => trade.entryPrice !== null && trade.exitPrice !== null && trade.netPL !== null);
    
    if (csvPreviewData.length === 0) {
      showCSVStatus('ვერ მოხერხდა ტრანზაქციების გამოტანა. შეამოწმეთ ფაილის ფორმატი და სვეტების სახელები.', 'error');
      return;
    }
    
    // Show preview
    showCSVPreview(csvPreviewData);
    showCSVStatus(`ნაპოვნია ${csvPreviewData.length} ტრანზაქცია`, 'success');
  } catch (error) {
    console.error('Import error:', error);
    showCSVStatus('შეცდომა ფაილის წაკითხვისას: ' + error.message, 'error');
  }
}

// Show CSV preview
function showCSVPreview(data) {
  const preview = document.getElementById('csvPreview');
  const previewBody = document.getElementById('csvPreviewBody');
  const previewCount = document.getElementById('previewCount');
  const clearBtn = document.getElementById('clearPreviewBtn');
  
  previewCount.textContent = data.length;
  preview.style.display = 'block';
  clearBtn.style.display = 'inline-block';
  
  previewBody.innerHTML = data.map((trade, idx) => {
    const isPositive = trade.netPL > 0;
    return `
      <tr style="border-bottom:1px solid var(--border-secondary);background:${idx % 2 === 0 ? 'var(--bg-card)' : 'var(--bg-tertiary)'};">
        <td style="padding:8px;text-align:center;color:var(--text-primary);border-right:1px solid var(--border-secondary);">${trade.token || '-'}</td>
        <td style="padding:8px;text-align:center;color:var(--text-primary);border-right:1px solid var(--border-secondary);">${trade.entryPrice ? trade.entryPrice.toFixed(2) : '-'}</td>
        <td style="padding:8px;text-align:center;color:var(--text-primary);border-right:1px solid var(--border-secondary);">${trade.exitPrice ? trade.exitPrice.toFixed(2) : '-'}</td>
        <td style="padding:8px;text-align:center;color:${isPositive ? 'var(--success)' : 'var(--error)'};font-weight:600;border-right:1px solid var(--border-secondary);">${trade.netPL >= 0 ? '+' : ''}${trade.netPL.toFixed(2)}</td>
        <td style="padding:8px;text-align:center;color:var(--text-secondary);">${trade.date || '-'}</td>
      </tr>
    `;
  }).join('');
}

// Show CSV import status
function showCSVStatus(message, type) {
  const statusEl = document.getElementById('csvImportStatus');
  statusEl.style.display = 'block';
  statusEl.textContent = message;
  statusEl.style.background = type === 'success' ? 'var(--success-bg)' : 'var(--error-bg)';
  statusEl.style.border = type === 'success' ? '1px solid var(--success)' : '1px solid var(--error)';
  statusEl.style.color = type === 'success' ? 'var(--success)' : 'var(--error)';
  
  if (type === 'success') {
    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);
  }
}

// Confirm and import CSV trades
async function confirmCSVImport() {
  if (csvPreviewData.length === 0) {
    showCSVStatus('იმპორტისთვის ტრანზაქციები არ არის', 'error');
    return;
  }
  
  if (!currentUser) {
    showCSVStatus('გთხოვთ შეხვიდეთ სისტემაში იმპორტისთვის', 'error');
    return;
  }
  
  let imported = 0;
  let errors = 0;
  
  // Import all trades first
  for (const tradeData of csvPreviewData) {
    try {
      const entry = parseFloat(tradeData.entryPrice);
      const stopLossPrice = tradeData.stopLoss ? parseFloat(tradeData.stopLoss) : null;
      const takeProfitPrice = tradeData.takeProfit ? parseFloat(tradeData.takeProfit) : null;
      
      const stopLossPercent = stopLossPrice ? calculatePercentage(entry, stopLossPrice) : null;
      const takeProfitPercent = takeProfitPrice ? calculatePercentage(entry, takeProfitPrice) : null;
      
      const trade = {
        id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9),
        tradeNumber: nextTradeNumber++,
        token: tradeData.token || '',
        entryPrice: entry,
        exitPrice: parseFloat(tradeData.exitPrice),
        leverage: tradeData.leverage ? parseFloat(tradeData.leverage) : null,
        stopLoss: stopLossPrice,
        stopLossPercent: stopLossPercent,
        takeProfit: takeProfitPrice,
        takeProfitPercent: takeProfitPercent,
        net: parseFloat(tradeData.netPL),
        date: tradeData.date || new Date().toISOString().split('T')[0]
      };
      
      trades.push(trade);
      imported++;
    } catch (error) {
      console.error('Error importing trade:', error);
      errors++;
    }
  }
  
  // Save all trades to Firebase at once
  try {
    await saveTrades();
    updateMetrics();
    renderTradesTable();
  } catch (error) {
    console.error('Error saving imported trades:', error);
    showCSVStatus('შეცდომა ტრანზაქციების შენახვისას: ' + error.message, 'error');
    return;
  }
  
  // Clear preview
  csvPreviewData = [];
  document.getElementById('csvPreview').style.display = 'none';
  document.getElementById('csvFileInput').value = '';
  document.getElementById('clearPreviewBtn').style.display = 'none';
  
  if (errors === 0) {
    showCSVStatus(`წარმატებით იმპორტირდა ${imported} ტრანზაქცია`, 'success');
  } else {
    showCSVStatus(`იმპორტირდა ${imported} ტრანზაქცია, ${errors} შეცდომა`, 'error');
  }
}

// Clear CSV preview
function clearCSVPreview() {
  csvPreviewData = [];
  document.getElementById('csvPreview').style.display = 'none';
  document.getElementById('csvFileInput').value = '';
  document.getElementById('clearPreviewBtn').style.display = 'none';
  document.getElementById('csvImportStatus').style.display = 'none';
}

// CSV import event listeners
if (document.getElementById('importCsvBtn')) {
  document.getElementById('importCsvBtn').addEventListener('click', handleCSVImport);
}

if (document.getElementById('confirmImportBtn')) {
  document.getElementById('confirmImportBtn').addEventListener('click', confirmCSVImport);
}

if (document.getElementById('clearPreviewBtn')) {
  document.getElementById('clearPreviewBtn').addEventListener('click', clearCSVPreview);
}

// Load trades when page is shown (integrated into existing showPage function)
// This is handled in the main showPage function above

// Load trades on auth state change
firebase.auth().onAuthStateChanged((user) => {
  if (user && window.location.hash !== '#login' && window.location.hash !== '#register') {
    const currentPage = document.querySelector('.page-content.active');
    if (currentPage && currentPage.id === 'tradingJournalPage') {
      loadTrades();
    }
  }
});

// Make functions globally available
window.deleteTrade = deleteTrade;

</script>

</body>
</html>
