<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRYPTO COLLECTIVE X - Desktop Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   FULL "DESKTOP PRO" STYLE ‚Äì 100% PRESERVED */
* { margin:0; padding:0; box-sizing:border-box; }
@keyframes gradientFlow {0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
@keyframes fadeInUp {from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes shimmerEffect {0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
@keyframes hoverFloat {0%,100%{transform:translateY(0)}50%{transform:translateY(-1px)}}
@keyframes neonGlow {0%,100%{filter:drop-shadow(0 0 4px #00ffff)}50%{filter:drop-shadow(0 0 20px #00ffff)}}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#0a0e1a 0%,#0f1419 50%,#0a0e1a 100%);color:#e8eaed;min-height:100vh;overflow-x:hidden}
.grain-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");opacity:.02;pointer-events:none;z-index:1}
.navbar{background:rgba(10,14,26,.85);backdrop-filter:blur(24px) saturate(180%);border-bottom:1px solid rgba(255,255,255,.08);padding:20px 60px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 4px 24px rgba(0,0,0,.3)}
.logo-section{display:flex;align-items:center;gap:16px}
.logo-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;animation:hoverFloat 6s ease-in-out infinite,neonGlow 3s linear infinite;overflow:hidden;position:relative}
.logo-icon img{width:44px;height:44px;object-fit:contain;filter:brightness(0) invert(1)}
.logo-text{display:flex;flex-direction:column}
.logo-title{font-size:24px;font-weight:800;letter-spacing:-0.5px;background:linear-gradient(135deg,#e8eaed 0%,#9aa0a6 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 2px 8px rgba(255,255,255,.1)}
.logo-subtitle{font-size:11px;color:#5f6368;text-transform:uppercase;letter-spacing:1.5px;font-weight:600}
.nav-right{display:flex;align-items:center;gap:20px}
.auth-buttons{display:flex;gap:12px}
.auth-btn{padding:10px 24px;background:transparent;border:1.5px solid rgba(255,255,255,.12);color:#bdc1c6;font-size:13px;font-weight:600;border-radius:10px;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);letter-spacing:0.3px}
.auth-btn:hover{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.2);color:#e8eaed;transform:translateY(-1px)}
.auth-btn.primary{background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;color:#fff;box-shadow:0 2px 8px rgba(139,92,246,.25)}
.auth-btn.primary:hover{box-shadow:0 4px 16px rgba(139,92,246,.4);transform:translateY(-1px)}
.user-menu{display:flex;align-items:center;gap:12px}
.user-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.15);box-shadow:0 2px 8px rgba(0,0,0,.2)}
.user-name{font-size:14px;font-weight:500;color:#bdc1c6;letter-spacing:0.2px}
.admin-controls{display:none;gap:12px;align-items:center}
.admin-controls.show{display:flex}
.admin-btn{padding:10px 20px;font-size:13px;font-weight:600;border-radius:10px;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);letter-spacing:0.3px}
.admin-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
.live-indicator{display:flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(52,168,83,.12);border:1px solid rgba(52,168,83,.25);border-radius:12px;backdrop-filter:blur(10px)}
.live-dot{width:8px;height:8px;background:#34a853;border-radius:50%;box-shadow:0 0 8px rgba(52,168,83,.6);animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.1)}}
.live-text{font-size:12px;color:#34a853;font-weight:600;text-transform:uppercase;letter-spacing:0.8px}
.time-display{font-size:14px;color:#9aa0a6;font-weight:500;font-variant-numeric:tabular-nums;letter-spacing:0.5px}
.container{max-width:1920px;margin:0 auto;padding:48px 60px;position:relative;z-index:2}
.hero-section{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:32px}
.hero-stat{background:rgba(15,20,30,.6);backdrop-filter:blur(16px) saturate(180%);border-radius:12px;padding:16px 20px;border:1px solid rgba(255,255,255,.08);transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:0 4px 16px rgba(0,0,0,.2);display:flex;flex-direction:column;justify-content:space-between;min-height:90px}
.hero-stat:hover{border-color:#8b5cf6;transform:translateY(-2px);box-shadow:0 8px 24px rgba(139,92,246,.25)}
.hero-stat-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#9aa0a6;margin-bottom:8px;font-weight:600}
.hero-stat-value{font-size:20px;font-weight:700;color:#e8eaed;letter-spacing:-0.3px;text-shadow:0 2px 8px rgba(0,0,0,.3);line-height:1.2}
.hero-stat-change{font-size:11px;margin-top:4px;font-weight:600}
.hero-stat-change.positive{color:#34a853}
.hero-stat-change.negative{color:#ea4335}
.content-grid{display:grid;grid-template-columns:380px 1fr;gap:32px;margin-bottom:48px}
.sidebar-section{display:flex;flex-direction:column;gap:20px}
.featured-card{background:rgba(15,20,30,.6);backdrop-filter:blur(16px) saturate(180%);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:32px;transition:all .35s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.2)}
.featured-card::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.03),transparent);transition:left .6s}
.featured-card:hover::before{left:100%}
.featured-card:hover{border-color:#8b5cf6;transform:translateY(-8px);box-shadow:0 24px 64px rgba(139,92,246,.25)}
.card-badge{display:inline-block;font-size:10px;text-transform:uppercase;letter-spacing:2px;font-weight:900;padding:6px 12px;border-radius:12px;margin-bottom:20px}
.badge-gainer{background:rgba(16,185,129,.15);color:#10b981;border:1px solid rgba(16,185,129,.3)}
.badge-gold{background:rgba(245,158,11,.15);color:#f59e0b;border:1px solid rgba(245,158,11,.3)}
.badge-loss{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)}
.featured-header{display:flex;align-items:center;gap:20px;margin-bottom:24px}
.featured-icon{width:72px;height:72px;border-radius:50%;border:3px solid #1a1a1a;box-shadow:0 8px 24px rgba(0,0,0,.5);transition:all .4s}
.featured-card:hover .featured-icon{transform:rotate(10deg) scale(1.1);border-color:#8b5cf6;box-shadow:0 12px 32px rgba(139,92,246,.4)}
.featured-info h3{font-size:22px;font-weight:800;margin-bottom:6px}
.featured-price{font-size:18px;color:#888;font-weight:700}
.progress-section{margin-top:24px}
.progress-label{display:flex;justify-content:space-between;margin-bottom:12px;font-size:13px;font-weight:700}
.progress-bar{height:12px;background:#1a1a1a;border-radius:6px;overflow:hidden;position:relative}
.progress-fill{height:100%;border-radius:6px;position:relative;overflow:hidden;transition:width 1.2s cubic-bezier(.4,0,.2,1)}
.progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmerEffect 2s infinite}
.progress-fill.green{background:linear-gradient(90deg,#10b981,#059669);box-shadow:0 0 16px rgba(16,185,129,.5)}
.progress-fill.gold{background:linear-gradient(90deg,#f59e0b,#d97706);box-shadow:0 0 16px rgba(245,158,11,.5)}
.progress-fill.red{background:linear-gradient(90deg,#ef4444,#dc2626);box-shadow:0 0 16px rgba(239,68,68,.5)}
.progress-value{color:#10b981;font-size:18px}
.progress-value.negative{color:#ef4444}
.progress-value.gold{color:#f59e0b}
.main-section{background:rgba(15,20,30,.6);backdrop-filter:blur(16px) saturate(180%);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:40px;min-height:800px;box-shadow:0 4px 24px rgba(0,0,0,.3)}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid rgba(255,255,255,.08)}
.section-title{font-size:28px;font-weight:700;color:#e8eaed;letter-spacing:-0.5px}
.filter-tabs{display:flex;gap:8px;background:rgba(10,14,26,.6);padding:6px;border-radius:12px;border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(10px)}
.filter-tab{padding:10px 20px;border:none;background:transparent;color:#9aa0a6;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;cursor:pointer;border-radius:8px;transition:all .25s cubic-bezier(.4,0,.2,1)}
.filter-tab:hover{color:#e8eaed;background:rgba(255,255,255,.05)}
.filter-tab.active{background:rgba(139,92,246,.15);color:#8b5cf6;border:1px solid rgba(139,92,246,.3);box-shadow:0 2px 8px rgba(139,92,246,.2)}
.table-header{display:grid;grid-template-columns:80px 2fr 1fr 1fr 1fr;gap:24px;padding:18px 24px;margin-bottom:16px;border-radius:12px;background:rgba(10,14,26,.4);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px)}
.table-header-cell{font-size:11px;color:#9aa0a6;text-transform:uppercase;letter-spacing:1.2px;font-weight:600}
.tokens-list{display:flex;flex-direction:column;gap:10px}
.token-row{display:grid;grid-template-columns:80px 2fr 1fr 1fr 1fr;gap:24px;padding:20px 24px;background:rgba(10,14,26,.4);border:1px solid rgba(255,255,255,.08);border-radius:14px;align-items:center;transition:all .3s cubic-bezier(.4,0,.2,1);animation:fadeInUp .5s ease-out backwards;animation-delay:calc(var(--index)*.03s);backdrop-filter:blur(10px)}
.token-row:hover{border-color:#8b5cf6;transform:translateX(4px);box-shadow:0 8px 24px rgba(139,92,246,.2);background:rgba(15,20,30,.6)}
.token-icon-col{display:flex;align-items:center;justify-content:center}
.token-icon{width:48px;height:48px;border-radius:50%;border:2px solid rgba(255,255,255,.1);transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,.2)}
.token-row:hover .token-icon{border-color:#8b5cf6;transform:scale(1.08);box-shadow:0 4px 12px rgba(139,92,246,.3)}
.token-name-col h3{font-size:16px;font-weight:600;margin-bottom:4px;color:#e8eaed;letter-spacing:-0.3px}
.token-symbol{font-size:12px;color:#9aa0a6;font-weight:500;text-transform:uppercase;letter-spacing:0.8px}
.token-price-col{font-size:17px;font-weight:600;color:#e8eaed;letter-spacing:-0.3px}
.token-change-col{text-align:right}
.change-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;transition:all .25s;position:relative;overflow:hidden;letter-spacing:0.3px}
.token-row:hover .change-badge{transform:scale(1.05)}
.change-badge.positive{background:rgba(52,168,83,.15);color:#34a853;border:1px solid rgba(52,168,83,.25)}
.change-badge.negative{background:rgba(234,67,53,.15);color:#ea4335;border:1px solid rgba(234,67,53,.25)}
.token-mcap-col{font-size:13px;font-weight:500;color:#9aa0a6;letter-spacing:0.2px}
.loading{text-align:center;padding:120px}
.spinner{width:64px;height:64px;border:4px solid rgba(255,255,255,.1);border-top:4px solid #8b5cf6;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 24px;box-shadow:0 0 24px rgba(139,92,246,.2)}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:15px;color:#9aa0a6;font-weight:500;letter-spacing:0.3px}
.error{background:rgba(234,67,53,.12);border:1px solid rgba(234,67,53,.25);color:#ea4335;border-radius:14px;padding:20px;margin:24px 0;font-weight:500;text-align:center;backdrop-filter:blur(10px)}

/* ANIMATED SVG ARROWS */
.change-arrow{width:18px;height:18px;transition:transform .3s ease,filter .3s ease;animation:arrowPulse 1.5s ease-in-out infinite}
@keyframes arrowPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.change-badge:hover .change-arrow{transform:translateY(-2px) scale(1.2);filter:drop-shadow(0 0 8px currentColor)}
.change-value{font-variant-numeric:tabular-nums}

/* USER TABS */
.user-tabs{display:flex;gap:10px;margin-bottom:24px}
.user-tab{padding:12px 24px;background:rgba(10,14,26,.4);border:1px solid rgba(255,255,255,.08);border-radius:10px;color:#9aa0a6;font-weight:600;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);letter-spacing:0.3px;backdrop-filter:blur(10px)}
.user-tab:hover{color:#e8eaed;background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.12)}
.user-tab.active{background:rgba(139,92,246,.15);color:#8b5cf6;border:1px solid rgba(139,92,246,.3);box-shadow:0 2px 8px rgba(139,92,246,.2)}
.user-content{display:none}
.user-content.active{display:block}

/* PORTFOLIO */
.portfolio-summary{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:32px}
.summary-card{background:rgba(10,14,26,.4);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:24px;text-align:center;backdrop-filter:blur(10px);transition:all .3s}
.summary-card:hover{border-color:rgba(255,255,255,.12);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.summary-value{font-size:24px;font-weight:600;margin:8px 0;color:#e8eaed;letter-spacing:-0.5px}
.summary-label{font-size:12px;color:#9aa0a6;text-transform:uppercase;letter-spacing:0.8px;font-weight:500}
.holdings-list{display:flex;flex-direction:column;gap:10px}
.holding-row{display:grid;grid-template-columns:80px 2fr 1fr 1fr 1fr 120px;gap:16px;padding:18px;background:rgba(10,14,26,.4);border:1px solid rgba(255,255,255,.08);border-radius:12px;align-items:center;position:relative;transition:all .3s;backdrop-filter:blur(10px)}
.holding-row:hover{background:rgba(15,20,30,.6);border-color:rgba(255,255,255,.12);box-shadow:0 4px 16px rgba(0,0,0,.3);transform:translateX(2px)}
.holding-name{font-weight:600}
.token-symbol{color:#666;font-size:12px}
.editable{cursor:pointer;padding:4px 8px;border-radius:6px;transition:all .2s}
.editable:hover{background:rgba(139,92,246,.1);border:1px dashed #8b5cf6}
.holding-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.edit-btn{background:rgba(139,92,246,.12);border:1px solid rgba(139,92,246,.25);color:#8b5cf6;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all .25s;display:flex;align-items:center;justify-content:center;letter-spacing:0.2px}
.edit-btn:hover{background:rgba(139,92,246,.2);transform:translateY(-1px);box-shadow:0 2px 8px rgba(139,92,246,.25)}
.delete-btn{background:rgba(234,67,53,.12);border:1px solid rgba(234,67,53,.25);color:#ea4335;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600;transition:all .25s;font-size:13px;letter-spacing:0.2px}
.delete-btn:hover{background:rgba(234,67,53,.2);transform:translateY(-1px);box-shadow:0 2px 8px rgba(234,67,53,.25)}
.add-holding-form{display:grid;grid-template-columns:1fr 1fr 1fr 80px;gap:12px;margin-top:24px}
.add-holding-form input,.add-holding-form select{padding:12px;background:rgba(10,14,26,.4);border:1px solid rgba(255,255,255,.08);border-radius:10px;color:#e8eaed;font-size:14px;transition:all .25s;backdrop-filter:blur(10px)}
.add-holding-form input:focus,.add-holding-form select:focus{outline:none;border-color:rgba(139,92,246,.4);box-shadow:0 0 0 3px rgba(139,92,246,.1)}
.add-holding-form button{background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;color:#fff;padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all .25s;box-shadow:0 2px 8px rgba(139,92,246,.25);letter-spacing:0.3px}
.add-holding-form button:hover{box-shadow:0 4px 12px rgba(139,92,246,.35);transform:translateY(-1px)}

/* ALERTS */
.alerts-list{display:flex;flex-direction:column;gap:10px}
.alert-row{display:grid;grid-template-columns:80px 2fr 1fr 1fr 80px;gap:16px;padding:18px;background:rgba(10,14,26,.4);border:1px solid rgba(255,255,255,.08);border-radius:12px;align-items:center;backdrop-filter:blur(10px);transition:all .3s}
.alert-row:hover{border-color:rgba(255,255,255,.12);transform:translateX(2px)}
.alert-row.triggered{background:rgba(52,168,83,.12);border-color:rgba(52,168,83,.3);box-shadow:0 2px 8px rgba(52,168,83,.2)}
.add-alert-form{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 80px;gap:12px;margin-top:24px}
.add-alert-form select,.add-alert-form input{padding:12px;background:rgba(10,14,26,.4);border:1px solid rgba(255,255,255,.08);border-radius:10px;color:#e8eaed;font-size:14px;transition:all .25s;backdrop-filter:blur(10px)}
.add-alert-form select:focus,.add-alert-form input:focus{outline:none;border-color:rgba(139,92,246,.4);box-shadow:0 0 0 3px rgba(139,92,246,.1)}
.add-alert-form button{background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;color:#fff;padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all .25s;box-shadow:0 2px 8px rgba(139,92,246,.25);letter-spacing:0.3px}
.add-alert-form button:hover{box-shadow:0 4px 12px rgba(139,92,246,.35);transform:translateY(-1px)}

/* MODALS */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(12px);align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal-content{background:rgba(15,20,30,.95);backdrop-filter:blur(24px) saturate(180%);border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:32px;width:420px;max-width:90vw;box-shadow:0 24px 64px rgba(0,0,0,.5)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-size:20px;font-weight:600;color:#e8eaed;letter-spacing:-0.3px}
.close-modal{cursor:pointer;color:#9aa0a6;font-size:24px;font-weight:300;transition:all .25s}
.close-modal:hover{color:#e8eaed}
.modal-input{margin-bottom:16px}
.modal-input label{display:block;font-size:12px;color:#9aa0a6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500}
.modal-input input{width:100%;padding:12px 16px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:12px;color:#e8eaed;font-size:14px;transition:all .25s;backdrop-filter:blur(10px)}
.modal-input input:focus{outline:none;border-color:rgba(139,92,246,.4);box-shadow:0 0 0 3px rgba(139,92,246,.1)}
.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
.modal-btn{padding:12px 24px;border-radius:10px;font-weight:600;font-size:13px;cursor:pointer;transition:all .25s;letter-spacing:0.3px}
.modal-btn.cancel{background:transparent;border:1.5px solid rgba(255,255,255,.15);color:#9aa0a6}
.modal-btn.cancel:hover{background:rgba(255,255,255,.05);color:#e8eaed;border-color:rgba(255,255,255,.2)}
.modal-btn.add{background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;color:#fff;box-shadow:0 2px 8px rgba(139,92,246,.25)}
.modal-btn.add:hover{box-shadow:0 4px 16px rgba(139,92,246,.4);transform:translateY(-1px)}
.modal-btn.save{background:linear-gradient(135deg,#34a853 0%,#2d8e47 100%);border:none;color:#fff;box-shadow:0 2px 8px rgba(52,168,83,.25)}
.modal-btn.save:hover{box-shadow:0 4px 16px rgba(52,168,83,.4);transform:translateY(-1px)}
.modal-close{background:transparent;border:none;color:#9aa0a6;font-size:28px;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all .25s}
.modal-close:hover{background:rgba(255,255,255,.05);color:#e8eaed}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:12px;color:#9aa0a6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.8px;font-weight:500}
.form-group input,.form-group select{width:100%;padding:12px 16px;background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:12px;color:#e8eaed;font-size:14px;transition:all .25s;backdrop-filter:blur(10px)}
.form-group input:focus,.form-group select:focus{outline:none;border-color:rgba(139,92,246,.4);box-shadow:0 0 0 3px rgba(139,92,246,.1)}
.form-group input:disabled,.form-group select:disabled{opacity:.5;cursor:not-allowed}
.form-group small{display:block;margin-top:6px;font-size:11px;color:#9aa0a6}
.modal-header h3{font-size:20px;font-weight:600;color:#e8eaed;letter-spacing:-0.3px;margin:0}

@media(max-width:1600px){.content-grid{grid-template-columns:340px 1fr}.hero-section{grid-template-columns:repeat(3,1fr)}}
@media(max-width:1400px){.content-grid{grid-template-columns:1fr}.hero-section{grid-template-columns:repeat(3,1fr)}}
@media(max-width:1024px){.navbar{padding:16px 32px}.container{padding:32px}.hero-section{grid-template-columns:repeat(2,1fr)}.token-row{grid-template-columns:60px 1.5fr 1fr 1fr}.token-mcap-col{display:none}.table-header{grid-template-columns:60px 1.5fr 1fr 1fr}.table-header-cell:last-child{display:none}}
</style>
</head>
<body>

<div class="grain-overlay"></div>

<nav class="navbar">
  <div class="logo-section">
    <div class="logo-icon"><img src="https://ta3bviqjtxy1kv7x.public.blob.vercel-storage.com/sticker.webp" alt="Logo"></div>
    <div class="logo-text">
      <div class="logo-title">CRYPTO COLLECTIVE X</div>
      <div class="logo-subtitle"></div>
    </div>
  </div>

  <div class="nav-right">
    <div class="live-indicator"><div class="live-dot"></div><div class="live-text">Live</div></div>
    <div class="time-display" id="navTime">--:--:--</div>

    <div id="authContainer">
      <div class="auth-buttons">
        <button class="auth-btn" id="loginBtn">Login</button>
        <button class="auth-btn primary" id="registerBtn">Register</button>
      </div>
    </div>

    <div id="userContainer" class="user-menu" style="display:none;">
      <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
      <span id="userName" class="user-name"></span>
      <button class="auth-btn" id="logoutBtn">Logout</button>
    </div>

    <div id="adminControls" class="admin-controls" style="display:none;gap:12px;align-items:center;padding:14px 24px;background:rgba(15,20,30,.6);border:1px solid rgba(255,255,255,.12);border-radius:14px;backdrop-filter:blur(16px) saturate(180%);box-shadow:0 4px 16px rgba(0,0,0,.2);">
      <div style="display:flex;align-items:center;gap:10px;padding-right:16px;border-right:1px solid rgba(255,255,255,.1);">
        <span style="font-size:16px;opacity:0.9;">üëë</span>
        <span style="font-size:11px;font-weight:600;color:#9aa0a6;text-transform:uppercase;letter-spacing:0.8px;">Admin</span>
      </div>
      <button class="admin-btn" id="addTokenBtn" style="padding:10px 20px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;color:#fff;font-size:13px;font-weight:600;border-radius:10px;cursor:pointer;transition:all .25s;box-shadow:0 2px 8px rgba(139,92,246,.25);letter-spacing:0.3px;">‚ûï Add Token</button>
      <button class="admin-btn" id="refreshBtn" style="padding:10px 20px;background:rgba(52,168,83,.12);border:1.5px solid rgba(52,168,83,.25);color:#34a853;font-size:13px;font-weight:600;border-radius:10px;cursor:pointer;transition:all .25s;letter-spacing:0.3px;">üîÑ Refresh</button>
    </div>
  </div>
</nav>

<div class="container">
  <div id="loading" class="loading"><div class="spinner"></div><div class="loading-text">Loading market data...</div></div>
  <div id="error"></div>

  <div class="hero-section" id="heroStats" style="display:none;"></div>

  <div class="content-grid" id="contentGrid" style="display:none;">
    <div class="sidebar-section" id="sidebarSection">
      <div class="sidebar-card" style="background:rgba(15,20,30,.6);backdrop-filter:blur(16px) saturate(180%);border-radius:16px;padding:24px;border:1px solid rgba(255,255,255,.08);margin-bottom:20px;box-shadow:0 4px 16px rgba(0,0,0,.2);">
        <div style="font-size:13px;font-weight:600;margin-bottom:18px;text-transform:uppercase;letter-spacing:0.8px;color:#9aa0a6;display:flex;align-items:center;gap:8px;">
          <span style="opacity:0.8;">üìà</span> Top Gainers
        </div>
        <div id="topGainersList" class="top-gainers-list" style="display:flex;flex-direction:column;gap:10px;">
          <div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">Loading...</div>
        </div>
      </div>
      <div class="sidebar-card" style="background:rgba(15,20,30,.6);backdrop-filter:blur(16px) saturate(180%);border-radius:16px;padding:24px;border:1px solid rgba(255,255,255,.08);margin-bottom:20px;box-shadow:0 4px 16px rgba(0,0,0,.2);">
        <div style="font-size:13px;font-weight:600;margin-bottom:18px;text-transform:uppercase;letter-spacing:0.8px;color:#9aa0a6;display:flex;align-items:center;gap:8px;">
          <span style="opacity:0.8;">üíπ</span> Market Quotes
        </div>
        <div id="quotesList" class="quotes-list" style="display:flex;flex-direction:column;gap:10px;">
          <div style="padding:20px;text-align:center;color:#9aa0a6;font-size:13px;">Loading quotes...</div>
        </div>
      </div>
      <div class="sidebar-card" style="background:rgba(15,20,30,.6);backdrop-filter:blur(16px) saturate(180%);border-radius:16px;padding:24px;border:1px solid rgba(255,255,255,.08);box-shadow:0 4px 16px rgba(0,0,0,.2);">
        <div style="font-size:13px;font-weight:600;margin-bottom:18px;text-transform:uppercase;letter-spacing:0.8px;color:#9aa0a6;">Settings</div>
        <div id="settingsPanel" class="settings-panel" style="display:flex;flex-direction:column;gap:16px;">
          <div class="setting-item" style="display:flex;justify-content:space-between;align-items:center;">
            <label style="font-size:13px;color:#bdc1c6;font-weight:500;">Auto-refresh:</label>
            <select id="refreshInterval" style="background:rgba(10,14,26,.6);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:8px 12px;color:#e8eaed;font-size:12px;cursor:pointer;transition:all .25s;backdrop-filter:blur(10px);">
              <option value="60000">1 min</option>
              <option value="120000">2 min</option>
              <option value="180000" selected>3 min</option>
              <option value="300000">5 min</option>
            </select>
          </div>
          <div class="setting-item" style="display:flex;justify-content:space-between;align-items:center;">
            <label style="font-size:13px;color:#bdc1c6;font-weight:500;">Price alerts:</label>
            <input type="checkbox" id="enableAlerts" checked style="width:18px;height:18px;accent-color:#8b5cf6;cursor:pointer;">
          </div>
        </div>
      </div>
    </div>

    <div class="main-section">
      <div id="userTabs" class="user-tabs" style="display:none;">
        <div class="user-tab active" data-tab="market">Market</div>
        <div class="user-tab" data-tab="portfolio">Portfolio</div>
        <div class="user-tab" data-tab="alerts">Alerts</div>
      </div>

      <div id="marketContent" class="user-content active">
        <div class="section-header">
          <div class="section-title">Market Overview</div>
          <div class="filter-tabs">
            <button class="filter-tab" onclick="sortBy('name')" id="sortName">Name</button>
            <button class="filter-tab" onclick="sortBy('price')" id="sortPrice">Price</button>
            <button class="filter-tab active" onclick="sortBy('change')" id="sortChange">24h</button>
            <button class="filter-tab" onclick="sortBy('mcap')" id="sortMcap">MCap</button>
          </div>
        </div>

        <div class="table-header">
          <div class="table-header-cell">#</div>
          <div class="table-header-cell">Asset</div>
          <div class="table-header-cell">Price</div>
          <div class="table-header-cell">24h Change</div>
          <div class="table-header-cell">Market Cap</div>
        </div>

        <div class="tokens-list" id="tokensList"></div>
      </div>

      <div id="portfolioContent" class="user-content">
        <div class="portfolio-summary">
          <div class="summary-card">
            <div class="summary-label">Total Value</div>
            <div class="summary-value" id="totalValue">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Total P/L</div>
            <div class="summary-value" id="totalPL">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">ROI</div>
            <div class="summary-value" id="roi">0%</div>
          </div>
        </div>

        <div class="holdings-list" id="holdingsList"></div>

        <form class="add-holding-form" id="addHoldingForm">
          <select id="holdingToken" required></select>
          <input type="number" step="any" placeholder="Amount" id="holdingAmount" required>
          <input type="number" step="any" placeholder="Buy Price" id="buyPrice" required>
          <button type="submit">Add</button>
        </form>
      </div>

      <!-- Edit Holding Modal -->
      <div id="editHoldingModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Edit Holding</h3>
            <button class="modal-close" onclick="$('editHoldingModal').classList.remove('show')">√ó</button>
          </div>
          <form id="editHoldingForm">
            <input type="hidden" id="editHoldingId">
            <div class="form-group">
              <label>Token</label>
              <select id="editHoldingToken" required disabled></select>
              <small style="color: #888;">Token cannot be changed</small>
            </div>
            <div class="form-group">
              <label>Amount</label>
              <input type="number" step="any" id="editHoldingAmount" required>
            </div>
            <div class="form-group">
              <label>Buy Price (USD)</label>
              <input type="number" step="any" id="editHoldingBuyPrice" required>
            </div>
            <div class="modal-actions">
              <button type="button" class="modal-btn cancel" onclick="$('editHoldingModal').classList.remove('show')">Cancel</button>
              <button type="submit" class="modal-btn save">Save Changes</button>
            </div>
          </form>
        </div>
      </div>

      <div id="alertsContent" class="user-content">
        <div class="alerts-list" id="alertsList"></div>

        <form class="add-alert-form" id="addAlertForm">
          <select id="alertToken" required></select>
          <select id="alertCondition" required>
            <option value="above">Above</option>
            <option value="below">Below</option>
          </select>
          <input type="number" step="any" placeholder="Target Price" id="targetPrice" required>
          <input type="text" placeholder="Message (optional)" id="alertMessage">
          <button type="submit">Set Alert</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="addTokenModal" class="modal">
  <div class="modal-content" style="max-width:600px;width:90vw;">
    <div class="modal-header" style="background:rgba(15,20,30,.95);backdrop-filter:blur(24px) saturate(180%);padding:24px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,.08);">
      <div class="modal-title" style="font-size:20px;font-weight:600;color:#e8eaed;letter-spacing:-0.3px;">üîç Add Crypto Token</div>
      <span class="close-modal" id="closeModal" style="color:#9aa0a6;font-size:28px;cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:transparent;transition:all .25s;">√ó</span>
    </div>
    <div style="padding:28px;background:rgba(15,20,30,.95);backdrop-filter:blur(24px) saturate(180%);">
      <div class="modal-input" style="margin-bottom:20px;">
        <label style="display:block;font-size:12px;font-weight:500;color:#9aa0a6;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.8px;">Search Token</label>
        <div style="position:relative;">
          <input type="text" id="tokenSearch" placeholder="Type to search (e.g. bitcoin, ethereum, solana)..." 
            style="width:100%;padding:14px 18px;background:rgba(10,14,26,.6);border:1.5px solid rgba(255,255,255,.1);border-radius:12px;color:#e8eaed;font-size:14px;transition:all .25s;backdrop-filter:blur(10px);"
            autocomplete="off">
          <div id="tokenSearchResults" style="position:absolute;top:100%;left:0;right:0;margin-top:8px;background:rgba(15,20,30,.98);backdrop-filter:blur(24px) saturate(180%);border:1px solid rgba(255,255,255,.12);border-radius:12px;max-height:300px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 12px 40px rgba(0,0,0,.5);"></div>
        </div>
        <div id="selectedToken" style="margin-top:16px;padding:16px;background:rgba(139,92,246,.1);border:1.5px solid rgba(139,92,246,.25);border-radius:12px;display:none;backdrop-filter:blur(10px);">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-weight:600;color:#e8eaed;font-size:15px;letter-spacing:-0.2px;" id="selectedTokenName"></div>
              <div style="font-size:12px;color:#9aa0a6;margin-top:4px;font-weight:400;" id="selectedTokenId"></div>
            </div>
            <button id="clearSelection" style="padding:8px 14px;background:rgba(234,67,53,.12);border:1.5px solid rgba(234,67,53,.25);color:#ea4335;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;transition:all .25s;letter-spacing:0.2px;">Clear</button>
          </div>
        </div>
      </div>
      <div class="modal-actions" style="display:flex;gap:12px;justify-content:flex-end;">
        <button class="modal-btn cancel" id="cancelAdd" style="padding:12px 24px;background:transparent;border:1.5px solid rgba(255,255,255,.15);color:#9aa0a6;border-radius:10px;cursor:pointer;font-weight:600;transition:all .25s;letter-spacing:0.3px;">Cancel</button>
        <button class="modal-btn add" id="confirmAdd" style="padding:12px 24px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;color:#fff;border-radius:10px;cursor:pointer;font-weight:600;transition:all .25s;box-shadow:0 2px 8px rgba(139,92,246,.25);letter-spacing:0.3px;" disabled>Add Token</button>
      </div>
      <div id="addTokenStatus" style="margin-top:16px;padding:14px;border-radius:10px;display:none;font-size:13px;font-weight:500;backdrop-filter:blur(10px);"></div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebase config - Complete web app configuration
const firebaseConfig = { 
  apiKey: "AIzaSyARWG4t3i_pCpu-pOZPqauRufMQhZaI14U",
  authDomain: "ccx-dashboard.firebaseapp.com",
  databaseURL: "https://ccx-dashboard-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ccx-dashboard",
  storageBucket: "ccx-dashboard.firebasestorage.app",
  messagingSenderId: "413950601775",
  appId: "1:413950601775:web:53ca78e202ef7ec884b4da"
};
// Initialize Firebase app
let app;
try {
  app = firebase.initializeApp(firebaseConfig);
} catch (e) {
  // App already initialized
  app = firebase.app();
}
const auth = firebase.auth();

/* ---------- GLOBALS ---------- */
let cryptoData = [], prices = {}, globalData = null, fearGreedData = null;
let sortColumn = 'change', sortDirection = 'desc';
let currentUser = null;

/* ---------- HELPERS ---------- */
function $(id){return document.getElementById(id);}
function formatPrice(p){return p>=1000?p.toLocaleString('en-US',{maximumFractionDigits:0}):p>=1?p.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):p>=.01?p.toFixed(4):p.toFixed(6);}
function formatMarketCap(m){return m>=1e12?`${(m/1e12).toFixed(2)}T`:m>=1e9?`${(m/1e9).toFixed(2)}B`:m>=1e6?`${(m/1e6).toFixed(2)}M`:m.toLocaleString();}
function updateTime(){$('navTime').textContent=new Date().toLocaleTimeString('en-US',{hour12:false});}
updateTime();setInterval(updateTime,1000);

/* ---------- AUTH (same as before) ---------- */
$('loginBtn').onclick = () => authModal('login');
$('registerBtn').onclick = () => authModal('register');
$('logoutBtn').onclick = () => auth.signOut();

function authModal(mode){
  const email = prompt(`Enter email:`);
  if(!email) return;
  const password = prompt('Enter password:');
  if(!password) return;
  
  // Ensure Firebase Auth is initialized
  if (!auth) {
    try {
      auth = firebase.auth();
    } catch (e) {
      console.error('Firebase Auth initialization error:', e);
      alert('Authentication service is not available. Please refresh the page.');
      return;
    }
  }
  
  const authMethod = mode === 'login' ? auth.signInWithEmailAndPassword : auth.createUserWithEmailAndPassword;
  
  authMethod.call(auth, email, password)
    .then(() => {
      if(mode === 'register') {
        alert('Registration successful! You are now logged in.');
      }
    })
    .catch(e => {
      console.error('Auth error:', e);
      let errorMsg = e.message;
      // Provide more helpful error messages
      if(e.code === 'auth/email-already-in-use') {
        errorMsg = 'This email is already registered. Please login instead.';
      } else if(e.code === 'auth/weak-password') {
        errorMsg = 'Password is too weak. Please use at least 6 characters.';
      } else if(e.code === 'auth/invalid-email') {
        errorMsg = 'Invalid email address. Please check and try again.';
      } else if(e.code === 'auth/user-not-found') {
        errorMsg = 'No account found with this email. Please register first.';
      } else if(e.code === 'auth/wrong-password') {
        errorMsg = 'Incorrect password. Please try again.';
      } else if(e.message && e.message.includes('_delegate')) {
        errorMsg = 'Authentication service error. Please refresh the page and try again.';
      }
      alert(errorMsg);
    });
}

auth.onAuthStateChanged(user=>{
  currentUser = user;
  if(user){
    $('authContainer').style.display='none';
    $('userContainer').style.display='flex';
    $('userName').textContent = user.email.split('@')[0];
    $('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=8b5cf6&color=fff&size=64`;
    $('userTabs').style.display='flex';
    if(user.email === 'testireba5@gmail.com') $('adminControls').classList.add('show');
  }else{
    $('authContainer').style.display='flex';
    $('userContainer').style.display='none';
    $('userTabs').style.display='none';
    $('adminControls').style.display='none';
  }
});

/* ---------- USER TABS (same as before) ---------- */
document.querySelectorAll('.user-tab').forEach(tab=>{
  tab.onclick = () => {
    document.querySelectorAll('.user-tab,.user-content').forEach(el=>el.classList.remove('active'));
    tab.classList.add('active');
    $(tab.dataset.tab + 'Content').classList.add('active');
  };
});

/* ---------- RENDER FUNCTIONS ---------- */
function renderAll() {
  renderHeroStats();
  renderTokens();
  if (cryptoData && cryptoData.length > 0) {
    renderTopGainers();
    renderQuotes();
  }
  populateTokenSelect('holdingToken');
  populateTokenSelect('alertToken');
}

function renderTopGainers() {
  const gainersList = $('topGainersList');
  if (!gainersList) return;
  
  if (!cryptoData || cryptoData.length === 0) {
    gainersList.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">No market data available</div>';
    return;
  }
  
  // Show top 5 tokens by 24h change (gainers)
  const topGainers = [...cryptoData]
    .filter(token => (token.price_change_percentage_24h || 0) > 0)
    .sort((a, b) => (b.price_change_percentage_24h || 0) - (a.price_change_percentage_24h || 0))
    .slice(0, 5);
  
  if (topGainers.length === 0) {
    gainersList.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">No gainers found</div>';
    return;
  }
  
  gainersList.innerHTML = topGainers.map((token, idx) => {
    const change = token.price_change_percentage_24h || 0;
    return `
      <div class="gainer-item" style="padding:14px;background:rgba(52,168,83,.08);border:1px solid rgba(52,168,83,.2);border-radius:12px;display:flex;justify-content:space-between;align-items:center;transition:all .25s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(10px);">
        <div style="display:flex;align-items:center;gap:12px;flex:1;">
          <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#34a853 0%,#2d8e47 100%);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;color:#fff;box-shadow:0 2px 8px rgba(52,168,83,.3);">${idx + 1}</div>
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:8px;">
              <img src="${token.image || 'https://via.placeholder.com/20'}" style="width:20px;height:20px;border-radius:50%;border:1px solid rgba(255,255,255,.1);" onerror="this.src='https://via.placeholder.com/20?text=?'">
              <div style="font-weight:600;font-size:13px;color:#e8eaed;letter-spacing:-0.2px;">${token.symbol?.toUpperCase() || token.id}</div>
            </div>
            <div style="font-size:11px;color:#9aa0a6;margin-top:3px;font-weight:400;">${token.name || token.id}</div>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:600;font-size:13px;color:#34a853;letter-spacing:-0.2px;">+${change.toFixed(2)}%</div>
          <div style="font-size:11px;color:#9aa0a6;margin-top:3px;font-weight:400;">$${formatPrice(token.current_price || 0)}</div>
        </div>
      </div>
    `;
  }).join('');
  
  // Add hover effect
  gainersList.querySelectorAll('.gainer-item').forEach(item => {
    item.onmouseenter = () => {
      item.style.background = 'rgba(52,168,83,.12)';
      item.style.borderColor = 'rgba(52,168,83,.3)';
      item.style.transform = 'translateX(3px)';
      item.style.boxShadow = '0 4px 12px rgba(0,0,0,.2)';
    };
    item.onmouseleave = () => {
      item.style.background = 'rgba(52,168,83,.08)';
      item.style.borderColor = 'rgba(52,168,83,.2)';
      item.style.transform = 'translateX(0)';
      item.style.boxShadow = 'none';
    };
  });
}

function renderQuotes() {
  const quotesList = $('quotesList');
  if (!quotesList) return;
  
  if (!cryptoData || cryptoData.length === 0) {
    quotesList.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">No market data available</div>';
    return;
  }
  
  // Show top 5 tokens by market cap
  const topTokens = [...cryptoData]
    .sort((a, b) => (b.market_cap || 0) - (a.market_cap || 0))
    .slice(0, 5);
  
  quotesList.innerHTML = topTokens.map(token => {
    const change = token.price_change_percentage_24h || 0;
    const changeClass = change >= 0 ? 'positive' : 'negative';
    return `
      <div class="quote-item" style="padding:14px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.15);border-radius:12px;display:flex;justify-content:space-between;align-items:center;transition:all .25s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(10px);">
        <div style="display:flex;align-items:center;gap:10px;">
          <img src="${token.image || 'https://via.placeholder.com/24'}" style="width:24px;height:24px;border-radius:50%;border:1px solid rgba(255,255,255,.1);" onerror="this.src='https://via.placeholder.com/24?text=?'">
          <div>
            <div style="font-weight:600;font-size:13px;color:#e8eaed;letter-spacing:-0.2px;">${token.symbol?.toUpperCase() || token.id}</div>
            <div style="font-size:11px;color:#9aa0a6;margin-top:2px;font-weight:400;">${token.name || token.id}</div>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:600;font-size:13px;color:#e8eaed;letter-spacing:-0.2px;">$${formatPrice(token.current_price || 0)}</div>
          <div class="change-badge ${changeClass}" style="font-size:11px;padding:3px 8px;border-radius:6px;display:inline-block;margin-top:4px;background:${change >= 0 ? 'rgba(52,168,83,.15)' : 'rgba(234,67,53,.15)'};color:${change >= 0 ? '#34a853' : '#ea4335'};border:1px solid ${change >= 0 ? 'rgba(52,168,83,.25)' : 'rgba(234,67,53,.25)'};font-weight:600;">
            ${change >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(change).toFixed(2)}%
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Add hover effect
  quotesList.querySelectorAll('.quote-item').forEach(item => {
    item.onmouseenter = () => {
      item.style.background = 'rgba(139,92,246,.1)';
      item.style.borderColor = 'rgba(139,92,246,.25)';
      item.style.transform = 'translateX(3px)';
      item.style.boxShadow = '0 4px 12px rgba(139,92,246,.2)';
    };
    item.onmouseleave = () => {
      item.style.background = 'rgba(139,92,246,.06)';
      item.style.borderColor = 'rgba(139,92,246,.15)';
      item.style.transform = 'translateX(0)';
      item.style.boxShadow = 'none';
    };
  });
}

function renderHeroStats() {
  const hero = $('heroStats');
  if (!globalData) return;
  
  const marketCap = globalData.total_market_cap?.usd || 0;
  const volume = globalData.total_volume?.usd || 0;
  const btcDominance = globalData.market_cap_percentage?.btc || 0;
  const ethDominance = globalData.market_cap_percentage?.eth || 0;
  const marketCapChange = globalData.market_cap_change_percentage_24h_usd || 0;
  const activeCryptos = globalData.active_cryptocurrencies || 0;
  
  const fearGreedValue = fearGreedData?.value || 'N/A';
  const fearGreedClassification = fearGreedData?.value_classification || 'N/A';
  
  hero.innerHTML = `
    <div class="hero-stat">
      <div class="hero-stat-label">Market Cap</div>
      <div class="hero-stat-value">$${formatMarketCap(marketCap)}</div>
      <div class="hero-stat-change ${marketCapChange >= 0 ? 'positive' : 'negative'}">
        ${marketCapChange >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(marketCapChange).toFixed(2)}%
      </div>
    </div>
    <div class="hero-stat">
      <div class="hero-stat-label">24h Volume</div>
      <div class="hero-stat-value">$${formatMarketCap(volume)}</div>
      <div class="hero-stat-change" style="color:#9aa0a6;font-size:10px;">
        ${volume > 0 ? ((volume / marketCap * 100).toFixed(1) + '% of cap') : 'N/A'}
      </div>
    </div>
    <div class="hero-stat">
      <div class="hero-stat-label">BTC Dominance</div>
      <div class="hero-stat-value">${btcDominance.toFixed(1)}%</div>
      <div class="hero-stat-change" style="color:#9aa0a6;font-size:10px;">
        ETH: ${ethDominance.toFixed(1)}%
      </div>
    </div>
    <div class="hero-stat">
      <div class="hero-stat-label">Fear & Greed</div>
      <div class="hero-stat-value">${fearGreedValue}</div>
      <div class="hero-stat-change" style="color:#9aa0a6;font-size:10px;text-transform:capitalize;">
        ${fearGreedClassification}
      </div>
    </div>
    <div class="hero-stat">
      <div class="hero-stat-label">Active Cryptos</div>
      <div class="hero-stat-value">${activeCryptos.toLocaleString()}</div>
      <div class="hero-stat-change" style="color:#9aa0a6;font-size:10px;">
        Markets: ${(globalData.markets || 0).toLocaleString()}
      </div>
    </div>
    <div class="hero-stat">
      <div class="hero-stat-label">Total Coins</div>
      <div class="hero-stat-value">${(globalData.total_cryptocurrencies || 0).toLocaleString()}</div>
      <div class="hero-stat-change" style="color:#9aa0a6;font-size:10px;">
        Exchanges: ${(globalData.exchanges || 0).toLocaleString()}
      </div>
    </div>
  `;
}

function renderTokens() {
  const list = $('tokensList');
  list.innerHTML = '';
  if (!cryptoData || cryptoData.length === 0) {
    list.innerHTML = '<div class="error">No tokens found. Add tokens in admin panel.</div>';
    return;
  }
  cryptoData.sort((a, b) => {
    if (sortColumn === 'name') return sortDirection * a.name.localeCompare(b.name);
    if (sortColumn === 'price') return sortDirection * (a.current_price - b.current_price);
    if (sortColumn === 'change') return sortDirection * (a.price_change_percentage_24h - b.price_change_percentage_24h);
    if (sortColumn === 'mcap') return sortDirection * (a.market_cap - b.market_cap);
    return 0;
  }).forEach((coin, idx) => {
    const change = coin.price_change_percentage_24h || 0;
    const changeClass = change >= 0 ? 'positive' : 'negative';
    list.innerHTML += `
      <div class="token-row" style="--index: ${idx}">
        <div class="token-icon-col"><img src="${coin.image}" class="token-icon" alt="${coin.name}"></div>
        <div class="token-name-col">
          <h3>${coin.name}</h3>
          <span class="token-symbol">${coin.symbol.toUpperCase()}</span>
        </div>
        <div class="token-price-col">$${formatPrice(coin.current_price)}</div>
        <div class="token-change-col">
          <span class="change-badge ${changeClass}">
            ${change >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(change).toFixed(2)}%
          </span>
        </div>
        <div class="token-mcap-col">$${formatMarketCap(coin.market_cap)}</div>
      </div>
    `;
  });
}

window.sortBy = function(col) {
  if (sortColumn === col) {
    sortDirection *= -1;
  } else {
    sortColumn = col;
    sortDirection = col === 'name' ? 1 : -1;
  }
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  $(`sort${col.charAt(0).toUpperCase() + col.slice(1)}`).classList.add('active');
  renderTokens();
};

/* ---------- FETCH MARKET DATA (via Vercel API) ---------- */
async function fetchAll(){
  const err = $('error'), load = $('loading');
  err.innerHTML = ''; load.style.display = 'block';
  try {
    console.log('Fetching market data from /api/portfolio...');
    const res = await fetch('/api/portfolio');
    console.log('Response status:', res.status, res.statusText);
    
    let data;
    try {
      data = await res.json();
      console.log('Response data:', data);
    } catch (jsonError) {
      console.error('Failed to parse JSON response:', jsonError);
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      // API returned an error response
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      const hint = data.hint || '';
      const requiredVars = data.requiredVars || [];
      
      let errorHtml = `<div class="error"><strong>Error: ${errorMsg}</strong>`;
      if (hint) errorHtml += `<br><br>${hint}`;
      if (requiredVars.length) {
        errorHtml += `<br><br><strong>Required Environment Variables:</strong><br>${requiredVars.join(', ')}`;
        errorHtml += `<br><br>Go to Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables and set these values.`;
      }
      errorHtml += `<br><br><small>Check browser console (F12) and Vercel logs for more details</small></div>`;
      
      err.innerHTML = errorHtml;
      $('contentGrid').style.display = 'grid';
      $('heroStats').style.display = 'grid';
      load.style.display = 'none';
      return;
    }
    
    // Success - process data (even if some data is missing due to rate limiting)
    cryptoData = data.cryptoData || [];
    cryptoData.forEach(t => prices[t.id] = t.current_price);
    globalData = data.globalData;
    fearGreedData = data.fearGreed;
    
    if (data.cached && !data.stale) {
      // Silently use cached data - no warning needed for fresh cache
      console.log('Using cached data');
    }
    
    if (data.warning || data.stale) {
      const warningMsg = data.warning || 'Using cached data due to API error';
      console.warn('API Warning:', warningMsg);
      // Show a subtle warning to user
      const warningEl = document.createElement('div');
      warningEl.className = 'error';
      warningEl.style.background = 'rgba(245,158,11,.1)';
      warningEl.style.borderColor = 'rgba(245,158,11,.3)';
      warningEl.style.color = '#f59e0b';
      warningEl.innerHTML = `<strong>‚ö†Ô∏è ${data.stale ? 'Cached Data' : 'Rate Limit Warning'}:</strong> ${warningMsg}. Some data may be incomplete.`;
      const errorDiv = $('error');
      if (errorDiv && !errorDiv.querySelector('.error')) {
        errorDiv.appendChild(warningEl);
        setTimeout(() => warningEl.remove(), 10000); // Remove after 10 seconds
      }
    }
    
    if (data.retryAfter) {
      console.warn('API Rate Limited - Retry after:', data.retryAfter, 'seconds');
      const errorEl = document.createElement('div');
      errorEl.className = 'error';
      errorEl.innerHTML = `<strong>‚ö†Ô∏è Rate Limit Exceeded:</strong> ${data.message || 'CoinGecko API rate limit exceeded'}. Please wait ${data.retryAfter} seconds before refreshing.`;
      $('error').innerHTML = '';
      $('error').appendChild(errorEl);
    }
    
    console.log(`Loaded ${cryptoData.length} tokens`);
    
    renderAll();
    $('contentGrid').style.display = 'grid';
    $('heroStats').style.display = 'grid';
    if(currentUser) { loadPortfolio(); loadAlerts(); }
  } catch (e) {
    console.error('Fetch error:', e);
    console.error('Error details:', e.message, e.stack);
    // Check if it's a rate limit error (503)
    if (e.message && e.message.includes('503')) {
      err.innerHTML = `<div class="error"><strong>‚ö†Ô∏è Rate Limit Exceeded</strong><br><br>CoinGecko API rate limit has been exceeded. Please wait a minute and refresh the page.<br><br><small>The system will automatically retry, but you may need to wait a bit longer.</small></div>`;
    } else {
      err.innerHTML = `<div class="error"><strong>Network Error: ${e.message}</strong><br><br>This could mean:<br>‚Ä¢ The API endpoint is not responding<br>‚Ä¢ There's a network connectivity issue<br>‚Ä¢ The serverless function crashed<br>‚Ä¢ API rate limiting (429 errors)<br><br><small>Check browser console (F12) and Vercel deployment logs for details</small></div>`;
    }
    $('contentGrid').style.display = 'grid';
    $('heroStats').style.display = 'grid';
  } finally {
    load.style.display = 'none';
  }
}

/* ---------- PORTFOLIO (via Vercel API) ---------- */
async function loadPortfolio(){
  if(!currentUser) return;
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/portfolio', {
      method: 'GET',
      headers: { Authorization: `Bearer ${token}` }
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // GET /api/portfolio returns market data, not user holdings
    // We need to fetch user holdings separately using Firebase Realtime Database
    const userId = currentUser.uid;
    const db = firebase.database();
    const holdingsRef = db.ref(`users/${userId}/holdings`);
    
    holdingsRef.once('value', (snapshot) => {
      const holdings = snapshot.val() || {};
      renderPortfolio(holdings);
    }, (error) => {
      console.error('Database read error:', error);
      // Only show alert if it's a real error, not just empty data
      if (error.code !== 'PERMISSION_DENIED') {
        alert('Failed to load portfolio: ' + error.message);
      }
    });
  } catch (e) {
    alert('Load portfolio error: ' + e.message);
    console.error('Portfolio load error:', e);
  }
}

async function updateHolding(id, field, value) {
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/portfolio', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id, field, value })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    loadPortfolio();
  } catch (e) {
    alert('Update error: ' + e.message);
    console.error('Update holding error:', e);
  }
}

window.editHolding = function(id, tokenId, amount, buyPrice) {
  // Populate the edit modal with current values
  $('editHoldingId').value = id;
  $('editHoldingToken').value = tokenId;
  $('editHoldingAmount').value = amount;
  $('editHoldingBuyPrice').value = buyPrice;
  
  // Populate token select (in case it's not already populated)
  const tokenSelect = $('editHoldingToken');
  if (tokenSelect.options.length === 0) {
    cryptoData.forEach(token => {
      const option = document.createElement('option');
      option.value = token.id;
      option.textContent = `${token.name} (${token.symbol.toUpperCase()})`;
      if (token.id === tokenId) option.selected = true;
      tokenSelect.appendChild(option);
    });
  }
  
  // Show the modal
  $('editHoldingModal').classList.add('show');
};

window.deleteHolding = async (id) => {
  if(!confirm('Delete?')) return;
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/portfolio', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    loadPortfolio();
  } catch (e) {
    alert('Delete error: ' + e.message);
    console.error('Delete holding error:', e);
  }
};

$('addHoldingForm').onsubmit = async e => {
  e.preventDefault();
  const tokenId = $('holdingToken').value;
  const amount = parseFloat($('holdingAmount').value);
  const buyPrice = parseFloat($('buyPrice').value);
  if(!tokenId || isNaN(amount) || isNaN(buyPrice)) return alert('Fill all fields');
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/portfolio', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ holding: { tokenId, amount, buyPrice } })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    e.target.reset();
    loadPortfolio();
  } catch (e) {
    alert('Add error: ' + e.message);
    console.error('Add holding error:', e);
  }
};

// Edit holding form handler
$('editHoldingForm').onsubmit = async e => {
  e.preventDefault();
  const id = $('editHoldingId').value;
  const amount = parseFloat($('editHoldingAmount').value);
  const buyPrice = parseFloat($('editHoldingBuyPrice').value);
  
  if (!id || isNaN(amount) || isNaN(buyPrice) || amount <= 0 || buyPrice <= 0) {
    return alert('Please enter valid values for amount and buy price');
  }
  
  try {
    // Update both fields
    const token = await currentUser.getIdToken();
    
    // Update amount
    let res = await fetch('/api/portfolio', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id, field: 'amount', value: amount })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // Update buy price
    res = await fetch('/api/portfolio', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id, field: 'buyPrice', value: buyPrice })
    });
    
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    // Close modal and reload portfolio
    $('editHoldingModal').classList.remove('show');
    loadPortfolio();
  } catch (e) {
    alert('Update error: ' + e.message);
    console.error('Edit holding error:', e);
  }
};

/* ---------- ALERTS (via Vercel API) ---------- */
async function loadAlerts(){
  if(!currentUser) return;
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/alerts', {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    let data;
    try {
      const text = await res.text();
      if (!text) {
        data = {};
      } else {
        data = JSON.parse(text);
      }
    } catch (jsonError) {
      console.error('Failed to parse alerts response:', jsonError);
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText}). Response: ${(await res.text()).substring(0, 100)}`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    renderAlerts(data);
  } catch (e) {
    console.error('Load alerts error:', e);
    // Don't show alert if it's just empty alerts
    if (!e.message.includes('404') && !e.message.includes('invalid response')) {
      alert('Load alerts error: ' + e.message);
    }
  }
}

async function addAlert(alert) {
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/alerts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ alert })
    });
    if (res.status !== 200) throw new Error('Add failed');
    loadAlerts();
  } catch (e) {
    alert('Add error: ' + e.message);
  }
}

window.deleteAlert = async (id) => {
  if(!confirm('Delete?')) return;
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch(`/api/alerts?id=${encodeURIComponent(id)}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      const text = await res.text();
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText}): ${text.substring(0, 100)}`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    loadAlerts();
  } catch (e) {
    alert('Delete alert error: ' + e.message);
    console.error('Delete alert error:', e);
  }
};

$('addAlertForm').onsubmit = async e => {
  e.preventDefault();
  const tokenId = $('alertToken').value;
  const condition = $('alertCondition').value;
  const target = parseFloat($('targetPrice').value);
  const message = $('alertMessage').value;
  if(!tokenId || isNaN(target)) return alert('Fill all fields');
  await addAlert({ tokenId, condition, target, message });
  e.target.reset();
};

/* ---------- ADMIN ADD TOKEN (with CoinGecko Search) ---------- */
let selectedTokenId = null;
let searchTimeout = null;

// Token search functionality
$('tokenSearch').oninput = async (e) => {
  const query = e.target.value.trim();
  const resultsDiv = $('tokenSearchResults');
  
  if (query.length < 2) {
    resultsDiv.style.display = 'none';
    selectedTokenId = null;
    $('selectedToken').style.display = 'none';
    $('confirmAdd').disabled = true;
    return;
  }
  
  // Debounce search
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    try {
      resultsDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">Searching...</div>';
      resultsDiv.style.display = 'block';
      
      const res = await fetch(`/api/search-tokens?query=${encodeURIComponent(query)}`);
      const data = await res.json();
      
      if (!res.ok || !data.success) {
        throw new Error(data.error || 'Search failed');
      }
      
      if (data.tokens.length === 0) {
        resultsDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">No tokens found</div>';
        return;
      }
      
      resultsDiv.innerHTML = data.tokens.map(token => `
        <div class="token-result-item" onclick="selectToken('${token.id}', '${token.name}', '${token.symbol}')" 
          style="padding:14px 18px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.06);transition:all .25s;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:600;color:#e8eaed;font-size:14px;letter-spacing:-0.2px;">${token.name}</div>
            <div style="font-size:12px;color:#9aa0a6;margin-top:3px;font-weight:400;">${token.symbol} ‚Ä¢ ${token.id}</div>
          </div>
          <span style="color:#8b5cf6;font-size:18px;opacity:0.7;">‚Üí</span>
        </div>
      `).join('');
      
      // Add hover effect
      resultsDiv.querySelectorAll('.token-result-item').forEach(item => {
        item.onmouseenter = () => {
          item.style.background = 'rgba(139,92,246,.08)';
          item.style.borderBottomColor = 'rgba(255,255,255,.1)';
        };
        item.onmouseleave = () => {
          item.style.background = 'transparent';
          item.style.borderBottomColor = 'rgba(255,255,255,.06)';
        };
      });
      
    } catch (error) {
      console.error('Search error:', error);
      resultsDiv.innerHTML = `<div style="padding:20px;text-align:center;color:#ef4444;">Error: ${error.message}</div>`;
    }
  }, 300);
};

// Select token from search results
window.selectToken = (id, name, symbol) => {
  selectedTokenId = id;
  $('tokenSearch').value = name;
  $('tokenSearchResults').style.display = 'none';
  $('selectedTokenName').textContent = `${name} (${symbol})`;
  $('selectedTokenId').textContent = `ID: ${id}`;
  $('selectedToken').style.display = 'block';
  $('confirmAdd').disabled = false;
};

// Clear selection
$('clearSelection').onclick = () => {
  selectedTokenId = null;
  $('tokenSearch').value = '';
  $('selectedToken').style.display = 'none';
  $('confirmAdd').disabled = true;
  $('tokenSearchResults').style.display = 'none';
};

// Close search results when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('#tokenSearch') && !e.target.closest('#tokenSearchResults')) {
    $('tokenSearchResults').style.display = 'none';
  }
});

// Add token
$('confirmAdd').onclick = async () => {
  if (!selectedTokenId) return alert('Please select a token');
  
  const statusDiv = $('addTokenStatus');
  statusDiv.style.display = 'block';
  statusDiv.style.background = 'rgba(59,130,246,.1)';
  statusDiv.style.border = '1px solid rgba(59,130,246,.3)';
  statusDiv.style.color = '#3b82f6';
  statusDiv.textContent = 'Adding token...';
  $('confirmAdd').disabled = true;
  
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch('/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ id: selectedTokenId })
    });
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      throw new Error(`Server returned invalid response (${res.status} ${res.statusText})`);
    }
    
    if (!res.ok) {
      const errorMsg = data.error || data.message || `HTTP ${res.status}: ${res.statusText}`;
      throw new Error(errorMsg);
    }
    
    statusDiv.style.background = 'rgba(16,185,129,.1)';
    statusDiv.style.border = '1px solid rgba(16,185,129,.3)';
    statusDiv.style.color = '#10b981';
    statusDiv.textContent = `‚úÖ ${data.message || `Token "${selectedTokenId}" added successfully!`}`;
    
    setTimeout(() => {
      $('addTokenModal').classList.remove('show');
      $('tokenSearch').value = '';
      $('selectedToken').style.display = 'none';
      selectedTokenId = null;
      $('confirmAdd').disabled = true;
      statusDiv.style.display = 'none';
      fetchAll();
    }, 1500);
    
  } catch (e) {
    statusDiv.style.background = 'rgba(239,68,68,.1)';
    statusDiv.style.border = '1px solid rgba(239,68,68,.3)';
    statusDiv.style.color = '#ef4444';
    statusDiv.textContent = `‚ùå Error: ${e.message}`;
    $('confirmAdd').disabled = false;
    console.error('Token add error:', e);
  }
};

/* ---------- RENDER FUNCTIONS (same as before) ---------- */
function renderPortfolio(holdings) {
  const list = $('holdingsList');
  list.innerHTML = '';
  let totalValue = 0, totalCost = 0;
  Object.entries(holdings || {}).forEach(([id, h]) => {
    if (!h || !h.tokenId) return; // Skip invalid holdings
    const token = cryptoData.find(t => t.id === h.tokenId) || { 
      name: h.tokenId || 'Unknown Token', 
      symbol: h.tokenId ? h.tokenId.toUpperCase().substring(0, 4) : 'UNK', 
      image: 'https://via.placeholder.com/32?text=?' 
    };
    const price = prices[h.tokenId] || 0;
    const value = h.amount * price;
    const cost = h.amount * h.buyPrice;
    totalValue += value;
    totalCost += cost;
    const pl = value - cost;
    const plPct = cost > 0 ? (pl / cost * 100) : 0;
    const symbolDisplay = token.symbol ? `(${token.symbol.toUpperCase()})` : '';
    list.innerHTML += `
      <div class="holding-row" data-id="${id}">
        <div class="token-icon-col"><img src="${token.image || 'https://via.placeholder.com/32'}" class="token-icon" onerror="this.src='https://via.placeholder.com/32?text=?'"></div>
        <div class="holding-name">${token.name || h.tokenId || 'Unknown'} ${symbolDisplay}</div>
        <div class="editable" data-field="amount" data-value="${h.amount}">${h.amount}</div>
        <div class="editable" data-field="buyPrice" data-value="${h.buyPrice}">$${formatPrice(h.buyPrice)}</div>
        <div style="color:${pl >= 0 ? '#10b981' : '#ef4444'}">
          ${pl >= 0 ? '+' : ''}${formatPrice(pl)}<br><small>(${plPct.toFixed(2)}%)</small>
        </div>
        <div class="holding-actions">
          <button class="edit-btn" onclick="editHolding('${id}', '${h.tokenId}', ${h.amount}, ${h.buyPrice})" title="Edit">‚úèÔ∏è</button>
          <button class="delete-btn" onclick="deleteHolding('${id}')" title="Delete">X</button>
        </div>
      </div>`;
  });
  $('totalValue').textContent = `$${totalValue.toFixed(2)}`;
  const pl = totalValue - totalCost;
  $('totalPL').textContent = pl >= 0 ? `+$${pl.toFixed(2)}` : `-$${Math.abs(pl).toFixed(2)}`;
  $('totalPL').style.color = pl >= 0 ? '#10b981' : '#ef4444';
  $('roi').textContent = totalCost > 0 ? `${((totalValue / totalCost - 1) * 100).toFixed(2)}%` : '0%';
  document.querySelectorAll('.editable').forEach(el => el.onclick = () => startEdit(el));
}

function startEdit(el) {
  if (el.querySelector('input')) return;
  const field = el.dataset.field;
  const value = el.dataset.value;
  const input = document.createElement('input');
  input.type = 'number';
  input.step = 'any';
  input.value = value;
  input.style.width = '80px';
  input.style.padding = '4px 8px';
  input.style.background = '#0a0a0a';
  input.style.border = '1px solid #8b5cf6';
  input.style.borderRadius = '8px';
  input.style.color = '#fff';
  input.style.fontSize = '14px';
  const saveBtn = document.createElement('span');
  saveBtn.textContent = 'Save';
  saveBtn.style.cursor = 'pointer';
  saveBtn.style.color = '#10b981';
  saveBtn.style.marginLeft = '8px';
  saveBtn.style.fontWeight = '700';
  const cancelBtn = document.createElement('span');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.style.cursor = 'pointer';
  cancelBtn.style.color = '#ef4444';
  cancelBtn.style.marginLeft = '8px';
  cancelBtn.style.fontWeight = '700';
  el.innerHTML = '';
  el.appendChild(input);
  el.appendChild(saveBtn);
  el.appendChild(cancelBtn);
  input.focus();
  const save = async () => {
    const newVal = parseFloat(input.value);
    if (isNaN(newVal) || newVal < 0) return alert('Invalid value');
    const holdingId = el.closest('.holding-row').dataset.id;
    await updateHolding(holdingId, field, newVal);
  };
  saveBtn.onclick = save;
  input.onkeypress = e => e.key === 'Enter' && save();
  cancelBtn.onclick = () => loadPortfolio();
}

function renderAlerts(alerts) {
  const list = $('alertsList');
  list.innerHTML = '';
  if (!alerts || Object.keys(alerts).length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#888;">No alerts set. Create one below!</div>';
    populateTokenSelect('alertToken');
    return;
  }
  Object.entries(alerts || {}).forEach(([id, a]) => {
    if (!a || !a.tokenId) return; // Skip invalid alerts
    const token = cryptoData.find(t => t.id === a.tokenId);
    const tokenName = token?.name || a.tokenId || 'Unknown Token';
    const tokenImage = token?.image || 'https://via.placeholder.com/32?text=?';
    const price = prices[a.tokenId] || 0;
    const triggered = (a.condition === 'above' && price >= a.target) || (a.condition === 'below' && price <= a.target);
    list.innerHTML += `
      <div class="alert-row ${triggered ? 'triggered' : ''}">
        <div class="token-icon-col"><img src="${tokenImage}" class="token-icon" onerror="this.src='https://via.placeholder.com/32?text=?'"></div>
        <div>${tokenName}</div>
        <div>${a.condition === 'above' ? '>' : '<'} $${formatPrice(a.target || 0)}</div>
        <div>$${formatPrice(price)}</div>
        <div class="delete-btn" onclick="deleteAlert('${id}')">X</div>
      </div>`;
    if (triggered && !a.notified) {
      if (typeof confetti !== 'undefined') {
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
      }
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('CCX Alert', { body: `${a.message || ''} ${tokenName} is ${a.condition} $${a.target}!` });
      }
    }
  });
  populateTokenSelect('alertToken');
}

/* ---------- POPULATE SELECTS ---------- */
function populateTokenSelect(id) {
  const sel = $(id);
  if (!sel) return; // Element doesn't exist
  sel.innerHTML = '<option value="">Select Token</option>';
  if (!cryptoData || cryptoData.length === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'No tokens available';
    opt.disabled = true;
    sel.appendChild(opt);
    return;
  }
  cryptoData.forEach(t => {
    if (!t || !t.id) return; // Skip invalid tokens
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = `${t.name || t.id} (${(t.symbol || t.id.substring(0, 4)).toUpperCase()})`;
    sel.appendChild(opt);
  });
}

/* ---------- MODAL HANDLERS ---------- */
$('addTokenBtn').onclick = () => {
  $('addTokenModal').classList.add('show');
  $('tokenSearch').focus();
};
$('closeModal').onclick = () => {
  $('addTokenModal').classList.remove('show');
  $('tokenSearch').value = '';
  $('selectedToken').style.display = 'none';
  $('tokenSearchResults').style.display = 'none';
  selectedTokenId = null;
  $('confirmAdd').disabled = true;
};
$('cancelAdd').onclick = () => {
  $('addTokenModal').classList.remove('show');
  $('tokenSearch').value = '';
  $('selectedToken').style.display = 'none';
  $('tokenSearchResults').style.display = 'none';
  selectedTokenId = null;
  $('confirmAdd').disabled = true;
};
$('refreshBtn').onclick = () => fetchAll();

/* ---------- AUTO REFRESH ---------- */
let refreshIntervalId = null;
let refreshIntervalMs = 180000; // Default 3 minutes

function startAutoRefresh() {
  if (refreshIntervalId) clearInterval(refreshIntervalId);
  refreshIntervalId = setInterval(() => {
    fetchAll();
    if (currentUser) {
      loadPortfolio();
      loadAlerts();
    }
  }, refreshIntervalMs);
}

// Load settings and start auto-refresh
fetchAll();
startAutoRefresh();

// Settings handler
const refreshIntervalSelect = $('refreshInterval');
if (refreshIntervalSelect) {
  refreshIntervalSelect.onchange = (e) => {
    refreshIntervalMs = parseInt(e.target.value);
    startAutoRefresh();
    console.log(`Refresh interval changed to ${refreshIntervalMs / 1000} seconds`);
  };
}

if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
</script>
</body>
</html>
